!function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}sm.siteId=sm.conf.engagement.site_id,sm.rxVersion=6;var n=t(e);function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function h(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,n){return(d=h()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&p(i,n.prototype),i}).apply(null,arguments)}function v(e){var t="function"==typeof Map?new Map:void 0;return(v=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return d(e,arguments,f(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),p(r,e)})(e)}function b(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){var t=h();return function(){var n,r=f(e);if(t){var i=f(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return b(this,n)}}function g(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}function y(){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=g(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}}).apply(this,arguments)}function _(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,o=[],s=!0,a=!1;try{for(n=n.call(e);!(s=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);s=!0);}catch(e){a=!0,i=e}finally{try{s||null==n.return||n.return()}finally{if(a)throw i}}return o}(e,t)||E(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e){return function(e){if(Array.isArray(e))return O(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||E(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){if(e){if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?O(e,t):void 0}}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function T(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function k(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}function A(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})})),t}var x=k((function(e){
/*!
     * EventEmitter v4.2.5 - git.io/ee
     * Oliver Caldwell
     * MIT license
     * @preserve
     */
(function(){function t(){}var n=t.prototype,r=this,i=r.EventEmitter;function s(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function a(e){return function(){return this[e].apply(this,arguments)}}n.getListeners=function(e){var t,n,r=this._getEvents();if("object"===o(e))for(n in t={},r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n]);else t=r[e]||(r[e]=[]);return t},n.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},n.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},n.addListener=function(e,t){var n,r=this.getListenersAsObject(e),i="object"===o(t);for(n in r)r.hasOwnProperty(n)&&-1===s(r[n],t)&&r[n].push(i?t:{listener:t,once:!1});return this},n.on=a("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=a("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,t){var n,r,i=this.getListenersAsObject(e);for(r in i)i.hasOwnProperty(r)&&-1!==(n=s(i[r],t))&&i[r].splice(n,1);return this},n.off=a("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,a=e?this.removeListeners:this.addListeners;if("object"!==o(t)||t instanceof RegExp)for(r=n.length;r--;)s.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&("function"==typeof i?s.call(this,r,i):a.call(this,r,i));return this},n.removeEvent=function(e){var t,n=o(e),r=this._getEvents();if("string"===n)delete r[e];else if("object"===n)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},n.removeAllListeners=a("removeEvent"),n.emitEvent=function(e,t){var n,r,i,o=this.getListenersAsObject(e);for(i in o)if(o.hasOwnProperty(i))for(r=o[i].length;r--;)!0===(n=o[i][r]).once&&this.removeListener(e,n.listener),n.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},n.trigger=a("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},n._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return r.EventEmitter=i,t},e.exports?e.exports=t:this.EventEmitter=t}).call(S)})),I=k((function(e,t){(function(){var t,n,r,i,s,a,u,c={"@@functional/placeholder":!0},l=function(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,i){return t.apply(this,arguments)};case 5:return function(e,n,r,i,o){return t.apply(this,arguments)};case 6:return function(e,n,r,i,o,s){return t.apply(this,arguments)};case 7:return function(e,n,r,i,o,s,a){return t.apply(this,arguments)};case 8:return function(e,n,r,i,o,s,a,u){return t.apply(this,arguments)};case 9:return function(e,n,r,i,o,s,a,u,c){return t.apply(this,arguments)};case 10:return function(e,n,r,i,o,s,a,u,c,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}},f=function(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n},p=function(e){return new RegExp(e.source,(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":""))},h=function(e){return function(){return!e.apply(this,arguments)}},d=function(e,t){var n;t=t||[];var r=(e=e||[]).length,i=t.length,o=[];for(n=0;n<r;)o[o.length]=e[n],n+=1;for(n=0;n<i;)o[o.length]=t[n],n+=1;return o},v=function(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1},b=function(e,t){for(var n=0,r=t.length,i=[];n<r;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i},m=function(e,t){return Object.prototype.hasOwnProperty.call(t,e)},g=function(e){return e},y=function(){var e=Object.prototype.toString;return"[object Arguments]"===e.call(arguments)?function(t){return"[object Arguments]"===e.call(t)}:function(e){return m("callee",e)}}(),_=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)},w=Number.isInteger||function(e){return e<<0===e},E=function(e){return"[object Number]"===Object.prototype.toString.call(e)},O=function(e){return"[object Object]"===Object.prototype.toString.call(e)},S=function(e){return null!=e&&"object"===o(e)&&!0===e["@@functional/placeholder"]},T=function(e){return"[object String]"===Object.prototype.toString.call(e)},k=function(e){return"function"==typeof e["@@transducer/step"]},A=function(e,t){for(var n=0,r=t.length,i=Array(r);n<r;)i[n]=e(t[n]),n+=1;return i},x=function(e,t){return function(){return t.call(this,e.apply(this,arguments))}},I=function(e,t){return function(){var n=this;return e.apply(n,arguments).then((function(e){return t.call(n,e)}))}},N=function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'},M=function(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}},C=function e(t,n,r){switch(arguments.length){case 1:return e(t,0,t.length);case 2:return e(t,n,t.length);default:for(var i=[],o=0,s=Math.max(0,Math.min(t.length,r)-n);o<s;)i[o]=t[n+o],o+=1;return i}},R=(t=function(e){return(e<10?"0":"")+e},"function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}),P={init:function(){return this.xf["@@transducer/init"]()},result:function(e){return this.xf["@@transducer/result"](e)}},j=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},function(t){return new e(t)}}(),L=function(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return _(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,C(arguments,0,n-1))}},q=function(e){return function t(n){return 0===arguments.length||S(n)?t:e.apply(this,arguments)}},U=function(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return S(n)?t:q((function(t){return e(n,t)}));default:return S(n)&&S(r)?t:S(n)?q((function(t){return e(t,r)})):S(r)?q((function(t){return e(n,t)})):e(n,r)}}},D=function(e){return function t(n,r,i){switch(arguments.length){case 0:return t;case 1:return S(n)?t:U((function(t,r){return e(n,t,r)}));case 2:return S(n)&&S(r)?t:S(n)?U((function(t,n){return e(t,r,n)})):S(r)?U((function(t,r){return e(n,t,r)})):q((function(t){return e(n,r,t)}));default:return S(n)&&S(r)&&S(i)?t:S(n)&&S(r)?U((function(t,n){return e(t,n,i)})):S(n)&&S(i)?U((function(t,n){return e(t,r,n)})):S(r)&&S(i)?U((function(t,r){return e(n,t,r)})):S(n)?q((function(t){return e(t,r,i)})):S(r)?q((function(t){return e(n,t,i)})):S(i)?q((function(t){return e(n,r,t)})):e(n,r,i)}}},V=function e(t,n,r){return function(){for(var i=[],o=0,s=t,a=0;a<n.length||o<arguments.length;){var u;a<n.length&&(!S(n[a])||o>=arguments.length)?u=n[a]:(u=arguments[o],o+=1),i[a]=u,S(u)||(s-=1),a+=1}return s<=0?r.apply(this,i):l(s,e(t,i,r))}},F=function(e,t,n){return function(){var r=arguments.length;if(0===r)return n();var i=arguments[r-1];if(!_(i)){var o=C(arguments,0,r-1);if("function"==typeof i[e])return i[e].apply(i,o);if(k(i)){var s=t.apply(null,o);return s(i)}}return n.apply(this,arguments)}},B=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=M(this.xf["@@transducer/step"](e,!1))),e},U((function(t,n){return new e(t,n)}))}(),H=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=M(this.xf["@@transducer/step"](e,!0))),e},U((function(t,n){return new e(t,n)}))}(),W=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return d(C(this.acc,this.pos),C(this.acc,0,this.pos))},U((function(t,n){return new e(t,n)}))}(),G=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),z=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},U((function(t,n){return new e(t,n)}))}(),J=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=function(){return this.xf["@@transducer/init"]()},e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),Y=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),Q=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},U((function(t,n){return new e(t,n)}))}(),K=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=M(this.xf["@@transducer/step"](e,t))),e},U((function(t,n){return new e(t,n)}))}(),X=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=M(this.xf["@@transducer/step"](e,this.idx))),e},U((function(t,n){return new e(t,n)}))}(),$=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},U((function(t,n){return new e(t,n)}))}(),Z=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},U((function(t,n){return new e(t,n)}))}(),ee=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},U((function(t,n){return new e(t,n)}))}(),te=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return 0===this.n?M(e):(this.n-=1,this.xf["@@transducer/step"](e,t))},U((function(t,n){return new e(t,n)}))}(),ne=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=P.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):M(e)},U((function(t,n){return new e(t,n)}))}(),re=U((function(e,t){return e+t})),ie=D((function(e,t,n){if(t>=n.length||t<-n.length)return n;var r=(t<0?n.length:0)+t,i=d(n);return i[r]=e(n[r]),i})),oe=U(F("all",B,(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0}))),se=q((function(e){return function(){return e}})),ae=U((function(e,t){return e&&t})),ue=U(F("any",H,(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1}))),ce=U(F("aperture",W,(function(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=C(t,n,n+e),n+=1;return i}))),le=U((function(e,t){return d(t,[e])})),fe=U((function(e,t){return e.apply(this,t)})),pe=D((function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r})),he=D((function e(t,n,r){switch(t.length){case 0:return n;case 1:return pe(t[0],n,r);default:return pe(t[0],e(C(t,1),n,Object(r[t[0]])),r)}})),de=U((function(e,t){return l(e.length,(function(){return e.apply(t,arguments)}))})),ve=U((function(e,t){return function(){return e.apply(this,arguments)&&t.apply(this,arguments)}})),be=q((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}})),me=q((function(e){return function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}})),ge=U((function(e,t){for(var n={},r=t.length,i=0;i<r;){var o=e(t[i]);n[o]=(m(o,n)?n[o]:0)+1,i+=1}return n})),ye=U((function(e,t){return 1===e?q(t):l(e,V(e,[],t))})),_e=re(-1),we=U((function(e,t){return null==t||t!=t?e:t})),Ee=D((function(e,t,n){for(var r=[],i=0,o=t.length;i<o;)v(e,t[i],n)||v(e,t[i],r)||r.push(t[i]),i+=1;return r})),Oe=U((function(e,t){var n={};for(var r in t)r!==e&&(n[r]=t[r]);return n})),Se=U((function e(t,n){switch(t.length){case 0:return n;case 1:return Oe(t[0],n);default:var r=t[0],i=C(t,1);return null==n[r]?n:pe(r,e(i,n[r]),n)}})),Te=U((function(e,t){return e/t})),ke=U(F("dropWhile",Y,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return C(t,n)}))),Ae=U((function(e,t){return function(){return e.apply(this,arguments)||t.apply(this,arguments)}})),xe=q((function(e){return null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():_(e)?[]:T(e)?"":O(e)?{}:y(e)?function(){return arguments}():void 0})),Ie=U((function e(t,n){var r,i,s,a={};for(i in n)s=o(r=t[i]),a[i]="function"===s?r(n[i]):"object"===s?e(t[i],n[i]):n[i];return a})),Ne=U(F("find",K,(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}}))),Me=U(F("findIndex",X,(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1}))),Ce=U(F("findLast",$,(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}}))),Re=U(F("findLastIndex",Z,(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),Pe=U(L("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t}))),je=q((function(e){for(var t=0,n=e.length,r={};t<n;)_(e[t])&&e[t].length&&(r[e[t][0]]=e[t][1]),t+=1;return r})),Le=U((function(e,t){return e>t})),qe=U((function(e,t){return e>=t})),Ue=U(m),De=U((function(e,t){return e in t})),Ve=U((function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t})),Fe=q(g),Be=D((function(e,t,n){return ye(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),He=re(1),We=D((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=C(n);return r.splice(e,0,t),r})),Ge=D((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,d(d(C(n,0,e),t),C(n,e))})),ze=U(L("intersperse",(function(e,t){for(var n=[],r=0,i=t.length;r<i;)r===i-1?n.push(t[r]):n.push(t[r],e),r+=1;return n}))),Je=U((function(e,t){return null!=t&&t.constructor===e||t instanceof e})),Ye=q((function(e){return!!_(e)||!!e&&("object"===o(e)&&(!(e instanceof String)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))})),Qe=q((function(e){return null==e})),Ke=function(){var e=!{toString:null}.propertyIsEnumerable("toString"),t=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],n=function(){return arguments.propertyIsEnumerable("length")}(),r=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1};return"function"!=typeof Object.keys||n?q((function(i){if(Object(i)!==i)return[];var o,s,a=[],u=n&&y(i);for(o in i)!m(o,i)||u&&"length"===o||(a[a.length]=o);if(e)for(s=t.length-1;s>=0;)m(o=t[s],i)&&!r(a,o)&&(a[a.length]=o),s-=1;return a})):q((function(e){return Object(e)!==e?[]:Object.keys(e)}))}(),Xe=q((function(e){var t,n=[];for(t in e)n[n.length]=t;return n})),$e=q((function(e){return null!=e&&Je(Number,e.length)?e.length:NaN})),Ze=U((function(e,t){return e<t})),et=U((function(e,t){return e<=t})),tt=D((function(e,t,n){for(var r=0,i=n.length,o=[],s=[t];r<i;)s=e(s[0],n[r]),o[r]=s[1],r+=1;return[s[0],o]})),nt=D((function(e,t,n){for(var r=n.length-1,i=[],o=[t];r>=0;)o=e(o[0],n[r]),i[r]=o[1],r-=1;return[o[0],i]})),rt=U((function(e,t){return t.match(e)||[]})),it=U((function(e,t){return w(e)?!w(t)||t<1?NaN:(e%t+t)%t:NaN})),ot=U((function(e,t){return t>e?t:e})),st=D((function(e,t,n){return e(n)>e(t)?n:t})),at=D((function(e,t,n){var r,i={};for(r in t)m(r,t)&&(i[r]=m(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)m(r,n)&&!m(r,i)&&(i[r]=n[r]);return i})),ut=U((function(e,t){return t<e?t:e})),ct=D((function(e,t,n){return e(n)<e(t)?n:t})),lt=U((function(e,t){return e%t})),ft=U((function(e,t){return e*t})),pt=U((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,i){return t.call(this,e,n,r,i)};case 5:return function(e,n,r,i,o){return t.call(this,e,n,r,i,o)};case 6:return function(e,n,r,i,o,s){return t.call(this,e,n,r,i,o,s)};case 7:return function(e,n,r,i,o,s,a){return t.call(this,e,n,r,i,o,s,a)};case 8:return function(e,n,r,i,o,s,a,u){return t.call(this,e,n,r,i,o,s,a,u)};case 9:return function(e,n,r,i,o,s,a,u,c){return t.call(this,e,n,r,i,o,s,a,u,c)};case 10:return function(e,n,r,i,o,s,a,u,c,l){return t.call(this,e,n,r,i,o,s,a,u,c,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}})),ht=q((function(e){return-e})),dt=U(h(F("any",H,ue))),vt=q((function(e){return!e})),bt=U((function(e,t){var n=e<0?t.length+e:e;return T(t)?t.charAt(n):t[n]})),mt=q((function(e){return function(){return bt(e,arguments)}})),gt=U((function(e,t){var n={};return n[e]=t,n})),yt=q((function(e){return[e]})),_t=q((function(e){var t,n=!1;return l(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))})),wt=U((function(e,t){return e||t})),Et=(n=function e(t){return{value:t,map:function(n){return e(n(t))}}},D((function(e,t,r){return e((function(e){return n(t(e))}))(r).value}))),Ot=U((function(e,t){return[e,t]})),St=U((function(e,t){for(var n=t,r=0;r<e.length;){if(null==n)return;n=n[e[r]],r+=1}return n})),Tt=D((function(e,t,n){return we(e,St(t,n))})),kt=D((function(e,t,n){return t.length>0&&e(St(t,n))})),At=U((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n})),xt=U((function(e,t){for(var n={},r=0,i=e.length;r<i;){var o=e[r];n[o]=t[o],r+=1}return n})),It=U((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n})),Nt=U((function(e,t){return d([e],t)})),Mt=U((function(e,t){return t[e]})),Ct=D((function(e,t,n){return null!=n&&m(t,n)?n[t]:e})),Rt=D((function(e,t,n){return e(n[t])})),Pt=U((function(e,t){for(var n=e.length,r=[],i=0;i<n;)r[i]=t[e[i]],i+=1;return r})),jt=U((function(e,t){if(!E(e)||!E(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n})),Lt=D((function(e,t,n){for(var r=n.length-1;r>=0;)t=e(t,n[r]),r-=1;return t})),qt=q(M),Ut=D((function(e,t,n){return d(C(n,0,Math.min(e,n.length)),C(n,Math.min(n.length,e+t)))})),Dt=D((function(e,t,n){return n.replace(e,t)})),Vt=q((function(e){return T(e)?e.split("").reverse().join(""):C(e).reverse()})),Ft=D((function(e,t,n){for(var r=0,i=n.length,o=[t];r<i;)t=e(t,n[r]),o[r+1]=t,r+=1;return o})),Bt=D((function(e,t,n){return Et(e,se(t),n)})),Ht=D(L("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),Wt=U((function(e,t){return C(t).sort(e)})),Gt=U((function(e,t){return C(t).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))})),zt=U((function(e,t){return[Ht(0,e,t),Ht(e,$e(t),t)]})),Jt=U((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(Ht(r,r+=e,t));return n})),Yt=U((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,C(t,n)]})),Qt=U((function(e,t){return e-t})),Kt=L("tail",Ht(1,1/0)),Xt=U(F("take",te,(function(e,t){return Ht(0,e<0?1/0:e,t)}))),$t=U((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return C(t,n+1,1/0)})),Zt=U(F("takeWhile",ne,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return C(t,0,n)}))),en=U((function(e,t){return e(t),t})),tn=U((function(e,t){var n,r=Number(t),i=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=new Array(r);i<r;)n[i]=e(i),i+=1;return n})),nn=q((function(e){var t=[];for(var n in e)m(n,e)&&(t[t.length]=[n,e[n]]);return t})),rn=q((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t})),on=q((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],i=0;i<r.length;)void 0===n[i]&&(n[i]=[]),n[i].push(r[i]),i+=1;t+=1}return n})),sn=(r="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff","function"==typeof String.prototype.trim&&!r.trim()&&"​".trim()?q((function(e){return e.trim()})):q((function(e){var t=new RegExp("^["+r+"]["+r+"]*"),n=new RegExp("["+r+"]["+r+"]*$");return e.replace(t,"").replace(n,"")}))),an=q((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)})),un=q((function(e){return function(){return e(C(arguments))}})),cn=q((function(e){return pt(1,e)})),ln=U((function(e,t){return ye(e,(function(){for(var n,r=1,i=t,o=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:o+i.length,i=i.apply(this,C(arguments,o,n)),r+=1,o=n;return i}))})),fn=U((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),pn=U((function(e,t){for(var n,r=0,i=t.length,o=[];r<i;)n=t[r],v(e,n,o)||(o[o.length]=n),r+=1;return o})),hn=D((function(e,t,n){return e(n)?n:t(n)})),dn=D((function(e,t,n){return ie(se(t),e,n)})),vn=U((function(e,t){return ye(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(C(arguments,t.length)))}))})),bn=q((function(e){for(var t=Ke(e),n=t.length,r=[],i=0;i<n;)r[i]=e[t[i]],i+=1;return r})),mn=q((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n})),gn=(i=function(e){return{value:e,map:function(){return this}}},U((function(e,t){return e(i)(t).value}))),yn=D((function(e,t,n){return e(n)?t(n):n})),_n=U((function(e,t){for(var n in e)if(m(n,e)&&!e[n](t[n]))return!1;return!0})),wn=U((function(e,t){return ye(e.length,(function(){return t.apply(this,d([e],arguments))}))})),En=U((function(e,t){for(var n,r=0,i=e.length,o=t.length,s=[];r<i;){for(n=0;n<o;)s[s.length]=[e[r],t[n]],n+=1;r+=1}return s})),On=U((function(e,t){for(var n=[],r=0,i=Math.min(e.length,t.length);r<i;)n[r]=[e[r],t[r]],r+=1;return n})),Sn=U((function(e,t){for(var n=0,r=e.length,i={};n<r;)i[e[n]]=t[n],n+=1;return i})),Tn=D((function(e,t,n){for(var r=[],i=0,o=Math.min(t.length,n.length);i<o;)r[i]=e(t[i],n[i]),i+=1;return r})),kn=se(!1),An=se(!0),xn=function e(t,n,r){var i=function(i){for(var o=n.length,s=0;s<o;){if(t===n[s])return r[s];s+=1}for(var a in n[s+1]=t,r[s+1]=i,t)i[a]=e(t[a],n,r);return i};switch(an(t)){case"Object":return i({});case"Array":return i([]);case"Date":return new Date(t.valueOf());case"RegExp":return p(t);default:return t}},In=function(e){return U((function(t,n){return l(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))},Nn=function e(t,n,r,i){if(Ve(t,n))return!0;if(an(t)!==an(n))return!1;if(null==t||null==n)return!1;if("function"==typeof t.equals||"function"==typeof n.equals)return"function"==typeof t.equals&&t.equals(n)&&"function"==typeof n.equals&&n.equals(t);switch(an(t)){case"Arguments":case"Array":case"Object":break;case"Boolean":case"Number":case"String":if(o(t)!==o(n)||!Ve(t.valueOf(),n.valueOf()))return!1;break;case"Date":if(!Ve(t.valueOf(),n.valueOf()))return!1;break;case"Error":return t.name===n.name&&t.message===n.message;case"RegExp":if(t.source!==n.source||t.global!==n.global||t.ignoreCase!==n.ignoreCase||t.multiline!==n.multiline||t.sticky!==n.sticky||t.unicode!==n.unicode)return!1;break;case"Map":case"Set":if(!e(f(t.entries()),f(n.entries()),r,i))return!1;break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var s=Ke(t);if(s.length!==Ke(n).length)return!1;for(var a=r.length-1;a>=0;){if(r[a]===t)return i[a]===n;a-=1}for(r.push(t),i.push(n),a=s.length-1;a>=0;){var u=s[a];if(!m(u,n)||!e(n[u],t[u],r,i))return!1;a-=1}return r.pop(),i.pop(),!0},Mn=function(e){return function t(n){for(var r,i,o,s=[],a=0,u=n.length;a<u;){if(Ye(n[a]))for(o=0,i=(r=e?t(n[a]):n[a]).length;o<i;)s[s.length]=r[o],o+=1;else s[s.length]=n[a];a+=1}return s}},Cn=function(){function e(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}var t="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";return function(n,r,i){if("function"==typeof n&&(n=j(n)),Ye(i))return function(e,t,n){for(var r=0,i=n.length;r<i;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}(n,r,i);if("function"==typeof i.reduce)return function(e,t,n){return e["@@transducer/result"](n.reduce(de(e["@@transducer/step"],e),t))}(n,r,i);if(null!=i[t])return e(n,r,i[t]());if("function"==typeof i.next)return e(n,r,i);throw new TypeError("reduce: list must be array or iterable")}}(),Rn=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=Cn(this.xf["@@transducer/step"],e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},U((function(t,n){return new e(t,n)}))}(),Pn=function(){function e(e,t){this.xf=t,this.f=e,this.inputs={}}return e.prototype["@@transducer/init"]=P.init,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(m(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.f(t);return this.inputs[n]=this.inputs[n]||[n,[]],this.inputs[n][1]=le(t,this.inputs[n][1]),e},U((function(t,n){return new e(t,n)}))}(),jn=q((function(e){return ye(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],i=C(arguments);return i[0]=function(){var e=n.apply(this,d(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))})),Ln=q((function(e){return pt(2,e)})),qn=q((function(e){return null!=e&&"function"==typeof e.clone?e.clone():xn(e,[],[])})),Un=q((function(e){return ye(e.length,e)})),Dn=U(F("drop",G,(function(e,t){return Ht(Math.max(0,e),1/0,t)}))),Vn=U(F("dropLast",z,(function(e,t){return Xt(e<t.length?t.length-e:0,t)}))),Fn=U(F("dropLastWhile",Rn,(function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return C(t,0,n+1)}))),Bn=U((function(e,t){return Nn(e,t,[],[])})),Hn=U(F("filter",Q,(function(e,t){return O(t)?Cn((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},Ke(t)):b(e,t)}))),Wn=q(Mn(!0)),Gn=q((function(e){return Un((function(t,n){var r=C(arguments);return r[0]=n,r[1]=t,e.apply(this,r)}))})),zn=U(F("groupBy",Pn,(function(e,t){return Cn((function(t,n){var r=e(n);return t[r]=le(n,t[r]||(t[r]=[])),t}),{},t)}))),Jn=bt(0),Yn=U((function(e,t){return Cn((function(t,n){return t[e(n)]=n,t}),{},t)})),Qn=Ht(0,-1),Kn=D((function(e,t,n){for(var r=[],i=0;i<t.length;)v(e,t[i],n)&&(r[r.length]=t[i]),i+=1;return pn(e,r)})),Xn=q((function(e){for(var t=Ke(e),n=t.length,r=0,i={};r<n;){var o=t[r],s=e[o],a=m(s,i)?i[s]:i[s]=[];a[a.length]=o,r+=1}return i})),$n=q((function(e){for(var t=Ke(e),n=t.length,r=0,i={};r<n;){var o=t[r];i[e[o]]=o,r+=1}return i})),Zn=q((function(e){return null!=e&&Bn(e,xe(e))})),er=bt(-1),tr=U((function(e,t){if("function"!=typeof t.lastIndexOf||_(t)){for(var n=t.length-1;n>=0;){if(Bn(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)})),nr=U(F("map",ee,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return ye(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return Cn((function(n,r){return n[r]=e(t[r]),n}),{},Ke(t));default:return A(e,t)}}))),rr=U((function(e,t){return Cn((function(n,r){return n[r]=e(t[r],r,t),n}),{},Ke(t))})),ir=D((function(e,t,n){return at((function(t,n,r){return e(n,r)}),t,n)})),or=In(d),sr=In(Gn(d)),ar=U((function(e,t){return Cn((function(t,n){var r=t[e(n)?0:1];return r[r.length]=n,t}),[[],[]],t)})),ur=D((function(e,t,n){return Bn(St(e,n),t)})),cr=U((function(e,t){return nr(Mt(e),t)})),lr=vn(A,[xt,Fe]),fr=D((function(e,t,n){return Rt(Bn(t),e,n)})),pr=D((function(e,t,n){return Rt(Je(e),t,n)})),hr=D(Cn),dr=U((function(e,t){return Hn(h(e),t)})),vr=U((function(e,t){return tn(se(e),t)})),br=hr(re,0),mr=U((function(e,t){return Dn(e>=0?t.length-e:0,t)})),gr=ye(4,(function(e,t,n,r){return Cn(e("function"==typeof t?j(t):t),n,r)})),yr=D((function(e,t,n){return pn(e,d(t,n))})),_r=U((function(e,t){return _n(nr(Bn,e),t)})),wr=function(e){var t=function(e){return{"@@transducer/init":P.init,"@@transducer/result":function(t){return e["@@transducer/result"](t)},"@@transducer/step":function(t,n){var r=e["@@transducer/step"](t,n);return r["@@transducer/reduced"]?{"@@transducer/value":r,"@@transducer/reduced":!0}:r}}}(e);return{"@@transducer/init":P.init,"@@transducer/result":function(e){return t["@@transducer/result"](e)},"@@transducer/step":function(e,n){return Ye(n)?Cn(t,e,n):Cn(t,e,[n])}}},Er=function(e,t,n){var r,i;if("function"==typeof e.indexOf)switch(o(t)){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(i=e[n])&&1/i===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(Bn(e[n],t))return n;n+=1}return-1},Or=U((function(e,t){return nr(e,wr(t))})),Sr=q((function(e){return ye(hr(ot,0,cr("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))})),Tr=q((function(e){for(var t=e.length,n=0;n<t;){if(Er(e,e[n],n+1)>=0)return!1;n+=1}return!0})),kr=q((function(e){return ye(hr(ot,0,cr("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))})),Ar=U((function(e,t){return"function"==typeof e.ap?e.ap(t):"function"==typeof e?ye(Math.max(e.length,t.length),(function(){return e.apply(this,arguments)(t.apply(this,arguments))})):Cn((function(e,n){return d(e,nr(n,t))}),[],e)})),xr=Un((function(e){return e.apply(this,C(arguments,1))})),Ir=U(F("chain",Or,(function(e,t){return"function"==typeof t?function(){return t.call(this,e.apply(this,arguments)).apply(this,arguments)}:Mn(!1)(nr(e,t))}))),Nr=D((function(e,t,n){return Lt((function(t,n){return Ar(nr(Nt,e(n)),t)}),t([]),n)})),Mr=U((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Un(pt(e,(function(e,n,r,i,o,s,a,u,c,l){switch(arguments.length){case 1:return new t(e);case 2:return new t(e,n);case 3:return new t(e,n,r);case 4:return new t(e,n,r,i);case 5:return new t(e,n,r,i,o);case 6:return new t(e,n,r,i,o,s);case 7:return new t(e,n,r,i,o,s,a);case 8:return new t(e,n,r,i,o,s,a,u);case 9:return new t(e,n,r,i,o,s,a,u,c);case 10:return new t(e,n,r,i,o,s,a,u,c,l)}})))})),Cr=U((function(e,t){return ye(Math.max.apply(Math,cr("length",t)),(function(){var n=arguments,r=this;return e.apply(r,A((function(e){return e.apply(r,n)}),t))}))})),Rr=U(F("dropRepeatsWith",J,(function(e,t){var n=[],r=1,i=t.length;if(0!==i)for(n[0]=t[0];r<i;)e(er(n),t[r])||(n[n.length]=t[r]),r+=1;return n}))),Pr=D((function(e,t,n){return Bn(e(t),e(n))})),jr=D((function(e,t,n){return Bn(t[e],n[e])})),Lr=U((function(e,t){return"function"!=typeof t.indexOf||_(t)?Er(t,e,0):t.indexOf(e)})),qr=q((function(e){return function(){return nr(fe(c,arguments),e)}})),Ur=U((function(e,t){return function(n){return function(r){return nr((function(e){return t(e,r)}),n(e(r)))}}})),Dr=q((function(e){return Ur(bt(e),dn(e))})),Vr=q((function(e){return Ur(St(e),he(e))})),Fr=q((function(e){return Ur(Mt(e),pe(e))})),Br=U((function(e,t){var n=ye(e,t);return ye(e,(function(){return Cn(Ar,nr(n,arguments[0]),C(arguments,1))}))})),Hr=q((function(e){return br(e)/e.length})),Wr=q((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return Hr(C(e).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))})),Gr=ir((function(e,t){return t})),zr=q((function(e){return hr(Gr,{},e)})),Jr=function(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return l(arguments[0].length,hr(x,arguments[0],Kt(arguments)))},Yr=function(){if(0===arguments.length)throw new Error("pipeP requires at least one argument");return l(arguments[0].length,hr(I,arguments[0],Kt(arguments)))},Qr=hr(ft,1),Kr=U((function(e,t){return"function"==typeof t.sequence?t.sequence(e):Lt((function(e,t){return Ar(nr(Nt,t),e)}),e([]),t)})),Xr=D((function(e,t,n){return Kr(e,nr(t,n))})),$r=Ir(g),Zr=function(e,t){return Er(t,e,0)>=0},ei=(s={"@@transducer/init":Array,"@@transducer/step":function(e,t){return d(e,[t])},"@@transducer/result":g},a={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":g},u={"@@transducer/init":Object,"@@transducer/step":function(e,t){return Gr(e,Ye(t)?gt(t[0],t[1]):t)},"@@transducer/result":g},function(e){if(k(e))return e;if(Ye(e))return s;if("string"==typeof e)return a;if("object"===o(e))return u;throw new Error("Cannot create transformer for "+e)}),ti=function e(t,n){var r=function(r){var i=n.concat([t]);return Zr(r,i)?"<Circular>":e(r,i)},i=function(e,t){return A((function(t){return N(t)+": "+r(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(t)){case"[object Arguments]":return"(function() { return arguments; }("+A(r,t).join(", ")+"))";case"[object Array]":return"["+A(r,t).concat(i(t,dr((function(e){return/^\d+$/.test(e)}),Ke(t)))).join(", ")+"]";case"[object Boolean]":return"object"===o(t)?"new Boolean("+r(t.valueOf())+")":t.toString();case"[object Date]":return"new Date("+(isNaN(t.valueOf())?r(NaN):N(R(t)))+")";case"[object Null]":return"null";case"[object Number]":return"object"===o(t)?"new Number("+r(t.valueOf())+")":1/t==-1/0?"-0":t.toString(10);case"[object String]":return"object"===o(t)?"new String("+r(t.valueOf())+")":N(t);case"[object Undefined]":return"undefined";default:if("function"==typeof t.toString){var s=t.toString();if("[object Object]"!==s)return s}return"{"+i(t,Ke(t)).join(", ")+"}"}},ni=Nr(Fe),ri=function(){if(0===arguments.length)throw new Error("compose requires at least one argument");return Jr.apply(this,Vt(arguments))},ii=function(){return ri.apply(this,Nt(Fe,nr(Ir,arguments)))},oi=q((function(e){return Mr(e.length,e)})),si=U(Zr),ai=U((function(e,t){for(var n=[],r=0,i=e.length;r<i;)Zr(e[r],t)||Zr(e[r],n)||(n[n.length]=e[r]),r+=1;return n})),ui=q(F("dropRepeats",J(Bn),Rr(Bn))),ci=D((function(e,t,n){return k(e)?Cn(t(e),e["@@transducer/init"](),n):Cn(t(ei(e)),e,n)})),li=q((function(e){return Br(e.length,e)})),fi=U((function(e,t){var n={};for(var r in t)Zr(r,e)||(n[r]=t[r]);return n})),pi=q((function(e){return ti(e,[])})),hi=U("undefined"==typeof Set?function(e,t){for(var n,r,i=0,o=[],s=[];i<t.length;)n=e(r=t[i]),Zr(n,o)||(s.push(r),o.push(n)),i+=1;return s}:function(e,t){for(var n,r,i,s=new Set,a=[],u=0,c=[],l=!1,f=!1,p=0;p<t.length;){switch(o(n=e(r=t[p]))){case"number":if(0===n&&!f&&1/n==-1/0){f=!0,c.push(r);break}case"string":case"boolean":case"function":case"undefined":s.add(n),(i=s.size)>u&&(c.push(r),u=i);break;case"object":if(null===n){l||(l=!0,c.push(null));break}default:Zr(n,a)||(a.push(n),c.push(r))}p+=1}return c}),di=U((function(e,t){return dr(Gn(Zr)(e),t)})),vi=li(vt),bi=U((function(e,t){return ye(e+1,(function(){var n=arguments[e];if(null!=n&&Je(Function,n[t]))return n[t].apply(n,C(arguments,0,e));throw new TypeError(pi(n)+' does not have a method named "'+t+'"')}))})),mi=bi(1,"join"),gi=q((function(e){var t={};return l(e.length,(function(){var n=pi(arguments);return m(n,t)||(t[n]=e.apply(this,arguments)),t[n]}))})),yi=bi(1,"split"),_i=U((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+pi(e));var n;return p(e).test(t)})),wi=bi(0,"toLowerCase"),Ei=bi(0,"toUpperCase"),Oi=hi(Fe),Si=Gn(bi(1,"concat")),Ti=U((function(e,t){return Oi(b(Gn(Zr)(e),t))})),ki=U((function(e,t){return Si(ai(e,t),ai(t,e))})),Ai=D((function(e,t,n){return Si(Ee(e,t,n),Ee(e,n,t))})),xi=U(ri(Oi,d)),Ii={F:kn,T:An,__:c,add:re,addIndex:jn,adjust:ie,all:oe,allPass:Sr,allUniq:Tr,always:se,and:ae,any:ue,anyPass:kr,ap:Ar,aperture:ce,append:le,apply:fe,assoc:pe,assocPath:he,binary:Ln,bind:de,both:ve,call:xr,chain:Ir,clone:qn,commute:ni,commuteMap:Nr,comparator:be,complement:vi,compose:ri,composeK:ii,composeP:function(){if(0===arguments.length)throw new Error("composeP requires at least one argument");return Yr.apply(this,Vt(arguments))},concat:Si,cond:me,construct:oi,constructN:Mr,contains:si,converge:Cr,countBy:ge,curry:Un,curryN:ye,dec:_e,defaultTo:we,difference:ai,differenceWith:Ee,dissoc:Oe,dissocPath:Se,divide:Te,drop:Dn,dropLast:Vn,dropLastWhile:Fn,dropRepeats:ui,dropRepeatsWith:Rr,dropWhile:ke,either:Ae,empty:xe,eqBy:Pr,eqProps:jr,equals:Bn,evolve:Ie,filter:Hn,find:Ne,findIndex:Me,findLast:Ce,findLastIndex:Re,flatten:Wn,flip:Gn,forEach:Pe,fromPairs:je,groupBy:zn,gt:Le,gte:qe,has:Ue,hasIn:De,head:Jn,identical:Ve,identity:Fe,ifElse:Be,inc:He,indexBy:Yn,indexOf:Lr,init:Qn,insert:We,insertAll:Ge,intersection:Ti,intersectionWith:Kn,intersperse:ze,into:ci,invert:Xn,invertObj:$n,invoker:bi,is:Je,isArrayLike:Ye,isEmpty:Zn,isNil:Qe,join:mi,juxt:qr,keys:Ke,keysIn:Xe,last:er,lastIndexOf:tr,length:$e,lens:Ur,lensIndex:Dr,lensPath:Vr,lensProp:Fr,lift:li,liftN:Br,lt:Ze,lte:et,map:nr,mapAccum:tt,mapAccumRight:nt,mapObjIndexed:rr,match:rt,mathMod:it,max:ot,maxBy:st,mean:Hr,median:Wr,memoize:gi,merge:Gr,mergeAll:zr,mergeWith:ir,mergeWithKey:at,min:ut,minBy:ct,modulo:lt,multiply:ft,nAry:pt,negate:ht,none:dt,not:vt,nth:bt,nthArg:mt,objOf:gt,of:yt,omit:fi,once:_t,or:wt,over:Et,pair:Ot,partial:or,partialRight:sr,partition:ar,path:St,pathEq:ur,pathOr:Tt,pathSatisfies:kt,pick:At,pickAll:xt,pickBy:It,pipe:Jr,pipeK:function(){return ii.apply(this,Vt(arguments))},pipeP:Yr,pluck:cr,prepend:Nt,product:Qr,project:lr,prop:Mt,propEq:fr,propIs:pr,propOr:Ct,propSatisfies:Rt,props:Pt,range:jt,reduce:hr,reduceRight:Lt,reduced:qt,reject:dr,remove:Ut,repeat:vr,replace:Dt,reverse:Vt,scan:Ft,sequence:Kr,set:Bt,slice:Ht,sort:Wt,sortBy:Gt,split:yi,splitAt:zt,splitEvery:Jt,splitWhen:Yt,subtract:Qt,sum:br,symmetricDifference:ki,symmetricDifferenceWith:Ai,tail:Kt,take:Xt,takeLast:mr,takeLastWhile:$t,takeWhile:Zt,tap:en,test:_i,times:tn,toLower:wi,toPairs:nn,toPairsIn:rn,toString:pi,toUpper:Ei,transduce:gr,transpose:on,traverse:Xr,trim:sn,type:an,unapply:un,unary:cn,uncurryN:ln,unfold:fn,union:xi,unionWith:yr,uniq:Oi,uniqBy:hi,uniqWith:pn,unless:hn,unnest:$r,update:dn,useWith:vn,values:bn,valuesIn:mn,view:gn,when:yn,where:_n,whereEq:_r,without:di,wrap:wn,xprod:En,zip:On,zipObj:Sn,zipWith:Tn};e.exports=Ii}).call(S)})),N={enabled:!0},M=function(e,t,n,r,i){t||(t=6e4),void 0===n&&(n=2),void 0===r&&(r=.5),i||(i=Math.random);var o=null,s=function(s){if(!N.enabled)return 6048e5;var a=e*Math.pow(n,s);o&&(a=Math.max(a,o),o=null);var u=i(),c=Math.floor(u*r*a),l=Math.floor(10*u)%2==0?a-c:a+c;return a=Math.min(l,t),N.maxDelay&&a>N.maxDelay?N.maxDelay:N.minDelay&&a<=N.minDelay?N.minDelay:a};return s.setNextDelayMinimum=function(e){o=e},s.maximizeNextDelay=function(){return s.setNextDelayMinimum(t)},s},C=function e(t){var n=t.calculateAttemptDelay,r=t.attempt,i=t.onGiveUp,o=t.retryLimit,s=t.retryCount,a=function(t){return r({context:{retryLimit:o,retryCount:s,delay:t},repeat:function(t){return 0===o||s<o?e({calculateAttemptDelay:n,attempt:r,onGiveUp:i,retryLimit:o,retryCount:s+1}):i(t)}})};if(0===s)a(0);else{var u=n(s);setTimeout((function(){return a(u)}),u)}},R=function(e){var t=e.calculateAttemptDelay,n=e.attempt,r=e.onGiveUp,i=e.retryLimit;if(0!==i&&!r)throw new Error("Must define onGiveUp if retryLimit is not 0");return C({calculateAttemptDelay:t,attempt:n,onGiveUp:r,retryLimit:i,retryCount:0})},P=function(){return sm.conf.integrities_enabled},j=function(e){if(P()||e.force){var t=e.name?I.propEq("name",e.name):I.propEq("versioned_name",e.versionedName),n=I.find(t,sm.conf.integrities);if(n)return I.prop("integrity",n);sm.logger.error("Could not find expected integrity for module",e)}},L=function(e){var t=e.beforeLoad,n=e.onAttempt,r=e.onLoad,i=e.onError,o=e.onGiveUp,s=e.integrity,a=e.fileUrl,u=e.retryLimit,c=void 0===u?5:u,l=e.backoffDelay;R({calculateAttemptDelay:M(void 0===l?1e3:l),attempt:function(e){var o=e.repeat;"function"==typeof n&&n();var u=document.createElement("script");return u.type="text/javascript",u.onload=function(){"function"==typeof r&&r()},u.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(u),o()},u.src=a,s&&(u.setAttribute("integrity",s),u.setAttribute("crossorigin","*")),"function"==typeof t&&t(u),document.head.appendChild(u),u},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:c})},q=function(e){var t=e.integrity,n=e.fileUrl,r=e.onAttempt,i=e.onError,o=e.onGiveUp;return R({calculateAttemptDelay:M(1e3),attempt:function(e){var o=e.repeat;"function"==typeof r&&r();var s=document.createElement("link");return s.type="text/css",s.rel="stylesheet",s.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(s),o()},s.href=n,t&&(s.setAttribute("integrity",t),s.setAttribute("crossorigin","*")),document.head.appendChild(s),s},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:5})};function U(e){return(U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function D(){var e=this;this.list=[],this.add=function(t){10===e.list.length&&(e.list=e.list.slice(1)),e.list.push(t)}}var V=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var i in t)n[i]=t[i];return n},F=function(e){var t={};for(var n in e){var r=e[n];t[n]="function"==typeof r?r():r}return t},B=function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n)},H=["string","number","boolean","null","undefined"];var W=function(e){return Object.keys(e).map((function(t){return e[t]}))};var G={CustomTransport:function(e){if(!e)throw new Error("processFn must be specificed when using CustomTransport");this.process=e},HttpTransport:function(e){var t=e.url,n=e.method,r=e.headers,i=e.encode;if(!t)throw new Error("url must be specificed when using HttpTransport");n||(n="POST"),r||(r={}),i||(i=function(e){return JSON.stringify(e)}),this.process=window.fetch?function(e){var o=e.payload;return window.fetch(t,{method:n,headers:r,keepalive:!0,body:i(o)})}:function(e){var o=e.payload;return new Promise((function(e,s){var a=new XMLHttpRequest;a.open(n,t),Object.keys(r).forEach((function(e){a.setRequestHeader(e,r[e])})),a.onload=function(){a.status<200||status>=300?s():e()},a.onerror=function(){return s()},a.send(i(o))}))}}},z=function(e){return function(t){var n=t.namespace;return{attempted:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.tags,i=void 0===r?[]:r,o=Date.now(),s=!1,a=function(t){var r=t.action,o=t.reason,s=["action:".concat(r)];return o&&s.push("reason:".concat(o)),e.increment("sm.lib.".concat(n),I.concat(i,s))},u=function(e){return a({action:"failed",reason:e})},c=function(t){var r=t.action;s=!0;var a=Date.now()-o;e.histogram("sm.timing.lib.".concat(n),a,I.concat(i,["client:browser","action:".concat(r)]))};return a({action:"attempted"}),{succeeded:function(){a({action:"succeeded"}),c({action:"succeeded"})},failed:function(e){u(e),c({action:"failed"})},timedOut:function(){u("timed_out"),c({action:"failed"})},failedUnknown:function(){u("unknown"),c({action:"failed"})},isFinished:function(){return s}}}}}},J=["timing","increment","decrement","gauge","histogram","set"],Y=function(){function e(){var t=this;s(this,e),this.withTags=this.withTags.bind(this),this.instrument=function(){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}},J.forEach((function(e){t[e]=function(){}}))}return u(e,[{key:"recordMessageHubConnectionEstablished",value:function(){}},{key:"recordBaseDomCaching",value:function(){}},{key:"clientHandlerError",value:function(){}},{key:"statApiUsage",value:function(e){e.resource;return function(e){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}}},{key:"statScreenShareUsage",value:function(e,t){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}},{key:"withTags",value:function(){return this}}]),e}(),Q=function(){function e(t,n){var r=this;s(this,e),this.statApiUsage=this.statApiUsage.bind(this),this.statScreenShareUsage=this.statScreenShareUsage.bind(this),this.withTags=this.withTags.bind(this),this.statsClient=t,this.latencyMeasurer=n,this.instrument=z(this.statsClient),J.forEach((function(e){r.statsClient[e]&&(r[e]=r.statsClient[e].bind(r.statsClient))}))}return u(e,[{key:"recordBaseDomCaching",value:function(e){var t=e.result;this.statsClient.increment("sm.app.visitor.api.cached_base_dom",["action:save","result:".concat(t)])}},{key:"clientHandlerError",value:function(e){this.statsClient.increment("sm.app.visitor.api.client_handler",["action:failed","executor:".concat(e)])}},{key:"statApiUsage",value:function(e){var t=this,n=e.protocol,r=e.resource;return function(e){return z(t.statsClient.withTags(["protocol:".concat(n),"method:".concat(e)]))({namespace:r})}}},{key:"statScreenShareUsage",value:function(e){var t=e.stage,n=e.resource;return z(this.statsClient.withTags(["stage:".concat(t)]))({namespace:n})}},{key:"withTags",value:function(t){return new e(this.statsClient.withTags(t))}}],[{key:"createDummy",value:function(){return new Y}}]),e}(),K=function(e,t){return(K=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function X(e,t){function n(){this.constructor=e}K(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var $=function(){return($=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function Z(e){return"function"==typeof e}var ee=!1,te={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;ee=e},get useDeprecatedSynchronousErrorHandling(){return ee}};function ne(e){setTimeout((function(){throw e}),0)}var re={closed:!0,next:function(e){},error:function(e){if(te.useDeprecatedSynchronousErrorHandling)throw e;ne(e)},complete:function(){}},ie=function(){return Array.isArray||function(e){return e&&"number"==typeof e.length}}();function oe(e){return null!==e&&"object"===o(e)}var se=function(){function e(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}return e.prototype=Object.create(Error.prototype),e}(),ae=function(){function e(e){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,e&&(this._ctorUnsubscribe=!0,this._unsubscribe=e)}return e.prototype.unsubscribe=function(){var t;if(!this.closed){var n=this,r=n._parentOrParents,i=n._ctorUnsubscribe,o=n._unsubscribe,s=n._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof e)r.remove(this);else if(null!==r)for(var a=0;a<r.length;++a){r[a].remove(this)}if(Z(o)){i&&(this._unsubscribe=void 0);try{o.call(this)}catch(e){t=e instanceof se?ue(e.errors):[e]}}if(ie(s)){a=-1;for(var u=s.length;++a<u;){var c=s[a];if(oe(c))try{c.unsubscribe()}catch(e){t=t||[],e instanceof se?t=t.concat(ue(e.errors)):t.push(e)}}}if(t)throw new se(t)}},e.prototype.add=function(t){var n=t;if(!t)return e.EMPTY;switch(o(t)){case"function":n=new e(t);case"object":if(n===this||n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if(!(n instanceof e)){var r=n;(n=new e)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}var i=n._parentOrParents;if(null===i)n._parentOrParents=this;else if(i instanceof e){if(i===this)return n;n._parentOrParents=[i,this]}else{if(-1!==i.indexOf(this))return n;i.push(this)}var s=this._subscriptions;return null===s?this._subscriptions=[n]:s.push(n),n},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},e.EMPTY=function(e){return e.closed=!0,e}(new e),e}();function ue(e){return e.reduce((function(e,t){return e.concat(t instanceof se?t.errors:t)}),[])}var ce=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),le=function(e){function t(n,r,i){var s=e.call(this)||this;switch(s.syncErrorValue=null,s.syncErrorThrown=!1,s.syncErrorThrowable=!1,s.isStopped=!1,arguments.length){case 0:s.destination=re;break;case 1:if(!n){s.destination=re;break}if("object"===o(n)){n instanceof t?(s.syncErrorThrowable=n.syncErrorThrowable,s.destination=n,n.add(s)):(s.syncErrorThrowable=!0,s.destination=new fe(s,n));break}default:s.syncErrorThrowable=!0,s.destination=new fe(s,n,r,i)}return s}return X(t,e),t.prototype[ce]=function(){return this},t.create=function(e,n,r){var i=new t(e,n,r);return i.syncErrorThrowable=!1,i},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=e,this},t}(ae),fe=function(e){function t(t,n,r,i){var o,s=e.call(this)||this;s._parentSubscriber=t;var a=s;return Z(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==re&&(Z((a=Object.create(n)).unsubscribe)&&s.add(a.unsubscribe.bind(a)),a.unsubscribe=s.unsubscribe.bind(s))),s._context=a,s._next=o,s._error=r,s._complete=i,s}return X(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;te.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,n=te.useDeprecatedSynchronousErrorHandling;if(this._error)n&&t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else if(t.syncErrorThrowable)n?(t.syncErrorValue=e,t.syncErrorThrown=!0):ne(e),this.unsubscribe();else{if(this.unsubscribe(),n)throw e;ne(e)}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};te.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?(this.__tryOrSetError(t,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),te.useDeprecatedSynchronousErrorHandling)throw e;ne(e)}},t.prototype.__tryOrSetError=function(e,t,n){if(!te.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{t.call(this._context,n)}catch(t){return te.useDeprecatedSynchronousErrorHandling?(e.syncErrorValue=t,e.syncErrorThrown=!0,!0):(ne(t),!0)}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(le);function pe(e){for(;e;){var t=e,n=t.closed,r=t.destination,i=t.isStopped;if(n||i)return!1;e=r&&r instanceof le?r:null}return!0}function he(e,t,n){if(e){if(e instanceof le)return e;if(e[ce])return e[ce]()}return e||t||n?new le(e,t,n):new le(re)}var de=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function ve(e){return e}function be(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return me(e)}function me(e){return 0===e.length?ve:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var ge=function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,i=he(e,t,n);if(r?i.add(r.call(i,this.source)):i.add(this.source||te.useDeprecatedSynchronousErrorHandling&&!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),te.useDeprecatedSynchronousErrorHandling&&i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){te.useDeprecatedSynchronousErrorHandling&&(e.syncErrorThrown=!0,e.syncErrorValue=t),pe(e)?e.error(t):console.warn(t)}},e.prototype.forEach=function(e,t){var n=this;return new(t=ye(t))((function(t,r){var i;i=n.subscribe((function(t){try{e(t)}catch(e){r(e),i&&i.unsubscribe()}}),r,t)}))},e.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},e.prototype[de]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 0===e.length?this:me(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=ye(e))((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function ye(e){if(e||(e=te.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var _e=function(){function e(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return e.prototype=Object.create(Error.prototype),e}(),we=function(e){function t(t,n){var r=e.call(this)||this;return r.subject=t,r.subscriber=n,r.closed=!1,r}return X(t,e),t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var n=t.indexOf(this.subscriber);-1!==n&&t.splice(n,1)}}},t}(ae),Ee=function(e){function t(t){var n=e.call(this,t)||this;return n.destination=t,n}return X(t,e),t}(le),Oe=function(e){function t(){var t=e.call(this)||this;return t.observers=[],t.closed=!1,t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return X(t,e),t.prototype[ce]=function(){return new Ee(this)},t.prototype.lift=function(e){var t=new Se(this,this);return t.operator=e,t},t.prototype.next=function(e){if(this.closed)throw new _e;if(!this.isStopped)for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].next(e)},t.prototype.error=function(e){if(this.closed)throw new _e;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new _e;this.isStopped=!0;for(var e=this.observers,t=e.length,n=e.slice(),r=0;r<t;r++)n[r].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(t){if(this.closed)throw new _e;return e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){if(this.closed)throw new _e;return this.hasError?(e.error(this.thrownError),ae.EMPTY):this.isStopped?(e.complete(),ae.EMPTY):(this.observers.push(e),new we(this,e))},t.prototype.asObservable=function(){var e=new ge;return e.source=this,e},t.create=function(e,t){return new Se(e,t)},t}(ge),Se=function(e){function t(t,n){var r=e.call(this)||this;return r.destination=t,r.source=n,r}return X(t,e),t.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},t.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):ae.EMPTY},t}(Oe);function Te(){return function(e){return e.lift(new ke(e))}}var ke=function(){function e(e){this.connectable=e}return e.prototype.call=function(e,t){var n=this.connectable;n._refCount++;var r=new Ae(e,n),i=t.subscribe(r);return r.closed||(r.connection=n.connect()),i},e}(),Ae=function(e){function t(t,n){var r=e.call(this,t)||this;return r.connectable=n,r}return X(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var n=this.connection,r=e._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null},t}(le),xe=function(e){function t(t,n){var r=e.call(this)||this;return r.source=t,r.subjectFactory=n,r._refCount=0,r._isComplete=!1,r}return X(t,e),t.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},t.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},t.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new ae).add(this.source.subscribe(new Ne(this.getSubject(),this))),e.closed&&(this._connection=null,e=ae.EMPTY)),e},t.prototype.refCount=function(){return Te()(this)},t}(ge),Ie=function(){var e=xe.prototype;return{operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:e._subscribe},_isComplete:{value:e._isComplete,writable:!0},getSubject:{value:e.getSubject},connect:{value:e.connect},refCount:{value:e.refCount}}}(),Ne=function(e){function t(t,n){var r=e.call(this,t)||this;return r.connectable=n,r}return X(t,e),t.prototype._error=function(t){this._unsubscribe(),e.prototype._error.call(this,t)},t.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._connection;e._refCount=0,e._subject=null,e._connection=null,t&&t.unsubscribe()}},t}(Ee);function Me(e,t,n,r){return function(i){return i.lift(new Ce(e,t,n,r))}}var Ce=function(){function e(e,t,n,r){this.keySelector=e,this.elementSelector=t,this.durationSelector=n,this.subjectSelector=r}return e.prototype.call=function(e,t){return t.subscribe(new Re(e,this.keySelector,this.elementSelector,this.durationSelector,this.subjectSelector))},e}(),Re=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.keySelector=n,s.elementSelector=r,s.durationSelector=i,s.subjectSelector=o,s.groups=null,s.attemptedToUnsubscribe=!1,s.count=0,s}return X(t,e),t.prototype._next=function(e){var t;try{t=this.keySelector(e)}catch(e){return void this.error(e)}this._group(e,t)},t.prototype._group=function(e,t){var n=this.groups;n||(n=this.groups=new Map);var r,i=n.get(t);if(this.elementSelector)try{r=this.elementSelector(e)}catch(e){this.error(e)}else r=e;if(!i){i=this.subjectSelector?this.subjectSelector():new Oe,n.set(t,i);var o=new je(t,i,this);if(this.destination.next(o),this.durationSelector){var s=void 0;try{s=this.durationSelector(new je(t,i))}catch(e){return void this.error(e)}this.add(s.subscribe(new Pe(t,i,this)))}}i.closed||i.next(r)},t.prototype._error=function(e){var t=this.groups;t&&(t.forEach((function(t,n){t.error(e)})),t.clear()),this.destination.error(e)},t.prototype._complete=function(){var e=this.groups;e&&(e.forEach((function(e,t){e.complete()})),e.clear()),this.destination.complete()},t.prototype.removeGroup=function(e){this.groups.delete(e)},t.prototype.unsubscribe=function(){this.closed||(this.attemptedToUnsubscribe=!0,0===this.count&&e.prototype.unsubscribe.call(this))},t}(le),Pe=function(e){function t(t,n,r){var i=e.call(this,n)||this;return i.key=t,i.group=n,i.parent=r,i}return X(t,e),t.prototype._next=function(e){this.complete()},t.prototype._unsubscribe=function(){var e=this.parent,t=this.key;this.key=this.parent=null,e&&e.removeGroup(t)},t}(le),je=function(e){function t(t,n,r){var i=e.call(this)||this;return i.key=t,i.groupSubject=n,i.refCountSubscription=r,i}return X(t,e),t.prototype._subscribe=function(e){var t=new ae,n=this.refCountSubscription,r=this.groupSubject;return n&&!n.closed&&t.add(new Le(n)),t.add(r.subscribe(e)),t},t}(ge),Le=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,t.count++,n}return X(t,e),t.prototype.unsubscribe=function(){var t=this.parent;t.closed||this.closed||(e.prototype.unsubscribe.call(this),t.count-=1,0===t.count&&t.attemptedToUnsubscribe&&t.unsubscribe())},t}(ae),qe=function(e){function t(t){var n=e.call(this)||this;return n._value=t,n}return X(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return n&&!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new _e;return this._value},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(Oe),Ue=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r.pending=!1,r}return X(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(function(e){function t(t,n){return e.call(this)||this}return X(t,e),t.prototype.schedule=function(e,t){return this},t}(ae)),De=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return X(t,e),t.prototype.schedule=function(t,n){return void 0===n&&(n=0),n>0?e.prototype.schedule.call(this,t,n):(this.delay=n,this.state=t,this.scheduler.flush(this),this)},t.prototype.execute=function(t,n){return n>0||this.closed?e.prototype.execute.call(this,t,n):this._execute(t,n)},t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0?e.prototype.requestAsyncId.call(this,t,n,r):t.flush(this)},t}(Ue),Ve=function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=function(){return Date.now()},e}(),Fe=function(e){function t(n,r){void 0===r&&(r=Ve.now);var i=e.call(this,n,(function(){return t.delegate&&t.delegate!==i?t.delegate.now():r()}))||this;return i.actions=[],i.active=!1,i.scheduled=void 0,i}return X(t,e),t.prototype.schedule=function(n,r,i){return void 0===r&&(r=0),t.delegate&&t.delegate!==this?t.delegate.schedule(n,r,i):e.prototype.schedule.call(this,n,r,i)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(Ve),Be=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t}(Fe))(De),He=Be,We=new ge((function(e){return e.complete()}));function Ge(e){return e?function(e){return new ge((function(t){return e.schedule((function(){return t.complete()}))}))}(e):We}function ze(e){return e&&"function"==typeof e.schedule}var Je,Ye=function(e){return function(t){for(var n=0,r=e.length;n<r&&!t.closed;n++)t.next(e[n]);t.complete()}};function Qe(e,t){return new ge((function(n){var r=new ae,i=0;return r.add(t.schedule((function(){i!==e.length?(n.next(e[i++]),n.closed||r.add(this.schedule())):n.complete()}))),r}))}function Ke(e,t){return t?Qe(e,t):new ge(Ye(e))}function Xe(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return ze(n)?(e.pop(),Qe(e,n)):Ke(e)}function $e(e,t){return new ge(t?function(n){return t.schedule(Ze,0,{error:e,subscriber:n})}:function(t){return t.error(e)})}function Ze(e){var t=e.error;e.subscriber.error(t)}Je||(Je={});var et=function(){function e(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return e.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},e.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},e.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},e.prototype.toObservable=function(){switch(this.kind){case"N":return Xe(this.value);case"E":return $e(this.error);case"C":return Ge()}throw new Error("unexpected notification kind value")},e.createNext=function(t){return void 0!==t?new e("N",t):e.undefinedValueNotification},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C"),e.undefinedValueNotification=new e("N",void 0),e}();var tt=function(){function e(e,t){void 0===t&&(t=0),this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return t.subscribe(new nt(e,this.scheduler,this.delay))},e}(),nt=function(e){function t(t,n,r){void 0===r&&(r=0);var i=e.call(this,t)||this;return i.scheduler=n,i.delay=r,i}return X(t,e),t.dispatch=function(e){var t=e.notification,n=e.destination;t.observe(n),this.unsubscribe()},t.prototype.scheduleMessage=function(e){this.destination.add(this.scheduler.schedule(t.dispatch,this.delay,new rt(e,this.destination)))},t.prototype._next=function(e){this.scheduleMessage(et.createNext(e))},t.prototype._error=function(e){this.scheduleMessage(et.createError(e)),this.unsubscribe()},t.prototype._complete=function(){this.scheduleMessage(et.createComplete()),this.unsubscribe()},t}(le),rt=function(){return function(e,t){this.notification=e,this.destination=t}}(),it=function(e){function t(t,n,r){void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=Number.POSITIVE_INFINITY);var i=e.call(this)||this;return i.scheduler=r,i._events=[],i._infiniteTimeWindow=!1,i._bufferSize=t<1?1:t,i._windowTime=n<1?1:n,n===Number.POSITIVE_INFINITY?(i._infiniteTimeWindow=!0,i.next=i.nextInfiniteTimeWindow):i.next=i.nextTimeWindow,i}return X(t,e),t.prototype.nextInfiniteTimeWindow=function(t){if(!this.isStopped){var n=this._events;n.push(t),n.length>this._bufferSize&&n.shift()}e.prototype.next.call(this,t)},t.prototype.nextTimeWindow=function(t){this.isStopped||(this._events.push(new ot(this._getNow(),t)),this._trimBufferThenGetEvents()),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){var t,n=this._infiniteTimeWindow,r=n?this._events:this._trimBufferThenGetEvents(),i=this.scheduler,o=r.length;if(this.closed)throw new _e;if(this.isStopped||this.hasError?t=ae.EMPTY:(this.observers.push(e),t=new we(this,e)),i&&e.add(e=new nt(e,i)),n)for(var s=0;s<o&&!e.closed;s++)e.next(r[s]);else for(s=0;s<o&&!e.closed;s++)e.next(r[s].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},t.prototype._getNow=function(){return(this.scheduler||He).now()},t.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,n=this._windowTime,r=this._events,i=r.length,o=0;o<i&&!(e-r[o].time<n);)o++;return i>t&&(o=Math.max(o,i-t)),o>0&&r.splice(0,o),r},t}(Oe),ot=function(){return function(e,t){this.time=e,this.value=t}}(),st=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.value=null,t.hasNext=!1,t.hasCompleted=!1,t}return X(t,e),t.prototype._subscribe=function(t){return this.hasError?(t.error(this.thrownError),ae.EMPTY):this.hasCompleted&&this.hasNext?(t.next(this.value),t.complete(),ae.EMPTY):e.prototype._subscribe.call(this,t)},t.prototype.next=function(e){this.hasCompleted||(this.value=e,this.hasNext=!0)},t.prototype.error=function(t){this.hasCompleted||e.prototype.error.call(this,t)},t.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&e.prototype.next.call(this,this.value),e.prototype.complete.call(this)},t}(Oe),at=1,ut=function(){return Promise.resolve()}(),ct={};function lt(e){return e in ct&&(delete ct[e],!0)}var ft={setImmediate:function(e){var t=at++;return ct[t]=!0,ut.then((function(){return lt(t)&&e()})),t},clearImmediate:function(e){lt(e)}},pt=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return X(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=ft.setImmediate(t.flush.bind(t,null))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(ft.clearImmediate(n),t.scheduled=void 0)},t}(Ue),ht=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(Fe))(pt),dt=ht,vt=new Fe(Ue),bt=vt,mt=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.scheduler=t,r.work=n,r}return X(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=requestAnimationFrame((function(){return t.flush(null)}))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(cancelAnimationFrame(n),t.scheduled=void 0)},t}(Ue),gt=new(function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(Fe))(mt),yt=gt,_t=function(e){function t(t,n){void 0===t&&(t=wt),void 0===n&&(n=Number.POSITIVE_INFINITY);var r=e.call(this,t,(function(){return r.frame}))||this;return r.maxFrames=n,r.frame=0,r.index=-1,r}return X(t,e),t.prototype.flush=function(){for(var e,t,n=this.actions,r=this.maxFrames;(t=n[0])&&t.delay<=r&&(n.shift(),this.frame=t.delay,!(e=t.execute(t.state,t.delay))););if(e){for(;t=n.shift();)t.unsubscribe();throw e}},t.frameTimeFactor=10,t}(Fe),wt=function(e){function t(t,n,r){void 0===r&&(r=t.index+=1);var i=e.call(this,t,n)||this;return i.scheduler=t,i.work=n,i.index=r,i.active=!0,i.index=t.index=r,i}return X(t,e),t.prototype.schedule=function(n,r){if(void 0===r&&(r=0),!this.id)return e.prototype.schedule.call(this,n,r);this.active=!1;var i=new t(this.scheduler,this.work);return this.add(i),i.schedule(n,r)},t.prototype.requestAsyncId=function(e,n,r){void 0===r&&(r=0),this.delay=e.frame+r;var i=e.actions;return i.push(this),i.sort(t.sortActions),!0},t.prototype.recycleAsyncId=function(e,t,n){},t.prototype._execute=function(t,n){if(!0===this.active)return e.prototype._execute.call(this,t,n)},t.sortActions=function(e,t){return e.delay===t.delay?e.index===t.index?0:e.index>t.index?1:-1:e.delay>t.delay?1:-1},t}(Ue);function Et(){}var Ot=function(){function e(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return e.prototype=Object.create(Error.prototype),e}(),St=function(){function e(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}return e.prototype=Object.create(Error.prototype),e}(),Tt=function(){function e(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return e.prototype=Object.create(Error.prototype),e}();function kt(e,t){return function(n){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new At(e,t))}}var At=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new xt(e,this.project,this.thisArg))},e}(),xt=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.project=n,i.count=0,i.thisArg=r||i,i}return X(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(le);function It(e){var t=this,n=e.args,r=e.subscriber,i=e.params,o=i.callbackFunc,s=i.context,a=i.scheduler,u=i.subject;if(!u){u=i.subject=new st;try{o.apply(s,n.concat([function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e.length<=1?e[0]:e;t.add(a.schedule(Nt,0,{value:r,subject:u}))}]))}catch(e){u.error(e)}}this.add(u.subscribe(r))}function Nt(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function Mt(e){var t=this,n=e.params,r=e.subscriber,i=e.context,o=n.callbackFunc,s=n.args,a=n.scheduler,u=n.subject;if(!u){u=n.subject=new st;try{o.apply(i,s.concat([function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e.shift();if(r)t.add(a.schedule(Rt,0,{err:r,subject:u}));else{var i=e.length<=1?e[0]:e;t.add(a.schedule(Ct,0,{value:i,subject:u}))}}]))}catch(e){this.add(a.schedule(Rt,0,{err:e,subject:u}))}}this.add(u.subscribe(r))}function Ct(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function Rt(e){var t=e.err;e.subject.error(t)}var Pt=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(t)},t.prototype.notifyError=function(e,t){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.destination.complete()},t}(le),jt=function(e){function t(t,n,r){var i=e.call(this)||this;return i.parent=t,i.outerValue=n,i.outerIndex=r,i.index=0,i}return X(t,e),t.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this.index++,this)},t.prototype._error=function(e){this.parent.notifyError(e,this),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},t}(le),Lt=function(e){return function(t){return e.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,ne),t}};function qt(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var Ut=qt(),Dt=function(e){return function(t){for(var n=e[Ut]();;){var r=void 0;try{r=n.next()}catch(e){return t.error(e),t}if(r.done){t.complete();break}if(t.next(r.value),t.closed)break}return"function"==typeof n.return&&t.add((function(){n.return&&n.return()})),t}},Vt=function(e){return function(t){var n=e[de]();if("function"!=typeof n.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return n.subscribe(t)}},Ft=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function Bt(e){return!!e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}var Ht=function(e){if(e&&"function"==typeof e[de])return Vt(e);if(Ft(e))return Ye(e);if(Bt(e))return Lt(e);if(e&&"function"==typeof e[Ut])return Dt(e);var t=oe(e)?"an invalid object":"'"+e+"'";throw new TypeError("You provided "+t+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function Wt(e,t,n,r,i){if(void 0===i&&(i=new jt(e,n,r)),!i.closed)return t instanceof ge?t.subscribe(i):Ht(t)(i)}var Gt={};var zt=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Jt(e,this.resultSelector))},e}(),Jt=function(e){function t(t,n){var r=e.call(this,t)||this;return r.resultSelector=n,r.active=0,r.values=[],r.observables=[],r}return X(t,e),t.prototype._next=function(e){this.values.push(Gt),this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{this.active=t,this.toRespond=t;for(var n=0;n<t;n++){var r=e[n];this.add(Wt(this,r,void 0,n))}}},t.prototype.notifyComplete=function(e){0==(this.active-=1)&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n){var r=this.values,i=r[n],o=this.toRespond?i===Gt?--this.toRespond:this.toRespond:0;r[n]=t,0===o&&(this.resultSelector?this._tryResultSelector(r):this.destination.next(r.slice()))},t.prototype._tryResultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(Pt);function Yt(e,t){return new ge((function(n){var r=new ae;return r.add(t.schedule((function(){return e.then((function(e){r.add(t.schedule((function(){n.next(e),r.add(t.schedule((function(){return n.complete()})))})))}),(function(e){r.add(t.schedule((function(){return n.error(e)})))}))}))),r}))}function Qt(e,t){if(!e)throw new Error("Iterable cannot be null");return new ge((function(n){var r,i=new ae;return i.add((function(){r&&"function"==typeof r.return&&r.return()})),i.add(t.schedule((function(){r=e[Ut](),i.add(t.schedule((function(){if(!n.closed){var e,t;try{var i=r.next();e=i.value,t=i.done}catch(e){return void n.error(e)}t?n.complete():(n.next(e),this.schedule())}})))}))),i}))}function Kt(e){return e&&"function"==typeof e[de]}function Xt(e){return e&&"function"==typeof e[Ut]}function $t(e,t){if(null!=e){if(Kt(e))return function(e,t){return new ge((function(n){var r=new ae;return r.add(t.schedule((function(){var i=e[de]();r.add(i.subscribe({next:function(e){r.add(t.schedule((function(){return n.next(e)})))},error:function(e){r.add(t.schedule((function(){return n.error(e)})))},complete:function(){r.add(t.schedule((function(){return n.complete()})))}}))}))),r}))}(e,t);if(Bt(e))return Yt(e,t);if(Ft(e))return Qe(e,t);if(Xt(e)||"string"==typeof e)return Qt(e,t)}throw new TypeError((null!==e&&o(e)||e)+" is not observable")}function Zt(e,t){return t?$t(e,t):e instanceof ge?e:new ge(Ht(e))}var en=function(e){function t(t){var n=e.call(this)||this;return n.parent=t,n}return X(t,e),t.prototype._next=function(e){this.parent.notifyNext(e)},t.prototype._error=function(e){this.parent.notifyError(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},t}(le),tn=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.destination.complete()},t}(le);function nn(e,t){if(!t.closed){if(e instanceof ge)return e.subscribe(t);var n;try{n=Ht(e)(t)}catch(e){t.error(e)}return n}}function rn(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof t?function(r){return r.pipe(rn((function(n,r){return Zt(e(n,r)).pipe(kt((function(e,i){return t(n,e,r,i)})))}),n))}:("number"==typeof t&&(n=t),function(t){return t.lift(new on(e,n))})}var on=function(){function e(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.project=e,this.concurrent=t}return e.prototype.call=function(e,t){return t.subscribe(new sn(e,this.project,this.concurrent))},e}(),sn=function(e){function t(t,n,r){void 0===r&&(r=Number.POSITIVE_INFINITY);var i=e.call(this,t)||this;return i.project=n,i.concurrent=r,i.hasCompleted=!1,i.buffer=[],i.active=0,i.index=0,i}return X(t,e),t.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new en(this),n=this.destination;n.add(t);var r=nn(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t}(tn),an=rn;function un(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),rn(ve,e)}function cn(){return un(1)}function ln(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return cn()(Xe.apply(void 0,e))}function fn(e){return new ge((function(t){var n;try{n=e()}catch(e){return void t.error(e)}return(n?Zt(n):Ge()).subscribe(t)}))}function pn(e,t){return new ge((function(n){var r=e.length;if(0!==r)for(var i=new Array(r),o=0,s=0,a=function(a){var u=Zt(e[a]),c=!1;n.add(u.subscribe({next:function(e){c||(c=!0,s++),i[a]=e},error:function(e){return n.error(e)},complete:function(){++o!==r&&c||(s===r&&n.next(t?t.reduce((function(e,t,n){return e[t]=i[n],e}),{}):i),n.complete())}}))},u=0;u<r;u++)a(u);else n.complete()}))}function hn(e,t,n,r,i){var o;if(function(e){return e&&"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}(e)){var s=e;e.addEventListener(t,n,i),o=function(){return s.removeEventListener(t,n,i)}}else if(function(e){return e&&"function"==typeof e.on&&"function"==typeof e.off}(e)){var a=e;e.on(t,n),o=function(){return a.off(t,n)}}else if(function(e){return e&&"function"==typeof e.addListener&&"function"==typeof e.removeListener}(e)){var u=e;e.addListener(t,n),o=function(){return u.removeListener(t,n)}}else{if(!e||!e.length)throw new TypeError("Invalid event target");for(var c=0,l=e.length;c<l;c++)hn(e[c],t,n,r,i)}r.add(o)}function dn(e){var t=e.subscriber,n=e.condition;if(!t.closed){if(e.needIterate)try{e.state=e.iterate(e.state)}catch(e){return void t.error(e)}else e.needIterate=!0;if(n){var r=void 0;try{r=n(e.state)}catch(e){return void t.error(e)}if(!r)return void t.complete();if(t.closed)return}var i;try{i=e.resultSelector(e.state)}catch(e){return void t.error(e)}if(!t.closed&&(t.next(i),!t.closed))return this.schedule(e)}}function vn(e){return!ie(e)&&e-parseFloat(e)+1>=0}function bn(e){var t=e.subscriber,n=e.counter,r=e.period;t.next(n),this.schedule({subscriber:t,counter:n+1,period:r},r)}function mn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=Number.POSITIVE_INFINITY,r=null,i=e[e.length-1];return ze(i)?(r=e.pop(),e.length>1&&"number"==typeof e[e.length-1]&&(n=e.pop())):"number"==typeof i&&(n=e.pop()),null===r&&1===e.length&&e[0]instanceof ge?e[0]:un(n)(Ke(e,r))}var gn=new ge(Et);function yn(e){var t=e.keys,n=e.index,r=e.subscriber,i=e.subscription,o=e.obj;if(!r.closed)if(n<t.length){var s=t[n];r.next([s,o[s]]),i.add(this.schedule({keys:t,index:n+1,subscriber:r,subscription:i,obj:o}))}else r.complete()}function _n(e,t){function n(){return!n.pred.apply(n.thisArg,arguments)}return n.pred=e,n.thisArg=t,n}function wn(e,t){return function(n){return n.lift(new En(e,t))}}var En=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new On(e,this.predicate,this.thisArg))},e}(),On=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.thisArg=r,i.count=0,i}return X(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t}(le);function Sn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){if(!ie(e[0]))return e[0];e=e[0]}return Ke(e,void 0).lift(new Tn)}var Tn=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new kn(e))},e}(),kn=function(e){function t(t){var n=e.call(this,t)||this;return n.hasFirst=!1,n.observables=[],n.subscriptions=[],n}return X(t,e),t.prototype._next=function(e){this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{for(var n=0;n<t&&!this.hasFirst;n++){var r=Wt(this,e[n],void 0,n);this.subscriptions&&this.subscriptions.push(r),this.add(r)}this.observables=null}},t.prototype.notifyNext=function(e,t,n){if(!this.hasFirst){this.hasFirst=!0;for(var r=0;r<this.subscriptions.length;r++)if(r!==n){var i=this.subscriptions[r];i.unsubscribe(),this.remove(i)}this.subscriptions=null}this.destination.next(t)},t}(Pt);function An(e){var t=e.start,n=e.index,r=e.count,i=e.subscriber;n>=r?i.complete():(i.next(t),i.closed||(e.index=n+1,e.start=t+1,this.schedule(e)))}function xn(e,t,n){void 0===e&&(e=0);var r=-1;return vn(t)?r=Number(t)<1?1:Number(t):ze(t)&&(n=t),ze(n)||(n=bt),new ge((function(t){var i=vn(e)?e:+e-n.now();return n.schedule(In,i,{index:0,period:r,subscriber:t})}))}function In(e){var t=e.index,n=e.period,r=e.subscriber;if(r.next(t),!r.closed){if(-1===n)return r.complete();e.index=t+1,this.schedule(e,n)}}function Nn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return"function"==typeof n&&e.pop(),Ke(e,void 0).lift(new Mn(n))}var Mn=function(){function e(e){this.resultSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Cn(e,this.resultSelector))},e}(),Cn=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.resultSelector=n,i.iterators=[],i.active=0,i.resultSelector="function"==typeof n?n:void 0,i}return X(t,e),t.prototype._next=function(e){var t=this.iterators;ie(e)?t.push(new Pn(e)):"function"==typeof e[Ut]?t.push(new Rn(e[Ut]())):t.push(new jn(this.destination,this,e))},t.prototype._complete=function(){var e=this.iterators,t=e.length;if(this.unsubscribe(),0!==t){this.active=t;for(var n=0;n<t;n++){var r=e[n];if(r.stillUnsubscribed)this.destination.add(r.subscribe());else this.active--}}else this.destination.complete()},t.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},t.prototype.checkIterators=function(){for(var e=this.iterators,t=e.length,n=this.destination,r=0;r<t;r++){if("function"==typeof(s=e[r]).hasValue&&!s.hasValue())return}var i=!1,o=[];for(r=0;r<t;r++){var s,a=(s=e[r]).next();if(s.hasCompleted()&&(i=!0),a.done)return void n.complete();o.push(a.value)}this.resultSelector?this._tryresultSelector(o):n.next(o),i&&n.complete()},t.prototype._tryresultSelector=function(e){var t;try{t=this.resultSelector.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(le),Rn=function(){function e(e){this.iterator=e,this.nextResult=e.next()}return e.prototype.hasValue=function(){return!0},e.prototype.next=function(){var e=this.nextResult;return this.nextResult=this.iterator.next(),e},e.prototype.hasCompleted=function(){var e=this.nextResult;return Boolean(e&&e.done)},e}(),Pn=function(){function e(e){this.array=e,this.index=0,this.length=0,this.length=e.length}return e.prototype[Ut]=function(){return this},e.prototype.next=function(e){var t=this.index++,n=this.array;return t<this.length?{value:n[t],done:!1}:{value:null,done:!0}},e.prototype.hasValue=function(){return this.array.length>this.index},e.prototype.hasCompleted=function(){return this.array.length===this.index},e}(),jn=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.parent=n,i.observable=r,i.stillUnsubscribed=!0,i.buffer=[],i.isComplete=!1,i}return X(t,e),t.prototype[Ut]=function(){return this},t.prototype.next=function(){var e=this.buffer;return 0===e.length&&this.isComplete?{value:null,done:!0}:{value:e.shift(),done:!1}},t.prototype.hasValue=function(){return this.buffer.length>0},t.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},t.prototype.notifyComplete=function(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},t.prototype.notifyNext=function(e){this.buffer.push(e),this.parent.checkIterators()},t.prototype.subscribe=function(){return nn(this.observable,new en(this))},t}(tn),Ln=Object.freeze({__proto__:null,Observable:ge,ConnectableObservable:xe,GroupedObservable:je,observable:de,Subject:Oe,BehaviorSubject:qe,ReplaySubject:it,AsyncSubject:st,asap:dt,asapScheduler:ht,async:bt,asyncScheduler:vt,queue:He,queueScheduler:Be,animationFrame:yt,animationFrameScheduler:gt,VirtualTimeScheduler:_t,VirtualAction:wt,Scheduler:Ve,Subscription:ae,Subscriber:le,Notification:et,get NotificationKind(){return Je},pipe:be,noop:Et,identity:ve,isObservable:function(e){return!!e&&(e instanceof ge||"function"==typeof e.lift&&"function"==typeof e.subscribe)},ArgumentOutOfRangeError:Ot,EmptyError:St,ObjectUnsubscribedError:_e,UnsubscriptionError:se,TimeoutError:Tt,bindCallback:function e(t,n,r){if(n){if(!ze(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(kt((function(e){return ie(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i,o=this,s={context:o,subject:i,callbackFunc:t,scheduler:r};return new ge((function(n){if(r){var a={args:e,subscriber:n,params:s};return r.schedule(It,0,a)}if(!i){i=new st;try{t.apply(o,e.concat([function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];i.next(e.length<=1?e[0]:e),i.complete()}]))}catch(e){pe(i)?i.error(e):console.warn(e)}}return i.subscribe(n)}))}},bindNodeCallback:function e(t,n,r){if(n){if(!ze(n))return function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return e(t,r).apply(void 0,i).pipe(kt((function(e){return ie(e)?n.apply(void 0,e):n(e)})))};r=n}return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i={subject:void 0,args:e,callbackFunc:t,scheduler:r,context:this};return new ge((function(n){var o=i.context,s=i.subject;if(r)return r.schedule(Mt,0,{params:i,subscriber:n,context:o});if(!s){s=i.subject=new st;try{t.apply(o,e.concat([function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.shift();n?s.error(n):(s.next(e.length<=1?e[0]:e),s.complete())}]))}catch(e){pe(s)?s.error(e):console.warn(e)}}return s.subscribe(n)}))}},combineLatest:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=void 0,r=void 0;return ze(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&ie(e[0])&&(e=e[0]),Ke(e,r).lift(new zt(n))},concat:ln,defer:fn,empty:Ge,forkJoin:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(1===e.length){var n=e[0];if(ie(n))return pn(n,null);if(oe(n)&&Object.getPrototypeOf(n)===Object.prototype){var r=Object.keys(n);return pn(r.map((function(e){return n[e]})),r)}}if("function"==typeof e[e.length-1]){var i=e.pop();return pn(e=1===e.length&&ie(e[0])?e[0]:e,null).pipe(kt((function(e){return i.apply(void 0,e)})))}return pn(e,null)},from:Zt,fromEvent:function e(t,n,r,i){return Z(r)&&(i=r,r=void 0),i?e(t,n,r).pipe(kt((function(e){return ie(e)?i.apply(void 0,e):i(e)}))):new ge((function(e){hn(t,n,(function(t){arguments.length>1?e.next(Array.prototype.slice.call(arguments)):e.next(t)}),e,r)}))},fromEventPattern:function e(t,n,r){return r?e(t,n).pipe(kt((function(e){return ie(e)?r.apply(void 0,e):r(e)}))):new ge((function(e){var r,i=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return e.next(1===t.length?t[0]:t)};try{r=t(i)}catch(t){return void e.error(t)}if(Z(n))return function(){return n(i,r)}}))},generate:function(e,t,n,r,i){var o,s;if(1==arguments.length){var a=e;s=a.initialState,t=a.condition,n=a.iterate,o=a.resultSelector||ve,i=a.scheduler}else void 0===r||ze(r)?(s=e,o=ve,i=r):(s=e,o=r);return new ge((function(e){var r=s;if(i)return i.schedule(dn,0,{subscriber:e,iterate:n,condition:t,resultSelector:o,state:r});for(;;){if(t){var a=void 0;try{a=t(r)}catch(t){return void e.error(t)}if(!a){e.complete();break}}var u=void 0;try{u=o(r)}catch(t){return void e.error(t)}if(e.next(u),e.closed)break;try{r=n(r)}catch(t){return void e.error(t)}}}))},iif:function(e,t,n){return void 0===t&&(t=We),void 0===n&&(n=We),fn((function(){return e()?t:n}))},interval:function(e,t){return void 0===e&&(e=0),void 0===t&&(t=bt),(!vn(e)||e<0)&&(e=0),t&&"function"==typeof t.schedule||(t=bt),new ge((function(n){return n.add(t.schedule(bn,e,{subscriber:n,counter:0,period:e})),n}))},merge:mn,never:function(){return gn},of:Xe,onErrorResumeNext:function e(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(0===t.length)return We;var r=t[0],i=t.slice(1);return 1===t.length&&ie(r)?e.apply(void 0,r):new ge((function(t){var n=function(){return t.add(e.apply(void 0,i).subscribe(t))};return Zt(r).subscribe({next:function(e){t.next(e)},error:n,complete:n})}))},pairs:function(e,t){return new ge(t?function(n){var r=Object.keys(e),i=new ae;return i.add(t.schedule(yn,0,{keys:r,index:0,subscriber:n,subscription:i,obj:e})),i}:function(t){for(var n=Object.keys(e),r=0;r<n.length&&!t.closed;r++){var i=n[r];e.hasOwnProperty(i)&&t.next([i,e[i]])}t.complete()})},partition:function(e,t,n){return[wn(t,n)(new ge(Ht(e))),wn(_n(t,n))(new ge(Ht(e)))]},race:Sn,range:function(e,t,n){return void 0===e&&(e=0),new ge((function(r){void 0===t&&(t=e,e=0);var i=0,o=e;if(n)return n.schedule(An,0,{index:i,count:t,start:e,subscriber:r});for(;;){if(i++>=t){r.complete();break}if(r.next(o++),r.closed)break}}))},throwError:$e,timer:xn,using:function(e,t){return new ge((function(n){var r,i;try{r=e()}catch(e){return void n.error(e)}try{i=t(r)}catch(e){return void n.error(e)}var o=(i?Zt(i):We).subscribe(n);return function(){o.unsubscribe(),r&&r.unsubscribe()}}))},zip:Nn,scheduled:$t,EMPTY:We,NEVER:gn,config:te});var qn="undefined"!=typeof window&&window,Un="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,Dn="undefined"!=typeof global&&global,Vn=qn||Dn||Un;function Fn(e,t){return void 0===t&&(t=null),new Yn({method:"GET",url:e,headers:t})}function Bn(e,t,n){return new Yn({method:"POST",url:e,body:t,headers:n})}function Hn(e,t){return new Yn({method:"DELETE",url:e,headers:t})}function Wn(e,t,n){return new Yn({method:"PUT",url:e,body:t,headers:n})}function Gn(e,t,n){return new Yn({method:"PATCH",url:e,body:t,headers:n})}var zn=kt((function(e,t){return e.response}));function Jn(e,t){return zn(new Yn({method:"GET",url:e,responseType:"json",headers:t}))}var Yn=function(e){function t(t){var n=e.call(this)||this,r={async:!0,createXHR:function(){return this.crossDomain?function(){if(Vn.XMLHttpRequest)return new Vn.XMLHttpRequest;if(Vn.XDomainRequest)return new Vn.XDomainRequest;throw new Error("CORS is not supported by your browser")}():function(){if(Vn.XMLHttpRequest)return new Vn.XMLHttpRequest;var e=void 0;try{for(var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=0;n<3;n++)try{if(e=t[n],new Vn.ActiveXObject(e))break}catch(e){}return new Vn.ActiveXObject(e)}catch(e){throw new Error("XMLHttpRequest is not supported by your browser")}}()},crossDomain:!0,withCredentials:!1,headers:{},method:"GET",responseType:"json",timeout:0};if("string"==typeof t)r.url=t;else for(var i in t)t.hasOwnProperty(i)&&(r[i]=t[i]);return n.request=r,n}return X(t,e),t.prototype._subscribe=function(e){return new Qn(e,this.request)},t.create=function(){var e=function(e){return new t(e)};return e.get=Fn,e.post=Bn,e.delete=Hn,e.put=Wn,e.patch=Gn,e.getJSON=Jn,e}(),t}(ge),Qn=function(e){function t(t,n){var r=e.call(this,t)||this;r.request=n,r.done=!1;var i=n.headers=n.headers||{};return n.crossDomain||r.getHeader(i,"X-Requested-With")||(i["X-Requested-With"]="XMLHttpRequest"),r.getHeader(i,"Content-Type")||Vn.FormData&&n.body instanceof Vn.FormData||void 0===n.body||(i["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),n.body=r.serializeBody(n.body,r.getHeader(n.headers,"Content-Type")),r.send(),r}return X(t,e),t.prototype.next=function(e){this.done=!0;var t,n=this,r=n.xhr,i=n.request,o=n.destination;try{t=new Kn(e,r,i)}catch(e){return o.error(e)}o.next(t)},t.prototype.send=function(){var e=this.request,t=this.request,n=t.user,r=t.method,i=t.url,o=t.async,s=t.password,a=t.headers,u=t.body;try{var c=this.xhr=e.createXHR();this.setupEvents(c,e),n?c.open(r,i,o,n,s):c.open(r,i,o),o&&(c.timeout=e.timeout,c.responseType=e.responseType),"withCredentials"in c&&(c.withCredentials=!!e.withCredentials),this.setHeaders(c,a),u?c.send(u):c.send()}catch(e){this.error(e)}},t.prototype.serializeBody=function(e,t){if(!e||"string"==typeof e)return e;if(Vn.FormData&&e instanceof Vn.FormData)return e;if(t){var n=t.indexOf(";");-1!==n&&(t=t.substring(0,n))}switch(t){case"application/x-www-form-urlencoded":return Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&");case"application/json":return JSON.stringify(e);default:return e}},t.prototype.setHeaders=function(e,t){for(var n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n])},t.prototype.getHeader=function(e,t){for(var n in e)if(n.toLowerCase()===t.toLowerCase())return e[n]},t.prototype.setupEvents=function(e,t){var n=t.progressSubscriber;function r(e){var t,n=r,i=n.subscriber,o=n.progressSubscriber,s=n.request;o&&o.error(e);try{t=new Zn(this,s)}catch(e){t=e}i.error(t)}if(e.ontimeout=r,r.request=t,r.subscriber=this,r.progressSubscriber=n,e.upload&&"withCredentials"in e){var i,o;if(n)i=function(e){i.progressSubscriber.next(e)},Vn.XDomainRequest?e.onprogress=i:e.upload.onprogress=i,i.progressSubscriber=n;o=function(e){var t,n=o,r=n.progressSubscriber,i=n.subscriber,s=n.request;r&&r.error(e);try{t=new Xn("ajax error",this,s)}catch(e){t=e}i.error(t)},e.onerror=o,o.request=t,o.subscriber=this,o.progressSubscriber=n}function s(e){}function a(e){var t=a,n=t.subscriber,r=t.progressSubscriber,i=t.request;if(4===this.readyState){var o=1223===this.status?204:this.status,s="text"===this.responseType?this.response||this.responseText:this.response;if(0===o&&(o=s?200:0),o<400)r&&r.complete(),n.next(e),n.complete();else{r&&r.error(e);var u=void 0;try{u=new Xn("ajax error "+o,this,i)}catch(e){u=e}n.error(u)}}}e.onreadystatechange=s,s.subscriber=this,s.progressSubscriber=n,s.request=t,e.onload=a,a.subscriber=this,a.progressSubscriber=n,a.request=t},t.prototype.unsubscribe=function(){var t=this.done,n=this.xhr;!t&&n&&4!==n.readyState&&"function"==typeof n.abort&&n.abort(),e.prototype.unsubscribe.call(this)},t}(le),Kn=function(){return function(e,t,n){this.originalEvent=e,this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=$n(this.responseType,t)}}(),Xn=function(){function e(e,t,n){return Error.call(this),this.message=e,this.name="AjaxError",this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=$n(this.responseType,t),this}return e.prototype=Object.create(Error.prototype),e}();function $n(e,t){switch(e){case"json":return function(e){return"response"in e?e.responseType?e.response:JSON.parse(e.response||e.responseText||"null"):JSON.parse(e.responseText||"null")}(t);case"xml":return t.responseXML;case"text":default:return"response"in t?t.response:t.responseText}}var Zn=function(e,t){return Xn.call(this,"ajax timeout",e,t),this.name="AjaxTimeoutError",this},er=function(){return Yn.create}(),tr={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},nr=function(e){function t(t,n){var r=e.call(this)||this;if(t instanceof ge)r.destination=n,r.source=t;else{var i=r._config=$({},tr);if(r._output=new Oe,"string"==typeof t)i.url=t;else for(var o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);if(!i.WebSocketCtor&&WebSocket)i.WebSocketCtor=WebSocket;else if(!i.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new it}return r}return X(t,e),t.prototype.lift=function(e){var n=new t(this._config,this.destination);return n.operator=e,n.source=this,n},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new it),this._output=new Oe},t.prototype.multiplex=function(e,t,n){var r=this;return new ge((function(i){try{r.next(e())}catch(e){i.error(e)}var o=r.subscribe((function(e){try{n(e)&&i.next(e)}catch(e){i.error(e)}}),(function(e){return i.error(e)}),(function(){return i.complete()}));return function(){try{r.next(t())}catch(e){i.error(e)}o.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,n=t.WebSocketCtor,r=t.protocol,i=t.url,o=t.binaryType,s=this._output,a=null;try{a=r?new n(i,r):new n(i),this._socket=a,o&&(this._socket.binaryType=o)}catch(e){return void s.error(e)}var u=new ae((function(){e._socket=null,a&&1===a.readyState&&a.close()}));a.onopen=function(t){if(!e._socket)return a.close(),void e._resetState();var n=e._config.openObserver;n&&n.next(t);var r=e.destination;e.destination=le.create((function(t){if(1===a.readyState)try{var n=e._config.serializer;a.send(n(t))}catch(t){e.destination.error(t)}}),(function(t){var n=e._config.closingObserver;n&&n.next(void 0),t&&t.code?a.close(t.code,t.reason):s.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),a.close(),e._resetState()})),r&&r instanceof it&&u.add(r.subscribe(e.destination))},a.onerror=function(t){e._resetState(),s.error(t)},a.onclose=function(t){e._resetState();var n=e._config.closeObserver;n&&n.next(t),t.wasClean?s.complete():s.error(t)},a.onmessage=function(t){try{var n=e._config.deserializer;s.next(n(t))}catch(e){s.error(e)}}},t.prototype._subscribe=function(e){var t=this,n=this.source;return n?n.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(e&&1===e.readyState&&e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;t&&1===t.readyState&&t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(Se);function rr(e){return new nr(e)}var ir=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=dt);var i=e.call(this)||this;return i.source=t,i.delayTime=n,i.scheduler=r,(!vn(n)||n<0)&&(i.delayTime=0),r&&"function"==typeof r.schedule||(i.scheduler=dt),i}return X(t,e),t.create=function(e,n,r){return void 0===n&&(n=0),void 0===r&&(r=dt),new t(e,n,r)},t.dispatch=function(e){var t=e.source,n=e.subscriber;return this.add(t.subscribe(n))},t.prototype._subscribe=function(e){var n=this.delayTime,r=this.source;return this.scheduler.schedule(t.dispatch,n,{source:r,subscriber:e})},t}(ge);var or=function(){return function(e,t){this.value=e,this.timestamp=t}}();function sr(e,t){var n=!1;return arguments.length>=2&&(n=!0),function(r){return r.lift(new ar(e,t,n))}}var ar=function(){function e(e,t,n){void 0===n&&(n=!1),this.accumulator=e,this.seed=t,this.hasSeed=n}return e.prototype.call=function(e,t){return t.subscribe(new ur(e,this.accumulator,this.seed,this.hasSeed))},e}(),ur=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.accumulator=n,o._seed=r,o.hasSeed=i,o.index=0,o}return X(t,e),Object.defineProperty(t.prototype,"seed",{get:function(){return this._seed},set:function(e){this.hasSeed=!0,this._seed=e},enumerable:!0,configurable:!0}),t.prototype._next=function(e){if(this.hasSeed)return this._tryNext(e);this.seed=e,this.destination.next(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.accumulator(this.seed,e,n)}catch(e){this.destination.error(e)}this.seed=t,this.destination.next(t)},t}(le);var cr=function(){return function(e,t){this.value=e,this.interval=t}}(),lr={leading:!0,trailing:!1};var fr=function(){function e(e,t,n){this.durationSelector=e,this.leading=t,this.trailing=n}return e.prototype.call=function(e,t){return t.subscribe(new pr(e,this.durationSelector,this.leading,this.trailing))},e}(),pr=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.destination=t,o.durationSelector=n,o._leading=r,o._trailing=i,o._hasValue=!1,o}return X(t,e),t.prototype._next=function(e){this._hasValue=!0,this._sendValue=e,this._throttled||(this._leading?this.send():this.throttle(e))},t.prototype.send=function(){var e=this._hasValue,t=this._sendValue;e&&(this.destination.next(t),this.throttle(t)),this._hasValue=!1,this._sendValue=void 0},t.prototype.throttle=function(e){var t=this.tryDurationSelector(e);t&&this.add(this._throttled=nn(t,new en(this)))},t.prototype.tryDurationSelector=function(e){try{return this.durationSelector(e)}catch(e){return this.destination.error(e),null}},t.prototype.throttlingDone=function(){var e=this._throttled,t=this._trailing;e&&e.unsubscribe(),this._throttled=void 0,t&&this.send()},t.prototype.notifyNext=function(){this.throttlingDone()},t.prototype.notifyComplete=function(){this.throttlingDone()},t}(tn);var hr,dr={e:{}};function vr(e){return e instanceof Date&&!isNaN(+e)}function br(){dr.e=void 0;try{return hr.apply(this,arguments)}catch(e){return dr.e=e,dr}finally{hr=void 0}}var mr=Object.freeze({__proto__:null,config:te,InnerSubscriber:jt,OuterSubscriber:Pt,Scheduler:Ve,AnonymousSubject:Se,SubjectSubscription:we,Subscriber:le,fromPromise:function(e,t){return t?Yt(e,t):new ge(Lt(e))},fromIterable:function(e,t){if(!e)throw new Error("Iterable cannot be null");return t?Qt(e,t):new ge(Dt(e))},ajax:er,webSocket:rr,ajaxGet:Fn,ajaxPost:Bn,ajaxDelete:Hn,ajaxPut:Wn,ajaxPatch:Gn,ajaxGetJSON:Jn,AjaxObservable:Yn,AjaxSubscriber:Qn,AjaxResponse:Kn,AjaxError:Xn,AjaxTimeoutError:Zn,WebSocketSubject:nr,CombineLatestOperator:zt,dispatch:An,SubscribeOnObservable:ir,Timestamp:or,TimeInterval:cr,GroupedObservable:je,defaultThrottleConfig:lr,rxSubscriber:ce,iterator:Ut,observable:de,ArgumentOutOfRangeError:Ot,EmptyError:St,Immediate:ft,ObjectUnsubscribedError:_e,TimeoutError:Tt,UnsubscriptionError:se,applyMixins:function(e,t){for(var n=0,r=t.length;n<r;n++)for(var i=t[n],o=Object.getOwnPropertyNames(i.prototype),s=0,a=o.length;s<a;s++){var u=o[s];e.prototype[u]=i.prototype[u]}},errorObject:dr,hostReportError:ne,identity:ve,isArray:ie,isArrayLike:Ft,isDate:vr,isFunction:Z,isIterable:Xt,isNumeric:vn,isObject:oe,isObservable:Kt,isPromise:Bt,isScheduler:ze,noop:Et,not:_n,pipe:be,root:Vn,subscribeTo:Ht,subscribeToArray:Ye,subscribeToIterable:Dt,subscribeToObservable:Vt,subscribeToPromise:Lt,subscribeToResult:Wt,toSubscriber:he,tryCatch:function(e){return hr=e,br}}),gr=A(Ln),yr=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.bindCallback=gr.bindCallback})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.bindNodeCallback=gr.bindNodeCallback})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.combineLatest=gr.combineLatest})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.concat=gr.concat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.defer=gr.defer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.empty=gr.empty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.forkJoin=gr.forkJoin})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.from=gr.from})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.fromEvent=gr.fromEvent})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.fromEventPattern=gr.fromEventPattern})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.fromPromise=gr.from})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.generate=gr.generate})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.if=gr.iif})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.interval=gr.interval})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.merge=gr.merge})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.race=gr.race})),k((function(e,t){function n(){return gr.NEVER}Object.defineProperty(t,"__esModule",{value:!0}),t.staticNever=n,gr.Observable.never=n})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.of=gr.of})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.onErrorResumeNext=gr.onErrorResumeNext})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.pairs=gr.pairs})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.range=gr.range})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.using=gr.using})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.throw=gr.throwError,gr.Observable.throwError=gr.throwError})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.timer=gr.timer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.zip=gr.zip})),A(Object.freeze({__proto__:null,ajax:er,AjaxResponse:Kn,AjaxError:Xn,AjaxTimeoutError:Zn}))),_r=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.ajax=yr.ajax})),A(Object.freeze({__proto__:null,webSocket:rr,WebSocketSubject:nr})));k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.webSocket=_r.webSocket}));function wr(e){return function(t){return t.lift(new Er(e))}}var Er=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Or(e,this.durationSelector))},e}(),Or=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return X(t,e),t.prototype._next=function(e){if(this.value=e,this.hasValue=!0,!this.throttled){var t=void 0;try{t=(0,this.durationSelector)(e)}catch(e){return this.destination.error(e)}var n=nn(t,new en(this));!n||n.closed?this.clearThrottle():this.add(this.throttled=n)}},t.prototype.clearThrottle=function(){var e=this,t=e.value,n=e.hasValue,r=e.throttled;r&&(this.remove(r),this.throttled=void 0,r.unsubscribe()),n&&(this.value=void 0,this.hasValue=!1,this.destination.next(t))},t.prototype.notifyNext=function(){this.clearThrottle()},t.prototype.notifyComplete=function(){this.clearThrottle()},t}(tn);var Sr=function(){function e(e){this.closingNotifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Tr(e,this.closingNotifier))},e}(),Tr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.buffer=[],r.add(nn(n,new en(r))),r}return X(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype.notifyNext=function(){var e=this.buffer;this.buffer=[],this.destination.next(e)},t}(tn);function kr(e,t){return void 0===t&&(t=null),function(n){return n.lift(new Ar(e,t))}}var Ar=function(){function e(e,t){this.bufferSize=e,this.startBufferEvery=t,this.subscriberClass=t&&e!==t?Ir:xr}return e.prototype.call=function(e,t){return t.subscribe(new this.subscriberClass(e,this.bufferSize,this.startBufferEvery))},e}(),xr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.bufferSize=n,r.buffer=[],r}return X(t,e),t.prototype._next=function(e){var t=this.buffer;t.push(e),t.length==this.bufferSize&&(this.destination.next(t),this.buffer=[])},t.prototype._complete=function(){var t=this.buffer;t.length>0&&this.destination.next(t),e.prototype._complete.call(this)},t}(le),Ir=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.bufferSize=n,i.startBufferEvery=r,i.buffers=[],i.count=0,i}return X(t,e),t.prototype._next=function(e){var t=this,n=t.bufferSize,r=t.startBufferEvery,i=t.buffers,o=t.count;this.count++,o%r==0&&i.push([]);for(var s=i.length;s--;){var a=i[s];a.push(e),a.length===n&&(i.splice(s,1),this.destination.next(a))}},t.prototype._complete=function(){for(var t=this.buffers,n=this.destination;t.length>0;){var r=t.shift();r.length>0&&n.next(r)}e.prototype._complete.call(this)},t}(le);var Nr=function(){function e(e,t,n,r){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Cr(e,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},e}(),Mr=function(){return function(){this.buffer=[]}}(),Cr=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;s.bufferTimeSpan=n,s.bufferCreationInterval=r,s.maxBufferSize=i,s.scheduler=o,s.contexts=[];var a=s.openContext();if(s.timespanOnly=null==r||r<0,s.timespanOnly){var u={subscriber:s,context:a,bufferTimeSpan:n};s.add(a.closeAction=o.schedule(Rr,n,u))}else{var c={subscriber:s,context:a},l={bufferTimeSpan:n,bufferCreationInterval:r,subscriber:s,scheduler:o};s.add(a.closeAction=o.schedule(jr,n,c)),s.add(o.schedule(Pr,r,l))}return s}return X(t,e),t.prototype._next=function(e){for(var t,n=this.contexts,r=n.length,i=0;i<r;i++){var o=n[i],s=o.buffer;s.push(e),s.length==this.maxBufferSize&&(t=o)}t&&this.onBufferFull(t)},t.prototype._error=function(t){this.contexts.length=0,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts,n=this.destination;t.length>0;){var r=t.shift();n.next(r.buffer)}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.contexts=null},t.prototype.onBufferFull=function(e){this.closeContext(e);var t=e.closeAction;if(t.unsubscribe(),this.remove(t),!this.closed&&this.timespanOnly){e=this.openContext();var n=this.bufferTimeSpan,r={subscriber:this,context:e,bufferTimeSpan:n};this.add(e.closeAction=this.scheduler.schedule(Rr,n,r))}},t.prototype.openContext=function(){var e=new Mr;return this.contexts.push(e),e},t.prototype.closeContext=function(e){this.destination.next(e.buffer);var t=this.contexts;(t?t.indexOf(e):-1)>=0&&t.splice(t.indexOf(e),1)},t}(le);function Rr(e){var t=e.subscriber,n=e.context;n&&t.closeContext(n),t.closed||(e.context=t.openContext(),e.context.closeAction=this.schedule(e,e.bufferTimeSpan))}function Pr(e){var t=e.bufferCreationInterval,n=e.bufferTimeSpan,r=e.subscriber,i=e.scheduler,o=r.openContext();r.closed||(r.add(o.closeAction=i.schedule(jr,n,{subscriber:r,context:o})),this.schedule(e,t))}function jr(e){var t=e.subscriber,n=e.context;t.closeContext(n)}var Lr=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new qr(e,this.openings,this.closingSelector))},e}(),qr=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.closingSelector=r,i.contexts=[],i.add(Wt(i,n)),i}return X(t,e),t.prototype._next=function(e){for(var t=this.contexts,n=t.length,r=0;r<n;r++)t[r].buffer.push(e)},t.prototype._error=function(t){for(var n=this.contexts;n.length>0;){var r=n.shift();r.subscription.unsubscribe(),r.buffer=null,r.subscription=null}this.contexts=null,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts;t.length>0;){var n=t.shift();this.destination.next(n.buffer),n.subscription.unsubscribe(),n.buffer=null,n.subscription=null}this.contexts=null,e.prototype._complete.call(this)},t.prototype.notifyNext=function(e,t){e?this.closeBuffer(e):this.openBuffer(t)},t.prototype.notifyComplete=function(e){this.closeBuffer(e.context)},t.prototype.openBuffer=function(e){try{var t=this.closingSelector.call(this,e);t&&this.trySubscribe(t)}catch(e){this._error(e)}},t.prototype.closeBuffer=function(e){var t=this.contexts;if(t&&e){var n=e.buffer,r=e.subscription;this.destination.next(n),t.splice(t.indexOf(e),1),this.remove(r),r.unsubscribe()}},t.prototype.trySubscribe=function(e){var t=this.contexts,n=new ae,r={buffer:[],subscription:n};t.push(r);var i=Wt(this,e,r);!i||i.closed?this.closeBuffer(r):(i.context=r,this.add(i),n.add(i))},t}(Pt);var Ur=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Dr(e,this.closingSelector))},e}(),Dr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.closingSelector=n,r.subscribing=!1,r.openBuffer(),r}return X(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype._complete=function(){var t=this.buffer;t&&this.destination.next(t),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.buffer=void 0,this.subscribing=!1},t.prototype.notifyNext=function(){this.openBuffer()},t.prototype.notifyComplete=function(){this.subscribing?this.complete():this.openBuffer()},t.prototype.openBuffer=function(){var e=this.closingSubscription;e&&(this.remove(e),e.unsubscribe());var t,n=this.buffer;this.buffer&&this.destination.next(n),this.buffer=[];try{t=(0,this.closingSelector)()}catch(e){return this.error(e)}e=new ae,this.closingSubscription=e,this.add(e),this.subscribing=!0,e.add(nn(t,new en(this))),this.subscribing=!1},t}(tn);function Vr(e){return function(t){var n=new Fr(e),r=t.lift(n);return n.caught=r}}var Fr=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new Br(e,this.selector,this.caught))},e}(),Br=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.selector=n,i.caught=r,i}return X(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=void 0;try{n=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle();var r=new en(this);this.add(r);var i=nn(n,r);i!==r&&this.add(i)}},t}(tn);function Hr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&ie(e[0])&&(e=e[0].slice()),function(t){return t.lift.call(Zt([t].concat(e)),new zt(n))}}function Wr(e,t){return rn(e,t,1)}var Gr=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new zr(e,this.predicate,this.source))},e}(),zr=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.source=r,i.count=0,i.index=0,i}return X(t,e),t.prototype._next=function(e){this.predicate?this._tryPredicate(e):this.count++},t.prototype._tryPredicate=function(e){var t;try{t=this.predicate(e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t&&this.count++},t.prototype._complete=function(){this.destination.next(this.count),this.destination.complete()},t}(le);var Jr=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Yr(e,this.durationSelector))},e}(),Yr=function(e){function t(t,n){var r=e.call(this,t)||this;return r.durationSelector=n,r.hasValue=!1,r}return X(t,e),t.prototype._next=function(e){try{var t=this.durationSelector.call(this,e);t&&this._tryNext(e,t)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.emitValue(),this.destination.complete()},t.prototype._tryNext=function(e,t){var n=this.durationSubscription;this.value=e,this.hasValue=!0,n&&(n.unsubscribe(),this.remove(n)),(n=nn(t,new en(this)))&&!n.closed&&this.add(this.durationSubscription=n)},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){if(this.hasValue){var t=this.value,n=this.durationSubscription;n&&(this.durationSubscription=void 0,n.unsubscribe(),this.remove(n)),this.value=void 0,this.hasValue=!1,e.prototype._next.call(this,t)}},t}(tn);function Qr(e,t){return void 0===t&&(t=bt),function(n){return n.lift(new Kr(e,t))}}var Kr=function(){function e(e,t){this.dueTime=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Xr(e,this.dueTime,this.scheduler))},e}(),Xr=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.dueTime=n,i.scheduler=r,i.debouncedSubscription=null,i.lastValue=null,i.hasValue=!1,i}return X(t,e),t.prototype._next=function(e){this.clearDebounce(),this.lastValue=e,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule($r,this.dueTime,this))},t.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},t.prototype.debouncedNext=function(){if(this.clearDebounce(),this.hasValue){var e=this.lastValue;this.lastValue=null,this.hasValue=!1,this.destination.next(e)}},t.prototype.clearDebounce=function(){var e=this.debouncedSubscription;null!==e&&(this.remove(e),e.unsubscribe(),this.debouncedSubscription=null)},t}(le);function $r(e){e.debouncedNext()}function Zr(e){return void 0===e&&(e=null),function(t){return t.lift(new ei(e))}}var ei=function(){function e(e){this.defaultValue=e}return e.prototype.call=function(e,t){return t.subscribe(new ti(e,this.defaultValue))},e}(),ti=function(e){function t(t,n){var r=e.call(this,t)||this;return r.defaultValue=n,r.isEmpty=!0,r}return X(t,e),t.prototype._next=function(e){this.isEmpty=!1,this.destination.next(e)},t.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},t}(le);var ni=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new ri(e,this.delay,this.scheduler))},e}(),ri=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.delay=n,i.scheduler=r,i.queue=[],i.active=!1,i.errored=!1,i}return X(t,e),t.dispatch=function(e){for(var t=e.source,n=t.queue,r=e.scheduler,i=e.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(e,o)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,n=new ii(t.now()+this.delay,e);this.queue.push(n),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(et.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(et.createComplete()),this.unsubscribe()},t}(le),ii=function(){return function(e,t){this.time=e,this.notification=t}}();var oi=function(){function e(e){this.delayDurationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new si(e,this.delayDurationSelector))},e}(),si=function(e){function t(t,n){var r=e.call(this,t)||this;return r.delayDurationSelector=n,r.completed=!1,r.delayNotifierSubscriptions=[],r.index=0,r}return X(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(e),this.removeSubscription(i),this.tryComplete()},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype.notifyComplete=function(e){var t=this.removeSubscription(e);t&&this.destination.next(t),this.tryComplete()},t.prototype._next=function(e){var t=this.index++;try{var n=this.delayDurationSelector(e,t);n&&this.tryDelay(n,e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.completed=!0,this.tryComplete(),this.unsubscribe()},t.prototype.removeSubscription=function(e){e.unsubscribe();var t=this.delayNotifierSubscriptions.indexOf(e);return-1!==t&&this.delayNotifierSubscriptions.splice(t,1),e.outerValue},t.prototype.tryDelay=function(e,t){var n=Wt(this,e,t);n&&!n.closed&&(this.destination.add(n),this.delayNotifierSubscriptions.push(n))},t.prototype.tryComplete=function(){this.completed&&0===this.delayNotifierSubscriptions.length&&this.destination.complete()},t}(Pt),ai=function(e){function t(t,n){var r=e.call(this)||this;return r.source=t,r.subscriptionDelay=n,r}return X(t,e),t.prototype._subscribe=function(e){this.subscriptionDelay.subscribe(new ui(e,this.source))},t}(ge),ui=function(e){function t(t,n){var r=e.call(this)||this;return r.parent=t,r.source=n,r.sourceSubscribed=!1,r}return X(t,e),t.prototype._next=function(e){this.subscribeToSource()},t.prototype._error=function(e){this.unsubscribe(),this.parent.error(e)},t.prototype._complete=function(){this.unsubscribe(),this.subscribeToSource()},t.prototype.subscribeToSource=function(){this.sourceSubscribed||(this.sourceSubscribed=!0,this.unsubscribe(),this.source.subscribe(this.parent))},t}(le);var ci=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new li(e))},e}(),li=function(e){function t(t){return e.call(this,t)||this}return X(t,e),t.prototype._next=function(e){e.observe(this.destination)},t}(le);function fi(e,t){return function(n){return n.lift(new pi(e,t))}}var pi=function(){function e(e,t){this.keySelector=e,this.flushes=t}return e.prototype.call=function(e,t){return t.subscribe(new hi(e,this.keySelector,this.flushes))},e}(),hi=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=n,i.values=new Set,r&&i.add(nn(r,new en(i))),i}return X(t,e),t.prototype.notifyNext=function(){this.values.clear()},t.prototype.notifyError=function(e){this._error(e)},t.prototype._next=function(e){this.keySelector?this._useKeySelector(e):this._finalizeNext(e,e)},t.prototype._useKeySelector=function(e){var t,n=this.destination;try{t=this.keySelector(e)}catch(e){return void n.error(e)}this._finalizeNext(t,e)},t.prototype._finalizeNext=function(e,t){var n=this.values;n.has(e)||(n.add(e),this.destination.next(t))},t}(tn);function di(e,t){return function(n){return n.lift(new vi(e,t))}}var vi=function(){function e(e,t){this.compare=e,this.keySelector=t}return e.prototype.call=function(e,t){return t.subscribe(new bi(e,this.compare,this.keySelector))},e}(),bi=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.keySelector=r,i.hasKey=!1,"function"==typeof n&&(i.compare=n),i}return X(t,e),t.prototype.compare=function(e,t){return e===t},t.prototype._next=function(e){var t;try{var n=this.keySelector;t=n?n(e):e}catch(e){return this.destination.error(e)}var r=!1;if(this.hasKey)try{r=(0,this.compare)(this.key,t)}catch(e){return this.destination.error(e)}else this.hasKey=!0;r||(this.key=t,this.destination.next(e))},t}(le);function mi(e){return void 0===e&&(e=_i),function(t){return t.lift(new gi(e))}}var gi=function(){function e(e){this.errorFactory=e}return e.prototype.call=function(e,t){return t.subscribe(new yi(e,this.errorFactory))},e}(),yi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.errorFactory=n,r.hasValue=!1,r}return X(t,e),t.prototype._next=function(e){this.hasValue=!0,this.destination.next(e)},t.prototype._complete=function(){if(this.hasValue)return this.destination.complete();var e=void 0;try{e=this.errorFactory()}catch(t){e=t}this.destination.error(e)},t}(le);function _i(){return new St}function wi(e){return function(t){return 0===e?Ge():t.lift(new Ei(e))}}var Ei=function(){function e(e){if(this.total=e,this.total<0)throw new Ot}return e.prototype.call=function(e,t){return t.subscribe(new Oi(e,this.total))},e}(),Oi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return X(t,e),t.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},t}(le);var Si=function(){function e(e,t,n){this.predicate=e,this.thisArg=t,this.source=n}return e.prototype.call=function(e,t){return t.subscribe(new Ti(e,this.predicate,this.thisArg,this.source))},e}(),Ti=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.predicate=n,o.thisArg=r,o.source=i,o.index=0,o.thisArg=r||o,o}return X(t,e),t.prototype.notifyComplete=function(e){this.destination.next(e),this.destination.complete()},t.prototype._next=function(e){var t=!1;try{t=this.predicate.call(this.thisArg,e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t||this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(le);var ki=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Ai(e))},e}(),Ai=function(e){function t(t){var n=e.call(this,t)||this;return n.hasCompleted=!1,n.hasSubscription=!1,n}return X(t,e),t.prototype._next=function(e){this.hasSubscription||(this.hasSubscription=!0,this.add(nn(e,new en(this))))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(tn);var xi=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Ii(e,this.project))},e}(),Ii=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.hasSubscription=!1,r.hasCompleted=!1,r.index=0,r}return X(t,e),t.prototype._next=function(e){this.hasSubscription||this.tryNext(e)},t.prototype.tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.hasSubscription=!0,this._innerSub(t)},t.prototype._innerSub=function(e){var t=new en(this),n=this.destination;n.add(t);var r=nn(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this.destination.next(e)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(){this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(tn);var Ni=function(){function e(e,t,n){this.project=e,this.concurrent=t,this.scheduler=n}return e.prototype.call=function(e,t){return t.subscribe(new Mi(e,this.project,this.concurrent,this.scheduler))},e}(),Mi=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.project=n,o.concurrent=r,o.scheduler=i,o.index=0,o.active=0,o.hasCompleted=!1,r<Number.POSITIVE_INFINITY&&(o.buffer=[]),o}return X(t,e),t.dispatch=function(e){var t=e.subscriber,n=e.result,r=e.value,i=e.index;t.subscribeToProjection(n,r,i)},t.prototype._next=function(e){var n=this.destination;if(n.closed)this._complete();else{var r=this.index++;if(this.active<this.concurrent){n.next(e);try{var i=(0,this.project)(e,r);if(this.scheduler){var o={subscriber:this,result:i,value:e,index:r};this.destination.add(this.scheduler.schedule(t.dispatch,0,o))}else this.subscribeToProjection(i,e,r)}catch(e){n.error(e)}}else this.buffer.push(e)}},t.prototype.subscribeToProjection=function(e,t,n){this.active++,this.destination.add(nn(e,new en(this)))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasCompleted&&0===this.active&&this.destination.complete(),this.unsubscribe()},t.prototype.notifyNext=function(e){this._next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e&&e.length>0&&this._next(e.shift()),this.hasCompleted&&0===this.active&&this.destination.complete()},t}(tn);function Ci(e){return function(t){return t.lift(new Ri(e))}}var Ri=function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){return t.subscribe(new Pi(e,this.callback))},e}(),Pi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.add(new ae(n)),r}return X(t,e),t}(le);var ji=function(){function e(e,t,n,r){this.predicate=e,this.source=t,this.yieldIndex=n,this.thisArg=r}return e.prototype.call=function(e,t){return t.subscribe(new Li(e,this.predicate,this.source,this.yieldIndex,this.thisArg))},e}(),Li=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.predicate=n,s.source=r,s.yieldIndex=i,s.thisArg=o,s.index=0,s}return X(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete(),this.unsubscribe()},t.prototype._next=function(e){var t=this.predicate,n=this.thisArg,r=this.index++;try{t.call(n||this,e,r,this.source)&&this.notifyComplete(this.yieldIndex?r:e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.notifyComplete(this.yieldIndex?-1:void 0)},t}(le);var qi=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Ui(e))},e}(),Ui=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return X(t,e),t.prototype._next=function(e){},t}(le);var Di=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Vi(e))},e}(),Vi=function(e){function t(t){return e.call(this,t)||this}return X(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype._next=function(e){this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(le);function Fi(e){return function(t){return 0===e?Ge():t.lift(new Bi(e))}}var Bi=function(){function e(e){if(this.total=e,this.total<0)throw new Ot}return e.prototype.call=function(e,t){return t.subscribe(new Hi(e,this.total))},e}(),Hi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.ring=new Array,r.count=0,r}return X(t,e),t.prototype._next=function(e){var t=this.ring,n=this.total,r=this.count++;t.length<n?t.push(e):t[r%n]=e},t.prototype._complete=function(){var e=this.destination,t=this.count;if(t>0)for(var n=this.count>=this.total?this.total:this.count,r=this.ring,i=0;i<n;i++){var o=t++%n;e.next(r[o])}e.complete()},t}(le);function Wi(e){return function(t){return t.lift(new Gi(e))}}var Gi=function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.subscribe(new zi(e,this.value))},e}(),zi=function(e){function t(t,n){var r=e.call(this,t)||this;return r.value=n,r}return X(t,e),t.prototype._next=function(e){this.destination.next(this.value)},t}(le);var Ji=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Yi(e))},e}(),Yi=function(e){function t(t){return e.call(this,t)||this}return X(t,e),t.prototype._next=function(e){this.destination.next(et.createNext(e))},t.prototype._error=function(e){var t=this.destination;t.next(et.createError(e)),t.complete()},t.prototype._complete=function(){var e=this.destination;e.next(et.createComplete()),e.complete()},t}(le);function Qi(e,t){return arguments.length>=2?function(n){return be(sr(e,t),Fi(1),Zr(t))(n)}:function(t){return be(sr((function(t,n,r){return e(t,n,r+1)})),Fi(1))(t)}}function Ki(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(mn.apply(void 0,[t].concat(e)))}}function Xi(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"function"==typeof t?rn((function(){return e}),t,n):("number"==typeof t&&(n=t),rn((function(){return e}),n))}var $i=function(){function e(e,t,n){this.accumulator=e,this.seed=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new Zi(e,this.accumulator,this.seed,this.concurrent))},e}(),Zi=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o.accumulator=n,o.acc=r,o.concurrent=i,o.hasValue=!1,o.hasCompleted=!1,o.buffer=[],o.active=0,o.index=0,o}return X(t,e),t.prototype._next=function(e){if(this.active<this.concurrent){var t=this.index++,n=this.destination,r=void 0;try{r=(0,this.accumulator)(this.acc,e,t)}catch(e){return n.error(e)}this.active++,this._innerSub(r)}else this.buffer.push(e)},t.prototype._innerSub=function(e){var t=new en(this),n=this.destination;n.add(t);var r=nn(e,t);r!==t&&n.add(r)},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete()),this.unsubscribe()},t.prototype.notifyNext=function(e){var t=this.destination;this.acc=e,this.hasValue=!0,t.next(e)},t.prototype.notifyComplete=function(){var e=this.buffer;this.active--,e.length>0?this._next(e.shift()):0===this.active&&this.hasCompleted&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())},t}(tn);function eo(e,t){return function(n){var r;if(r="function"==typeof e?e:function(){return e},"function"==typeof t)return n.lift(new to(r,t));var i=Object.create(n,Ie);return i.source=n,i.subjectFactory=r,i}}var to=function(){function e(e,t){this.subjectFactory=e,this.selector=t}return e.prototype.call=function(e,t){var n=this.selector,r=this.subjectFactory(),i=n(r).subscribe(e);return i.add(t.subscribe(r)),i},e}();var no=function(){function e(e){this.nextSources=e}return e.prototype.call=function(e,t){return t.subscribe(new ro(e,this.nextSources))},e}(),ro=function(e){function t(t,n){var r=e.call(this,t)||this;return r.destination=t,r.nextSources=n,r}return X(t,e),t.prototype.notifyError=function(){this.subscribeToNextSource()},t.prototype.notifyComplete=function(){this.subscribeToNextSource()},t.prototype._error=function(e){this.subscribeToNextSource(),this.unsubscribe()},t.prototype._complete=function(){this.subscribeToNextSource(),this.unsubscribe()},t.prototype.subscribeToNextSource=function(){var e=this.nextSources.shift();if(e){var t=new en(this),n=this.destination;n.add(t);var r=nn(e,t);r!==t&&n.add(r)}else this.destination.complete()},t}(tn);var io=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new oo(e))},e}(),oo=function(e){function t(t){var n=e.call(this,t)||this;return n.hasPrev=!1,n}return X(t,e),t.prototype._next=function(e){var t;this.hasPrev?t=[this.prev,e]:this.hasPrev=!0,this.prev=e,t&&this.destination.next(t)},t}(le);function so(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.length;if(0===n)throw new Error("list of properties cannot be empty.");return function(t){return kt(ao(e,n))(t)}}function ao(e,t){return function(n){for(var r=n,i=0;i<t;i++){var o=null!=r?r[e[i]]:void 0;if(void 0===o)return;r=o}return r}}function uo(e){return e?eo((function(){return new Oe}),e):eo(new Oe)}function co(e,t,n,r){n&&"function"!=typeof n&&(r=n);var i="function"==typeof n?n:void 0,o=new it(e,t,r);return function(e){return eo((function(){return o}),i)(e)}}function lo(e){return void 0===e&&(e=-1),function(t){return 0===e?Ge():e<0?t.lift(new fo(-1,t)):t.lift(new fo(e-1,t))}}var fo=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new po(e,this.count,this.source))},e}(),po=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.count=n,i.source=r,i}return X(t,e),t.prototype.complete=function(){if(!this.isStopped){var t=this.source,n=this.count;if(0===n)return e.prototype.complete.call(this);n>-1&&(this.count=n-1),t.subscribe(this._unsubscribeAndRecycle())}},t}(le);var ho=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new vo(e,this.notifier,t))},e}(),vo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.notifier=n,i.source=r,i.sourceIsBeingSubscribedTo=!0,i}return X(t,e),t.prototype.notifyNext=function(){this.sourceIsBeingSubscribedTo=!0,this.source.subscribe(this)},t.prototype.notifyComplete=function(){if(!1===this.sourceIsBeingSubscribedTo)return e.prototype.complete.call(this)},t.prototype.complete=function(){if(this.sourceIsBeingSubscribedTo=!1,!this.isStopped){if(this.retries||this.subscribeToRetries(),!this.retriesSubscription||this.retriesSubscription.closed)return e.prototype.complete.call(this);this._unsubscribeAndRecycle(),this.notifications.next(void 0)}},t.prototype._unsubscribe=function(){var e=this.notifications,t=this.retriesSubscription;e&&(e.unsubscribe(),this.notifications=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},t.prototype._unsubscribeAndRecycle=function(){var t=this._unsubscribe;return this._unsubscribe=null,e.prototype._unsubscribeAndRecycle.call(this),this._unsubscribe=t,this},t.prototype.subscribeToRetries=function(){var t;this.notifications=new Oe;try{t=(0,this.notifier)(this.notifications)}catch(t){return e.prototype.complete.call(this)}this.retries=t,this.retriesSubscription=nn(t,new en(this))},t}(tn);var bo=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new mo(e,this.count,this.source))},e}(),mo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.count=n,i.source=r,i}return X(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.source,r=this.count;if(0===r)return e.prototype.error.call(this,t);r>-1&&(this.count=r-1),n.subscribe(this._unsubscribeAndRecycle())}},t}(le);var go=function(){function e(e,t){this.notifier=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new yo(e,this.notifier,this.source))},e}(),yo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.notifier=n,i.source=r,i}return X(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.errors,r=this.retries,i=this.retriesSubscription;if(r)this.errors=void 0,this.retriesSubscription=void 0;else{n=new Oe;try{r=(0,this.notifier)(n)}catch(t){return e.prototype.error.call(this,t)}i=nn(r,new en(this))}this._unsubscribeAndRecycle(),this.errors=n,this.retries=r,this.retriesSubscription=i,n.next(t)}},t.prototype._unsubscribe=function(){var e=this.errors,t=this.retriesSubscription;e&&(e.unsubscribe(),this.errors=void 0),t&&(t.unsubscribe(),this.retriesSubscription=void 0),this.retries=void 0},t.prototype.notifyNext=function(){var e=this._unsubscribe;this._unsubscribe=null,this._unsubscribeAndRecycle(),this._unsubscribe=e,this.source.subscribe(this)},t}(tn);var _o=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new wo(e),r=t.subscribe(n);return r.add(nn(this.notifier,new en(n))),r},e}(),wo=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.hasValue=!1,t}return X(t,e),t.prototype._next=function(e){this.value=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.value))},t}(tn);var Eo=function(){function e(e,t){this.period=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Oo(e,this.period,this.scheduler))},e}(),Oo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.period=n,i.scheduler=r,i.hasValue=!1,i.add(r.schedule(So,n,{subscriber:i,period:n})),i}return X(t,e),t.prototype._next=function(e){this.lastValue=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.lastValue))},t}(le);function So(e){var t=e.subscriber,n=e.period;t.notifyNext(),this.schedule(e,n)}var To=function(){function e(e,t){this.compareTo=e,this.comparator=t}return e.prototype.call=function(e,t){return t.subscribe(new ko(e,this.compareTo,this.comparator))},e}(),ko=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.compareTo=n,i.comparator=r,i._a=[],i._b=[],i._oneComplete=!1,i.destination.add(n.subscribe(new Ao(t,i))),i}return X(t,e),t.prototype._next=function(e){this._oneComplete&&0===this._b.length?this.emit(!1):(this._a.push(e),this.checkValues())},t.prototype._complete=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0,this.unsubscribe()},t.prototype.checkValues=function(){for(var e=this,t=e._a,n=e._b,r=e.comparator;t.length>0&&n.length>0;){var i=t.shift(),o=n.shift(),s=!1;try{s=r?r(i,o):i===o}catch(e){this.destination.error(e)}s||this.emit(!1)}},t.prototype.emit=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype.nextB=function(e){this._oneComplete&&0===this._a.length?this.emit(!1):(this._b.push(e),this.checkValues())},t.prototype.completeB=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0},t}(le),Ao=function(e){function t(t,n){var r=e.call(this,t)||this;return r.parent=n,r}return X(t,e),t.prototype._next=function(e){this.parent.nextB(e)},t.prototype._error=function(e){this.parent.error(e),this.unsubscribe()},t.prototype._complete=function(){this.parent.completeB(),this.unsubscribe()},t}(le);function xo(){return new Oe}function Io(){return function(e){return Te()(eo(xo)(e))}}function No(e,t,n){var r;return r=e&&"object"===o(e)?e:{bufferSize:e,windowTime:t,refCount:!1,scheduler:n},function(e){return e.lift(function(e){var t,n,r=e.bufferSize,i=void 0===r?Number.POSITIVE_INFINITY:r,o=e.windowTime,s=void 0===o?Number.POSITIVE_INFINITY:o,a=e.refCount,u=e.scheduler,c=0,l=!1,f=!1;return function(e){var r;c++,!t||l?(l=!1,t=new it(i,s,u),r=t.subscribe(this),n=e.subscribe({next:function(e){t.next(e)},error:function(e){l=!0,t.error(e)},complete:function(){f=!0,n=void 0,t.complete()}}),f&&(n=void 0)):r=t.subscribe(this),this.add((function(){c--,r.unsubscribe(),r=void 0,n&&!f&&a&&0===c&&(n.unsubscribe(),n=void 0,t=void 0)}))}}(r))}}var Mo=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Co(e,this.predicate,this.source))},e}(),Co=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.source=r,i.seenValue=!1,i.index=0,i}return X(t,e),t.prototype.applySingleValue=function(e){this.seenValue?this.destination.error("Sequence contains more than one element"):(this.seenValue=!0,this.singleValue=e)},t.prototype._next=function(e){var t=this.index++;this.predicate?this.tryNext(e,t):this.applySingleValue(e)},t.prototype.tryNext=function(e,t){try{this.predicate(e,t,this.source)&&this.applySingleValue(e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){var e=this.destination;this.index>0?(e.next(this.seenValue?this.singleValue:void 0),e.complete()):e.error(new St)},t}(le);function Ro(e){return function(t){return t.lift(new Po(e))}}var Po=function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new jo(e,this.total))},e}(),jo=function(e){function t(t,n){var r=e.call(this,t)||this;return r.total=n,r.count=0,r}return X(t,e),t.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},t}(le);var Lo=function(){function e(e){if(this._skipCount=e,this._skipCount<0)throw new Ot}return e.prototype.call=function(e,t){return 0===this._skipCount?t.subscribe(new le(e)):t.subscribe(new qo(e,this._skipCount))},e}(),qo=function(e){function t(t,n){var r=e.call(this,t)||this;return r._skipCount=n,r._count=0,r._ring=new Array(n),r}return X(t,e),t.prototype._next=function(e){var t=this._skipCount,n=this._count++;if(n<t)this._ring[n]=e;else{var r=n%t,i=this._ring,o=i[r];i[r]=e,this.destination.next(o)}},t}(le);function Uo(e){return function(t){return t.lift(new Do(e))}}var Do=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Vo(e,this.notifier))},e}(),Vo=function(e){function t(t,n){var r=e.call(this,t)||this;r.hasValue=!1;var i=new en(r);r.add(i),r.innerSubscription=i;var o=nn(n,i);return o!==i&&(r.add(o),r.innerSubscription=o),r}return X(t,e),t.prototype._next=function(t){this.hasValue&&e.prototype._next.call(this,t)},t.prototype.notifyNext=function(){this.hasValue=!0,this.innerSubscription&&this.innerSubscription.unsubscribe()},t.prototype.notifyComplete=function(){},t}(tn);var Fo=function(){function e(e){this.predicate=e}return e.prototype.call=function(e,t){return t.subscribe(new Bo(e,this.predicate))},e}(),Bo=function(e){function t(t,n){var r=e.call(this,t)||this;return r.predicate=n,r.skipping=!0,r.index=0,r}return X(t,e),t.prototype._next=function(e){var t=this.destination;this.skipping&&this.tryCallPredicate(e),this.skipping||t.next(e)},t.prototype.tryCallPredicate=function(e){try{var t=this.predicate(e,this.index++);this.skipping=Boolean(t)}catch(e){this.destination.error(e)}},t}(le);function Ho(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[e.length-1];return ze(n)?(e.pop(),function(t){return ln(e,t,n)}):function(t){return ln(e,t)}}var Wo=function(){function e(e,t){this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return new ir(t,this.delay,this.scheduler).subscribe(e)},e}();function Go(e,t){return"function"==typeof t?function(n){return n.pipe(Go((function(n,r){return Zt(e(n,r)).pipe(kt((function(e,i){return t(n,e,r,i)})))})))}:function(t){return t.lift(new zo(e))}}var zo=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Jo(e,this.project))},e}(),Jo=function(e){function t(t,n){var r=e.call(this,t)||this;return r.project=n,r.index=0,r}return X(t,e),t.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t)},t.prototype._innerSub=function(e){var t=this.innerSubscription;t&&t.unsubscribe();var n=new en(this),r=this.destination;r.add(n),this.innerSubscription=nn(e,n),this.innerSubscription!==n&&r.add(this.innerSubscription)},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this),this.unsubscribe()},t.prototype._unsubscribe=function(){this.innerSubscription=void 0},t.prototype.notifyComplete=function(){this.innerSubscription=void 0,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e){this.destination.next(e)},t}(tn);function Yo(e,t){return t?Go((function(){return e}),t):Go((function(){return e}))}function Qo(e){return function(t){return t.lift(new Ko(e))}}var Ko=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new Xo(e),r=nn(this.notifier,new en(n));return r&&!n.seenValue?(n.add(r),t.subscribe(n)):n},e}(),Xo=function(e){function t(t){var n=e.call(this,t)||this;return n.seenValue=!1,n}return X(t,e),t.prototype.notifyNext=function(){this.seenValue=!0,this.complete()},t.prototype.notifyComplete=function(){},t}(tn);var $o=function(){function e(e,t){this.predicate=e,this.inclusive=t}return e.prototype.call=function(e,t){return t.subscribe(new Zo(e,this.predicate,this.inclusive))},e}(),Zo=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.predicate=n,i.inclusive=r,i.index=0,i}return X(t,e),t.prototype._next=function(e){var t,n=this.destination;try{t=this.predicate(e,this.index++)}catch(e){return void n.error(e)}this.nextOrComplete(e,t)},t.prototype.nextOrComplete=function(e,t){var n=this.destination;Boolean(t)?n.next(e):(this.inclusive&&n.next(e),n.complete())},t}(le);function es(e,t,n){return function(r){return r.lift(new ts(e,t,n))}}var ts=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new ns(e,this.nextOrObserver,this.error,this.complete))},e}(),ns=function(e){function t(t,n,r,i){var o=e.call(this,t)||this;return o._tapNext=Et,o._tapError=Et,o._tapComplete=Et,o._tapError=r||Et,o._tapComplete=i||Et,Z(n)?(o._context=o,o._tapNext=n):n&&(o._context=n,o._tapNext=n.next||Et,o._tapError=n.error||Et,o._tapComplete=n.complete||Et),o}return X(t,e),t.prototype._next=function(e){try{this._tapNext.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.next(e)},t.prototype._error=function(e){try{this._tapError.call(this._context,e)}catch(e){return void this.destination.error(e)}this.destination.error(e)},t.prototype._complete=function(){try{this._tapComplete.call(this._context)}catch(e){return void this.destination.error(e)}return this.destination.complete()},t}(le);function rs(e,t,n){return void 0===t&&(t=bt),void 0===n&&(n=lr),function(r){return r.lift(new is(e,t,n.leading,n.trailing))}}var is=function(){function e(e,t,n,r){this.duration=e,this.scheduler=t,this.leading=n,this.trailing=r}return e.prototype.call=function(e,t){return t.subscribe(new os(e,this.duration,this.scheduler,this.leading,this.trailing))},e}(),os=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.duration=n,s.scheduler=r,s.leading=i,s.trailing=o,s._hasTrailingValue=!1,s._trailingValue=null,s}return X(t,e),t.prototype._next=function(e){this.throttled?this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(ss,this.duration,{subscriber:this})),this.leading?this.destination.next(e):this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0))},t.prototype._complete=function(){this._hasTrailingValue?(this.destination.next(this._trailingValue),this.destination.complete()):this.destination.complete()},t.prototype.clearThrottle=function(){var e=this.throttled;e&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),e.unsubscribe(),this.remove(e),this.throttled=null)},t}(le);function ss(e){e.subscriber.clearThrottle()}function as(e,t,n){return void 0===n&&(n=bt),function(r){var i=vr(e),o=i?+e-n.now():Math.abs(e);return r.lift(new us(o,i,t,n))}}var us=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new cs(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),cs=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;return s.absoluteTimeout=n,s.waitFor=r,s.withObservable=i,s.scheduler=o,s.scheduleTimeout(),s}return X(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(nn(t,new en(e)))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=void 0,this.scheduler=null,this.withObservable=null},t}(tn);function ls(e,t){return void 0===t&&(t=bt),as(e,$e(new Tt),t)}function fs(e,t,n){return 0===n?[t]:(e.push(t),e)}function ps(e){return function(t){return t.lift(new hs(e))}}var hs=function(){function e(e){this.windowBoundaries=e}return e.prototype.call=function(e,t){var n=new ds(e),r=t.subscribe(n);return r.closed||n.add(nn(this.windowBoundaries,new en(n))),r},e}(),ds=function(e){function t(t){var n=e.call(this,t)||this;return n.window=new Oe,t.next(n.window),n}return X(t,e),t.prototype.notifyNext=function(){this.openWindow()},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(){this._complete()},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e)},t.prototype._complete=function(){this.window.complete(),this.destination.complete()},t.prototype._unsubscribe=function(){this.window=null},t.prototype.openWindow=function(){var e=this.window;e&&e.complete();var t=this.destination,n=this.window=new Oe;t.next(n)},t}(tn);var vs=function(){function e(e,t){this.windowSize=e,this.startWindowEvery=t}return e.prototype.call=function(e,t){return t.subscribe(new bs(e,this.windowSize,this.startWindowEvery))},e}(),bs=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.destination=t,i.windowSize=n,i.startWindowEvery=r,i.windows=[new Oe],i.count=0,t.next(i.windows[0]),i}return X(t,e),t.prototype._next=function(e){for(var t=this.startWindowEvery>0?this.startWindowEvery:this.windowSize,n=this.destination,r=this.windowSize,i=this.windows,o=i.length,s=0;s<o&&!this.closed;s++)i[s].next(e);var a=this.count-r+1;if(a>=0&&a%t==0&&!this.closed&&i.shift().complete(),++this.count%t==0&&!this.closed){var u=new Oe;i.push(u),n.next(u)}},t.prototype._error=function(e){var t=this.windows;if(t)for(;t.length>0&&!this.closed;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){var e=this.windows;if(e)for(;e.length>0&&!this.closed;)e.shift().complete();this.destination.complete()},t.prototype._unsubscribe=function(){this.count=0,this.windows=null},t}(le);var ms=function(){function e(e,t,n,r){this.windowTimeSpan=e,this.windowCreationInterval=t,this.maxWindowSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new ys(e,this.windowTimeSpan,this.windowCreationInterval,this.maxWindowSize,this.scheduler))},e}(),gs=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._numberOfNextedValues=0,t}return X(t,e),t.prototype.next=function(t){this._numberOfNextedValues++,e.prototype.next.call(this,t)},Object.defineProperty(t.prototype,"numberOfNextedValues",{get:function(){return this._numberOfNextedValues},enumerable:!0,configurable:!0}),t}(Oe),ys=function(e){function t(t,n,r,i,o){var s=e.call(this,t)||this;s.destination=t,s.windowTimeSpan=n,s.windowCreationInterval=r,s.maxWindowSize=i,s.scheduler=o,s.windows=[];var a=s.openWindow();if(null!==r&&r>=0){var u={subscriber:s,window:a,context:null},c={windowTimeSpan:n,windowCreationInterval:r,subscriber:s,scheduler:o};s.add(o.schedule(Es,n,u)),s.add(o.schedule(ws,r,c))}else{var l={subscriber:s,window:a,windowTimeSpan:n};s.add(o.schedule(_s,n,l))}return s}return X(t,e),t.prototype._next=function(e){for(var t=this.windows,n=t.length,r=0;r<n;r++){var i=t[r];i.closed||(i.next(e),i.numberOfNextedValues>=this.maxWindowSize&&this.closeWindow(i))}},t.prototype._error=function(e){for(var t=this.windows;t.length>0;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){for(var e=this.windows;e.length>0;){var t=e.shift();t.closed||t.complete()}this.destination.complete()},t.prototype.openWindow=function(){var e=new gs;return this.windows.push(e),this.destination.next(e),e},t.prototype.closeWindow=function(e){e.complete();var t=this.windows;t.splice(t.indexOf(e),1)},t}(le);function _s(e){var t=e.subscriber,n=e.windowTimeSpan,r=e.window;r&&t.closeWindow(r),e.window=t.openWindow(),this.schedule(e,n)}function ws(e){var t=e.windowTimeSpan,n=e.subscriber,r=e.scheduler,i=e.windowCreationInterval,o=n.openWindow(),s=this,a={action:s,subscription:null},u={subscriber:n,window:o,context:a};a.subscription=r.schedule(Es,t,u),s.add(a.subscription),s.schedule(e,i)}function Es(e){var t=e.subscriber,n=e.window,r=e.context;r&&r.action&&r.subscription&&r.action.remove(r.subscription),t.closeWindow(n)}var Os=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Ss(e,this.openings,this.closingSelector))},e}(),Ss=function(e){function t(t,n,r){var i=e.call(this,t)||this;return i.openings=n,i.closingSelector=r,i.contexts=[],i.add(i.openSubscription=Wt(i,n,n)),i}return X(t,e),t.prototype._next=function(e){var t=this.contexts;if(t)for(var n=t.length,r=0;r<n;r++)t[r].window.next(e)},t.prototype._error=function(t){var n=this.contexts;if(this.contexts=null,n)for(var r=n.length,i=-1;++i<r;){var o=n[i];o.window.error(t),o.subscription.unsubscribe()}e.prototype._error.call(this,t)},t.prototype._complete=function(){var t=this.contexts;if(this.contexts=null,t)for(var n=t.length,r=-1;++r<n;){var i=t[r];i.window.complete(),i.subscription.unsubscribe()}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.contexts;if(this.contexts=null,e)for(var t=e.length,n=-1;++n<t;){var r=e[n];r.window.unsubscribe(),r.subscription.unsubscribe()}},t.prototype.notifyNext=function(e,t,n,r,i){if(e===this.openings){var o=void 0;try{o=(0,this.closingSelector)(t)}catch(e){return this.error(e)}var s=new Oe,a=new ae,u={window:s,subscription:a};this.contexts.push(u);var c=Wt(this,o,u);c.closed?this.closeWindow(this.contexts.length-1):(c.context=u,a.add(c)),this.destination.next(s)}else this.closeWindow(this.contexts.indexOf(e))},t.prototype.notifyError=function(e){this.error(e)},t.prototype.notifyComplete=function(e){e!==this.openSubscription&&this.closeWindow(this.contexts.indexOf(e.context))},t.prototype.closeWindow=function(e){if(-1!==e){var t=this.contexts,n=t[e],r=n.window,i=n.subscription;t.splice(e,1),r.complete(),i.unsubscribe()}},t}(Pt);var Ts=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new ks(e,this.closingSelector))},e}(),ks=function(e){function t(t,n){var r=e.call(this,t)||this;return r.destination=t,r.closingSelector=n,r.openWindow(),r}return X(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.openWindow(i)},t.prototype.notifyError=function(e){this._error(e)},t.prototype.notifyComplete=function(e){this.openWindow(e)},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e),this.unsubscribeClosingNotification()},t.prototype._complete=function(){this.window.complete(),this.destination.complete(),this.unsubscribeClosingNotification()},t.prototype.unsubscribeClosingNotification=function(){this.closingNotification&&this.closingNotification.unsubscribe()},t.prototype.openWindow=function(e){void 0===e&&(e=null),e&&(this.remove(e),e.unsubscribe());var t=this.window;t&&t.complete();var n,r=this.window=new Oe;this.destination.next(r);try{n=(0,this.closingSelector)()}catch(e){return this.destination.error(e),void this.window.error(e)}this.add(this.closingNotification=Wt(this,n))},t}(Pt);function As(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){var n;"function"==typeof e[e.length-1]&&(n=e.pop());var r=e;return t.lift(new xs(r,n))}}var xs=function(){function e(e,t){this.observables=e,this.project=t}return e.prototype.call=function(e,t){return t.subscribe(new Is(e,this.observables,this.project))},e}(),Is=function(e){function t(t,n,r){var i=e.call(this,t)||this;i.observables=n,i.project=r,i.toRespond=[];var o=n.length;i.values=new Array(o);for(var s=0;s<o;s++)i.toRespond.push(s);for(s=0;s<o;s++){var a=n[s];i.add(Wt(i,a,void 0,s))}return i}return X(t,e),t.prototype.notifyNext=function(e,t,n){this.values[n]=t;var r=this.toRespond;if(r.length>0){var i=r.indexOf(n);-1!==i&&r.splice(i,1)}},t.prototype.notifyComplete=function(){},t.prototype._next=function(e){if(0===this.toRespond.length){var t=[e].concat(this.values);this.project?this._tryProject(t):this.destination.next(t)}},t.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(Pt);function Ns(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(Nn.apply(void 0,[t].concat(e)))}}var Ms=Object.freeze({__proto__:null,audit:wr,auditTime:function(e,t){return void 0===t&&(t=bt),wr((function(){return xn(e,t)}))},buffer:function(e){return function(t){return t.lift(new Sr(e))}},bufferCount:kr,bufferTime:function(e){var t=arguments.length,n=bt;ze(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),function(t){return t.lift(new Nr(e,r,i,n))}},bufferToggle:function(e,t){return function(n){return n.lift(new Lr(e,t))}},bufferWhen:function(e){return function(t){return t.lift(new Ur(e))}},catchError:Vr,combineAll:function(e){return function(t){return t.lift(new zt(e))}},combineLatest:Hr,concat:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return t.lift.call(ln.apply(void 0,[t].concat(e)))}},concatAll:cn,concatMap:Wr,concatMapTo:function(e,t){return Wr((function(){return e}),t)},count:function(e){return function(t){return t.lift(new Gr(e,t))}},debounce:function(e){return function(t){return t.lift(new Jr(e))}},debounceTime:Qr,defaultIfEmpty:Zr,delay:function(e,t){void 0===t&&(t=bt);var n=vr(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new ni(n,t))}},delayWhen:function(e,t){return t?function(n){return new ai(n,t).lift(new oi(e))}:function(t){return t.lift(new oi(e))}},dematerialize:function(){return function(e){return e.lift(new ci)}},distinct:fi,distinctUntilChanged:di,distinctUntilKeyChanged:function(e,t){return di((function(n,r){return t?t(n[e],r[e]):n[e]===r[e]}))},elementAt:function(e,t){if(e<0)throw new Ot;var n=arguments.length>=2;return function(r){return r.pipe(wn((function(t,n){return n===e})),wi(1),n?Zr(t):mi((function(){return new Ot})))}},endWith:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return ln(t,Xe.apply(void 0,e))}},every:function(e,t){return function(n){return n.lift(new Si(e,t,n))}},exhaust:function(){return function(e){return e.lift(new ki)}},exhaustMap:function e(t,n){return n?function(r){return r.pipe(e((function(e,r){return Zt(t(e,r)).pipe(kt((function(t,i){return n(e,t,r,i)})))})))}:function(e){return e.lift(new xi(t))}},expand:function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),t=(t||0)<1?Number.POSITIVE_INFINITY:t,function(r){return r.lift(new Ni(e,t,n))}},filter:wn,finalize:Ci,find:function(e,t){if("function"!=typeof e)throw new TypeError("predicate is not a function");return function(n){return n.lift(new ji(e,n,!1,t))}},findIndex:function(e,t){return function(n){return n.lift(new ji(e,n,!0,t))}},first:function(e,t){var n=arguments.length>=2;return function(r){return r.pipe(e?wn((function(t,n){return e(t,n,r)})):ve,wi(1),n?Zr(t):mi((function(){return new St})))}},groupBy:Me,ignoreElements:function(){return function(e){return e.lift(new qi)}},isEmpty:function(){return function(e){return e.lift(new Di)}},last:function(e,t){var n=arguments.length>=2;return function(r){return r.pipe(e?wn((function(t,n){return e(t,n,r)})):ve,Fi(1),n?Zr(t):mi((function(){return new St})))}},map:kt,mapTo:Wi,materialize:function(){return function(e){return e.lift(new Ji)}},max:function(e){return Qi("function"==typeof e?function(t,n){return e(t,n)>0?t:n}:function(e,t){return e>t?e:t})},merge:Ki,mergeAll:un,mergeMap:rn,flatMap:an,mergeMapTo:Xi,mergeScan:function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),function(r){return r.lift(new $i(e,t,n))}},min:function(e){return Qi("function"==typeof e?function(t,n){return e(t,n)<0?t:n}:function(e,t){return e<t?e:t})},multicast:eo,observeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new tt(e,t))}},onErrorResumeNext:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 1===e.length&&ie(e[0])&&(e=e[0]),function(t){return t.lift(new no(e))}},pairwise:function(){return function(e){return e.lift(new io)}},partition:function(e,t){return function(n){return[wn(e,t)(n),wn(_n(e,t))(n)]}},pluck:so,publish:uo,publishBehavior:function(e){return function(t){return eo(new qe(e))(t)}},publishLast:function(){return function(e){return eo(new st)(e)}},publishReplay:co,race:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return function(t){return 1===e.length&&ie(e[0])&&(e=e[0]),t.lift.call(Sn.apply(void 0,[t].concat(e)))}},reduce:Qi,repeat:lo,repeatWhen:function(e){return function(t){return t.lift(new ho(e))}},retry:function(e){return void 0===e&&(e=-1),function(t){return t.lift(new bo(e,t))}},retryWhen:function(e){return function(t){return t.lift(new go(e,t))}},refCount:Te,sample:function(e){return function(t){return t.lift(new _o(e))}},sampleTime:function(e,t){return void 0===t&&(t=bt),function(n){return n.lift(new Eo(e,t))}},scan:sr,sequenceEqual:function(e,t){return function(n){return n.lift(new To(e,t))}},share:Io,shareReplay:No,single:function(e){return function(t){return t.lift(new Mo(e,t))}},skip:Ro,skipLast:function(e){return function(t){return t.lift(new Lo(e))}},skipUntil:Uo,skipWhile:function(e){return function(t){return t.lift(new Fo(e))}},startWith:Ho,subscribeOn:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new Wo(e,t))}},switchAll:function(){return Go(ve)},switchMap:Go,switchMapTo:Yo,take:wi,takeLast:Fi,takeUntil:Qo,takeWhile:function(e,t){return void 0===t&&(t=!1),function(n){return n.lift(new $o(e,t))}},tap:es,throttle:function(e,t){return void 0===t&&(t=lr),function(n){return n.lift(new fr(e,!!t.leading,!!t.trailing))}},throttleTime:rs,throwIfEmpty:mi,timeInterval:function(e){return void 0===e&&(e=bt),function(t){return fn((function(){return t.pipe(sr((function(t,n){var r=t.current;return{value:n,current:e.now(),last:r}}),{current:e.now(),value:void 0,last:void 0}),kt((function(e){var t=e.current,n=e.last,r=e.value;return new cr(r,t-n)})))}))}},timeout:ls,timeoutWith:as,timestamp:function(e){return void 0===e&&(e=bt),kt((function(t){return new or(t,e.now())}))},toArray:function(){return Qi(fs,[])},window:ps,windowCount:function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new vs(e,t))}},windowTime:function(e){var t=bt,n=null,r=Number.POSITIVE_INFINITY;return ze(arguments[3])&&(t=arguments[3]),ze(arguments[2])?t=arguments[2]:vn(arguments[2])&&(r=Number(arguments[2])),ze(arguments[1])?t=arguments[1]:vn(arguments[1])&&(n=Number(arguments[1])),function(i){return i.lift(new ms(e,n,r,t))}},windowToggle:function(e,t){return function(n){return n.lift(new Os(e,t))}},windowWhen:function(e){return function(t){return t.lift(new Ts(e))}},withLatestFrom:As,zip:Ns,zipAll:function(e){return function(t){return t.lift(new Mn(e))}}}),Cs=A(Ms),Rs=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.buffer=function(e){return Cs.buffer(e)(this)}})),Ps=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.buffer=Rs.buffer})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferCount=function(e,t){return void 0===t&&(t=null),Cs.bufferCount(e,t)(this)}}))),js=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferCount=Ps.bufferCount})),A(mr)),Ls=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferTime=function(e){var t=arguments.length,n=gr.asyncScheduler;js.isScheduler(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),Cs.bufferTime(e,r,i,n)(this)}})),qs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferTime=Ls.bufferTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferToggle=function(e,t){return Cs.bufferToggle(e,t)(this)}}))),Us=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferToggle=qs.bufferToggle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.bufferWhen=function(e){return Cs.bufferWhen(e)(this)}}))),Ds=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.bufferWhen=Us.bufferWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._catch=function(e){return Cs.catchError(e)(this)}}))),Vs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.catch=Ds._catch,gr.Observable.prototype._catch=Ds._catch})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineAll=function(e){return Cs.combineAll(e)(this)}}))),Fs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.combineAll=Vs.combineAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineLatest=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&js.isArray(e[0])&&(e=e[0].slice()),this.lift.call(gr.of.apply(void 0,[this].concat(e)),new js.CombineLatestOperator(n))}}))),Bs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.combineLatest=Fs.combineLatest})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concat=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(gr.concat.apply(void 0,[this].concat(e)))}}))),Hs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concat=Bs.concat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatAll=function(){return Cs.concatAll()(this)}}))),Ws=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concatAll=Hs.concatAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatMap=function(e){return Cs.concatMap(e)(this)}}))),Gs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concatMap=Ws.concatMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.concatMapTo=function(e){return Cs.concatMapTo(e)(this)}}))),zs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.concatMapTo=Gs.concatMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.count=function(e){return Cs.count(e)(this)}}))),Js=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.count=zs.count})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.dematerialize=function(){return Cs.dematerialize()(this)}}))),Ys=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.dematerialize=Js.dematerialize})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debounce=function(e){return Cs.debounce(e)(this)}}))),Qs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.debounce=Ys.debounce})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debounceTime=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.debounceTime(e,t)(this)}}))),Ks=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.debounceTime=Qs.debounceTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.defaultIfEmpty=function(e){return void 0===e&&(e=null),Cs.defaultIfEmpty(e)(this)}}))),Xs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.defaultIfEmpty=Ks.defaultIfEmpty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.delay=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.delay(e,t)(this)}}))),$s=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.delay=Xs.delay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.delayWhen=function(e,t){return Cs.delayWhen(e,t)(this)}}))),Zs=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.delayWhen=$s.delayWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinct=function(e,t){return Cs.distinct(e,t)(this)}}))),ea=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.distinct=Zs.distinct})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinctUntilChanged=function(e,t){return Cs.distinctUntilChanged(e,t)(this)}}))),ta=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.distinctUntilChanged=ea.distinctUntilChanged})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.distinctUntilKeyChanged=function(e,t){return Cs.distinctUntilKeyChanged(e,t)(this)}}))),na=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.distinctUntilKeyChanged=ta.distinctUntilKeyChanged})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._do=function(e,t,n){return Cs.tap(e,t,n)(this)}}))),ra=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.do=na._do,gr.Observable.prototype._do=na._do})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.exhaust=function(){return Cs.exhaust()(this)}}))),ia=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.exhaust=ra.exhaust})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.exhaustMap=function(e){return Cs.exhaustMap(e)(this)}}))),oa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.exhaustMap=ia.exhaustMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.expand=function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=void 0),t=(t||0)<1?Number.POSITIVE_INFINITY:t,Cs.expand(e,t,n)(this)}}))),sa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.expand=oa.expand})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.elementAt=function(e,t){return Cs.elementAt.apply(void 0,arguments)(this)}}))),aa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.elementAt=sa.elementAt})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.filter=function(e,t){return Cs.filter(e,t)(this)}}))),ua=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.filter=aa.filter})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._finally=function(e){return Cs.finalize(e)(this)}}))),ca=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.finally=ua._finally,gr.Observable.prototype._finally=ua._finally})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.find=function(e,t){return Cs.find(e,t)(this)}}))),la=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.find=ca.find})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.findIndex=function(e,t){return Cs.findIndex(e,t)(this)}}))),fa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.findIndex=la.findIndex})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.first=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.first.apply(void 0,e)(this)}}))),pa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.first=fa.first})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.groupBy=function(e,t,n,r){return Cs.groupBy(e,t,n,r)(this)}}))),ha=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.groupBy=pa.groupBy})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ignoreElements=function(){return Cs.ignoreElements()(this)}}))),da=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.ignoreElements=ha.ignoreElements})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.isEmpty=function(){return Cs.isEmpty()(this)}}))),va=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.isEmpty=da.isEmpty})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.audit=function(e){return Cs.audit(e)(this)}}))),ba=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.audit=va.audit})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.auditTime=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.auditTime(e,t)(this)}}))),ma=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.auditTime=ba.auditTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.last=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.last.apply(void 0,e)(this)}}))),ga=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.last=ma.last})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.letProto=function(e){return e(this)}}))),ya=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.let=ga.letProto,gr.Observable.prototype.letBind=ga.letProto})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.every=function(e,t){return Cs.every(e,t)(this)}}))),_a=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.every=ya.every})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.map=function(e,t){return Cs.map(e,t)(this)}}))),wa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.map=_a.map})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mapTo=function(e){return Cs.mapTo(e)(this)}}))),Ea=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mapTo=wa.mapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.materialize=function(){return Cs.materialize()(this)}}))),Oa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.materialize=Ea.materialize})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.max=function(e){return Cs.max(e)(this)}}))),Sa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.max=Oa.max})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.merge=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(gr.merge.apply(void 0,[this].concat(e)))}}))),Ta=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.merge=Sa.merge})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeAll=function(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),Cs.mergeAll(e)(this)}}))),ka=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mergeAll=Ta.mergeAll})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeMap=function(e,t){return void 0===t&&(t=Number.POSITIVE_INFINITY),Cs.mergeMap(e,t)(this)}}))),Aa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mergeMap=ka.mergeMap,gr.Observable.prototype.flatMap=ka.mergeMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeMapTo=function(e,t){return void 0===t&&(t=Number.POSITIVE_INFINITY),Cs.mergeMapTo(e,t)(this)}}))),xa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.flatMapTo=Aa.mergeMapTo,gr.Observable.prototype.mergeMapTo=Aa.mergeMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.mergeScan=function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),Cs.mergeScan(e,t,n)(this)}}))),Ia=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.mergeScan=xa.mergeScan})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.min=function(e){return Cs.min(e)(this)}}))),Na=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.min=Ia.min})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.multicast=function(e,t){return Cs.multicast(e,t)(this)}}))),Ma=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.multicast=Na.multicast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.observeOn=function(e,t){return void 0===t&&(t=0),Cs.observeOn(e,t)(this)}}))),Ca=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.observeOn=Ma.observeOn})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.onErrorResumeNext=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.onErrorResumeNext.apply(void 0,e)(this)}}))),Ra=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.onErrorResumeNext=Ca.onErrorResumeNext})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.pairwise=function(){return Cs.pairwise()(this)}}))),Pa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.pairwise=Ra.pairwise})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.partition=function(e,t){return Cs.partition(e,t)(this)}}))),ja=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.partition=Pa.partition})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.pluck=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.pluck.apply(void 0,e)(this)}}))),La=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.pluck=ja.pluck})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publish=function(e){return Cs.publish(e)(this)}}))),qa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publish=La.publish})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishBehavior=function(e){return Cs.publishBehavior(e)(this)}}))),Ua=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publishBehavior=qa.publishBehavior})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishReplay=function(e,t,n,r){return Cs.publishReplay(e,t,n,r)(this)}}))),Da=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publishReplay=Ua.publishReplay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.publishLast=function(){return Cs.publishLast()(this)}}))),Va=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.publishLast=Da.publishLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.race=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.race.apply(void 0,e)(this)}}))),Fa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.race=Va.race})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.reduce=function(e,t){return arguments.length>=2?Cs.reduce(e,t)(this):Cs.reduce(e)(this)}}))),Ba=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.reduce=Fa.reduce})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.repeat=function(e){return void 0===e&&(e=-1),Cs.repeat(e)(this)}}))),Ha=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.repeat=Ba.repeat})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.repeatWhen=function(e){return Cs.repeatWhen(e)(this)}}))),Wa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.repeatWhen=Ha.repeatWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.retry=function(e){return void 0===e&&(e=-1),Cs.retry(e)(this)}}))),Ga=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.retry=Wa.retry})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.retryWhen=function(e){return Cs.retryWhen(e)(this)}}))),za=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.retryWhen=Ga.retryWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sample=function(e){return Cs.sample(e)(this)}}))),Ja=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.sample=za.sample})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sampleTime=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.sampleTime(e,t)(this)}}))),Ya=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.sampleTime=Ja.sampleTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.scan=function(e,t){return arguments.length>=2?Cs.scan(e,t)(this):Cs.scan(e)(this)}}))),Qa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.scan=Ya.scan})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sequenceEqual=function(e,t){return Cs.sequenceEqual(e,t)(this)}}))),Ka=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.sequenceEqual=Qa.sequenceEqual})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.share=function(){return Cs.share()(this)}}))),Xa=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.share=Ka.share})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.shareReplay=function(e,t,n){return e&&"object"===o(e)?Cs.shareReplay(e)(this):Cs.shareReplay(e,t,n)(this)}}))),$a=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.shareReplay=Xa.shareReplay})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.single=function(e){return Cs.single(e)(this)}}))),Za=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.single=$a.single})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skip=function(e){return Cs.skip(e)(this)}}))),eu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skip=Za.skip})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipLast=function(e){return Cs.skipLast(e)(this)}}))),tu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skipLast=eu.skipLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipUntil=function(e){return Cs.skipUntil(e)(this)}}))),nu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skipUntil=tu.skipUntil})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.skipWhile=function(e){return Cs.skipWhile(e)(this)}}))),ru=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.skipWhile=nu.skipWhile})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.startWith=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.startWith.apply(void 0,e)(this)}}))),iu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.startWith=ru.startWith})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.subscribeOn=function(e,t){return void 0===t&&(t=0),Cs.subscribeOn(e,t)(this)}}))),ou=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.subscribeOn=iu.subscribeOn})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._switch=function(){return Cs.switchAll()(this)}}))),su=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.switch=ou._switch,gr.Observable.prototype._switch=ou._switch})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.switchMap=function(e){return Cs.switchMap(e)(this)}}))),au=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.switchMap=su.switchMap})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.switchMapTo=function(e){return Cs.switchMapTo(e)(this)}}))),uu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.switchMapTo=au.switchMapTo})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.take=function(e){return Cs.take(e)(this)}}))),cu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.take=uu.take})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeLast=function(e){return Cs.takeLast(e)(this)}}))),lu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.takeLast=cu.takeLast})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeUntil=function(e){return Cs.takeUntil(e)(this)}}))),fu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.takeUntil=lu.takeUntil})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.takeWhile=function(e){return Cs.takeWhile(e)(this)}}))),pu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.takeWhile=fu.takeWhile})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.throttle=function(e,t){return void 0===t&&(t=js.defaultThrottleConfig),Cs.throttle(e,t)(this)}}))),hu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.throttle=pu.throttle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.throttleTime=function(e,t,n){return void 0===t&&(t=gr.asyncScheduler),void 0===n&&(n=js.defaultThrottleConfig),Cs.throttleTime(e,t,n)(this)}}))),du=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.throttleTime=hu.throttleTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeInterval=function(e){return void 0===e&&(e=gr.asyncScheduler),Cs.timeInterval(e)(this)}}))),vu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timeInterval=du.timeInterval})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeout=function(e,t){return void 0===t&&(t=gr.asyncScheduler),Cs.timeout(e,t)(this)}}))),bu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timeout=vu.timeout})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timeoutWith=function(e,t,n){return void 0===n&&(n=gr.asyncScheduler),Cs.timeoutWith(e,t,n)(this)}}))),mu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timeoutWith=bu.timeoutWith})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timestamp=function(e){return void 0===e&&(e=gr.asyncScheduler),Cs.timestamp(e)(this)}}))),gu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.timestamp=mu.timestamp})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(){return Cs.toArray()(this)}}))),yu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.toArray=gu.toArray})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.window=function(e){return Cs.window(e)(this)}}))),_u=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.window=yu.window})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowCount=function(e,t){return void 0===t&&(t=0),Cs.windowCount(e,t)(this)}}))),wu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowCount=_u.windowCount})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowTime=function(e){var t=gr.asyncScheduler,n=null,r=Number.POSITIVE_INFINITY;return js.isScheduler(arguments[3])&&(t=arguments[3]),js.isScheduler(arguments[2])?t=arguments[2]:js.isNumeric(arguments[2])&&(r=Number(arguments[2])),js.isScheduler(arguments[1])?t=arguments[1]:js.isNumeric(arguments[1])&&(n=Number(arguments[1])),Cs.windowTime(e,n,r,t)(this)}}))),Eu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowTime=wu.windowTime})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowToggle=function(e,t){return Cs.windowToggle(e,t)(this)}}))),Ou=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowToggle=Eu.windowToggle})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.windowWhen=function(e){return Cs.windowWhen(e)(this)}}))),Su=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.windowWhen=Ou.windowWhen})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.withLatestFrom=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cs.withLatestFrom.apply(void 0,e)(this)}}))),Tu=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.withLatestFrom=Su.withLatestFrom})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.zipProto=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this.lift.call(gr.zip.apply(void 0,[this].concat(e)))}}))),ku=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.zip=Tu.zipProto})),k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.zipAll=function(e){return Cs.zipAll(e)(this)}}))),Au=(k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),gr.Observable.prototype.zipAll=ku.zipAll})),function(){return function(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.subscribedFrame=e,this.unsubscribedFrame=t}}()),xu=function(e){function t(t,n){var r=e.call(this,(function(e){var t=this,n=t.logSubscribedFrame(),r=new ae;return r.add(new ae((function(){t.logUnsubscribedFrame(n)}))),t.scheduleMessages(e),r}))||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}return X(t,e),t.prototype.scheduleMessages=function(e){for(var t=this.messages.length,n=0;n<t;n++){var r=this.messages[n];e.add(this.scheduler.schedule((function(e){var t=e.message,n=e.subscriber;t.notification.observe(n)}),r.frame,{message:r,subscriber:e}))}},t}(ge),Iu=function(e){function t(t,n){var r=e.call(this)||this;return r.messages=t,r.subscriptions=[],r.scheduler=n,r}return X(t,e),t.prototype._subscribe=function(t){var n=this,r=n.logSubscribedFrame(),i=new ae;return i.add(new ae((function(){n.logUnsubscribedFrame(r)}))),i.add(e.prototype._subscribe.call(this,t)),i},t.prototype.setup=function(){for(var e=this,t=e.messages.length,n=0;n<t;n++)!function(){var t=e.messages[n];e.scheduler.schedule((function(){t.notification.observe(e)}),t.frame)}()},t}(Oe),Nu=function(e){function t(t){var n=e.call(this,wt,750)||this;return n.assertDeepEqual=t,n.hotObservables=[],n.coldObservables=[],n.flushTests=[],n.runMode=!1,n}return X(t,e),t.prototype.createTime=function(e){var n=e.indexOf("|");if(-1===n)throw new Error('marble diagram for time should have a completion marker "|"');return n*t.frameTimeFactor},t.prototype.createColdObservable=function(e,n,r){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new xu(i,this);return this.coldObservables.push(o),o},t.prototype.createHotObservable=function(e,n,r){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r,void 0,this.runMode),o=new Iu(i,this);return this.hotObservables.push(o),o},t.prototype.materializeInnerObservable=function(e,t){var n=this,r=[];return e.subscribe((function(e){r.push({frame:n.frame-t,notification:et.createNext(e)})}),(function(e){r.push({frame:n.frame-t,notification:et.createError(e)})}),(function(){r.push({frame:n.frame-t,notification:et.createComplete()})})),r},t.prototype.expectObservable=function(e,n){var r=this;void 0===n&&(n=null);var i,o=[],s={actual:o,ready:!1},a=t.parseMarblesAsSubscriptions(n,this.runMode),u=a.subscribedFrame===Number.POSITIVE_INFINITY?0:a.subscribedFrame,c=a.unsubscribedFrame;this.schedule((function(){i=e.subscribe((function(e){var t=e;e instanceof ge&&(t=r.materializeInnerObservable(t,r.frame)),o.push({frame:r.frame,notification:et.createNext(t)})}),(function(e){o.push({frame:r.frame,notification:et.createError(e)})}),(function(){o.push({frame:r.frame,notification:et.createComplete()})}))}),u),c!==Number.POSITIVE_INFINITY&&this.schedule((function(){return i.unsubscribe()}),c),this.flushTests.push(s);var l=this.runMode;return{toBe:function(e,n,r){s.ready=!0,s.expected=t.parseMarbles(e,n,r,!0,l)}}},t.prototype.expectSubscriptions=function(e){var n={actual:e,ready:!1};this.flushTests.push(n);var r=this.runMode;return{toBe:function(e){var i="string"==typeof e?[e]:e;n.ready=!0,n.expected=i.map((function(e){return t.parseMarblesAsSubscriptions(e,r)}))}}},t.prototype.flush=function(){for(var t=this,n=this.hotObservables;n.length>0;)n.shift().setup();e.prototype.flush.call(this),this.flushTests=this.flushTests.filter((function(e){return!e.ready||(t.assertDeepEqual(e.actual,e.expected),!1)}))},t.parseMarblesAsSubscriptions=function(e,t){var n=this;if(void 0===t&&(t=!1),"string"!=typeof e)return new Au(Number.POSITIVE_INFINITY);for(var r,i=e.length,o=-1,s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,u=0,c=function(i){var c=u,f=function(e){c+=e*n.frameTimeFactor},p=e[i];switch(p){case" ":t||f(1);break;case"-":f(1);break;case"(":o=u,f(1);break;case")":o=-1,f(1);break;case"^":if(s!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");s=o>-1?o:u,f(1);break;case"!":if(a!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");a=o>-1?o:u;break;default:if(t&&p.match(/^[0-9]$/)&&(0===i||" "===e[i-1])){var h=e.slice(i).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(h){i+=h[0].length-1;var d=parseFloat(h[1]),v=void 0;switch(h[2]){case"ms":v=d;break;case"s":v=1e3*d;break;case"m":v=1e3*d*60}f(v/l.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+p+"'.")}u=c,r=i},l=this,f=0;f<i;f++)c(f),f=r;return a<0?new Au(s):new Au(s,a)},t.parseMarbles=function(e,t,n,r,i){var s=this;if(void 0===r&&(r=!1),void 0===i&&(i=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var a,u=e.length,c=[],l=i?e.replace(/^[ ]+/,"").indexOf("^"):e.indexOf("^"),f=-1===l?0:l*-this.frameTimeFactor,p="object"!==o(t)?function(e){return e}:function(e){return r&&t[e]instanceof xu?t[e].messages:t[e]},h=-1,d=function(t){var r=f,o=function(e){r+=e*s.frameTimeFactor},u=void 0,l=e[t];switch(l){case" ":i||o(1);break;case"-":o(1);break;case"(":h=f,o(1);break;case")":h=-1,o(1);break;case"|":u=et.createComplete(),o(1);break;case"^":o(1);break;case"#":u=et.createError(n||"error"),o(1);break;default:if(i&&l.match(/^[0-9]$/)&&(0===t||" "===e[t-1])){var d=e.slice(t).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(d){t+=d[0].length-1;var b=parseFloat(d[1]),m=void 0;switch(d[2]){case"ms":m=b;break;case"s":m=1e3*b;break;case"m":m=1e3*b*60}o(m/v.frameTimeFactor);break}}u=et.createNext(p(l)),o(1)}u&&c.push({frame:h>-1?h:f,notification:u}),f=r,a=t},v=this,b=0;b<u;b++)d(b),b=a;return c},t.prototype.run=function(e){var n=t.frameTimeFactor,r=this.maxFrames;t.frameTimeFactor=1,this.maxFrames=Number.POSITIVE_INFINITY,this.runMode=!0,Fe.delegate=this;var i={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this)};try{var o=e(i);return this.flush(),o}finally{t.frameTimeFactor=n,this.maxFrames=r,this.runMode=!1,Fe.delegate=void 0}},t}(_t),Mu=A(Object.freeze({__proto__:null,TestScheduler:Nu})),Cu=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Observable=gr.Observable,t.Subject=gr.Subject,t.AnonymousSubject=js.AnonymousSubject;var n=js;t.config=n.config;var r=gr;t.Subscription=r.Subscription,t.ReplaySubject=r.ReplaySubject,t.BehaviorSubject=r.BehaviorSubject,t.Notification=r.Notification,t.EmptyError=r.EmptyError,t.ArgumentOutOfRangeError=r.ArgumentOutOfRangeError,t.ObjectUnsubscribedError=r.ObjectUnsubscribedError,t.UnsubscriptionError=r.UnsubscriptionError,t.pipe=r.pipe,t.TestScheduler=Mu.TestScheduler;var i=gr;t.Subscriber=i.Subscriber,t.AsyncSubject=i.AsyncSubject,t.ConnectableObservable=i.ConnectableObservable,t.TimeoutError=i.TimeoutError,t.VirtualTimeScheduler=i.VirtualTimeScheduler,t.AjaxResponse=yr.AjaxResponse,t.AjaxError=yr.AjaxError,t.AjaxTimeoutError=yr.AjaxTimeoutError;var o=gr,s=js,a=js;t.TimeInterval=a.TimeInterval,t.Timestamp=a.Timestamp,t.operators=Cs;var u={asap:o.asapScheduler,queue:o.queueScheduler,animationFrame:o.animationFrameScheduler,async:o.asyncScheduler};t.Scheduler=u;var c={rxSubscriber:s.rxSubscriber,observable:s.observable,iterator:s.iterator};t.Symbol=c})),Ru=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Cu)})),Pu=T(Ru),ju=sm.visitorId,Lu=function(){return ju},qu=new Pu.Subject(1),Uu=function(){return qu.asObservable().startWith(Lu()).distinctUntilChanged()},Du=function(e){ju=e,qu.next(e),sm.visitorId=e},Vu=function(){return sm.siteId},Fu=new Pu.BehaviorSubject(sm.authenticatedExternally||!1),Bu=function(){return Fu.value},Hu=function(e){Fu.next(Boolean(e))},Wu=new function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.publishInterval,n=void 0===t?3e3:t,r=e.maximumBatchSize,i=void 0===r?50:r,o=e.maximumBufferSize,s=void 0===o?1e3:o,a=e.maximumConsecutiveRetries,u=void 0===a?10:a,c=e.transports,l=void 0===c?[]:c,f=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.position;void 0===n&&(n=l.length),l.splice(n,0,e)},p={},h={},d=function e(t){var n=t.transports,r=t.payload;return 0===n.length?Promise.reject():n[0].process({payload:r}).catch((function(){return e({payload:r,transports:n.slice(1)})}))},v=function(e){return 0===Object.keys(e).length||W(e).every((function(e){return 0===e.length}))},b=function(){var e={};return Object.keys(p).forEach((function(t){e[t]=p[t].splice(0,i)})),v(e)?Promise.resolve():d({transports:l,payload:e}).then((function(){return Object.keys(h).forEach((function(e){return h[e]=0})),Promise.resolve()})).catch((function(){return Object.keys(e).forEach((function(t){h[t]++,h[t]<u?p[t]=e[t].concat(p[t]):h[t]=0})),Promise.reject()}))},m=!1,g=null,y=!1,_=function(){if(m)throw new Error("Publisher is already started");m=!0,g=setInterval((function(){y||(y=!0,b().then((function(){return y=!1}),(function(){return y=!1})))}),n),window.addEventListener("unload",b)},w=function(){m=!1,clearInterval(g)},E=function(e,t){p[e]||(h[e]||(h[e]=0),p[e]=[]),p[e].push(t),p[e].splice(s)};return{start:_,stop:w,addToBucket:E,flush:b,buckets:p,addTransport:f,transports:l}}({publishInterval:sm.conf.log_publish_interval_ms||3e3});Wu.start(),Wu.addTransport(new G.HttpTransport({url:sm.conf.client_logger_url,method:"POST",encode:function(e){var t=e.logs,n=e.stats;return JSON.stringify({logs:t||[],stats:n||[]})}}));sm.logger=new function e(t){var n=arguments,r=t.publisher,i=t.tags,o=void 0===i?{}:i,s=t.currentIsoDate,a=void 0===s?function(){return(new Date).toISOString()}:s,u=t.maxObjectDepth,c=void 0===u?3:u,l=t.maxArrayLength,f=void 0===l?10:l,p=t.windowConsole,h=void 0===p?window.console:p,d=t.localStorage,v=void 0===d?window.localStorage:d,b=t.liveLogsKey,m=void 0===b?"sm.live_logs":b,g=t.liveLogsEnabled,y=void 0!==g&&g,_=new D,w=function(e){return r.addToBucket("logs",e)},E=function(){return h&&(y||"1"===v[m])},O=function(e,t){for(var n=[],r=0;r<e.length;r++){if(r===f){var i=e[r-1];Array.isArray(i)?n.push(["-pruned-"]):i&&"object"===U(i)?n.push({pruned:!0}):n.push("-pruned-");break}n.push(k(e[r],t+1))}return n},S=function(e,t){if(c===t)return"-pruned-";var n={};return B(e,(function(r){n[r]=k(e[r],t+1)})),n},T=function(e){return{message:e.message,stack:e.stack}},k=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return-1!==H.indexOf(U(e))?e:"function"==typeof e?"<Function>":e instanceof Error?T(e):Array.isArray(e)?O(e,t):S(e,t)},A=function(e){return function(){if(E()){var t=h[e]||h.log;t.apply(t,arguments)}var n=Array.prototype.slice.call(arguments).map((function(e){return k(e,0)})).filter((function(e){return void 0!==e})),r=F(o);r=V(r,{level:e,attributes:n,timestamp:a()}),"error"===e?r=V(r,{breadcrumbs:_.list}):_.add(r),w(r)}},x=function(e){return e.filter((function(e){return e instanceof Error}))[0]};this.debug=A("debug"),this.log=A("info"),this.info=A("info"),this.warn=A("warn"),this.error=function(){var e=Array.prototype.slice.call(arguments),t=x(e);if(!t||!t._acked)return"string"!=typeof e[0]||t||(e[0]=new Error(e[0])),A("error").apply(null,e)},this.withTags=function(t){return new e(V(n[0],{tags:V(o,t)}))},this.enableLiveLogs=function(){return v[m]="1"}}({publisher:Wu,tags:{actor:"visitor",site_id:sm.siteId,visitor_id:function(){return Lu()},tab_id:function(){return sm.tabId},user_agent:window.navigator.userAgent,url:function(){return String(window.location)},client_version:function(e){e||(e="visitor/bootstrapper-544677dd8.js");var t=e.split("-")[1];if(t)return t.slice(0,-3)}()}});var Gu,zu=sm.logger,Ju=new Q(new function e(t){var n=t.publisher,r=t.globalTags,i=void 0===r?[]:r,o=function(e){return n.addToBucket("stats",e)},s=function(e,t,n,r){return r||(r=[]),{stat:e,params:[t,n,i.concat(r)]}};this.increment=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("increment",e,t,n))},this.decrement=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("decrement",e,t,n))},this.gauge=function(e,t,n){o(s("gauge",e,t,n))},this.histogram=function(e,t,n){o(s("histogram",e,t,n))},this.timing=function(e,t,n){o(s("timing",e,t,n))},this.set=function(e,t,n){o(s("set",e,t,n))},this.withTags=function(t){return new e({publisher:n,globalTags:i.concat(t)})}}({publisher:Wu,globalTags:["application:visitor","visitor_page_adaption:".concat(sm.conf.engagement.visitor_page_adaption),"site_id:".concat(sm.siteId)]}),(Gu={},{record:function(e){Gu[e]=Number(new Date)},currentLatencyFrom:function(e){var t=Gu[e];return t?Number(new Date)-t:-1}})),Yu="sm.app.visitor_api.dynamic_import",Qu="default"===sm.conf.communications.lib,Ku=function(e){return-1!==sm.conf.assets.server.indexOf("libs.")?"".concat(sm.conf.assets.server,"/").concat(e):[sm.conf.assets.server,sm.conf.assets.prepend||"/",e].join("")},Xu={Medra:{url:Qu?"https://libs.salemove.com/medra-5.5.2.min.js":sm.conf.communications.lib,returning:function(){return sm.Medra},integrity:Qu?j({name:"medra"}):null},Comms:{url:Ku("visitor_app/comms/app-544677dd8.js"),integrity:j({name:"comms"})},Cobra:{url:"".concat(sm.conf.cobra.lib.visitor,".js"),returning:function(){return sm.Cobra},integrity:j({name:"visitor_cobra"})},webcomponents:{url:Ku("visitor/webcomponents-544677dd8.js"),integrity:j({name:"webcomponents"})},webcomponents_es5:{url:Ku("visitor/webcomponents_es5-544677dd8.js"),integrity:j({name:"webcomponents_es5"})},legacy_webcomponents:{url:Ku("visitor/legacy_webcomponents-544677dd8.js"),integrity:j({name:"legacy_webcomponents"})}},$u={},Zu=function(e){var t,n=Xu,r=L,i=Ju,o=$u;"string"==typeof e?t=e:(t=e.target,e.loader&&(r=e.loader),e.possibleTargets&&(n=e.possibleTargets),e.stats&&(i=e.stats),e.loaded&&(o=e.loaded));var s=n[t];if(!s)return Pu.Observable.throw("Invalid target");if(o[t]){if(s.returning){var a=s.returning();return void 0===a?Pu.Observable.throw(new Error("An error occurred while loading ".concat(t,", as it is undefined"))):Pu.Observable.of(a)}return Pu.Observable.of(null)}return Pu.Observable.create((function(e){r({fileUrl:s.url,integrity:s.integrity,onAttempt:function(){i.increment(Yu,["action:attempted","module:".concat(t)])},onLoad:function(){if(o[t]=!0,s.returning){var n=s.returning();void 0===n?(i.increment(Yu,["action:failed","module:".concat(t)]),e.error(new Error("An error occurred while loading ".concat(t,", as it is undefined")))):(i.increment(Yu,["action:succeeded","module:".concat(t)]),e.next(n),e.complete())}else i.increment(Yu,["action:succeeded","module:".concat(t)]),e.next(),e.complete()},onError:function(){i.increment(Yu,["action:warning","module:".concat(t)])},onGiveUp:function(){i.increment(Yu,["action:failed","module:".concat(t)]);var n=new Error("Loading ".concat(t," failed"));zu.warn(n,{target:t}),n._acked=!0,e.error(n)},retryLimit:3,backoffDelay:500})}))},ec={MSG:{PROACTIVE_REQUEST:"proactive_call:request",PROACTIVE_ACCEPT:"proactive_call:accept",PROACTIVE_DECLINE:"proactive_call:decline",REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT:"reactive_engagement_request_timeout",ENGAGEMENT_PREPARE:"engagement:prepare",ENGAGEMENT_CLEANUP:"engagement:cleanup",DISCONNECT:"connection_lost",RECONNECTED:"connection_restored",MEDIA_SELECTED:"media_selected",ENGAGEMENT_TRANSFERRED:"engagement:transferred",ENGAGEMENT_END_POPUP_CLOSED:"engagement:end:popup:closed",PUBLIC:{ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_GET_AUDIO_TYPE:"sm:engagement:get_audio_type",ENGAGEMENT_GET_UPGRADE_MEDIA_TYPE:"sm:engagement:get_upgrade_media_type",ENGAGEMENT_MEDIA_UPGRADE_REQUEST:"sm:engagement:media_upgrade_request",ENGAGEMENT_SELECT_MEDIA_TYPE:"sm:engagement:select_media_type"},WILL_ASK_MEDIA_PERMISSION:"engagement:media_permission:will_ask",SHOW_PERMISSION_ARROW:"communication:show_permission_arrow",HIDE_PERMISSION_ARROW:"communication:hide_permission_arrow",ALLOW_STREAM:"engagement:media_permission:allow",DENY_STREAM:"engagement:media_permission:_deny",IS_ENGAGED:"engagement:is_engaged",PHONE_STATUSES:{CONNECTED:"connected",CONNECTING:"connecting"},ENGAGEMENT_REMOVE_AUDIO:"engagement:remove_audio"}},tc=new Pu.Subject;ec.vent={trigger:function(e,t){tc.next({eventName:e,eventBody:t})},observable:function(e){return tc.filter((function(t){return t.eventName===e})).map((function(e){return e.eventBody}))}};var nc={};ec.request=function(e,t){var n=nc[e];if(n)return n(t)},ec.reqres={setHandler:function(e,t){nc[e]=t},removeHandler:function(e){delete nc[e]}};var rc=[],ic=null,oc=function(){(ic=document.createElement("SPAN")).id="cobrowsing-mouse-container",document.body.appendChild(ic);var e=new MutationObserver((function(){var e,t,n=document.body.childNodes[document.body.childNodes.length-1];n!==ic&&-1===rc.indexOf(n)&&(e=document.body,(t=e.childNodes[e.childNodes.length-1])!==ic&&(rc.push(t),setTimeout((function(){rc=[]}),1e4),e.appendChild(ic)))}));return e.observe(document.body,{childList:!0}),{unsubscribe:function(){e.disconnect()}}},sc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Observable=gr.Observable})),ac=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(sc)})),uc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.combineLatest=gr.combineLatest})),cc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(uc)})),lc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.interval=gr.interval})),fc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(lc)})),pc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.from=gr.from})),hc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(pc)})),dc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Subject=gr.Subject})),vc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(dc)})),bc=function(){function e(t){var n=t.duration;s(this,e),this.duration=n}return u(e,[{key:"perform",value:function(){ec.vent.trigger("trigger_expand_reactive",{duration:this.duration})}}]),e}(),mc=function(){function e(t){var n=t.text,r=t.no_operators_online_text,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o}return u(e,[{key:"perform",value:function(){ec.vent.trigger("trigger_reactive_callout",{text:this.text,noOperatorsOnlineText:this.noOperatorsOnlineText,duration:this.duration,priority:this.priority})}}]),e}(),gc=function(){function e(t){var n=t.text;s(this,e),this.text=n}return u(e,[{key:"perform",value:function(){ec.vent.trigger("trigger_media_selection",{text:this.text,source:"callout"})}}]),e}(),yc=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){ec.vent.trigger("reactive_bar:enable")}}]),e}(),_c=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){ec.vent.trigger("reactive_bar:disable")}}]),e}(),wc=function(){function e(t){var n=t.vertical_offset,r=t.horizontal_offset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r}return u(e,[{key:"perform",value:function(){ec.vent.trigger("reactive_bar:set_position",{verticalOffset:this.verticalOffset,horizontalOffset:this.horizontalOffset})}}]),e}(),Ec=function(e){var t=e.category,n=e.action,r=e.label;zu.info("Tracking Google Analytics Event",{category:t,action:n,label:r}),window._gaq&&window._gaq.push?window._gaq.push(["_trackEvent",t,n,r]):"function"==typeof window.ga&&window.ga("send","event",t,n,r)},Oc=function(){function e(t){s(this,e),this.options=t}return u(e,[{key:"perform",value:function(){switch(this.options.provider){case"google":this.trackGoogle(this.options);break;case"omniture":this.trackOmniture(this.options);break;default:zu.error("Unknown analytics provider",this.options.provider)}}},{key:"trackGoogle",value:function(e){var t=e.category,n=e.action,r=e.fields;Ec({category:t,action:n,label:r?JSON.stringify(r):void 0})}},{key:"trackOmniture",value:function(e){!function(e){var t=e.tagFunction,n=e.tagId,r=e.params;zu.info("Tracking Omniture Analytics Event",{tagFunction:t,tagId:n,params:r});try{"function"==typeof window[t]&&window[t](n,I.clone(r))}catch(e){zu.warn("Client error occurred during Omniture event tracking",e)}}({tagFunction:e.tag_function,tagId:e.tag_id,params:e.fields})}}]),e}(),Sc=function(e,t){var n=t.operator;return n&&-1!==n.teamNames.indexOf(e)},Tc=function(){function e(t){var n=t.operator_team;s(this,e),this.operatorTeam=n}return u(e,[{key:"perform",value:function(e){e.cobraObservable.filter(I.partial(Sc,this.operatorTeam)).pluck("cobraSourceInitializer").subscribe((function(e){return e.block()}))}}]),e}(),kc=function(){function e(t){var n=t.text,r=t.duration;s(this,e),this.text=n,this.duration=r}return u(e,[{key:"perform",value:function(){ec.vent.trigger("show_engagement_invitation",{text:this.text,duration:this.duration})}}]),e}(),Ac=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.empty=gr.empty})),xc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ac)})),Ic=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.of=gr.of})),Nc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ic)})),Mc=I.compose(I.isEmpty,I.symmetricDifference);(sm.BusinessRules={}).ACTION_TYPES={SHOW_OPERATORS_IN_SELECTOR_V2:"show_operators_in_selector_v2"};var Cc=function(e){var t=e.event,n=e.site_id,r=e.tab_id;return"business_rules"===t&&n===sm.siteId&&(!r||r===sm.tabId)},Rc=function(){function e(){s(this,e)}return u(e,[{key:"perform",value:function(){}}]),e}(),Pc=function(){function e(t){s(this,e),this.expectedAction=t}return u(e,[{key:"perform",value:function(){throw new Error("No handler found for action ".concat(this.expectedAction))}}]),e}(),jc={expand_operator_selector:bc,reactive_callout:mc,media_selection:gc,show_reactive_tab_only_when:yc,hide_reactive_tab:_c,set_reactive_tab_position:wc,show_operators_in_selector_v2:Rc,send_analytics_event:Oc,hide_page_from_operators:Tc,show_engagement_invitation:kc},Lc=new vc.Subject,qc=Lc.pipe(co());qc.connect();var Uc=function(){function e(t){var n=t.volatileNotifications,r=t.cobraObservable,i=t.routingObservable;s(this,e),this._performAction=this._performAction.bind(this),this.cobraObservable=r,this.routingObservable=i,this.actionsObservable=qc.pipe(Ki(n.pipe(wn(Cc),kt(I.prop("payload"))))),this._routingUpdateTimeout=sm.conf.overseer.routing_update_timeout_in_milliseconds}return u(e,[{key:"start",value:function(){return this.actionsObservable.subscribe(this._performAction)}},{key:"_performAction",value:function(e){var t=e.type,n=e.rule_id,r=e.browser_event_conditions,i=this.cobraObservable,o=function(e,t){var n=jc[e];return n?new n(t):new Pc(e)}(t,e);(function(e){var t=e.expectedQueueIds,n=e.routingObservable,r=e.routingUpdateTimeout,i=e.loggerMetadata,o=void 0===i?{}:i,s=e.logger,a=void 0===s?zu:s;return t?n.pipe(wn((function(e){var n=e.queue_ids;return!(!n||!t)&&Mc(n,t)})),wi(1),ls(r),Vr((function(e){return"TimeoutError"===e.name?a.warn("In-browser business rule action not triggered, expected queue ids not received",I.merge(o,{queue_ids:t})):a.error("In-browser business rule action triggering error",e),xc.empty()}))):Nc.of(null)})({expectedQueueIds:I.prop("queue_ids",r),routingUpdateTimeout:this._routingUpdateTimeout,routingObservable:this.routingObservable,loggerMetadata:{type:t,rule_id:n}}).subscribe((function(){var t,n;t=e,n={rule_id:I.prop("rule_id",t),action_attributes:I.omit(["rule_id"])(t)},zu.log("In-browser business rule action triggered",n),o.perform(i)}),(function(e){return zu.error("Error from should trigger in-browser action subscription",e)}))}}],[{key:"triggerAction",value:function(e){Lc.next(e)}},{key:"actionTriggers",value:function(e,t){return qc.pipe(Ki(e.pipe(wn(Cc),kt(I.prop("payload")))),wn((function(e){return e.type===t})))}}]),e}();sm.BusinessRules.Controller=Uc;var Dc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.merge=gr.merge})),Vc=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Dc)})),Fc=function(e){return{element_text:e.textContent,element_id:e.id,element_tag_name:e.tagName,element_class_name:e.className}},Bc=function(e){return!function(e){return 0===e.offsetWidth&&0===e.offsetHeight||e.style&&"none"===e.style.display}(e)},Hc=function(e){for(var t=e.parentElement,n=[];null!==t;)n.push(t),t=t.parentElement;return n},Wc=function(e){return Array.prototype.slice.call(e)},Gc=function(e,t){return(e.matches||e.msMatchesSelector).call(e,t)},zc=1,Jc=10;function Yc(e){if(!e)return null;for(var t=[];e&&e.nodeType===zc;e=e.parentNode){for(var n=0,r=e.previousSibling;r;r=r.previousSibling)r.nodeType!==Jc&&r.nodeName===e.nodeName&&++n;var i=(e.prefix?e.prefix+":":"")+e.localName,o="["+(n+1)+"]";t.splice(0,0,i+o)}return t.length?"/"+t.join("/"):null}var Qc=new RegExp(/\/([^/[]+)\[(\d+)\]/g),Kc=new RegExp(/:nth-of-type\(1\)/g);function Xc(e,t){if("/"===t)return e;if(t){var n=t.replace(Qc,"$1:nth-of-type($2) > ").slice(0,-2).replace(Kc,"");return e.querySelector(n)}return null}var $c=function(e,t){return Pu.Observable.fromEventPattern((function(n){return e.addEventListener(t,n)}),(function(n){return e.removeEventListener(t,n)}))},Zc=function(e,t){return Pu.Observable.fromEventPattern((function(n){return e.on(t,n)}),(function(n){return e.off(t,n)}))},el=function(e){return Pu.Observable.create((function(t){var n=e.subscribe(t);return function(){return n.unsubscribe()}}))},tl=function(e){return Pu.Observable.create((function(t){var n=e.subscribe(t.next.bind(t),t.error.bind(t),t.complete.bind(t));return function(){return n.dispose()}}))},nl=function(e){return e.flatMap((function(e){return Pu.Observable.throw(e)}))},rl=function(e){return Pu.Observable.create((function(t){e.connect(),e.subscribe(t)}))},il=function(e,t){var n=t.maxRetries,r=t.calculateDelay,i=t.shouldRetry,o=void 0===i?I.always(!0):i,s=t.scheduler,a=void 0===s?Pu.Scheduler.asap:s;return e.retryWhen((function(e){return function(e,t){return e.scan((function(e,n){return c({count:e.count+1},t,n)}),{count:0})}(e,"error").flatMap((function(e){var t=e.count,i=e.error;return o(i)&&t<=n?Pu.Observable.timer(r(t),a):Pu.Observable.throw(i)}))}))},ol=function(e){var t=e.target,n=e.selector;return"function"==typeof t.msMatchesSelector?t.msMatchesSelector(n):"function"==typeof t.matches&&t.matches(n)},sl=function(e){var t=e.pattern;return-1!==e.element.textContent.indexOf(t)},al=function(e){return e&&e.nodeType===zc},ul=function(e){var t=e.selector;return t&&-1!==t.indexOf(":contains")},cl=function(e){var t=e.selector,n=t.replace(/'/g,'"').match(/(.*):contains\("([^"]+)"/);if(I.isNil(n))throw new Error("Failed to match :contains selector - ".concat(t));var r=n[1].trim(),i=n[2].trim();if(I.isEmpty(r))throw new Error("The :contains selector has no tag to match");return{cssSelector:r,containsText:i}},ll=function(e){return ul({selector:e})?function(e){var t=e.selector,n=cl({selector:t}),r=n.cssSelector,i=n.containsText,o=Wc(document.querySelectorAll(r));return I.filter((function(e){return sl({pattern:i,element:e})}),o)}({selector:e}):Wc(document.querySelectorAll(e))},fl=function(e,t){return Vc.merge.apply(void 0,w(I.map((function(t){return $c(t,e)}),t)))},pl=function(e){var t=e.elementSelector,n=e.eventName;return fl(n,ll(t))},hl=function(e){var t=e.target,n=e.selector;if(!al(t))return!1;if(ul({selector:n})){var r=cl({selector:n}),i=r.cssSelector,o=r.containsText;return ol({target:t,selector:i})&&sl({pattern:o,element:t})}return!I.isEmpty(n)&&ol({target:t,selector:n})},dl=function(){function e(t){var n=t.id,r=t.form_selector,i=t.input_selector,o=t.value;s(this,e),this.filteredValueOrFocusout=this.filteredValueOrFocusout.bind(this),this._valueMatching=this._valueMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.formSelector=r,this.inputSelector=i,this.value=o}return u(e,[{key:"track",value:function(){return Vc.merge(this._trackTextFields(),this._trackChangeableFields(),this._trackCheckableFields()).pipe(kt(this._formatEvent))}},{key:"_trackTextFields",value:function(){var e;try{e=fl("keyup",this._getObservableFields("input[type=text], input:not([type]), textarea"))}catch(t){this._recordInvalidSelector(t),e=xc.empty()}return e.pipe(wn(this._valueChangingKey),kt(this._extractValueFromInput),di(I.equals),wn(this._valueMatching),Go(this.filteredValueOrFocusout))}},{key:"_trackChangeableFields",value:function(){var e;try{e=fl("change",this._getObservableFields("select"))}catch(t){this._recordInvalidSelector(t),e=xc.empty()}return e.pipe(kt(this._extractValueFromOption),di(I.equals),wn(this._valueMatching))}},{key:"_trackCheckableFields",value:function(){var e;try{e=fl("change",this._getObservableFields("input[type=radio], input[type=checkbox]"))}catch(t){this._recordInvalidSelector(t),e=xc.empty()}return e.pipe(kt(this._extractValueFromInput),wn(this._valueMatching))}},{key:"_getObservableFields",value:function(e){if(this.inputSelector)return Wc(document.querySelectorAll(this.inputSelector)).filter((function(t){return hl({target:t,selector:e})}));if(this.formSelector){var t=Wc(document.querySelectorAll("form"+this.formSelector));return I.unnest(I.map((function(t){return Wc(t.querySelectorAll(e))}),t))}return Wc(document.body.querySelectorAll(e))}},{key:"filteredValueOrFocusout",value:function(e){return this.value?Nc.of(e):$c(e.target,"focusout").pipe(Wi(e))}},{key:"_valueChangingKey",value:function(e){return e.keyCode>=45}},{key:"_valueMatching",value:function(e){var t=e.target.value;return!this.value||t.match(new RegExp(this.value))}},{key:"_extractValueFromInput",value:function(e){return{target:e.target,value:e.target.value}}},{key:"_extractValueFromOption",value:function(e){var t=I.find((function(e){return e.selected}),Wc(e.target.querySelectorAll("option")));return{target:e.target,value:t&&t.value}}},{key:"_formatEvent",value:function(e){var t=e.target,n=e.value;return{id:this.id,type:"form_filling",source_attributes:I.merge(Fc(t),{value:n})}}},{key:"_recordInvalidSelector",value:function(e){Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:form_filling","reason:invalid_selector"]),zu.warn("Failed to track form filling. Invalid selector",{error:e,form_selector:this.formSelector,input_selector:this.inputSelector,source_id:this.id})}}]),e}(),vl="clicking",bl=function(){function e(t){var n=t.id,r=t.element_selector,i=t.element_tag,o=t.number,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:zu,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500;s(this,e),this._isTargetElementsOrItsChild=this._isTargetElementsOrItsChild.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.elementTag=i,this.number=o,this.logger=a,this.throttleTime=u}return u(e,[{key:"track",value:function(){var e,t,n=this,r=(e=document,t="click",Pu.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!0)}),(function(n){return e.removeEventListener(t,n,!0)}))).pipe(wn((function(e){return n._isTargetElementsOrItsChild(e.target)}))),i=this.number||1;return function(e,t){var n=e.events,r=e.throttleTime,i=e.numberToTrigger;return n.pipe(rs(r,t),Ro(i-1))}({events:r,throttleTime:this.throttleTime,numberToTrigger:i}).map(this._formatEvent)}},{key:"_isTargetElementsOrItsChild",value:function(e){var t=this._getElementsSelector();try{var n=ll(t);return I.intersection(n,function(e){for(var t=[];e;)t.push(e),e=e.parentElement;return t}(e)).length>0}catch(e){return Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(vl),"reason:invalid_selector"]),this.logger.warn(e,"Failed to query DOM element",{elementSelector:t}),!1}}},{key:"_getElementsSelector",value:function(){return this._tagConstraint()+this._selectorConstraint()}},{key:"_tagConstraint",value:function(){return this.elementTag||""}},{key:"_selectorConstraint",value:function(){return this.elementSelector?"".concat(this.elementSelector):""}},{key:"_formatEvent",value:function(e){return{id:this.id,type:vl,source_attributes:Fc(e.target)}}}]),e}(),ml=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.timer=gr.timer})),gl=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(ml)}));var yl=function(){function e(t){var n=t.source_id;s(this,e),this.saveNavigationEvent=this.saveNavigationEvent.bind(this),this.clear=this.clear.bind(this),this._getHistory=this._getHistory.bind(this),this._formatHistory=this._formatHistory.bind(this),this.key="sm_navigations-"+n,this.storage=window.sessionStorage}return u(e,[{key:"saveNavigationEvent",value:function(e){this.storage.setItem(this.key,this._formatHistory(e))}},{key:"anyMatch",value:function(e){return I.any((function(t){return t.match(e)}))(this._getHistory())}},{key:"clear",value:function(){this.storage.removeItem(this.key)}},{key:"_getHistory",value:function(){try{return JSON.parse(this.storage.getItem(this.key))||[]}catch(e){return sm.logger.error("Unexpected format for navigation history in sessionStorage",{error:e}),this.clear(),[]}}},{key:"_formatHistory",value:function(e){var t=I.takeLast(2,I.append(e,this._getHistory()));return JSON.stringify(t)}}]),e}();var _l=!1;try{var wl=Object.defineProperty({},"passive",{get:function(){return _l=!0}});window.addEventListener("sm-passive-test",null,wl),window.removeEventListener("sm-passive-test",null,wl)}catch(e){}var El=function(e,t){return Pu.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!!_l&&{passive:!0})}),(function(n){return e.removeEventListener(t,n)}))},Ol={getStream:function(e){var t,n=I.map((function(e){return El(document,e)}),e);return Pu.Observable.merge((t=Pu.Observable).merge.apply(t,w(n)),El(window,"focus"),El(window,"pageshow"))}};sm.PeriodicalActivityTracker=Ol;var Sl=function(){var e=_(void 0!==document.hidden?["hidden","visibilitychange"]:void 0!==document.mozHidden?["mozHidden","mozvisibilitychange"]:void 0!==document.msHidden?["msHidden","msvisibilitychange"]:["webkitHidden","webkitvisibilitychange"],2),t=e[0],n=e[1];if(void 0===document.addEventListener||void 0===t)return Pu.Observable.of({focused:void 0});var r=function(){return{visible:!document[t]}};return El(document,n).map(r).startWith(r())},Tl=function(){var e=(window.crypto||window.msCrypto).getRandomValues(new Uint8Array(16));e[6]=15&e[6]|64,e[8]=191&e[8]|128;for(var t="",n=0;n<e.length;n++)e[n]<16&&(t+="0"),t+=e[n].toString(16),[3,5,7,9].indexOf(n)>-1&&(t+="-");return t},kl=function(e){return"object"===o(e)&&Boolean(e&&e.messageName)},Al=function(e,t,n){var r={messageName:e,payload:t};return n&&(r.options=n),r};function xl(e){var t=this,n=new Il({allowedSource:e});["on","off","start","stop","respondTo"].forEach((function(e){t[e]=n[e].bind(n)})),this.observable=function(e){return Zc(n,e)},this.emit=function(t,n,r){e.postMessage(Al(t,n,r),"*")},this.request=function(e,n,r){var i=e+":response",o=Tl();t.on(i,(function e(n,s,a,u){u&&u.requestId===o&&(t.off(i,e),r(n,s,a))})),t.emit(e,n,{requestId:o})}}function Il(e){var t=this,n=e.allowAnySource,r=e.allowedSource;if(n&&r)throw new Error("Pass allowedSource or allowAnySource, not both");if(!n&&!r)throw new Error("Pass allowedSource or allowAnySource");var i=function(e){if((n||e.source===r)&&kl(e.data)){var i=e.data,o=i.messageName,s=i.payload,a=i.options;return t.emitEvent(o,[s,e.source,e.origin,a])}};this.start=function(){window.addEventListener("message",i)},this.stop=function(){window.removeEventListener("message",i),t.removeEvent()},this.respondTo=function(e,n){var r=function(t,r,i,o){n(t,(function(t){return r.postMessage(Al(e+":response",t,o),i)}),r,i)};return t.on(e,r),function(){return t.off(e,r)}}}Il.prototype=Object.create(x.prototype);var Nl=null,Ml=function(){if(!Nl){var e=Ol.getStream(["scroll","keyup","mousemove","touchstart","orientationchange"]).share(),t=new Il({allowAnySource:!0});t.start();var n=Zc(t,"activity_from_cobrowsable_iframe"),r=Sl().filter(I.propEq("visible",!0));(Nl=Pu.Observable.merge(e,n,r).publish()).connect()}return Nl};var Cl=function(e){return e?parseFloat(e.replace(/[^\d\.]+/,"")):null},Rl="number",Pl=function(){function e(t){var n=t.id,r=t.element_selector,i=t.minimum_value;s(this,e),this._elementValues=this._elementValues.bind(this),this._numberMatching=this._numberMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.minimumValue=i}return u(e,[{key:"track",value:function(){return fc.interval(100).pipe(an(this._elementValues),wn(this._numberMatching),kt(this._formatEvent),wi(1))}},{key:"_elementValues",value:function(){var e;try{e=Wc(document.querySelectorAll(this.elementSelector))}catch(t){Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(Rl),"reason:invalid_selector"]),zu.warn("Failed to track number. Invalid selector",{error:t,element_selector:this.elementSelector,source_id:this.id}),e=[]}return hc.from(I.flatten(e.map(this._elementValue)))}},{key:"_elementValue",value:function(e){return[{element:e,value:Cl(e.innerHTML)},{element:e,value:Cl(e.value)}]}},{key:"_numberMatching",value:function(e){var t=e.value;return"number"==typeof t&&t>=this.minimumValue}},{key:"_formatEvent",value:function(e){var t=e.element,n=e.value;return{id:this.id,type:Rl,source_attributes:I.merge(Fc(t),{value:n})}}}]),e}();var jl={attributes:!0,characterData:!1,childList:!1,subtree:!1,attributeOldValue:!1,characterDataOldValue:!1};var Ll=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.fromPromise=gr.from})),ql=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Ll)}));var Ul={text:"chat",audio:"voice",phone:"phone",video:"video"};var Dl=function(){function e(){s(this,e)}return u(e,[{key:"track",value:function(){return xc.empty()}}]),e}(),Vl={form_filling:dl,clicking:bl,time_on_page:function(e){var t=e.id,n=e.seconds,r=function(){return{id:t,type:"time_on_page",source_attributes:{}}};this.track=function(){return gl.timer(1e3*n).pipe(kt(r))}},mouse_in:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_in",source_attributes:Fc(e.target)}};this.track=function(){try{return pl({elementSelector:n,eventName:"mouseenter"}).pipe(kt(r))}catch(e){return Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_in","reason:invalid_selector"]),zu.warn("Failed to track mouse in. Invalid selector",{error:(null==e?void 0:e.message)||e,element_selector:n,source_id:t}),xc.empty()}}},mouse_out:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_out",source_attributes:Fc(e.target)}};this.track=function(){try{return pl({elementSelector:n,eventName:"mouseleave"}).pipe(kt(r))}catch(e){return Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_out","reason:invalid_selector"]),zu.warn("Failed to track mouse out. Invalid selector",{error:e,element_selector:n,source_id:t}),xc.empty()}}},scrolling:function(e){var t=e.id,n=e.percentage,r=function(){return{id:t,type:"scrolling",source_attributes:{}}},i=function(){var e=window.pageYOffset,t=window.innerHeight;return e/(document.documentElement.scrollHeight-t)*100>n};this.track=function(){return $c(window,"scroll").pipe(wn(i),kt(r),wi(1))}},navigation:function(e){var t=e.id,n=e.path,r=function(){return{id:t,type:"navigation",source_attributes:{}}};this.track=function(){var e=new RegExp(n,"i");return sm.hrefObservable.pipe(wn((function(t){return t.match(e)})),kt(r))}},activity:function(e){var t=e.id,n=function(){return{id:t,type:"activity",source_attributes:{}}};this.track=function(){return gl.timer(6e4).pipe(Xi(Ml()),wi(1),lo(),kt(n))}},number:Pl,element_created:function(e){var t=e.id,n=e.element_selector,r=e.on_page_load;this.track=function(e){var i=e.options;return n?i.initialLoad&&!r?xc.empty():Nc.of({id:t,type:"element_created",source_attributes:{}}):xc.empty()}},element_changed:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"element_changed",source_attributes:Fc(e.target)}};this.track=function(e){var i=e.options,o=i.triggerObservable,s=i.mutationObserver;try{ll(n).forEach((function(e){s.observe(e,jl)}))}catch(e){Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:element_changed","reason:invalid_selector"]),zu.warn("Failed to observe element changes. Invalid selector",{error:e,element_selector:n,source_id:t})}return o.pipe(kt(r))}},transfer:function(e){var t=e.id,n=function(e){return{id:t,type:"transfer",source_attributes:{operator_id:e.operatorId,operator_name:e.operatorName,starting_media:e.startingMedia}}};this.track=function(){return ec.vent.observable(ec.MSG.ENGAGEMENT_TRANSFERRED).pipe(kt(n))}},proactive_accept:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_accept",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return ec.vent.observable(ec.MSG.PROACTIVE_ACCEPT).pipe(fi(I.prop("engagement_request_id")),kt(n))}},proactive_decline:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_decline",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return ec.vent.observable(ec.MSG.PROACTIVE_DECLINE).pipe(kt(n))}},engagement_start:function(e){var t=e.id,n=function(e){var n=e.operator,r=e.startingMedia,i=e.engagementId,o=e.type;return{id:t,type:"engagement_start",source_attributes:{operator_id:n.id,operator_name:n.name,proactive_or_reactive:o,engagement_media:Ul[r],engagement_id:i}}};this.track=function(){return ql.fromPromise(sm.getApi({version:"v1"})).pipe(an((function(e){return e.observable(e.EVENTS.ENGAGEMENT_START)})),wn(I.complement(I.prop("isReestablishing"))),kt(n))}},reactive_engagement_request_timeout:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"reactive_engagement_request_timeout",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return ec.vent.observable(ec.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT).pipe(kt(n))}},consecutive_navigation:function(e,t){var n=e.id,r=e.to,i=e.from,o=t||new yl({source_id:n}),s=function(){return o.anyMatch(new RegExp(i,"i"))},a=function(){return{id:n,type:"consecutive_navigation",source_attributes:{}}};this.track=function(){return sm.hrefObservable.pipe(wn((function(e){return e.match(new RegExp(i,"i"))}))).subscribe(o.saveNavigationEvent),sm.hrefObservable.pipe(wn(I.both((function(e){return e.match(new RegExp(r,"i"))}),s)),es(o.clear),kt(a))}},enqueued:function(e){var t=e.id;this.track=function(e){var n=e.internalVisitorStateObservable,r=["enqueued","request_sent"],i=I.propEq("site_id",sm.siteId),o=I.compose(I.filter(i),I.pathOr([],["omniq","queue_tickets"])),s=I.compose(I.nth(0),I.filter((function(e){var t=I.lensPath(["visitor","browser_tab_id"]);return I.compose(I.equals(sm.tabId),I.view(t))(e)})),I.filter((function(e){return-1!==r.indexOf(e.state)})),o);return n.pipe(kt(s),wn(I.identity),di(null,I.prop("id")),kt((function(e){return{id:t,type:"enqueued",source_attributes:{ticket_id:e.id}}})))}}},Fl={buildObservable:I.curry((function(e,t,n){var r=function(e){var t=e.sources,n=e.internalVisitorStateObservable,r=e.options;return 0===Object.keys(t).length?xc.empty():new(Vl[t.type]||Dl)(t).track({internalVisitorStateObservable:n,options:r})}({sources:t.sources,internalVisitorStateObservable:e,options:n});return t.url_matcher?r.pipe(As(function(e){var t=new RegExp(e,"i");return sm.hrefObservable.pipe(kt((function(e){return e.match(t)})),di(I.equals))}(t.url_matcher),(function(e,t){return{value:e,isMatching:t}})),wn(I.prop("isMatching")),kt(I.prop("value"))):r}))},Bl=function(){function e(){s(this,e)}return u(e,null,[{key:"observable",value:function(e,t){var n=this._selectorsToObserveOnElementCreated(e.sources);return n.length>0?this._trackCreatedElements(e,n,t):Nc.of({})}},{key:"_trackCreatedElements",value:function(e,t,n){var r=this._initiateSourceAttributes(e.sources);return n.pipe(kt((function(e){return{target:e,initialLoad:!1}})),Ho({target:document.body,initialLoad:!0}),wn(this._filterBySourceType({source:e.sources,selectors:t,rawRule:e})),kt(I.pick(["initialLoad"])),kt(I.merge(r)))}},{key:"_filterBySourceType",value:function(e){var t=this,n=e.source,r=e.selectors,i=e.rawRule;return function(e){var o=e.target;return!(!e.initialLoad||"element_created"===n.type)||t._targetMatchesAny(o,r,i,n)}}},{key:"_initiateSourceAttributes",value:function(e){switch(e.type){case"element_changed":return this._getElementChangedAttributes(e);default:return{}}}},{key:"_getElementChangedAttributes",value:function(e){var t=new vc.Subject,n=new MutationObserver((function(n){return I.forEach((function(n){if(hl({target:n.target,selector:e.desired_selector}))return t.next(n)}),n)}));return{triggerObservable:t.asObservable(),mutationObserver:n}}},{key:"_selectorsToObserveOnElementCreated",value:function(e){switch(e.type){case"form_filling":return[e.form_selector,e.input_selector];case"mouse_in":case"mouse_out":case"element_changed":case"element_created":return[e.element_selector];default:return[]}}},{key:"_targetMatchesAny",value:function(e,t,n,r){return I.any((function(t){try{return hl({target:e,selector:t})||function(e){var t=e.target,n=e.selector;return!(!al(t)||!t.hasChildNodes())&&I.any((function e(t){var r=hl({target:t,selector:n});return!r&&t.hasChildNodes()?I.any(e,t.childNodes):r}),t.childNodes)}({target:e,selector:t})}catch(e){return Ju.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(r.type),"reason:invalid_selector"]),zu.warn("Failed to track element. Invalid selector",{error:e&&e.message,selector:t,source_type:r.type,rule_id:n.id}),!1}}),t)}}]),e}();function Hl(e){return(Hl="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Wl(e){return function(e){if(Array.isArray(e))return Gl(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return Gl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Gl(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Gl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var zl,Jl=function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r},Yl=function(e){return function t(n){return 0===arguments.length?t:e.apply(this,arguments)}},Ql=Yl((function(e){return null===e||"object"!==Hl(e)?e:Array.isArray(e)?e.map((function(e){return Ql(e)})):Object.keys(e).reduce((function(t,n){return Jl(function(e){var t=e.split("_");return[t[0]].concat(Wl(t.slice(1).map((function(e){return function(e){return"".concat(e.slice(0,1).toUpperCase()).concat(e.slice(1).toLowerCase())}(e)})))).join("")}(n),Ql(e[n]),t)}),{})})),Kl=Yl((function(e){return null===e||"object"!==Hl(e)?e:Array.isArray(e)?e.map((function(e){return Kl(e)})):Object.keys(e).reduce((function(t,n){return Jl(n.replace(/\W+/g," ").split(RegExp(" |\\B(?=[A-Z])")).map((function(e){return e.toLowerCase()})).join("_"),Kl(e[n]),t)}),{})})),Xl=(zl=function(e,t){return Object.keys(t).reduce((function(n,r){var i=e[r];if(Array.isArray(i)){var o=t[r];if(!o||"object"!==Hl(o))throw new Error("Nested value should be an object");return Jl(i[0]||r,Xl(i[1],o),n)}return Jl(i||r,t[r],n)}),{})},function e(t,n){return 0===arguments.length?e:1===arguments.length?Yl((function(e){return zl(t,e)})):zl(t,n)}),$l=u((function e(t){var n=t.status,r=t.medias;s(this,e),this.status=n,this.medias=r}));$l.prototype.STATUSES={OPEN:"open",CLOSED:"closed",FULL:"full",UNSTAFFED:"unstaffed"};var Zl=function(e){return"opened"===e?$l.prototype.STATUSES.OPEN:e},ef=u((function e(t){var n=t.id,r=t.name,i=t.status,o=t.medias;s(this,e),this.id=n,this.name=r,this.state=new $l({status:i,medias:o})})),tf={SALEMOVE:{ALREADY_QUEUED:"already queued",INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",FILE_TOO_LARGE:"file too large",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system"}},nf=5e3,rf=["text","phone","audio","video"],of=[502,503],sf=[400,413,422],af="sm_change_element_attributes",uf="omnicore",cf="omnibrowse",lf={"content-type":"application/json",accept:"application/vnd.salemove.v1+json"},ff=["af","al","dz","as","ad","ao","ai","ag","ar","am","aw","au","at","az","bs","bh","bd","bb","by","be","bz","bj","bm","bt","bo","ba","bw","br","io","vg","bn","bg","bf","bi","kh","cm","ca","cv","bq","ky","cf","td","cl","cn","cx","cc","co","km","cd","cg","ck","cr","ci","hr","cu","cw","cy","cz","dk","dj","dm","do","ec","eg","sv","gq","er","ee","et","fk","fo","fj","fi","fr","gf","pf","ga","gm","ge","de","gh","gi","gr","gl","gd","gp","gu","gt","gg","gn","gw","gy","ht","hn","hk","hu","is","in","id","ir","iq","ie","im","il","it","jm","jp","je","jo","kz","ke","ki","xk","kw","kg","la","lv","lb","ls","lr","ly","li","lt","lu","mo","mk","mg","mw","my","mv","ml","mt","mh","mq","mr","mu","yt","mx","fm","md","mc","mn","me","ms","ma","mz","mm","na","nr","np","nl","nc","nz","ni","ne","ng","nu","nf","kp","mp","no","om","pk","pw","ps","pa","pg","py","pe","ph","pl","pt","pr","qa","re","ro","ru","rw","bl","sh","kn","lc","mf","pm","vc","ws","sm","st","sa","sn","rs","sc","sl","sg","sx","sk","si","sb","so","za","kr","ss","es","lk","sd","sr","sj","sz","se","ch","sy","tw","tj","tz","th","tl","tg","tk","to","tt","tn","tr","tm","tc","tv","vi","ug","ua","ae","gb","us","uy","uz","vu","va","ve","vn","wf","eh","ye","zm","zw","ax"],pf=I.compose(I.chain(I.values),I.values)(tf),hf=u((function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(s(this,e),this.cause=n.cause,n.message&&(this.message=n.message),this.cause&&I.contains(this.cause,pf))||(this.cause=tf.SALEMOVE.INTERNAL_ERROR,(t=sm.logger).error.apply(t,["Incorrect Error usage"].concat(Array.prototype.slice.call(arguments))))})),df=function(e){var t=String(e);if(0===t.indexOf("[object "))try{t=JSON.stringify(e)}catch(e){t=e instanceof TypeError?"Unable to parse param: ".concat(e.message):"Unexpected parse error ".concat(e)}return t},vf=function(e,t){t||(t={});var n,r=t.logger||zu;return n=e.cause,I.contains(n,I.values(tf.SALEMOVE))?e:function(e,t){if(e||(e={}),t||(t=zu),I.contains(e.status,of))return new hf({cause:tf.SALEMOVE.INTERNAL_ERROR});if(0===e.status||0===e.readyState)return new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT});var n="Uncaught error in 'public' observable. Wrapping as an internal error.";return e.details&&(n+=" Details: ".concat(df(e.details),".")),e.error&&(n+=" Error: ".concat(df(e.error),".")),e.debug_message&&(n+=" Debug message: ".concat(df(e.debug_message),".")),e.message&&(n+=" Message: ".concat(df(e.message))),t.error(n.substr(0,1e3),e),new hf({cause:tf.SALEMOVE.INTERNAL_ERROR})}(e,r)},bf=function(e){return e||(e={}),Pu.Observable.throw(vf(e))},mf=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof hf)return Pu.Observable.throw(e);var n=function(){return I.contains(e.status,sf)?new hf({cause:tf.SALEMOVE.INVALID_INPUT}):409===e.status?new hf({cause:tf.SALEMOVE.CONFLICT}):e.cause===tf.SALEMOVE.NETWORK_TIMEOUT?e:vf(e)},r=n();return t.allowedCauses&&r.cause!==tf.SALEMOVE.INTERNAL_ERROR&&!I.contains(r.cause,t.allowedCauses)?(zu.error("Unhandled error treated as internal error",{status:e.status,message:e.message,debug_message:e.debugMessage}),Pu.Observable.throw(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR}))):Pu.Observable.throw(r)},gf=/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/gi,yf=function(e,t,n,r){var i=function(e){if(!e.match(gf))throw Error("Invalid visitor ID format");var t=e.split("-")[0];return parseInt(t,16)%100}(r),o=I.path([t,n],e);if(I.isNil(o))throw Error("Feature toggle value is absent");var s=I.type(o);if(!I.any(I.equals(s),["String","Number"]))throw Error("Invalid feature toggle type: ".concat(s,". Required type: String or Number"));var a=parseInt(o,10);if(isNaN(a))throw Error("Invalid feature toggle value. Value must be a number");if(a<0||a>100)throw Error("Invalid feature toggle value. Value must be within [0, 100] range");return a>i};function _f(e,t,n,r){var i=!1;return{enabledForVisitor:function(o){return s=function(){try{return yf(e,n,r,o)}catch(e){return zu.error("Failed to check feature toggle",{error:e,namespace:n,feature:r}),!1}},a="sm.app.".concat(n,".features"),u="feature:".concat(r),c=s(),i||(c?t.increment(a,["action:enabled",u]):t.increment(a,["action:disabled",u]),i=!0),c;var s,a,u,c}}}var wf="queue:multi",Ef={channelObservable:null,topicNotifications:{}},Of=function(e){var t=e.queueId,n=e.name,r=e.state,i=e.medias;return new ef({id:t,name:n,status:Zl(r),medias:i})},Sf=function(e){var t=e.pubsub,n=e.cache;n||(n=Ef);var r=n.channelObservable,i=n.topicNotifications||{};return function(e){var o=I.map(I.concat("queue:"),e);return Pu.Observable.create((function(s){if(r){!function(e){var t=e.queueIds,n=e.observer;t.forEach((function(e){var t=i[e];if(t)return n.next(t)}))}({queueIds:e,observer:s}),r.flatMap((function(e){return e.watchNewTopics(o)})).toPromise().catch((function(e){return zu.warn("Unable to update queue pubsub channel topics ",e)}))}else(r=t.joinChannel(wf,{topics:o}).do((function(){return zu.info("Joined ".concat(wf," topic"))})).publishReplay(1)).connect(),n.channelObservable=r;return r.flatMap((function(e){return e.observable("change")})).map(Xl({queue_id:"queueId"})).filter((function(t){var n=t.queueId;return-1!==e.indexOf(n)})).map(Of).do((function(e){i[e.id]=e})).subscribe(s)}))}},Tf=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(sr((function(e,t){var n=I.findIndex(I.propEq("id",t.id))(e);return-1===n?I.append(t,e):I.equals(I.find(I.propEq("id",t.id))(e),t)?e:I.update(n,t,e)}),[]),di((function(e,t){return e===t})))};var kf=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).pipe(Me(I.prop("id")),an((function(e){return e.distinctUntilChanged()})))},Af=function(e,t){if(!e)throw new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is undefined"});if(I.isEmpty(e))throw new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is empty"});if(!t)throw new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Listener is undefined"})},xf=function(e){var t=e.enabled,n=e.createQueueStateObservable,r=e.createQueueStateAccumulateObservable,i=e.pubsub;r||(r=Tf),n||(n=kf);var o=function(e){var n=e.queueIds,o=e.listener;if(t){var s=new Pu.Subscription;Af(n,o);try{var a=r({queueIds:n,observeQueueStateUpdates:Sf({pubsub:i})});s.add(a.subscribe(o,zu.error.bind(zu,"Failed to receive queue state list updates")))}catch(e){zu.error("Failed subscribe to queue state list updates",e)}return s}};return{subscribe:function(e,r){if(t){var o=new Pu.Subscription;Af(e,r);try{var s=n({queueIds:e,observeQueueStateUpdates:Sf({pubsub:i})}).publish();o.add(s.subscribe(r,zu.error.bind(zu,"Failed to receive queue state updates"))),o.add(function(e,t){var n=new Pu.Subscription;return n.add(t.bufferCount(e.length).take(1).subscribe((function(e){return zu.info("Received initial queue states",{queue_states:I.map((function(e){return{id:e.id,status:e.state.status}}),e)})}))),n.add(t.skip(e.length).subscribe((function(e){return zu.info("Received queue state update",{queue_id:e.id,queue_status:e.state.status})}))),n}(e,s)),o.add(s.connect())}catch(e){zu.error("Failed subscribe to queue state updates",e)}}},subscribeToList:o,subscribeToListAsObservable:function(e){var t=e.queueIds,n=e.subscribeToListFn;return n||(n=o),t?Pu.Observable.create((function(e){return n({queueIds:t,listener:e.next.bind(e)})})):Pu.Observable.empty()}}},If=function(){function e(){s(this,e)}return u(e,[{key:"start",value:function(e,t){var n=t.routingObservable;return this.ruleTracker(t,e).pipe(an((function(r){var i,o=t.queuesAvailabilityObservable.pipe(Qr(100,i));return cc.combineLatest(t.currentStatusObservable,o).pipe(wi(1),kt((function(t){var i=_(t,2),o=i[0],s=i[1];return{overseerApi:e,bufferedEvents:r,currentStatus:o,queuesState:s,routingObservable:n}})))}))).subscribe(this.actUponRules,(function(e){return zu.error("Error from business rule subscription: ".concat(I.prop("message",e)||e),e)}))}},{key:"ruleTracker",value:function(t,n,r){var i=t.rules,o=t.domInsertObservable,s=t.buildRuleObservable,a=t.overseerXhrEnabled?fc.interval(e.BUFFER_TIME,r):fc.interval(e.BUFFER_TIME,r).pipe(Uo(n.connectedObservable.pipe(wn(I.equals(!0)),wi(1))));return hc.from(i).pipe(an(Mf),an(function(e){var t=e.domInsertObservable,n=e.buildRuleObservable;return function(e){return Bl.observable(e,t).pipe(Go((function(t){return n(e,t)})),kt((function(t){return I.merge({attrs:t},e)})))}}({domInsertObservable:o,buildRuleObservable:s})),ps(a),rn((function(e){return e.toArray()})),Ns(a,(function(e,t){return e})),wn((function(e){return e.length>0})))}},{key:"actUponRules",value:function(e){var t=e.overseerApi,n=e.currentStatus,r=e.queuesState,i=e.bufferedEvents,o=e.controller,s=void 0===o?Uc:o,a=["visitor_status"];r&&a.push("queues_availability"),i=I.map((function(e){var t=I.map(I.prop("type"),e.conditions);return!I.isEmpty(I.difference(t,a))?I.merge(e,{actions:[],send_to_server:!0}):e}),i);var u=I.filter((function(e){return function(e){var t=e.event,n=e.currentStatus,r=e.queuesState,i=I.all((function(e){return function(e,t,n){return"visitor_status"===e.type?-1!==e.status.indexOf(t):"queues_availability"!==e.type||function(e,t){var n=_(I.partition(I.pathEq(["state","status"],"open"))(t),2),r=n[0],i=n[1],o=function(t){var n=t.id;return I.contains(n,e.queueIds)};if("can_enqueue"===e.compareType)return I.any(o,r);if("cannot_enqueue"===e.compareType)return I.any(o,i)}(Xl({queue_ids:"queueIds",compare_type:"compareType"},e),n)}(e,n,r)}),t.conditions);i&&zu.log("Business rule source matched: ",I.mergeAll([{rule_name:I.prop("name",t)},I.pick(["send_to_server"],t),I.pick(["type","source_attributes"],t.attrs),{url:window.location.href,source_id:t.attrs.id,rule_id:t.id}]));return i}({event:e,currentStatus:n,queuesState:r})}),i),c=I.groupBy((function(e){return e.send_to_server?"serverEvents":"browserEvents"}))(u),l=c.serverEvents||[],f=c.browserEvents||[];u.forEach((function(e){var t=e.actions,n=e.attrs,r=e.id,i=e.name,o=e.browser_event_conditions;if(!I.isEmpty(t))return function(e,t,n,r,i,o){e.forEach((function(e){var s={rule_id:n,rule_name:r,browser_event_conditions:o},a=I.merge(s,function(e,t){t||(t={});if(e.fields){var n=function(e,t){var n={};return t.forEach((function(t){var r=t.key,i=t.value,o=t.custom_value,s="custom"===i?o:e[i];n[r]=s})),n}(I.merge({visitor_id:Lu(),site_id:Vu(),url:window.location.href},t),e.fields);return I.merge(e,{fields:n})}return e}(e,t));i.triggerAction(a)}))}(t,n.source_attributes,r,i,s,o)})),I.isEmpty(l)||Cf(t,a,I.map((function(e){var t=e.attrs,n=e.id;return I.assoc("rule_id",n,t)}))(l));var p=I.filter((function(e){var t=e.actions;return!I.isEmpty(t)}),f),h=I.map((function(e){var t=e.actions;return{ruleId:e.id,actionTypes:I.pluck("type",t)}}),p);I.isEmpty(h)||function(e){var t=e.overseerApi,n=e.browserEvents;Rf?t.sendOverseerMetrics({browserEvents:n}):t.actionsShortcircuited({browserEvents:n})}({overseerApi:t,browserEvents:h})}}],[{key:"init",value:function(t,n){var r=n.currentStatusObservable,i=n.internalVisitorStateObservable,o=n.rules,s=n.queuesAvailabilityObservable,a=n.routingObservable,u=n.overseerXhrEnabled,c=ac.Observable.create((function(e){var t=new MutationObserver((function(t){return I.forEach((function(t){return I.forEach((function(t){if(t instanceof HTMLElement)return e.next(t)}),t.addedNodes)}),t)}));return t.observe(document.body,{attributes:!1,characterData:!1,childList:!0,subtree:!0,attributeOldValue:!1,characterDataOldValue:!1}),function(){return t.disconnect()}})),l=Fl.buildObservable(i);return(new e).start(t,{currentStatusObservable:r,queuesAvailabilityObservable:s,rules:o,domInsertObservable:c,buildRuleObservable:l,routingObservable:a,overseerXhrEnabled:u})}}]),e}();function Nf(e){return e.operator?Nf(e.left).concat(Nf(e.right)):[e]}function Mf(e){var t;t=Array.isArray(e.sources)?e.sources:Nf(e.sources);var n=I.map((function(t){return I.assoc("sources",t,e)}),t);return hc.from(n)}function Cf(e,t,n){e.sourcesTriggered({events:n,resolvedConditions:t,tabId:sm.tabId,initTimestamp:If.INIT_TIMESTAMP})}If.BUFFER_TIME=100,If.INIT_TIMESTAMP=(new Date).getTime();var Rf=sm.conf.visitor_api.disable_overseer_actions_shortcircuited;var Pf=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t._throw=gr.throwError})),jf=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Pf)})),Lf=function(e){var t=e.stats,n=e.protocol,r=e.failureTagProperty,i=e.timeout,o=e.timeoutError,s=e.scheduler;return function(e,a){var u=e.resource,c=e.method,l=t.statApiUsage({protocol:n,resource:u})(c).attempted();return a().do(l.succeeded,I.compose(l.failed,I.prop(r))).timeoutWith(i,o.do(null,l.timedOut),s).do((function(e){return zu.log("Successfully executed '".concat(c,"' on resource ").concat(u))}),(function(e){return zu.warn("Failed to execute '".concat(c,"' on resource ").concat(u))})).finally((function(){if(!l.isFinished())return l.failed("aborted")}))}},qf=new Error({cause:"Internal error"});function Uf(e,t){var n=e.wsProxy,r=e.stats,i=Lf({stats:r,protocol:"rest",failureTagProperty:"message",timeout:5e3,timeoutError:jf._throw(qf),scheduler:t}),o=function(e){return r.increment("sm.service.overseer_api.action_shortcircuited",["type:".concat(e),"site_id:".concat(Vu())])},s=function(){return{visitor_id:Lu(),site_id:Vu(),url:window.location.href}};return{sourcesTriggered:function(e){var t=e.events,r=e.tabId,o=e.resolvedConditions;return i({resource:"overseer",method:"sources_triggered"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/sources_triggered"),payload:I.merge(s(),{events:t,tab_id:r,resolved_conditions:o}),headers:{"content-type":"application/json"}})})).subscribe((function(){}),(function(){}))},actionsShortcircuited:function(e){var t=e.browserEvents,r={browser_events:I.map((function(e){return{rule_id:e.ruleId,action_types:e.actionTypes}}),t)};return i({resource:"overseer",method:"actions_shortcircuited"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/actions_shortcircuited"),payload:I.merge(s(),r),headers:{"content-type":"application/json"}})})).subscribe((function(){}),(function(){}))},sendOverseerMetrics:function(e){var t=e.browserEvents;I.forEach(o,t.map((function(e){return e.actionTypes})))},connectedObservable:n.connectedObservable}}var Df=[sm.conf.api_url,"libs.salemove.com","libs.glia.com","visitor.local.dev"],Vf=function(e){return I.any((function(t){return I.contains(t,e)}),Df)},Ff=function(e){if("string"!=typeof e&&(t=e,n=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i"),!Boolean(n.test(t))))return zu.warn("Invalid URL provided",{rawUrl:e}),!1;var t,n;try{var r=new window.URL(e);return Vf(r.origin)}catch(t){try{var i=e.trim();return Boolean(i)&&i.length>2&&Vf(i)}catch(t){return zu.warn("Error validating URL",{rawUrl:e,error:t}),!1}}},Bf=I.pick(["response","status","statusText","readyState","responseURL"]),Hf=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.onSuccess,u=e.onError,c=new XMLHttpRequest;if(c.open(t,n,!0),o){var l=o();r="application/json"===l["Content-Type"]&&"string"!=typeof r?JSON.stringify(r):r,Object.keys(l).forEach((function(e){var t=l[e];c.setRequestHeader(e,t)}))}return c.responseType=i,c.onreadystatechange=function(){if(4===c.readyState)if(c.status>=200&&c.status<300)if("json"===i&&"string"==typeof c.response)try{var e=I.assoc("response",c.response.length>0?JSON.parse(c.response):"",c);a(e)}catch(e){zu.error("Could not parse response json in IE11",{error:e,server_response:c.response}),u(c)}else a(c);else u(c)},s&&c.upload.addEventListener("progress",(function(e){e.lengthComputable&&s({loaded:e.loaded,total:e.total})}),!1),Ff(n)?c.send("GET"===t?void 0:r):(zu.error("Trying to fetch from invalid URL",{rawUrl:n}),u(c)),function(){return c.abort()}},Wf=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.sendRequest,u=e.contentType;return Ff(n)?(t=t||"GET",i=i||"json",a=a||Hf,o||(o=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}}),ac.Observable.create((function(e){return a({method:t,url:n,payload:r,responseType:i,getRequestHeaders:u?function(){return I.merge(o(),{"Content-Type":u})}:o,onUploadProgress:s,onSuccess:function(t){e.next(t),e.complete()},onError:function(t){return e.error(Bf(t))}})}))):(zu.error("Trying to fetch from invalid URL",{rawUrl:n}),jf._throw(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR,message:"Request URL is invalid"})))},Gf=function(e){var t=e.url,n=e.method,r=e.payload,i=e.responseType,o=e.contentType,s=e.getRequestHeaders,a=e.calculateAttemptDelay,u=e.retryLimit,c=void 0===u?5:u,l=e.onSuccess,f=e.onError,p=void 0===f?function(){}:f,h=e.onAttempt,d=void 0===h?function(){}:h,v=e.onAttemptError,b=void 0===v?function(){}:v,m=e.shouldRetry,g=void 0===m?function(){return!0}:m;R({calculateAttemptDelay:a,attempt:function(e){var a=e.repeat;d(),Hf({method:n,url:t,payload:r,responseType:i,getRequestHeaders:o?function(){return I.merge(s(),{"Content-Type":o})}:s,onError:function(e){var t=g(e.status);b(t),(t?a:p)(e)},onSuccess:l})},onGiveUp:p,retryLimit:c})},zf=function(e,t){var n=e.url,r=e.assetKey,i=e.onError,o=e.onSuccess,s=e.identifier,a={method:"GET",responseType:"json",onSuccess:function(e){t.increment("sm.assets.load",["action:succeeded","asset:".concat(r)]),o(e)},onAttempt:function(){t.increment("sm.assets.load",["action:attempted","asset:".concat(r)])},onAttemptError:function(e){zu.warn("Failed fetching ".concat(r).concat(e?", retrying":""),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:warning","asset:".concat(r)])},onError:function(){zu.warn("Error fetching ".concat(r),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:failed","asset:".concat(r)]),"function"==typeof i&&i()}};Gf(I.merge(a,e))},Jf=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}};function Yf(e){var t=e.stats,n=function(e){return t.increment("sm.service.overseer_api.action_shortcircuited",["type:".concat(e),"site_id:".concat(Vu())])},r=function(){return{visitor_id:Lu(),site_id:Vu(),url:window.location.href}},i=function(e){var n=e.resource,r=e.method;zu.log("Successfully executed '".concat(r,"' on resource ").concat(n)),t.increment("sm.lib.overseer",["action:succeeded"])},o=function(e){var n=e.resource,r=e.method;zu.warn("Failed to execute '".concat(r,"' on resource ").concat(n)),t.increment("sm.lib.overseer",["action:failed"])},s=function(){t.increment("sm.lib.overseer",["action:attempted"])},a=0;return{sourcesTriggered:function(e){var t=e.events,n=e.tabId,u=e.resolvedConditions,c=e.initTimestamp,l=e.xhrWithRetry,f=void 0===l?Gf:l;a++;var p=I.merge(r(),{events:t,tab_id:n,init_timestamp:c,request_number:a,resolved_conditions:u});f({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/sources_triggered"),payload:p,contentType:"application/json",responseType:"json",getRequestHeaders:Jf,onAttempt:s,onSuccess:function(){i({resource:"overseer",method:"sources_triggered"})},onError:function(){o({resource:"overseer",method:"sources_triggered"})},calculateAttemptDelay:M(100),shouldRetry:function(e){return 422!==e}})},actionsShortcircuited:function(e){var t=e.browserEvents,n=e.xhrWithRetry,a=void 0===n?Gf:n,u={browser_events:I.map((function(e){return{rule_id:e.ruleId,action_types:e.actionTypes}}),t)};a({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/actions_shortcircuited"),payload:I.merge(r(),u),contentType:"application/json",responseType:"json",getRequestHeaders:Jf,onAttempt:s,onSuccess:function(){i({resource:"overseer",method:"actions_shortcircuited"})},onError:function(){o({resource:"overseer",method:"actions_shortcircuited"})},calculateAttemptDelay:M(100),shouldRetry:function(e){return 422!==e}})},sendOverseerMetrics:function(e){var t=e.browserEvents;I.forEach(n,t.map((function(e){return e.actionTypes})))}}}var Qf=function(e){var t=function(e){return I.compose(I.reject(I.isNil),I.chain(I.prop("queue_ids")),I.chain(I.prop("conditions")))(e)}(e)||[],n=function(e){return I.compose(I.reject(I.isNil),I.chain(I.path(["browser_event_conditions","queue_ids"])))(e)}(e)||[],r=t.concat(n);return I.uniq(r)},Kf=function(e){return I.filter(I.compose(I.or(I.isEmpty,I.isNil),I.chain(I.propOr([],"queue_ids")),I.prop("conditions")))(e)},Xf=function(e){return I.filter(I.compose(I.isEmpty,I.pathOr([],["browser_event_conditions","queue_ids"])))(e)};function $f(e){var t=e.cobraObservable,n=e.internalVisitorStateObservable,r=e.volatileNotifications,i=e.stats,o=e.wsProxy,s=e.currentStatusObservable,a=e.queuesStateUpdatesObservable,u=e.routingObservable;new Uc({volatileNotifications:r,cobraObservable:t,routingObservable:u}).start();var c=new _f(sm.conf,i,"visitor_api","overseer_xhr_enabled_percentage"),l=sm.conf.visitor_api.enable_xhr_to_overseer&&c.enabledForVisitor(Lu()),f=l?new Yf({stats:i}):new Uf({wsProxy:o,stats:i}),p=sm.conf.overseer.rules,h=sm.conf.omniq.omniq_enabled?p:function(e){return I.compose(Kf,Xf)(e)}(p),d=Qf(h),v=function(){if(I.not(I.isEmpty(d))){var e=new Pu.ReplaySubject(1);return a.subscribeToList({queueIds:d,listener:e.next.bind(e)}),e}return Pu.Observable.of(null)}();If.init(f,{currentStatusObservable:s.startWith("available"),internalVisitorStateObservable:n,queuesAvailabilityObservable:v,rules:h,routingObservable:u,overseerXhrEnabled:l})}function Zf(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=!1!==r.rethrow;return function(){try{return n.apply(this,arguments)}catch(n){if(Ju.clientHandlerError(t),zu.warn(e,n),i)throw n;console.error(n)}}}var ep=I.curryN(2,(function(e,t){return I.compose(I.forEach((function(t){var n=_(t,2),r=n[0],i=n[1];return e(r,i)})),I.toPairs)(t)})),tp=function(){var e={},t=function(e,t){return Zf("Event handler for ".concat(e," threw an error"),e,t,{rethrow:!1})},n=function(n,r){var i=(e[n]||{}).listenerEntries||[],o=I.compose(I.map((function(e){var i=e.listener;return{listener:i,subscription:r.subscribe(t(n,i),zu.error)}})),I.forEach((function(e){return e.subscription.unsubscribe()})))(i);e[n]={observable:r,listenerEntries:o}};return{observable:function(t){return e[t].observable},addEventListener:function(n,r){var i=e[n]||{},o=i.listenerEntries||[],s=i.observable;if(!I.any(I.propEq("listener",r),o)){var a=s?s.subscribe(t(n,r),zu.error):Pu.Subscription.EMPTY,u=I.append({listener:r,subscription:a},o);return e[n]={listenerEntries:u,observable:s},null}},removeEventListener:function(t,n){var r=e[t]||{},i=r.listenerEntries||[],o=r.observable,s=I.find(I.propEq("listener",n))(i);if(s){s.subscription.unsubscribe();var a=I.without([s])(i);e[t]={observable:o,listenerEntries:a}}return null},proxy:n,proxyAll:ep(n),eventWithoutListenerObservable:function(t){return(e[t]||{}).observable.pipe(wn((function(){return!function(t){var n=(e[t]||{}).listenerEntries||[];return I.not(I.isEmpty(n))}(t)})))},stop:function(){I.compose(I.forEach((function(e){return e.unsubscribe()})),I.map(I.prop("subscription")),I.chain(I.prop("listenerEntries")),I.values)(e),e={}}}},np=function(){var e=new Pu.Subscription,t=tp(),n=function(n,r){var i=r.publishReplay(1);e.add(i.connect()),t.proxy(n,i)};return{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener,eventWithoutListenerObservable:t.eventWithoutListenerObservable,proxy:n,proxyAll:ep(n),stop:function(){e.unsubscribe(),t.stop()},observable:t.observable}};function rp(e){var t=np();return t.proxy("change",e),{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener}}var ip=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sm.tracker;return rp(e.getUserIsActiveTabObservable())},op=function(){return rp(Pu.Observable.of(!0))};function sp(e){var t=e.channelObservable,n=e.logger.withTags({feature:"cobra"}),r=t.flatMap((function(e){var t=e.channel,n=e.operator;return Zu("Cobra").map((function(e){return{Cobra:e,channel:t,operator:n}}))})).distinctUntilChanged(null,(function(e){return e.channel.url})).switchMap((function(e){var t=e.Cobra,r=e.channel,i=e.operator,o=new t.SourceInitializer(r,ip(),i.id,n),s=o.initialize(),a=function(){return o.stop()};return r.addDestroyListener((function(){return a()})),Pu.Observable.create((function(e){return e.next({cobraSourceInitializer:o,cobraSource:s,operator:i}),function(){return a()}}))})).do((function(e){var t=e.operator;return n.info("Cobra: Started successfully",{operator_id:t.id})}),n.error.bind(n,"Cobra: Failed to start"),(function(){return n.info("Cobra: Stopped and will not start again")})),i=r.publishReplay(1);return sm.cobraSubscription=i.connect(),{cobraObservable:r=i.filter(I.pathEq(["cobraSource","status"],"started"))}}var ap,up={UNKNOWN:"unknown",NESTED_COBROWSABLE_IFRAME:"nested_cobrowsable_visitor",ENGAGEMENT_IFRAME:"main_visitor"},cp="cobrowsable_iframe_id",lp="sm:source:nested_cobrowsable_iframe:channel_url",fp="sm:iframe_context_check",pp=function e(t,n){var r=function(e,t){for(var n=e.querySelectorAll("iframe"),r=0;r<n.length;r++){var i=n[r];if(i.contentWindow===t)return i}}(t,n);if(r)return r;for(var i=t.querySelectorAll("*"),o=0;o<i.length;++o){var s=i[o];if(s.shadowRoot){var a=e(s.shadowRoot,n);if(a)return a}}return null},hp=new Pu.ReplaySubject(1);ap=new Set,hp.next(ap);var dp=function(e){ap.has(e)||(ap.add(e),hp.next(ap))};function vp(e){var t={parent:{},top:{}},n=new xl(window.parent);this.start=function(){n.start()},this.stop=function(){n.stop()},this.request=function(){n.request(fp,{tab_id:e},(function(e){e.context?(t.parent[e.context]=!0,dp(e.tabId)):(zu.warn("Received iframe identity check with unexpected payload"),t.parent[e]=!0)})),n.request(lp,{},(function(e){var n=e.url;t.nestedCobrowsableVisitorIframeChannelUrl=n}))},this.getCurrentContext=function(){return t},this.getParentWindowMessenger=function(){return n}}var bp=function(e){var t=new Il({allowAnySource:!0});return t.start(),t.respondTo(fp,(function(t,n,r){var i=pp(document,r);i&&function(e){var t=e.attributes[cp];t&&t.value||e.setAttribute(cp,Tl())}(i),t.tab_id?dp(t.tab_id):zu.warn("Received iframe identity check with unexpected payload",t),n({context:"visitor_page",tabId:e})})),t.stop.bind(t)},mp=function(e){var t=new Il({allowAnySource:!0});return t.start(),t.respondTo(fp,(function(t,n,r){n({context:"visitor_browser",tabId:e})})),t.stop.bind(t)};function gp(e,t){var n=t.visitor_api.iframe_identity_detection_timeout||5e3,r=t.visitor_api.iframe_identity_validity_check_timeout||3e4,i=function(){var t=e.getCurrentContext();return t.parent.visitor_page?up.NESTED_COBROWSABLE_IFRAME:t.parent.visitor_browser?up.ENGAGEMENT_IFRAME:void 0};return{detect:i,identityObservable:function(t){var o=Pu.Observable.interval(200,t).take(Math.round(n/200)).do((function(t){if(!t)return e.request()})).map(i).startWith(i()).filter((function(e){return Boolean(e)})).take(1).defaultIfEmpty(up.UNKNOWN).share(),s=o.filter((function(e){return e===up.UNKNOWN})).flatMap((function(){return Pu.Observable.interval(r/2,t).take(2).do((function(t){t||e.request()})).map(i).filter((function(e){return Boolean(e)})).take(1)}));return o.merge(s)},IDENTITIES:up}}var yp=function(){var e,t,n=new Pu.Subject;e=window.history,(t=e?e.pushState:void 0)&&(e.pushState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i}),function(){var e=window.history,t=e?e.replaceState:void 0;t&&(e.replaceState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i})}(),$c(window,"popstate").subscribe(n);var r=n.startWith({}).map((function(){return window.location.href})).distinctUntilChanged();sm.hrefObservable=r},_p=function(e){if("function"==typeof e)return e;return function(){return e}},wp="undefined"!=typeof self?self:null,Ep="undefined"!=typeof window?window:null,Op=wp||Ep||Op,Sp="2.0.0",Tp=0,kp=1,Ap=2,xp=3,Ip="closed",Np="errored",Mp="joined",Cp="joining",Rp="leaving",Pp="phx_close",jp="phx_error",Lp="phx_join",qp="phx_reply",Up="phx_leave",Dp="longpoll",Vp="websocket",Fp=4,Bp=function(){function e(t,n,r,i){s(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return u(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref;this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),Hp=function(){function e(t,n){s(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return u(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),Wp=function(){function e(t,n,r){var i=this;s(this,e),this.state=Ip,this.topic=t,this.params=_p(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Bp(this,Lp,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new Hp((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=Mp,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=Np,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close ".concat(i.topic," ").concat(i.joinRef())),i.state=Ip,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error ".concat(i.topic),e),i.isJoining()&&i.joinPush.reset(),i.state=Np,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout ".concat(i.topic," (").concat(i.joinRef(),")"),i.joinPush.timeout),new Bp(i,Up,_p({}),i.timeout).send(),i.state=Np,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(qp,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return u(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(Pp,e)}},{key:"onError",value:function(e){return this.on(jp,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '".concat(e,"' to '").concat(this.topic,"' before joining. Use channel.join() before pushing events"));var r=new Bp(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=Rp;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave ".concat(e.topic)),e.trigger(Pp,"leave")},r=new Bp(this,Up,_p({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=Cp,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_".concat(e)}},{key:"isClosed",value:function(){return this.state===Ip}},{key:"isErrored",value:function(){return this.state===Np}},{key:"isJoined",value:function(){return this.state===Mp}},{key:"isJoining",value:function(){return this.state===Cp}},{key:"isLeaving",value:function(){return this.state===Rp}}]),e}(),Gp=function(){function e(){s(this,e)}return u(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(Op.XDomainRequest){var a=new Op.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new Op.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===Fp&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?"".concat(t,"[").concat(r,"]"):r,s=e[r];"object"===o(s)?n.push(this.serialize(s,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(s))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return"".concat(e).concat(n).concat(this.serialize(t))}}]),e}(),zp=function(){function e(t){s(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=Tp,this.poll()}return u(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+Vp),"$1/"+Dp)}},{key:"endpointURL",value:function(){return Gp.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=Tp}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===kp||this.readyState===Tp}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=kp,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r,i=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=E(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw o}}}}(this.reqs);try{for(i.s();!(r=i.n()).done;){r.value.abort()}}catch(e){i.e(e)}finally{i.f()}this.readyState=xp;var o=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",o)):this.onclose(o)}},{key:"ajax",value:function(e,t,n,r){var i,o=this;i=Gp.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){o.reqs.delete(i),n()}),(function(e){o.reqs.delete(i),o.isActive()&&r(e)})),this.reqs.add(i)}}]),e}(),Jp=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return u(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l={metas:c?c.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,w(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),Yp={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));var n=_(JSON.parse(e),5);return t({join_ref:n[0],ref:n[1],topic:n[2],event:n[3],payload:n[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var p=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:qp,payload:{status:f,response:p}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},Qp=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||Op.WebSocket||zp,this.establishedConnections=0,this.defaultEncoder=Yp.encode.bind(Yp),this.defaultDecoder=Yp.decode.bind(Yp),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==zp?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;Ep&&Ep.addEventListener&&(Ep.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),i=n.connectClock)})),Ep.addEventListener("pageshow",(function(e){i===n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=_p(r.params||{}),this.endPoint="".concat(t,"/").concat(Vp),this.vsn=r.vsn||Sp,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new Hp((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return u(e,[{key:"getLongPollTransport",value:function(){return zp}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=Gp.appendParams(Gp.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?"".concat(this.protocol(),":").concat(e):"".concat(this.protocol(),"://").concat(location.host).concat(e)}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=_p(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){this.hasLogger()&&this.log("transport","connected to ".concat(this.endPointURL())),this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,_(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==xp?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,_(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,_(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(jp)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case Tp:return"connecting";case kp:return"open";case Ap:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=_(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Wp(e,t,this);return this.channels.push(n),n}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push","".concat(n," ").concat(r," (").concat(s,", ").concat(o,")"),i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive","".concat(i.status||""," ").concat(n," ").concat(r," ").concat(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,_(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'.concat(e,'"')),t.leave())}}]),e}(),Kp=function(){return"hidden"===document.visibilityState},Xp=function(){return navigator.onLine},$p=function(e,t){return t.onlyLongPollEnabled?zp:window.WebSocket?Xp()?e.transport===window.WebSocket?zp:window.WebSocket:e.transport:zp};function Zp(e){var t,n={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},r=function(t,r){n.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=zp,r&&r(t),e.connect()}))};return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!n.connectionTriedOnce){o&&o(),"number"==typeof a&&(n.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}n.connectionTriedOnce=!0,t=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===zp){var n=$p(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,n)}},selectNewTransport:function(){Xp()&&!Kp()&&(e.transport=$p(e,n))},stop:function(){t&&t()}}}var eh=function(e){return e===window.WebSocket?"WebSocket":e===zp?"LongPoll":"unknown"},th=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},nh={metrics:{}};function rh(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"},o=r.logPrefix,s=0,a=!1;n=n||nh;var u=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},c=function(t){return i(i({},{transport:eh(e.transport),online:Xp(),visibility_state:document.visibilityState,error_count:s}),t)},l=function(t,n){var r=(n||{}).transport;return["transport:".concat(r||eh(e.transport)),"online:".concat(Xp())].concat(t)},f=function(){a=!0,u(l(["action:connected"])),t.info("".concat(o," socket opened"),c({}))},p=function(e){if(e){var n=eh(window.WebSocket),r=c({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),i=l(["action:disconnected","type:".concat(e.type),"code:".concat(e.code)],{transport:n});e.wasClean?(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected cleanly"),r)):Kp()?(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected while tab was hidden"),r)):(u(i.concat(["reason:closed"])),t.info("".concat(o," connection disconnected"),r))}else{var s=eh(zp),a=c({reason:"unknown",type:"unknown",code:"unknown",transport:s}),f=l(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:s});u(f),t.info("".concat(o," connection disconnected"),a)}},h=function(e){var n=e&&e.type||"unknown";s+=1;var r=e&&e.target?c({type:n}):c({type:n,error:e});Kp()?t.info("".concat(o," connection error while tab was hidden"),r):Xp()?1!==s||a?(u(l(["action:error"])),t.warn("".concat(o," socket connection error"),r)):t.info("".concat(o," socket connection error while attempting to establish the connection first time"),r):t.info("".concat(o," connection error while user was offline"),r)},d=function(n){return t.info("".concat(o," failed to connect with initial transport"),{new_transport:eh(e.transport),error:th(n)})},v=function(){return u(l(["action:connect"]))};return{onOpen:f,onClose:p,onError:h,onInitialTry:v,onInitialConnectError:d}}var ih=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,i){return e.info("".concat(r," ").concat(t,": ").concat(n),{pubsub_data:i})}:function(){}},oh="sm.app.visitor_api.pubsub",sh="".concat(oh,".connection"),ah="".concat(oh,".push"),uh=2147483647,ch=function(e){var t=e.server,n=e.socket,r=e.stats,i=e.logsEnabled,s=e.getAccessToken,a=e.visitorIdObservable,u=void 0===a?Uu():a,c=e.reconnectConf,l=void 0===c?{}:c,f=e.getVisitorPriority,p=e.renewAccessToken,h=null;l={initialDelay:l.initialDelay||3e3,maxDelay:l.maxDelay||6e4,delayFactor:l.delayFactor||1.5};var d=0,v=M(l.initialDelay,l.maxDelay,l.delayFactor);n||(n=new Qp("".concat(t,"/notifications"),{logger:ih(zu,{enabled:i,logPrefix:"[PubSub]"}),params:function(){return{access_token:s(),priority:f()}},reconnectAfterMs:function(e){return v(d)},heartbeatIntervalMs:1e4}));var b=new Zp(n),m=new rh(n,zu,{increment:r.increment.bind(r),metrics:{connectionMetric:sh}},{logPrefix:"PubSub"}),g=new Pu.ReplaySubject(1),y=sm.conf.engagement.api_timeout_milliseconds||1e4;n.onOpen((function(){g.next(!0),m.onOpen()})),n.onClose((function(e){g.next(!1),d+=1,m.onClose(e),h&&n.disconnect()})),n.onError((function(e){if(g.next(!1),"number"==typeof e)switch(e){case 403:zu.info("Detected likely pubsub authentication error, reconnecting after max delay"),v.setNextDelayMinimum(l.maxDelay);break;case 410:break;case 500:zu.info("PubSub connection disconnected with error 500");break;case 503:var t=l.maxDelay/2;zu.info("PubSub unavailable, postponing reconnecting for at least ".concat(t," ms")),v.setNextDelayMinimum(t);break;default:return zu.error("Received unhandled pubsub error status ".concat(e,", stopping reconnecting")),void n.disconnect()}m.onError(e),b.selectNewTransport()}));var _=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},w=function(e,t,i,o){var s=function(e){if("function"==typeof e)return e.modify=function(){throw new Error("Cannot modify channel params because it is a closure already")},e;var t=I.clone(e||{}),n=function(){return t};return n.modify=function(e,n){t[e]=n(t[e])},n}(t);o||(o={}),i||(i=[]);var a=Pu.Observable.create((function(a){var u=!1,c=(t||{}).timeout||uh,l=n.channel(e,s);return l.join(c).receive("ok",(function(){u=!0,a.next(function(e,t){var n=function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.disableStats,s=i.timeout;s||(s=y);var a=function(e,t){o||r.increment(e,t)};return Pu.Observable.create((function(r){return e.push(t,n,s).receive("ok",(function(e){r.next(e),r.complete()})).receive("error",(function(e){a(ah,["action:error"]),r.error({type:"error",error:e})})).receive("timeout",(function(){a(ah,["action:timeout"]),r.error({type:"timeout"})})),function(){}}))};return{observable:function(t,n){return n||(n={}),Pu.Observable.create((function(r){var i=e.on(t,(function(e){return r.next(e)}));return function(){e.off(t,i),n.leaveChannelOnDispose&&e.leave()}}))},push:n,phoenixChannel:e,leave:function(){return e.leave()},watchNewTopics:function(e){return t.modify("topics",(function(t){return I.union(t||[],e)})),n("watch",{topics:e},{timeout:uh})}}}(l,s)),a.complete()})).receive("error",(function(t){t&&"join crashed"===t.reason?zu.info("Joining Pubsub channel failed with crash, retrying",{reason:"error",error:_(t),topic:e}):t&&"overload"===t.reason?zu.info("Joining Pubsub channel failed because of overload, retrying",{topic:e}):(t&&-1!==i.indexOf(t.reason)?zu.info("Joining Pubsub channel failed with expected reason",{reason:"error",error:_(t),topic:e}):zu.warn("Joining Pubsub channel failed",{reason:"error",error:_(t),topic:e}),a.error({type:"error",error:t}))})).receive("timeout",(function(){return zu.warn("Joining Pubsub channel failed",{reason:"timeout",topic:e})})),function(){u&&!o.leaveChannelOnDispose||l.leave()}}));return Pu.Observable.defer((function(){return b.ensureConnected({onInitialTry:function(){return m.onInitialTry},onInitialError:function(e){return m.onInitialConnectError(e)}}),Pu.Observable.of({})})).flatMapTo(g).filter(I.equals(!0)).take(1).flatMapTo(a)},E=u.switchMap((function(e){return w("visitor_volatile:".concat(e))})).publishReplay(1);E.connect(),E.flatMap((function(e){return e.observable("system:avoid_reconnection")})).subscribe((function(e){var t,r,i=e.duration_in_seconds;r=.5,i=(t=i)+Math.floor(Math.random()*r*t),zu.info("Disabling reconnections to pubsub",{duration_in_seconds:i}),h&&clearTimeout(h),h=setTimeout((function(){zu.info("Enabling reconnections to pubsub"),h=null,n.connect()}),1e3*i)}));var O,S,T,k=I.compose(I.not,I.isEmpty,I.symmetricDifference),A=function(e,t){return I.map((function(t){return"site_visitor:".concat(e,":").concat(t)}),t)},x=[];return{joinChannel:w,volatileChannelObservable:E,joinSiteVisitorNotifications:function(e,t){return!I.isEmpty(x)&&O&&S===e||(S=e,x=t,(O=w("site_visitor:".concat(e),{topics:A(e,x)}).publishReplay(1)).connect(),(T=O.flatMap((function(e){return(0,e.observable)("message")})).filter(I.identity).publishReplay(50)).connect()),k(t,x)&&(x=I.union(t,x),O.take(1).flatMap((function(t){return(0,t.watchNewTopics)(A(e,x))})).subscribe((function(){return zu.debug("Subscribed to additional sites",x)}),(function(e){return zu.warn("Error subscribing to additional sites",e,x)}))),T},connectedObservable:g.distinctUntilChanged(),disconnect:n.disconnect.bind(n),connect:n.connect.bind(n),reconnect:function(){return n.disconnect((function(){return n.connect()}))},renewTokenAndReconnectWaitForTeardown:function(e){var t=e.consolidationSecret;return p({consolidationSecret:t}).flatMap((function(){return Pu.Observable.create((function(e){n.disconnect((function(){n.connect(),e.next(),e.complete()}))}))}))},allowReconnection:function(){return null===h}}};function lh(e,t){var n=t.visitorId,r=t.visitorIdObservable,o=t.tabId,s=t.idleTimeoutSeconds,a=t.visitorMetadata;n=n||Lu(),r=r||Uu();var u="JOIN_NOT_REQUESTED",c="JOINING_ALLOW_REJECTION",l="JOINING_ALLOW_REJECTION_BUT_NO_REJECTION_REQUESTED",f="JOINING_NO_REJECTION",p="JOIN_REJECTED",h="JOINED",d="JOIN_ERROR",v="JOIN_REQUESTED_ALLOW_REJECTION",b="JOIN_REJECTED",m="JOIN_ERROR",g="JOIN_SUCCESSFUL",y="JOIN_REQUESTED_NO_REJECTION",w="VISITOR_ID_CHANGED",E="too_many_tracked",O=new Pu.ReplaySubject(1),S=function(t,n,r){var i="visitor_presence:".concat(t),u=n?[E]:[],c=!1;e.joinChannel(i,(function(){return{tab_id:o,page_url:location.href,page_description:document.title,idle_timeout_seconds:s,visitor_metadata:I.pick(["location"],a),allow_rejection:n&&!c}}),u).take(1).map((function(e){var t=e.phoenixChannel,n=e.leave;return[new Jp(t),n]})).subscribe((function(e){var t=_(e,2),n=t[0],i=t[1];c=!0,r(g,{presence:n,leavePresence:i})}),(function(e){I.pathEq(["error","reason"],E,e)?r(b):r(m)}))},T={joinState:u,visitorId:n},k=function e(t,n){var r=_(function(e,t,n){switch(t){case v:switch(e.joinState){case u:return[i(i({},e),{},{joinState:c}),function(t){return S(e.visitorId,!0,t)}];default:return[e]}case y:switch(e.joinState){case u:case p:return[i(i({},e),{},{joinState:f}),function(t){return S(e.visitorId,!1,t)}];case c:return[i(i({},e),{},{joinState:l})];default:return[e]}case b:switch(e.joinState){case l:return[i(i({},e),{},{joinState:f}),function(t){return S(e.visitorId,!1,t)}];case c:return[i(i({},e),{},{joinState:p})];case f:return zu.error("Request to join visitor presence channel was rejected, although we did not allow rejection"),[i(i({},e),{},{joinState:p})];default:return zu.error("Received join rejection while we were not joining channel",{currentState:e}),[e]}case m:switch(e.joinState){case c:case f:case l:return[i(i({},e),{},{joinState:d})];default:return zu.error("Received join error while we were not joining channel",{currentState:e}),[e]}case g:switch(e.joinState){case c:case f:case l:return[i(i({},e),{},{joinState:h,leavePresence:n.leavePresence}),function(){return O.next(n.presence)}];default:return zu.error("Received join successful while we were not joining channel",{currentState:e}),[e]}case w:var r=n;if(r===e.visitorId)return[e];switch(e.joinState){case c:case f:case l:var o=e.joinState===c;return[i(i({},e),{},{visitorId:r}),function(e){return S(r,o,e)}];case h:return[i(i({},e),{},{visitorId:r,joinState:f}),function(t){e.leavePresence(),S(r,!1,t)}];default:return zu.info("Visitor ID changed, but not joining visitor presence"),[e]}default:return zu.error("Received invalid action",{action:t}),[e]}}(T,t,n),2),o=r[0],s=r[1];T=o,s&&s(e)};r.subscribe((function(e){return k(w,e)}),zu.error.bind(zu,"Error from visitor ID subscription in visitor presence channel")),this.requestJoin=function(){k(y)},this.requestJoinAllowRejection=function(){k(v)},this.getPresenceObservable=function(){return O.asObservable()};var A=O.switchMap((function(e){return Pu.Observable.create((function(t){e.onSync((function(){var n=e.list();n[0]?I.any(I.equals(void 0),n[0].metas)?zu.warn("Visitor Presence metas included undefined value"):t.next(n[0].metas):t.next([])}))}))})).publishReplay(1);A=rl(A),this.getSameVisitorConnections=function(){return A}}var fh="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ph(e,t){return e(t={exports:{}},t.exports),t.exports}var hh=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,dh=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],vh=function(e){var t=e,n=e.indexOf("["),r=e.indexOf("]");-1!=n&&-1!=r&&(e=e.substring(0,n)+e.substring(n,r).replace(/:/g,";")+e.substring(r,e.length));for(var i=hh.exec(e||""),o={},s=14;s--;)o[dh[s]]=i[s]||"";return-1!=n&&-1!=r&&(o.source=t,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o},bh="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)},mh=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},gh=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),yh=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},_h=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},wh=1e3,Eh=60*wh,Oh=60*Eh,Sh=24*Oh,Th=365.25*Sh,kh=function(e,t){t=t||{};var n,r=void 0===e?"undefined":bh(e);if("string"===r&&e.length>0)return function(e){if((e=String(e)).length>1e4)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*Th;case"days":case"day":case"d":return n*Sh;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Oh;case"minutes":case"minute":case"mins":case"min":case"m":return n*Eh;case"seconds":case"second":case"secs":case"sec":case"s":return n*wh;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===r&&!1===isNaN(e))return t.long?Ah(n=e,Sh,"day")||Ah(n,Oh,"hour")||Ah(n,Eh,"minute")||Ah(n,wh,"second")||n+" ms":function(e){if(e>=Sh)return Math.round(e/Sh)+"d";if(e>=Oh)return Math.round(e/Oh)+"h";if(e>=Eh)return Math.round(e/Eh)+"m";if(e>=wh)return Math.round(e/wh)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function Ah(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var xh=ph((function(e,t){(t=e.exports=o.debug=o).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/[\\^$+?.()|[\]{}]/g,"\\$&").replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=kh,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(){return t.colors[r++%t.colors.length]}function o(e){function r(){}function o(){var e=o,r=+new Date,s=r-(n||r);e.diff=s,e.prev=n,e.curr=r,n=r,null==e.useColors&&(e.useColors=t.useColors()),null==e.color&&e.useColors&&(e.color=i());for(var a=new Array(arguments.length),u=0;u<a.length;u++)a[u]=arguments[u];a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&(a=["%o"].concat(a));var c=0;a[0]=a[0].replace(/%([a-z%])/g,(function(n,r){if("%%"===n)return n;c++;var i=t.formatters[r];if("function"==typeof i){var o=a[c];n=i.call(e,o),a.splice(c,1),c--}return n})),a=t.formatArgs.apply(e,a);var l=o.log||t.log||console.log.bind(console);l.apply(e,a)}r.enabled=!1,o.enabled=!0;var s=t.enabled(e)?o:r;return s.namespace=e,s}})),Ih=ph((function(e,t){function n(){try{return t.storage.debug}catch(e){}if("undefined"!=typeof process&&"env"in process)return process.env.DEBUG}(t=e.exports=xh).log=function(){return"object"===("undefined"==typeof console?"undefined":bh(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"undefined"!=typeof document&&"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())})),Nh=vh,Mh=Ih("socket.io-client:url"),Ch=function(e,t){var n=e;t=t||fh.location,null==e&&(e=t.protocol+"//"+t.host);"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(Mh("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),Mh("parse %s",e),n=Nh(e));n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443"));n.path=n.path||"/";var r=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n};var Rh=1e3,Ph=6e4,jh=60*Ph,Lh=24*jh,qh=365.25*Lh,Uh=function(e,t){return t=t||{},"string"==typeof e?function(e){if((e=""+e).length>1e4)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*qh;case"days":case"day":case"d":return n*Lh;case"hours":case"hour":case"hrs":case"hr":case"h":return n*jh;case"minutes":case"minute":case"mins":case"min":case"m":return n*Ph;case"seconds":case"second":case"secs":case"sec":case"s":return n*Rh;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n}}(e):t.long?Dh(n=e,Lh,"day")||Dh(n,jh,"hour")||Dh(n,Ph,"minute")||Dh(n,Rh,"second")||n+" ms":function(e){return e>=Lh?Math.round(e/Lh)+"d":e>=jh?Math.round(e/jh)+"h":e>=Ph?Math.round(e/Ph)+"m":e>=Rh?Math.round(e/Rh)+"s":e+"ms"}(e);var n};function Dh(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var Vh=ph((function(e,t){(t=e.exports=function(e){function r(){}function o(){var e=o,r=+new Date,s=r-(n||r);e.diff=s,e.prev=n,e.curr=r,n=r,null==e.useColors&&(e.useColors=t.useColors()),null==e.color&&e.useColors&&(e.color=i());var a=Array.prototype.slice.call(arguments);a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&(a=["%o"].concat(a));var u=0;a[0]=a[0].replace(/%([a-z%])/g,(function(n,r){if("%%"===n)return n;u++;var i=t.formatters[r];if("function"==typeof i){var o=a[u];n=i.call(e,o),a.splice(u,1),u--}return n})),"function"==typeof t.formatArgs&&(a=t.formatArgs.apply(e,a));var c=o.log||t.log||console.log.bind(console);c.apply(e,a)}r.enabled=!1,o.enabled=!0;var s=t.enabled(e)?o:r;return s.namespace=e,s}).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=Uh,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(){return t.colors[r++%t.colors.length]}})),Fh=ph((function(e,t){function n(){var e;try{e=t.storage.debug}catch(e){}return e}(t=e.exports=Vh).log=function(){return"object"===("undefined"==typeof console?"undefined":bh(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){return JSON.stringify(e)},t.enable(n())})),Bh=ph((function(e,t){
/*! JSON v3.3.2 | http://bestiejs.github.io/json3 | Copyright 2012-2014, Kit Cambridge | http://kit.mit-license.org */
(function(){var n={function:!0,object:!0},r=n.object&&t&&!t.nodeType&&t,i=n["undefined"==typeof window?"undefined":bh(window)]&&window||this,o=r&&n.object&&e&&!e.nodeType&&"object"==bh(fh)&&fh;function s(e,t){e||(e=i.Object()),t||(t=i.Object());var r=e.Number||i.Number,o=e.String||i.String,a=e.Object||i.Object,u=e.Date||i.Date,c=e.SyntaxError||i.SyntaxError,l=e.TypeError||i.TypeError,f=e.Math||i.Math,p=e.JSON||i.JSON;"object"==(void 0===p?"undefined":bh(p))&&p&&(t.stringify=p.stringify,t.parse=p.parse);var h,d,v,b=a.prototype,m=b.toString,g=new u(-0xc782b5b800cec);try{g=-109252==g.getUTCFullYear()&&0===g.getUTCMonth()&&1===g.getUTCDate()&&10==g.getUTCHours()&&37==g.getUTCMinutes()&&6==g.getUTCSeconds()&&708==g.getUTCMilliseconds()}catch(e){}function y(e){if(y[e]!==v)return y[e];var n;if("bug-string-char-index"==e)n="a"!="a"[0];else if("json"==e)n=y("json-stringify")&&y("json-parse");else{var i,s='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==e){var a=t.stringify,c="function"==typeof a&&g;if(c){(i=function(){return 1}).toJSON=i;try{c="0"===a(0)&&"0"===a(new r)&&'""'==a(new o)&&a(m)===v&&a(v)===v&&a()===v&&"1"===a(i)&&"[1]"==a([i])&&"[null]"==a([v])&&"null"==a(null)&&"[null,null,null]"==a([v,m,null])&&a({a:[i,!0,!1,null,"\0\b\n\f\r\t"]})==s&&"1"===a(null,i)&&"[\n 1,\n 2\n]"==a([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==a(new u(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==a(new u(864e13))&&'"-000001-01-01T00:00:00.000Z"'==a(new u(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==a(new u(-1))}catch(e){c=!1}}n=c}if("json-parse"==e){var l=t.parse;if("function"==typeof l)try{if(0===l("0")&&!l(!1)){var f=5==(i=l(s)).a.length&&1===i.a[0];if(f){try{f=!l('"\t"')}catch(e){}if(f)try{f=1!==l("01")}catch(e){}if(f)try{f=1!==l("1.")}catch(e){}}}}catch(e){f=!1}n=f}}return y[e]=!!n}if(!y("json")){var _="[object Function]",w="[object Number]",E="[object String]",O="[object Array]",S=y("bug-string-char-index");if(!g)var T=f.floor,k=[0,31,59,90,120,151,181,212,243,273,304,334],A=function(e,t){return k[t]+365*(e-1970)+T((e-1969+(t=+(t>1)))/4)-T((e-1901+t)/100)+T((e-1601+t)/400)};if((h=b.hasOwnProperty)||(h=function(e){var t,n={};return(n.__proto__=null,n.__proto__={toString:1},n).toString!=m?h=function(e){var t=this.__proto__,n=e in(this.__proto__=null,this);return this.__proto__=t,n}:(t=n.constructor,h=function(e){var n=(this.constructor||t).prototype;return e in this&&!(e in n&&this[e]===n[e])}),n=null,h.call(this,e)}),d=function(e,t){var r,i,o,s=0;for(o in(r=function(){this.valueOf=0}).prototype.valueOf=0,i=new r)h.call(i,o)&&s++;return r=i=null,s?d=2==s?function(e,t){var n,r={},i=m.call(e)==_;for(n in e)i&&"prototype"==n||h.call(r,n)||!(r[n]=1)||!h.call(e,n)||t(n)}:function(e,t){var n,r,i=m.call(e)==_;for(n in e)i&&"prototype"==n||!h.call(e,n)||(r="constructor"===n)||t(n);(r||h.call(e,n="constructor"))&&t(n)}:(i=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],d=function(e,t){var r,o,s=m.call(e)==_,a=!s&&"function"!=typeof e.constructor&&n[bh(e.hasOwnProperty)]&&e.hasOwnProperty||h;for(r in e)s&&"prototype"==r||!a.call(e,r)||t(r);for(o=i.length;r=i[--o];a.call(e,r)&&t(r));}),d(e,t)},!y("json-stringify")){var x={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},I=function(e,t){return("000000"+(t||0)).slice(-e)},N=function(e){for(var t='"',n=0,r=e.length,i=!S||r>10,o=i&&(S?e.split(""):e);n<r;n++){var s=e.charCodeAt(n);switch(s){case 8:case 9:case 10:case 12:case 13:case 34:case 92:t+=x[s];break;default:if(s<32){t+="\\u00"+I(2,s.toString(16));break}t+=i?o[n]:e.charAt(n)}}return t+'"'},M=function e(t,n,r,i,o,s,a){var u,c,f,p,b,g,y,_,S,k,x,M,C,R,P,j;try{u=n[t]}catch(e){}if("object"==(void 0===u?"undefined":bh(u))&&u)if("[object Date]"!=(c=m.call(u))||h.call(u,"toJSON"))"function"==typeof u.toJSON&&(c!=w&&c!=E&&c!=O||h.call(u,"toJSON"))&&(u=u.toJSON(t));else if(u>-1/0&&u<1/0){if(A){for(b=T(u/864e5),f=T(b/365.2425)+1970-1;A(f+1,0)<=b;f++);for(p=T((b-A(f,0))/30.42);A(f,p+1)<=b;p++);b=1+b-A(f,p),y=T((g=(u%864e5+864e5)%864e5)/36e5)%24,_=T(g/6e4)%60,S=T(g/1e3)%60,k=g%1e3}else f=u.getUTCFullYear(),p=u.getUTCMonth(),b=u.getUTCDate(),y=u.getUTCHours(),_=u.getUTCMinutes(),S=u.getUTCSeconds(),k=u.getUTCMilliseconds();u=(f<=0||f>=1e4?(f<0?"-":"+")+I(6,f<0?-f:f):I(4,f))+"-"+I(2,p+1)+"-"+I(2,b)+"T"+I(2,y)+":"+I(2,_)+":"+I(2,S)+"."+I(3,k)+"Z"}else u=null;if(r&&(u=r.call(n,t,u)),null===u)return"null";if("[object Boolean]"==(c=m.call(u)))return""+u;if(c==w)return u>-1/0&&u<1/0?""+u:"null";if(c==E)return N(""+u);if("object"==(void 0===u?"undefined":bh(u))){for(R=a.length;R--;)if(a[R]===u)throw l();if(a.push(u),x=[],P=s,s+=o,c==O){for(C=0,R=u.length;C<R;C++)M=e(C,u,r,i,o,s,a),x.push(M===v?"null":M);j=x.length?o?"[\n"+s+x.join(",\n"+s)+"\n"+P+"]":"["+x.join(",")+"]":"[]"}else d(i||u,(function(t){var n=e(t,u,r,i,o,s,a);n!==v&&x.push(N(t)+":"+(o?" ":"")+n)})),j=x.length?o?"{\n"+s+x.join(",\n"+s)+"\n"+P+"}":"{"+x.join(",")+"}":"{}";return a.pop(),j}};t.stringify=function(e,t,r){var i,o,s,a;if(n[void 0===t?"undefined":bh(t)]&&t)if((a=m.call(t))==_)o=t;else if(a==O){s={};for(var u,c=0,l=t.length;c<l;u=t[c++],((a=m.call(u))==E||a==w)&&(s[u]=1));}if(r)if((a=m.call(r))==w){if((r-=r%1)>0)for(i="",r>10&&(r=10);i.length<r;i+=" ");}else a==E&&(i=r.length<=10?r:r.slice(0,10));return M("",((u={})[""]=e,u),o,s,i,"",[])}}if(!y("json-parse")){var C,R,P=o.fromCharCode,j={92:"\\",34:'"',47:"/",98:"\b",116:"\t",110:"\n",102:"\f",114:"\r"},L=function(){throw C=R=null,c()},q=function(){for(var e,t,n,r,i,o=R,s=o.length;C<s;)switch(i=o.charCodeAt(C)){case 9:case 10:case 13:case 32:C++;break;case 123:case 125:case 91:case 93:case 58:case 44:return e=S?o.charAt(C):o[C],C++,e;case 34:for(e="@",C++;C<s;)if((i=o.charCodeAt(C))<32)L();else if(92==i)switch(i=o.charCodeAt(++C)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:e+=j[i],C++;break;case 117:for(t=++C,n=C+4;C<n;C++)(i=o.charCodeAt(C))>=48&&i<=57||i>=97&&i<=102||i>=65&&i<=70||L();e+=P("0x"+o.slice(t,C));break;default:L()}else{if(34==i)break;for(i=o.charCodeAt(C),t=C;i>=32&&92!=i&&34!=i;)i=o.charCodeAt(++C);e+=o.slice(t,C)}if(34==o.charCodeAt(C))return C++,e;L();default:if(t=C,45==i&&(r=!0,i=o.charCodeAt(++C)),i>=48&&i<=57){for(48==i&&((i=o.charCodeAt(C+1))>=48&&i<=57)&&L(),r=!1;C<s&&((i=o.charCodeAt(C))>=48&&i<=57);C++);if(46==o.charCodeAt(C)){for(n=++C;n<s&&((i=o.charCodeAt(n))>=48&&i<=57);n++);n==C&&L(),C=n}if(101==(i=o.charCodeAt(C))||69==i){for(43!=(i=o.charCodeAt(++C))&&45!=i||C++,n=C;n<s&&((i=o.charCodeAt(n))>=48&&i<=57);n++);n==C&&L(),C=n}return+o.slice(t,C)}if(r&&L(),"true"==o.slice(C,C+4))return C+=4,!0;if("false"==o.slice(C,C+5))return C+=5,!1;if("null"==o.slice(C,C+4))return C+=4,null;L()}return"$"},U=function e(t){var n,r;if("$"==t&&L(),"string"==typeof t){if("@"==(S?t.charAt(0):t[0]))return t.slice(1);if("["==t){for(n=[];"]"!=(t=q());r||(r=!0))r&&(","==t?"]"==(t=q())&&L():L()),","==t&&L(),n.push(e(t));return n}if("{"==t){for(n={};"}"!=(t=q());r||(r=!0))r&&(","==t?"}"==(t=q())&&L():L()),","!=t&&"string"==typeof t&&"@"==(S?t.charAt(0):t[0])&&":"==q()||L(),n[t.slice(1)]=e(q());return n}L()}return t},D=function(e,t,n){var r=V(e,t,n);r===v?delete e[t]:e[t]=r},V=function(e,t,n){var r,i=e[t];if("object"==(void 0===i?"undefined":bh(i))&&i)if(m.call(i)==O)for(r=i.length;r--;)D(i,r,n);else d(i,(function(e){D(i,e,n)}));return n.call(e,t,i)};t.parse=function(e,t){var n,r;return C=0,R=""+e,n=U(q()),"$"!=q()&&L(),C=R=null,t&&m.call(t)==_?V(((r={})[""]=n,r),"",t):n}}}return t.runInContext=s,t}if(!o||o.global!==o&&o.window!==o&&o.self!==o||(i=o),r)s(i,r);else{var a=i.JSON,u=i.JSON3,c=!1,l=s(i,i.JSON3={noConflict:function(){return c||(c=!0,i.JSON=a,i.JSON3=u,a=u=null),l}});i.JSON={parse:l.parse,stringify:l.stringify}}}).call(fh)})),Hh=Wh;function Wh(e){if(e)return function(e){for(var t in Wh.prototype)e[t]=Wh.prototype[t];return e}(e)}Wh.prototype.on=Wh.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},Wh.prototype.once=function(e,t){var n=this;function r(){n.off(e,r),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=t,this.on(e,r),this},Wh.prototype.off=Wh.prototype.removeListener=Wh.prototype.removeAllListeners=Wh.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return this},Wh.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},Wh.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},Wh.prototype.hasListeners=function(e){return!!this.listeners(e).length};var Gh=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},zh=function(e){return fh.Buffer&&fh.Buffer.isBuffer(e)||fh.ArrayBuffer&&e instanceof ArrayBuffer};var Jh=Gh,Yh=zh,Qh={deconstructPacket:function(e){var t=[],n=e.data;var r=e;return r.data=function e(n){if(!n)return n;if(Yh(n)){var r={_placeholder:!0,num:t.length};return t.push(n),r}if(Jh(n)){for(var i=new Array(n.length),o=0;o<n.length;o++)i[o]=e(n[o]);return i}if("object"==(void 0===n?"undefined":bh(n))&&!(n instanceof Date)){i={};for(var s in n)i[s]=e(n[s]);return i}return n}(n),r.attachments=t.length,{packet:r,buffers:t}},reconstructPacket:function(e,t){return e.data=function e(n){if(n&&n._placeholder)return t[n.num];if(Jh(n)){for(var r=0;r<n.length;r++)n[r]=e(n[r]);return n}if(n&&"object"==(void 0===n?"undefined":bh(n))){for(var i in n)n[i]=e(n[i]);return n}return n}(e.data),e.attachments=void 0,e},removeBlobs:function(e,t){var n=0,r=e;!function e(i,o,s){if(!i)return i;if(fh.Blob&&i instanceof Blob||fh.File&&i instanceof File){n++;var a=new FileReader;a.onload=function(){s?s[o]=this.result:r=this.result,--n||t(r)},a.readAsArrayBuffer(i)}else if(Jh(i))for(var u=0;u<i.length;u++)e(i[u],u,i);else if(i&&"object"==(void 0===i?"undefined":bh(i))&&!Yh(i))for(var c in i)e(i[c],c,i)}(r),n||t(r)}},Kh=ph((function(e,t){var n=Fh("socket.io-parser"),r=Bh,i=Hh,o=Qh,s=zh;function a(){}function u(e){var i="",o=!1;return i+=e.type,t.BINARY_EVENT!=e.type&&t.BINARY_ACK!=e.type||(i+=e.attachments,i+="-"),e.nsp&&"/"!=e.nsp&&(o=!0,i+=e.nsp),null!=e.id&&(o&&(i+=",",o=!1),i+=e.id),null!=e.data&&(o&&(i+=","),i+=r.stringify(e.data)),n("encoded %j as %s",e,i),i}function c(){this.reconstructor=null}function l(e){this.reconPack=e,this.buffers=[]}function f(e){return{type:t.ERROR,data:"parser error"}}t.protocol=4,t.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],t.CONNECT=0,t.DISCONNECT=1,t.EVENT=2,t.ACK=3,t.ERROR=4,t.BINARY_EVENT=5,t.BINARY_ACK=6,t.Encoder=a,t.Decoder=c,a.prototype.encode=function(e,r){(n("encoding packet %j",e),t.BINARY_EVENT==e.type||t.BINARY_ACK==e.type)?function(e,t){function n(e){var n=o.deconstructPacket(e),r=u(n.packet),i=n.buffers;i.unshift(r),t(i)}o.removeBlobs(e,n)}(e,r):r([u(e)])},i(c.prototype),c.prototype.add=function(e){var i;if("string"==typeof e)i=function(e){var i={},o=0;if(i.type=Number(e.charAt(0)),null==t.types[i.type])return f();if(t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type){for(var s="";"-"!=e.charAt(++o)&&(s+=e.charAt(o),o!=e.length););if(s!=Number(s)||"-"!=e.charAt(o))throw new Error("Illegal attachments");i.attachments=Number(s)}if("/"==e.charAt(o+1))for(i.nsp="";++o;){if(","==(u=e.charAt(o)))break;if(i.nsp+=u,o==e.length)break}else i.nsp="/";var a=e.charAt(o+1);if(""!==a&&Number(a)==a){for(i.id="";++o;){var u;if(null==(u=e.charAt(o))||Number(u)!=u){--o;break}if(i.id+=e.charAt(o),o==e.length)break}i.id=Number(i.id)}e.charAt(++o)&&(i=function(e,t){try{e.data=r.parse(t)}catch(e){return f()}return e}(i,e.substr(o)));return n("decoded %s as %j",e,i),i}(e),t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type?(this.reconstructor=new l(i),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",i)):this.emit("decoded",i);else{if(!s(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(i=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,this.emit("decoded",i))}},c.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},l.prototype.takeBinaryData=function(e){if(this.buffers.push(e),this.buffers.length==this.reconPack.attachments){var t=o.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null},l.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}})),Xh=ph((function(e){try{e.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){e.exports=!1}})),$h=function(e){var t=e.xdomain,n=e.xscheme,r=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||Xh))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!n&&r)return new XDomainRequest}catch(e){}if(!t)try{return new(fh[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}},Zh=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var r in e)n.call(e,r)&&t.push(r);return t},ed=Gh,td=function(e){return function e(t){if(!t)return!1;if(fh.Buffer&&fh.Buffer.isBuffer&&fh.Buffer.isBuffer(t)||fh.ArrayBuffer&&t instanceof ArrayBuffer||fh.Blob&&t instanceof Blob||fh.File&&t instanceof File)return!0;if(ed(t)){for(var n=0;n<t.length;n++)if(e(t[n]))return!0}else if(t&&"object"==(void 0===t?"undefined":bh(t)))for(var r in t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),t)if(Object.prototype.hasOwnProperty.call(t,r)&&e(t[r]))return!0;return!1}(e)};var nd=function(e,t,n){var r=e.byteLength;if(t=t||0,n=n||r,e.slice)return e.slice(t,n);if(t<0&&(t+=r),n<0&&(n+=r),n>r&&(n=r),t>=r||t>=n||0===r)return new ArrayBuffer(0);for(var i=new Uint8Array(e),o=new Uint8Array(n-t),s=t,a=0;s<n;s++,a++)o[a]=i[s];return o.buffer},rd=function(e,t,n){var r=!1;return n=n||id,i.count=e,0===e?t():i;function i(e,o){if(i.count<=0)throw new Error("after called too many times");--i.count,e?(r=!0,t(e),t=n):0!==i.count||r||t(null,o)}};function id(){}var od=ph((function(e,t){
/*! https://mths.be/wtf8 v1.0.0 by @mathias */
!function(n){var r=t,i=e&&e.exports==r&&e,o="object"==bh(fh)&&fh;o.global!==o&&o.window!==o||(n=o);var s,a,u,c=String.fromCharCode;function l(e){for(var t,n,r=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function f(e,t){return c(e>>t&63|128)}function p(e){if(0==(4294967168&e))return c(e);var t="";return 0==(4294965248&e)?t=c(e>>6&31|192):0==(4294901760&e)?(t=c(e>>12&15|224),t+=f(e,6)):0==(4292870144&e)&&(t=c(e>>18&7|240),t+=f(e,12),t+=f(e,6)),t+=c(63&e|128)}function h(){if(u>=a)throw Error("Invalid byte index");var e=255&s[u];if(u++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function d(){var e,t;if(u>a)throw Error("Invalid byte index");if(u==a)return!1;if(e=255&s[u],u++,0==(128&e))return e;if(192==(224&e)){if((t=(31&e)<<6|h())>=128)return t;throw Error("Invalid continuation byte")}if(224==(240&e)){if((t=(15&e)<<12|h()<<6|h())>=2048)return t;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=(15&e)<<18|h()<<12|h()<<6|h())>=65536&&t<=1114111)return t;throw Error("Invalid WTF-8 detected")}var v={version:"1.0.0",encode:function(e){for(var t=l(e),n=t.length,r=-1,i="";++r<n;)i+=p(t[r]);return i},decode:function(e){s=l(e),a=s.length,u=0;for(var t,n=[];!1!==(t=d());)n.push(t);return function(e){for(var t,n=e.length,r=-1,i="";++r<n;)(t=e[r])>65535&&(i+=c((t-=65536)>>>10&1023|55296),t=56320|1023&t),i+=c(t);return i}(n)}};if(r&&!r.nodeType)if(i)i.exports=v;else{var b={}.hasOwnProperty;for(var m in v)b.call(v,m)&&(r[m]=v[m])}else n.wtf8=v}(fh)})),sd=ph((function(e,t){!function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256),r=0;r<e.length;r++)n[e.charCodeAt(r)]=r;t.encode=function(t){var n,r=new Uint8Array(t),i=r.length,o="";for(n=0;n<i;n+=3)o+=e[r[n]>>2],o+=e[(3&r[n])<<4|r[n+1]>>4],o+=e[(15&r[n+1])<<2|r[n+2]>>6],o+=e[63&r[n+2]];return i%3==2?o=o.substring(0,o.length-1)+"=":i%3==1&&(o=o.substring(0,o.length-2)+"=="),o},t.decode=function(e){var t,r,i,o,s,a=.75*e.length,u=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var l=new ArrayBuffer(a),f=new Uint8Array(l);for(t=0;t<u;t+=4)r=n[e.charCodeAt(t)],i=n[e.charCodeAt(t+1)],o=n[e.charCodeAt(t+2)],s=n[e.charCodeAt(t+3)],f[c++]=r<<2|i>>4,f[c++]=(15&i)<<4|o>>2,f[c++]=(3&o)<<6|63&s;return l}}()})),ad=fh.BlobBuilder||fh.WebKitBlobBuilder||fh.MSBlobBuilder||fh.MozBlobBuilder,ud=function(){try{return 2===new Blob(["hi"]).size}catch(e){return!1}}(),cd=ud&&function(){try{return 2===new Blob([new Uint8Array([1,2])]).size}catch(e){return!1}}(),ld=ad&&ad.prototype.append&&ad.prototype.getBlob;function fd(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.buffer instanceof ArrayBuffer){var r=n.buffer;if(n.byteLength!==r.byteLength){var i=new Uint8Array(n.byteLength);i.set(new Uint8Array(r,n.byteOffset,n.byteLength)),r=i.buffer}e[t]=r}}}function pd(e,t){t=t||{};var n=new ad;fd(e);for(var r=0;r<e.length;r++)n.append(e[r]);return t.type?n.getBlob(t.type):n.getBlob()}function hd(e,t){return fd(e),new Blob(e,t||{})}var dd=ud?cd?fh.Blob:hd:ld?pd:void 0,vd=ph((function(e,t){var n,r=Zh,i=td,o=nd,s=rd,a=od;fh&&fh.ArrayBuffer&&(n=sd);var u="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),c="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),l=u||c;t.protocol=3;var f=t.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},p=r(f),h={type:"error",data:"parser error"},d=dd;function v(e,t,n){for(var r=new Array(e.length),i=s(e.length,n),o=function(e,n,i){t(n,(function(t,n){r[e]=n,i(t,r)}))},a=0;a<e.length;a++)o(a,e[a],i)}t.encodePacket=function(e,n,r,i){"function"==typeof n&&(i=n,n=!1),"function"==typeof r&&(i=r,r=null);var o=void 0===e.data?void 0:e.data.buffer||e.data;if(fh.ArrayBuffer&&o instanceof ArrayBuffer)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var i=e.data,o=new Uint8Array(i),s=new Uint8Array(1+i.byteLength);s[0]=f[e.type];for(var a=0;a<o.length;a++)s[a+1]=o[a];return r(s.buffer)}(e,n,i);if(d&&o instanceof fh.Blob)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);if(l)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var i=new FileReader;return i.onload=function(){e.data=i.result,t.encodePacket(e,n,!0,r)},i.readAsArrayBuffer(e.data)}(e,n,r);var i=new Uint8Array(1);i[0]=f[e.type];var o=new d([i.buffer,e.data]);return r(o)}(e,n,i);if(o&&o.base64)return function(e,n){var r="b"+t.packets[e.type]+e.data.data;return n(r)}(e,i);var s=f[e.type];return void 0!==e.data&&(s+=r?a.encode(String(e.data)):String(e.data)),i(""+s)},t.encodeBase64Packet=function(e,n){var r,i="b"+t.packets[e.type];if(d&&e.data instanceof fh.Blob){var o=new FileReader;return o.onload=function(){var e=o.result.split(",")[1];n(i+e)},o.readAsDataURL(e.data)}try{r=String.fromCharCode.apply(null,new Uint8Array(e.data))}catch(t){for(var s=new Uint8Array(e.data),a=new Array(s.length),u=0;u<s.length;u++)a[u]=s[u];r=String.fromCharCode.apply(null,a)}return i+=fh.btoa(r),n(i)},t.decodePacket=function(e,n,r){if(void 0===e)return h;if("string"==typeof e){if("b"==e.charAt(0))return t.decodeBase64Packet(e.substr(1),n);if(r&&!1===(e=function(e){try{e=a.decode(e)}catch(e){return!1}return e}(e)))return h;var i=e.charAt(0);return Number(i)==i&&p[i]?e.length>1?{type:p[i],data:e.substring(1)}:{type:p[i]}:h}i=new Uint8Array(e)[0];var s=o(e,1);return d&&"blob"===n&&(s=new d([s])),{type:p[i],data:s}},t.decodeBase64Packet=function(e,t){var r=p[e.charAt(0)];if(!n)return{type:r,data:{base64:!0,data:e.substr(1)}};var i=n.decode(e.substr(1));return"blob"===t&&d&&(i=new d([i])),{type:r,data:i}},t.encodePayload=function(e,n,r){"function"==typeof n&&(r=n,n=null);var o=i(e);if(n&&o)return d&&!l?t.encodePayloadAsBlob(e,r):t.encodePayloadAsArrayBuffer(e,r);if(!e.length)return r("0:");v(e,(function(e,r){t.encodePacket(e,!!o&&n,!0,(function(e){r(null,function(e){return e.length+":"+e}(e))}))}),(function(e,t){return r(t.join(""))}))},t.decodePayload=function(e,n,r){if("string"!=typeof e)return t.decodePayloadAsBinary(e,n,r);var i;if("function"==typeof n&&(r=n,n=null),""==e)return r(h,0,1);for(var o,s,a="",u=0,c=e.length;u<c;u++){var l=e.charAt(u);if(":"!=l)a+=l;else{if(""==a||a!=(o=Number(a)))return r(h,0,1);if(a!=(s=e.substr(u+1,o)).length)return r(h,0,1);if(s.length){if(i=t.decodePacket(s,n,!0),h.type==i.type&&h.data==i.data)return r(h,0,1);if(!1===r(i,u+o,c))return}u+=o,a=""}}return""!=a?r(h,0,1):void 0},t.encodePayloadAsArrayBuffer=function(e,n){if(!e.length)return n(new ArrayBuffer(0));v(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){return n(null,e)}))}),(function(e,t){var r=t.reduce((function(e,t){var n;return e+(n="string"==typeof t?t.length:t.byteLength).toString().length+n+2}),0),i=new Uint8Array(r),o=0;return t.forEach((function(e){var t="string"==typeof e,n=e;if(t){for(var r=new Uint8Array(e.length),s=0;s<e.length;s++)r[s]=e.charCodeAt(s);n=r.buffer}i[o++]=t?0:1;var a=n.byteLength.toString();for(s=0;s<a.length;s++)i[o++]=parseInt(a[s]);i[o++]=255;for(r=new Uint8Array(n),s=0;s<r.length;s++)i[o++]=r[s]})),n(i.buffer)}))},t.encodePayloadAsBlob=function(e,n){v(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){var t=new Uint8Array(1);if(t[0]=1,"string"==typeof e){for(var r=new Uint8Array(e.length),i=0;i<e.length;i++)r[i]=e.charCodeAt(i);e=r.buffer,t[0]=0}var o=(e instanceof ArrayBuffer?e.byteLength:e.size).toString(),s=new Uint8Array(o.length+1);for(i=0;i<o.length;i++)s[i]=parseInt(o[i]);if(s[o.length]=255,d){var a=new d([t.buffer,s.buffer,e]);n(null,a)}}))}),(function(e,t){return n(new d(t))}))},t.decodePayloadAsBinary=function(e,n,r){"function"==typeof n&&(r=n,n=null);for(var i=e,s=[],a=!1;i.byteLength>0;){for(var u=new Uint8Array(i),c=0===u[0],l="",f=1;255!=u[f];f++){if(l.length>310){a=!0;break}l+=u[f]}if(a)return r(h,0,1);i=o(i,2+l.length),l=parseInt(l);var p=o(i,0,l);if(c)try{p=String.fromCharCode.apply(null,new Uint8Array(p))}catch(e){var d=new Uint8Array(p);p="";for(f=0;f<d.length;f++)p+=String.fromCharCode(d[f])}s.push(p),i=o(i,l)}var v=s.length;s.forEach((function(e,i){r(t.decodePacket(e,n,!0),i,v)}))}})),bd=ph((function(e){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks["$"+e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}})),md=vd,gd=yd;function yd(e){this.path=e.path,this.hostname=e.hostname,this.port=e.port,this.secure=e.secure,this.query=e.query,this.timestampParam=e.timestampParam,this.timestampRequests=e.timestampRequests,this.readyState="",this.agent=e.agent||!1,this.socket=e.socket,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.forceNode=e.forceNode,this.extraHeaders=e.extraHeaders,this.localAddress=e.localAddress}bd(yd.prototype),yd.prototype.onError=function(e,t){var n=new Error(e);return n.type="TransportError",n.description=t,this.emit("error",n),this},yd.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},yd.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},yd.prototype.send=function(e){if("open"!==this.readyState)throw new Error("Transport not open");this.write(e)},yd.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},yd.prototype.onData=function(e){var t=md.decodePacket(e,this.socket.binaryType);this.onPacket(t)},yd.prototype.onPacket=function(e){this.emit("packet",e)},yd.prototype.onClose=function(){this.readyState="closed",this.emit("close")};var _d,wd={encode:function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t},decode:function(e){for(var t={},n=e.split("&"),r=0,i=n.length;r<i;r++){var o=n[r].split("=");t[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return t}},Ed=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},Od="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Sd={},Td=0,kd=0;function Ad(e){var t="";do{t=Od[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function xd(){var e=Ad(+new Date);return e!==_d?(Td=0,_d=e):e+"."+Ad(Td++)}for(;kd<64;kd++)Sd[Od[kd]]=kd;xd.encode=Ad,xd.decode=function(e){var t=0;for(kd=0;kd<e.length;kd++)t=64*t+Sd[e.charAt(kd)];return t};var Id=xd,Nd=gd,Md=wd,Cd=vd,Rd=Ed,Pd=Id,jd=Ih("engine.io-client:polling"),Ld=Ud,qd=null!=new $h({xdomain:!1}).responseType;function Ud(e){var t=e&&e.forceBase64;qd&&!t||(this.supportsBinary=!1),Nd.call(this,e)}Rd(Ud,Nd),Ud.prototype.name="polling",Ud.prototype.doOpen=function(){this.poll()},Ud.prototype.pause=function(e){var t=this;function n(){jd("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(jd("we are currently polling - waiting to pause"),r++,this.once("pollComplete",(function(){jd("pre-pause polling complete"),--r||n()}))),this.writable||(jd("we are currently writing - waiting to pause"),r++,this.once("drain",(function(){jd("pre-pause writing complete"),--r||n()})))}else n()},Ud.prototype.poll=function(){jd("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},Ud.prototype.onData=function(e){var t=this;jd("polling got data %s",e);Cd.decodePayload(e,this.socket.binaryType,(function(e,n,r){if("opening"===t.readyState&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():jd('ignoring poll - transport state "%s"',this.readyState))},Ud.prototype.doClose=function(){var e=this;function t(){jd("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(jd("transport open - closing"),t()):(jd("transport not open - deferring close"),this.once("open",t))},Ud.prototype.write=function(e){var t=this;this.writable=!1;var n=function(){t.writable=!0,t.emit("drain")};Cd.encodePayload(e,this.supportsBinary,(function(e){t.doWrite(e,n)}))},Ud.prototype.uri=function(){var e=this.query||{},t=this.secure?"https":"http",n="";return!1!==this.timestampRequests&&(e[this.timestampParam]=Pd()),this.supportsBinary||e.sid||(e.b64=1),e=Md.encode(e),this.port&&("https"===t&&443!==Number(this.port)||"http"===t&&80!==Number(this.port))&&(n=":"+this.port),e.length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e};var Dd=$h,Vd=Ld,Fd=bd,Bd=Ed,Hd=Ih("engine.io-client:polling-xhr"),Wd=Jd,Gd=Yd;function zd(){}function Jd(e){if(Vd.call(this,e),this.requestTimeout=e.requestTimeout,fh.location){var t="https:"===location.protocol,n=location.port;n||(n=t?443:80),this.xd=e.hostname!==fh.location.hostname||n!==e.port,this.xs=e.secure!==t}else this.extraHeaders=e.extraHeaders}function Yd(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.xs=!!e.xs,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.agent=e.agent,this.isBinary=e.isBinary,this.supportsBinary=e.supportsBinary,this.enablesXDR=e.enablesXDR,this.requestTimeout=e.requestTimeout,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders,this.create()}function Qd(){for(var e in Yd.requests)Yd.requests.hasOwnProperty(e)&&Yd.requests[e].abort()}Bd(Jd,Vd),Jd.prototype.supportsBinary=!0,Jd.prototype.request=function(e){return(e=e||{}).uri=this.uri(),e.xd=this.xd,e.xs=this.xs,e.agent=this.agent||!1,e.supportsBinary=this.supportsBinary,e.enablesXDR=this.enablesXDR,e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized,e.requestTimeout=this.requestTimeout,e.extraHeaders=this.extraHeaders,new Yd(e)},Jd.prototype.doWrite=function(e,t){var n="string"!=typeof e&&void 0!==e,r=this.request({method:"POST",data:e,isBinary:n}),i=this;r.on("success",t),r.on("error",(function(e){i.onError("xhr post error",e)})),this.sendXhr=r},Jd.prototype.doPoll=function(){Hd("xhr poll");var e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e},Fd(Yd.prototype),Yd.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new Dd(e),n=this;try{Hd("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var r in t.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(r)&&t.setRequestHeader(r,this.extraHeaders[r])}catch(e){}if(this.supportsBinary&&(t.responseType="arraybuffer"),"POST"===this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.requestTimeout&&(t.timeout=this.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=function(){n.onError(t.responseText)}):t.onreadystatechange=function(){4===t.readyState&&(200===t.status||1223===t.status?n.onLoad():setTimeout((function(){n.onError(t.status)}),0))},Hd("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){n.onError(e)}),0)}fh.document&&(this.index=Yd.requestsCount++,Yd.requests[this.index]=this)},Yd.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Yd.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},Yd.prototype.onError=function(e){this.emit("error",e),this.cleanup(!0)},Yd.prototype.cleanup=function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=zd:this.xhr.onreadystatechange=zd,e)try{this.xhr.abort()}catch(e){}fh.document&&delete Yd.requests[this.index],this.xhr=null}},Yd.prototype.onLoad=function(){var e;try{var t;try{t=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}if("application/octet-stream"===t)e=this.xhr.response||this.xhr.responseText;else if(this.supportsBinary)try{e=String.fromCharCode.apply(null,new Uint8Array(this.xhr.response))}catch(t){for(var n=new Uint8Array(this.xhr.response),r=[],i=0,o=n.length;i<o;i++)r.push(n[i]);e=String.fromCharCode.apply(null,r)}else e=this.xhr.responseText}catch(e){this.onError(e)}null!=e&&this.onData(e)},Yd.prototype.hasXDR=function(){return void 0!==fh.XDomainRequest&&!this.xs&&this.enablesXDR},Yd.prototype.abort=function(){this.cleanup()},Yd.requestsCount=0,Yd.requests={},fh.document&&(fh.attachEvent?fh.attachEvent("onunload",Qd):fh.addEventListener&&fh.addEventListener("beforeunload",Qd,!1)),Wd.Request=Gd;var Kd,Xd=Ld,$d=nv,Zd=/\n/g,ev=/\\n/g;function tv(){}function nv(e){Xd.call(this,e),this.query=this.query||{},Kd||(fh.___eio||(fh.___eio=[]),Kd=fh.___eio),this.index=Kd.length;var t=this;Kd.push((function(e){t.onData(e)})),this.query.j=this.index,fh.document&&fh.addEventListener&&fh.addEventListener("beforeunload",(function(){t.script&&(t.script.onerror=tv)}),!1)}Ed(nv,Xd),nv.prototype.supportsBinary=!1,nv.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),Xd.prototype.doClose.call(this)},nv.prototype.doPoll=function(){var e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(t,n):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)},nv.prototype.doWrite=function(e,t){var n=this;if(!this.form){var r,i=document.createElement("form"),o=document.createElement("textarea"),s=this.iframeId="eio_iframe_"+this.index;i.className="socketio",i.style.position="absolute",i.style.top="-1000px",i.style.left="-1000px",i.target=s,i.method="POST",i.setAttribute("accept-charset","utf-8"),o.name="d",i.appendChild(o),document.body.appendChild(i),this.form=i,this.area=o}function a(){u(),t()}function u(){if(n.iframe)try{n.form.removeChild(n.iframe)}catch(e){n.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+n.iframeId+'">';r=document.createElement(e)}catch(e){(r=document.createElement("iframe")).name=n.iframeId,r.src="javascript:0"}r.id=n.iframeId,n.form.appendChild(r),n.iframe=r}this.form.action=this.uri(),u(),e=e.replace(ev,"\\\n"),this.area.value=e.replace(Zd,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===n.iframe.readyState&&a()}:this.iframe.onload=a};var rv,iv={},ov=Object.freeze({default:iv}),sv=ov&&iv||ov,av=gd,uv=vd,cv=wd,lv=Ed,fv=Id,pv=Ih("engine.io-client:websocket"),hv=fh.WebSocket||fh.MozWebSocket;if("undefined"==typeof window)try{rv=sv}catch(e){}var dv=hv;dv||"undefined"!=typeof window||(dv=rv);var vv=bv;function bv(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,this.usingBrowserWebSocket=hv&&!e.forceNode,this.usingBrowserWebSocket||(dv=rv),av.call(this,e)}lv(bv,av),bv.prototype.name="websocket",bv.prototype.supportsBinary=!0,bv.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t={agent:this.agent,perMessageDeflate:this.perMessageDeflate};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(t.headers=this.extraHeaders),this.localAddress&&(t.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket?new dv(e):new dv(e,void 0,t)}catch(e){return this.emit("error",e)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},bv.prototype.addEventListeners=function(){var e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}},bv.prototype.write=function(e){var t=this;this.writable=!1;for(var n=e.length,r=0,i=n;r<i;r++)!function(e){uv.encodePacket(e,t.supportsBinary,(function(r){if(!t.usingBrowserWebSocket){var i={};if(e.options&&(i.compress=e.options.compress),t.perMessageDeflate)("string"==typeof r?fh.Buffer.byteLength(r):r.length)<t.perMessageDeflate.threshold&&(i.compress=!1)}try{t.usingBrowserWebSocket?t.ws.send(r):t.ws.send(r,i)}catch(e){pv("websocket closed before onclose event")}--n||o()}))}(e[r]);function o(){t.emit("flush"),setTimeout((function(){t.writable=!0,t.emit("drain")}),0)}},bv.prototype.onClose=function(){av.prototype.onClose.call(this)},bv.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},bv.prototype.uri=function(){var e=this.query||{},t=this.secure?"wss":"ws",n="";return this.port&&("wss"===t&&443!==Number(this.port)||"ws"===t&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(e[this.timestampParam]=fv()),this.supportsBinary||(e.b64=1),(e=cv.encode(e)).length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e},bv.prototype.check=function(){return!(!dv||"__initialize"in dv&&this.name===bv.prototype.name)};var mv=$h,gv=Wd,yv=$d;var _v={polling:function(e){var t=!1,n=!1,r=!1!==e.jsonp;if(fh.location){var i="https:"===location.protocol,o=location.port;o||(o=i?443:80),t=e.hostname!==location.hostname||o!==e.port,n=e.secure!==i}if(e.xdomain=t,e.xscheme=n,"open"in new mv(e)&&!e.forceJSONP)return new gv(e);if(!r)throw new Error("JSONP disabled");return new yv(e)},websocket:vv},wv=[].indexOf,Ev=function(e,t){if(wv)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1},Ov=/^[\],:{}\s]*$/,Sv=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,Tv=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,kv=/(?:^|:|,)(?:\s*\[)+/g,Av=/^\s+/,xv=/\s+$/,Iv=_v,Nv=bd,Mv=Ih("engine.io-client:socket"),Cv=Ev,Rv=vd,Pv=vh,jv=function(e){return"string"==typeof e&&e?(e=e.replace(Av,"").replace(xv,""),fh.JSON&&JSON.parse?JSON.parse(e):Ov.test(e.replace(Sv,"@").replace(Tv,"]").replace(kv,""))?new Function("return "+e)():void 0):null},Lv=wd,qv=Uv;function Uv(e,t){if(!(this instanceof Uv))return new Uv(e,t);t=t||{},e&&"object"===(void 0===e?"undefined":bh(e))&&(t=e,e=null),e?(e=Pv(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=Pv(t.host).host),this.secure=null!=t.secure?t.secure:fh.location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||(fh.location?location.hostname:"localhost"),this.port=t.port||(fh.location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=Lv.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized?null:t.rejectUnauthorized,this.forceNode=!!t.forceNode;var n="object"===bh(fh)&&fh;n.global===n&&(t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),t.localAddress&&(this.localAddress=t.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}Uv.priorWebsocketSuccess=!1,Nv(Uv.prototype),Uv.protocol=Rv.protocol,Uv.Socket=Uv,Uv.Transport=gd,Uv.transports=_v,Uv.parser=vd,Uv.prototype.createTransport=function(e){Mv('creating transport "%s"',e);var t=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}(this.query);return t.EIO=Rv.protocol,t.transport=e,this.id&&(t.sid=this.id),new Iv[e]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:t,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized,perMessageDeflate:this.perMessageDeflate,extraHeaders:this.extraHeaders,forceNode:this.forceNode,localAddress:this.localAddress})},Uv.prototype.open=function(){var e;if(this.rememberUpgrade&&Uv.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){var t=this;return void setTimeout((function(){t.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)},Uv.prototype.setTransport=function(e){Mv("setting transport %s",e.name);var t=this;this.transport&&(Mv("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))},Uv.prototype.probe=function(e){Mv('probing transport "%s"',e);var t=this.createTransport(e,{probe:1}),n=!1,r=this;function i(){if(r.onlyBinaryUpgrades){var i=!this.supportsBinary&&r.transport.supportsBinary;n=n||i}n||(Mv('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(i){if(!n)if("pong"===i.type&&"probe"===i.data){if(Mv('probe transport "%s" pong',e),r.upgrading=!0,r.emit("upgrading",t),!t)return;Uv.priorWebsocketSuccess="websocket"===t.name,Mv('pausing current transport "%s"',r.transport.name),r.transport.pause((function(){n||"closed"!==r.readyState&&(Mv("changing transport and sending upgrade packet"),l(),r.setTransport(t),t.send([{type:"upgrade"}]),r.emit("upgrade",t),t=null,r.upgrading=!1,r.flush())}))}else{Mv('probe transport "%s" failed',e);var o=new Error("probe error");o.transport=t.name,r.emit("upgradeError",o)}})))}function o(){n||(n=!0,l(),t.close(),t=null)}function s(n){var i=new Error("probe error: "+n);i.transport=t.name,o(),Mv('probe transport "%s" failed because of error: %s',e,n),r.emit("upgradeError",i)}function a(){s("transport closed")}function u(){s("socket closed")}function c(e){t&&e.name!==t.name&&(Mv('"%s" works - aborting "%s"',e.name,t.name),o())}function l(){t.removeListener("open",i),t.removeListener("error",s),t.removeListener("close",a),r.removeListener("close",u),r.removeListener("upgrading",c)}Uv.priorWebsocketSuccess=!1,t.once("open",i),t.once("error",s),t.once("close",a),this.once("close",u),this.once("upgrading",c),t.open()},Uv.prototype.onOpen=function(){if(Mv("socket open"),this.readyState="open",Uv.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){Mv("starting upgrade probes");for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},Uv.prototype.onPacket=function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(Mv('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(jv(e.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else Mv('packet received with socket readyState "%s"',this.readyState)},Uv.prototype.onHandshake=function(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},Uv.prototype.onHeartbeat=function(e){clearTimeout(this.pingTimeoutTimer);var t=this;t.pingTimeoutTimer=setTimeout((function(){"closed"!==t.readyState&&t.onClose("ping timeout")}),e||t.pingInterval+t.pingTimeout)},Uv.prototype.setPing=function(){var e=this;clearTimeout(e.pingIntervalTimer),e.pingIntervalTimer=setTimeout((function(){Mv("writing ping packet - expecting pong within %sms",e.pingTimeout),e.ping(),e.onHeartbeat(e.pingTimeout)}),e.pingInterval)},Uv.prototype.ping=function(){var e=this;this.sendPacket("ping",(function(){e.emit("ping")}))},Uv.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},Uv.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(Mv("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},Uv.prototype.write=Uv.prototype.send=function(e,t,n){return this.sendPacket("message",e,t,n),this},Uv.prototype.sendPacket=function(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){(n=n||{}).compress=!1!==n.compress;var i={type:e,data:t,options:n};this.emit("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}},Uv.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var e=this;this.writeBuffer.length?this.once("drain",(function(){this.upgrading?r():t()})):this.upgrading?r():t()}function t(){e.onClose("forced close"),Mv("socket closing - telling transport to close"),e.transport.close()}function n(){e.removeListener("upgrade",n),e.removeListener("upgradeError",n),t()}function r(){e.once("upgrade",n),e.once("upgradeError",n)}return this},Uv.prototype.onError=function(e){Mv("socket error %j",e),Uv.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)},Uv.prototype.onClose=function(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){Mv('socket close with reason: "%s"',e);clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),this.writeBuffer=[],this.prevBufferLen=0}},Uv.prototype.filterUpgrades=function(e){for(var t=[],n=0,r=e.length;n<r;n++)~Cv(this.transports,e[n])&&t.push(e[n]);return t};var Dv=qv,Vv=vd;Dv.parser=Vv;var Fv=Dv,Bv=function(e,t){for(var n=[],r=(t=t||0)||0;r<e.length;r++)n[r-t]=e[r];return n};var Hv=function(e,t,n){return e.on(t,n),{destroy:function(){e.removeListener(t,n)}}};var Wv=[].slice,Gv=function(e,t){if("string"==typeof t&&(t=e[t]),"function"!=typeof t)throw new Error("bind() requires a function");var n=Wv.call(arguments,2);return function(){return t.apply(e,n.concat(Wv.call(arguments)))}},zv=ph((function(e,t){var n=Kh,r=bd,i=Bv,o=Hv,s=Gv,a=Ih("socket.io-client:socket"),u=td;e.exports=f;var c={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},l=r.prototype.emit;function f(e,t,n){this.io=e,this.nsp=t,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}r(f.prototype),f.prototype.subEvents=function(){if(!this.subs){var e=this.io;this.subs=[o(e,"open",s(this,"onopen")),o(e,"packet",s(this,"onpacket")),o(e,"close",s(this,"onclose"))]}},f.prototype.open=f.prototype.connect=function(){return this.connected||(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting")),this},f.prototype.send=function(){var e=i(arguments);return e.unshift("message"),this.emit.apply(this,e),this},f.prototype.emit=function(e){if(c.hasOwnProperty(e))return l.apply(this,arguments),this;var t=i(arguments),r=n.EVENT;u(t)&&(r=n.BINARY_EVENT);var o={type:r,data:t,options:{}};return o.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(a("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),o.id=this.ids++),this.connected?this.packet(o):this.sendBuffer.push(o),delete this.flags,this},f.prototype.packet=function(e){e.nsp=this.nsp,this.io.packet(e)},f.prototype.onopen=function(){a("transport is open - connecting"),"/"!==this.nsp&&(this.query?this.packet({type:n.CONNECT,query:this.query}):this.packet({type:n.CONNECT}))},f.prototype.onclose=function(e){a("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",e)},f.prototype.onpacket=function(e){if(e.nsp===this.nsp)switch(e.type){case n.CONNECT:this.onconnect();break;case n.EVENT:case n.BINARY_EVENT:this.onevent(e);break;case n.ACK:case n.BINARY_ACK:this.onack(e);break;case n.DISCONNECT:this.ondisconnect();break;case n.ERROR:this.emit("error",e.data)}},f.prototype.onevent=function(e){var t=e.data||[];a("emitting event %j",t),null!=e.id&&(a("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?l.apply(this,t):this.receiveBuffer.push(t)},f.prototype.ack=function(e){var t=this,r=!1;return function(){if(!r){r=!0;var o=i(arguments);a("sending ack %j",o);var s=u(o)?n.BINARY_ACK:n.ACK;t.packet({type:s,id:e,data:o})}}},f.prototype.onack=function(e){var t=this.acks[e.id];"function"==typeof t?(a("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):a("bad ack %s",e.id)},f.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},f.prototype.emitBuffered=function(){var e;for(e=0;e<this.receiveBuffer.length;e++)l.apply(this,this.receiveBuffer[e]);for(this.receiveBuffer=[],e=0;e<this.sendBuffer.length;e++)this.packet(this.sendBuffer[e]);this.sendBuffer=[]},f.prototype.ondisconnect=function(){a("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},f.prototype.destroy=function(){if(this.subs){for(var e=0;e<this.subs.length;e++)this.subs[e].destroy();this.subs=null}this.io.destroy(this)},f.prototype.close=f.prototype.disconnect=function(){return this.connected&&(a("performing disconnect (%s)",this.nsp),this.packet({type:n.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},f.prototype.compress=function(e){return this.flags=this.flags||{},this.flags.compress=e,this}})),Jv=Yv;function Yv(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Yv.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},Yv.prototype.reset=function(){this.attempts=0},Yv.prototype.setMin=function(e){this.ms=e},Yv.prototype.setMax=function(e){this.max=e},Yv.prototype.setJitter=function(e){this.jitter=e};var Qv=Fv,Kv=zv,Xv=bd,$v=Kh,Zv=Hv,eb=Gv,tb=Ih("socket.io-client:manager"),nb=Ev,rb=Jv,ib=Object.prototype.hasOwnProperty,ob=sb;function sb(e,t){if(!(this instanceof sb))return new sb(e,t);e&&"object"===(void 0===e?"undefined":bh(e))&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new rb({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[],this.encoder=new $v.Encoder,this.decoder=new $v.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoConnect&&this.open()}sb.prototype.emitAll=function(){for(var e in this.emit.apply(this,arguments),this.nsps)ib.call(this.nsps,e)&&this.nsps[e].emit.apply(this.nsps[e],arguments)},sb.prototype.updateSocketIds=function(){for(var e in this.nsps)ib.call(this.nsps,e)&&(this.nsps[e].id=this.engine.id)},Xv(sb.prototype),sb.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},sb.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},sb.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},sb.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFactor},sb.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this.backoff&&this.backoff.setMax(e),this):this._reconnectionDelayMax},sb.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},sb.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},sb.prototype.open=sb.prototype.connect=function(e,t){if(tb("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;tb("opening %s",this.uri),this.engine=Qv(this.uri,this.opts);var n=this.engine,r=this;this.readyState="opening",this.skipReconnect=!1;var i=Zv(n,"open",(function(){r.onopen(),e&&e()})),o=Zv(n,"error",(function(t){if(tb("connect_error"),r.cleanup(),r.readyState="closed",r.emitAll("connect_error",t),e){var n=new Error("Connection error");n.data=t,e(n)}else r.maybeReconnectOnOpen()}));if(!1!==this._timeout){var s=this._timeout;tb("connect attempt will timeout after %d",s);var a=setTimeout((function(){tb("connect attempt timed out after %d",s),i.destroy(),n.close(),n.emit("error","timeout"),r.emitAll("connect_timeout",s)}),s);this.subs.push({destroy:function(){clearTimeout(a)}})}return this.subs.push(i),this.subs.push(o),this},sb.prototype.onopen=function(){tb("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(Zv(e,"data",eb(this,"ondata"))),this.subs.push(Zv(e,"ping",eb(this,"onping"))),this.subs.push(Zv(e,"pong",eb(this,"onpong"))),this.subs.push(Zv(e,"error",eb(this,"onerror"))),this.subs.push(Zv(e,"close",eb(this,"onclose"))),this.subs.push(Zv(this.decoder,"decoded",eb(this,"ondecoded")))},sb.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},sb.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},sb.prototype.ondata=function(e){this.decoder.add(e)},sb.prototype.ondecoded=function(e){this.emit("packet",e)},sb.prototype.onerror=function(e){tb("error",e),this.emitAll("error",e)},sb.prototype.socket=function(e,t){var n=this.nsps[e];if(!n){n=new Kv(this,e,t),this.nsps[e]=n;var r=this;n.on("connecting",i),n.on("connect",(function(){n.id=r.engine.id})),this.autoConnect&&i()}function i(){~nb(r.connecting,n)||r.connecting.push(n)}return n},sb.prototype.destroy=function(e){var t=nb(this.connecting,e);~t&&this.connecting.splice(t,1),this.connecting.length||this.close()},sb.prototype.packet=function(e){tb("writing packet %j",e);var t=this;e.query&&0===e.type&&(e.nsp+="?"+e.query),t.encoding?t.packetBuffer.push(e):(t.encoding=!0,this.encoder.encode(e,(function(n){for(var r=0;r<n.length;r++)t.engine.write(n[r],e.options);t.encoding=!1,t.processPacketQueue()})))},sb.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},sb.prototype.cleanup=function(){tb("cleanup");for(var e=this.subs.length,t=0;t<e;t++){this.subs.shift().destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},sb.prototype.close=sb.prototype.disconnect=function(){tb("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},sb.prototype.onclose=function(e){tb("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},sb.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var e=this;if(this.backoff.attempts>=this._reconnectionAttempts)tb("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var t=this.backoff.duration();tb("will wait %dms before reconnect attempt",t),this.reconnecting=!0;var n=setTimeout((function(){e.skipReconnect||(tb("attempting reconnect"),e.emitAll("reconnect_attempt",e.backoff.attempts),e.emitAll("reconnecting",e.backoff.attempts),e.skipReconnect||e.open((function(t){t?(tb("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",t.data)):(tb("reconnect success"),e.onreconnect())})))}),t);this.subs.push({destroy:function(){clearTimeout(n)}})}},sb.prototype.onreconnect=function(){var e=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",e)};var ab=ph((function(e,t){var n=Ch,r=Kh,i=ob,o=Ih("socket.io-client");e.exports=t=a;var s=t.managers={};function a(e,t){"object"===(void 0===e?"undefined":bh(e))&&(t=e,e=void 0),t=t||{};var r,a=n(e),u=a.source,c=a.id,l=a.path,f=s[c]&&l in s[c].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||f?(o("ignoring socket cache for %s",u),r=i(u,t)):(s[c]||(o("new io instance for %s",u),s[c]=i(u,t)),r=s[c]),a.query&&!t.query?t.query=a.query:t&&"object"===bh(t.query)&&(t.query=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}(t.query)),r.socket(a.path,t)}t.protocol=r.protocol,t.connect=a,t.Manager=ob,t.Socket=zv})),ub=function(e,t){return void 0===t?e:t},cb=function(){function e(){mh(this,e)}return gh(e,null,[{key:"establish",value:function(e){var t=e.url,n=e.id,r=e.isActiveTab,i=e.options;e.logger.info("Establishing Kluster connection via Channel lib;");var o=function(e,t){return e+(e.split("?")[1]?"&":"?")+t}(t,"id="+n+"&tags="+function(e){var t=e?[{name:"cobrowse",unique:!0}]:[];return encodeURIComponent(JSON.stringify(t))}(r));return ab.connect(o,{"force new connection":!0,timeout:ub(15e3,i.timeout),reconnectionDelay:ub(1e3,i.reconnectionDelay),reconnectionDelayMax:ub(1e3,i.reconnectionDelayMax),randomizationFactor:ub(0,i.randomizationFactor),reconnectionAttempts:ub(Infinity,i.reconnectionAttempts),upgrade:ub(undefined,i.upgrade)})}}]),e}(),lb=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];mh(this,e),this.emit=this.emit.bind(this),this.socket=t,this.stopped=null===this.socket,this.tags=n,this.childEmitters=[]}return gh(e,[{key:"stop",value:function(){return this.stopped=!0,this.socket=null,this.childEmitters.map((function(e){return e.stop()}))}},{key:"in",value:function(e){var t=new this.constructor(this.socket,[e],this);return this.childEmitters.push(t),t}},{key:"emit",value:function(e,t){if(!this.stopped){var n={"channel:event_name":e,"channel:event_data":t,"channel:tags":this.tags};return this.socket.emit("announce",n)}}},{key:"authorize",value:function(e){if(!this.stopped)return this.socket.emit("authorize",{token:e})}}]),e}(),fb=function(){function e(t){var n=t.id,r=t.socketId,i=t.tags;mh(this,e),this.id=n,this.socketId=r,this.tags=i}return gh(e,null,[{key:"build",value:function(t){var n=t.tags.map((function(e){return e._name}));return new e({id:t.id,socketId:t.socketId,tags:n})}}]),e}(),pb=function(e){if("function"==typeof e)return e;return function(){return e}},hb="undefined"!=typeof self?self:null,db="undefined"!=typeof window?window:null,vb=hb||db||vb,bb="2.0.0",mb=0,gb=1,yb=2,_b=3,wb="closed",Eb="errored",Ob="joined",Sb="joining",Tb="leaving",kb="phx_close",Ab="phx_error",xb="phx_join",Ib="phx_reply",Nb="phx_leave",Mb="longpoll",Cb="websocket",Rb=4,Pb=function(){function e(t,n,r,i){mh(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return gh(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e._ref;this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),jb=function(){function e(t,n){mh(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return gh(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}(),Lb=function(){function e(t,n,r){var i=this;mh(this,e),this.state=wb,this.topic=t,this.params=pb(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new Pb(this,xb,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new jb((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=Ob,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=Eb,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close "+i.topic+" "+i.joinRef()),i.state=wb,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error "+i.topic,e),i.isJoining()&&i.joinPush.reset(),i.state=Eb,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout "+i.topic+" ("+i.joinRef()+")",i.joinPush.timeout),new Pb(i,Nb,pb({}),i.timeout).send(),i.state=Eb,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(Ib,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return gh(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(kb,e)}},{key:"onError",value:function(e){return this.on(Ab,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(t=t||{},!this.joinedOnce)throw new Error("tried to push '"+e+"' to '"+this.topic+"' before joining. Use channel.join() before pushing events");var r=new Pb(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=Tb;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave "+e.topic),e.trigger(kb,"leave")},r=new Pb(this,Nb,pb({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isMember",value:function(e,t,n,r){return this.topic===e&&(!r||r===this.joinRef()||(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),!1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=Sb,this.joinPush.resend(e))}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++){o[s].callback(i,n,r||this.joinRef())}}},{key:"replyEventName",value:function(e){return"chan_reply_"+e}},{key:"isClosed",value:function(){return this.state===wb}},{key:"isErrored",value:function(){return this.state===Eb}},{key:"isJoined",value:function(){return this.state===Ob}},{key:"isJoining",value:function(){return this.state===Sb}},{key:"isLeaving",value:function(){return this.state===Tb}}]),e}(),qb=function(){function e(){mh(this,e)}return gh(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(vb.XDomainRequest){var a=new vb.XDomainRequest;return this.xdomainRequest(a,e,t,r,i,o,s)}var u=new vb.XMLHttpRequest;return this.xhrRequest(u,e,t,n,r,i,o,s)}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;return e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r),e}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var u=this;return e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){return a&&a(null)},e.onreadystatechange=function(){if(e.readyState===Rb&&a){var t=u.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i),e}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=t?t+"["+r+"]":r,o=e[r];"object"===(void 0===o?"undefined":bh(o))?n.push(this.serialize(o,i)):n.push(encodeURIComponent(i)+"="+encodeURIComponent(o))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return""+e+n+this.serialize(t)}}]),e}(),Ub=function(){function e(t){mh(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=mb,this.poll()}return gh(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+Cb),"$1/"+Mb)}},{key:"endpointURL",value:function(){return qb.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(e,t,n){this.close(e,t,n),this.readyState=mb}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}},{key:"isActive",value:function(){return this.readyState===gb||this.readyState===mb}},{key:"poll",value:function(){var e=this;this.ajax("GET",null,(function(){return e.ontimeout()}),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){setTimeout((function(){return e.onmessage({data:t})}),0)})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=gb,e.onopen({}),e.poll();break;case 403:e.onerror(403),e.close(1008,"forbidden",!1);break;case 0:case 500:e.onerror(500),e.closeAndRetry(1011,"internal server error",500);break;default:e.onerror(n),e.close()}}))}},{key:"send",value:function(e){var t=this;this.ajax("POST",e,(function(){return t.onerror("timeout")}),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry(1011,"internal server error",!1))}))}},{key:"close",value:function(e,t,n){var r=!0,i=!1,o=void 0;try{for(var s,a=this.reqs[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){s.value.abort()}}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}this.readyState=_b;var u=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:n});"undefined"!=typeof CloseEvent?this.onclose(new CloseEvent("close",u)):this.onclose(u)}},{key:"ajax",value:function(e,t,n,r){var i=this,o=void 0;o=qb.request(e,this.endpointURL(),"application/json",t,this.timeout,(function(){i.reqs.delete(o),n()}),(function(e){i.reqs.delete(o),i.isActive()&&r(e)})),this.reqs.add(o)}}]),e}(),Db=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};mh(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return gh(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),u=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),c=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));u.length>0&&(r[t]=n,r[t].metas=u),c.length>0&&(u.length>0?i[t]={metas:c}:(i[t]=n,i[t].metas=c))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),u=n.metas.map((function(e){return e.phx_ref})),c=t.metas.filter((function(e){return u.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));c.length>0&&(s[e]=t,s[e].metas=c),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),u=o.map((function(e){return e.phx_ref})),c=e[t],l={metas:c?c.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===u.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,c,l)})),e}},{key:"syncDiff",value:function(e,t,n,r){var i=this,o=this.clone(t),s=o.joins,a=o.leaves;return n||(n=function(){}),r||(r=function(){}),this.map(s,(function(t,r){var o=e[t];if(e[t]=i.clone(r),o){var s,a=e[t].metas.map((function(e){return e.phx_ref})),u=o.metas.filter((function(e){return a.indexOf(e.phx_ref)<0}));(s=e[t].metas).unshift.apply(s,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(u))}n(t,o,r)})),this.map(a,(function(t,n){var i=e[t];if(i){var o=n.metas.map((function(e){return e.phx_ref}));i.metas=i.metas.filter((function(e){return o.indexOf(e.phx_ref)<0})),r(t,i,n),0===i.metas.length&&delete e[t]}})),e}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),Vb={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode:function(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));var n=JSON.parse(e),r=_h(n,5);return t({join_ref:r[0],ref:r[1],topic:r[2],event:r[3],payload:r[4]})},binaryEncode:function(e){var t=e.join_ref,n=e.ref,r=e.event,i=e.topic,o=e.payload,s=this.META_LENGTH+t.length+n.length+i.length+r.length,a=new ArrayBuffer(this.HEADER_LENGTH+s),u=new DataView(a),c=0;u.setUint8(c++,this.KINDS.push),u.setUint8(c++,t.length),u.setUint8(c++,n.length),u.setUint8(c++,i.length),u.setUint8(c++,r.length),Array.from(t,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(n,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(i,(function(e){return u.setUint8(c++,e.charCodeAt(0))})),Array.from(r,(function(e){return u.setUint8(c++,e.charCodeAt(0))}));var l=new Uint8Array(a.byteLength+o.byteLength);return l.set(new Uint8Array(a),0),l.set(new Uint8Array(o),a.byteLength),l.buffer},binaryDecode:function(e){var t=new DataView(e),n=t.getUint8(0),r=new TextDecoder;switch(n){case this.KINDS.push:return this.decodePush(e,t,r);case this.KINDS.reply:return this.decodeReply(e,t,r);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,r)}},decodePush:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,a=n.decode(e.slice(s,s+r));s+=r;var u=n.decode(e.slice(s,s+i));s+=i;var c=n.decode(e.slice(s,s+o));return s+=o,{join_ref:a,ref:null,topic:u,event:c,payload:e.slice(s,e.byteLength)}},decodeReply:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),s=t.getUint8(4),a=this.HEADER_LENGTH+this.META_LENGTH,u=n.decode(e.slice(a,a+r));a+=r;var c=n.decode(e.slice(a,a+i));a+=i;var l=n.decode(e.slice(a,a+o));a+=o;var f=n.decode(e.slice(a,a+s));a+=s;var p=e.slice(a,e.byteLength);return{join_ref:u,ref:c,topic:l,event:Ib,payload:{status:f,response:p}}},decodeBroadcast:function(e,t,n){var r=t.getUint8(1),i=t.getUint8(2),o=this.HEADER_LENGTH+2,s=n.decode(e.slice(o,o+r));o+=r;var a=n.decode(e.slice(o,o+i));return o+=i,{join_ref:null,ref:null,topic:s,event:a,payload:e.slice(o,e.byteLength)}}},Fb=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};mh(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||vb.WebSocket||Ub,this.establishedConnections=0,this.defaultEncoder=Vb.encode.bind(Vb),this.defaultDecoder=Vb.decode.bind(Vb),this.closeWasClean=!1,this.binaryType=r.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Ub?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);var i=null;db&&db.addEventListener&&(db.addEventListener("pagehide",(function(e){n.conn&&(n.disconnect(),i=n.connectClock)})),db.addEventListener("pageshow",(function(e){i===n.connectClock&&(i=null,n.connect())}))),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=pb(r.params||{}),this.endPoint=t+"/"+Cb,this.vsn=r.vsn||bb,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new jb((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return gh(e,[{key:"getLongPollTransport",value:function(){return Ub}},{key:"replaceTransport",value:function(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}},{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=qb.appendParams(qb.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?this.protocol()+":"+e:this.protocol()+"://"+location.host+e}},{key:"disconnect",value:function(e,t,n){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=pb(e)),this.conn||(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"ping",value:function(e){var t=this;if(!this.isConnected())return!1;var n=this.makeRef(),r=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:n});var i=this.onMessage((function(o){o.ref===n&&(t.off([i]),e(Date.now()-r))}));return!0}},{key:"clearHeartbeats",value:function(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}},{key:"onConnOpen",value:function(){this.hasLogger()&&this.log("transport","connected to "+this.endPointURL()),this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,_h(e,2)[1])()}))}},{key:"heartbeatTimeout",value:function(){var e=this;this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown((function(){return e.reconnectTimer.scheduleTimeout()}),1e3,"heartbeat timeout"))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){var r=this;if(!this.conn)return e&&e();this.waitForBufferDone((function(){r.conn&&(t?r.conn.close(t,n||""):r.conn.close()),r.waitForSocketClosed((function(){r.conn&&(r.conn.onopen=function(){},r.conn.onerror=function(){},r.conn.onmessage=function(){},r.conn.onclose=function(){},r.conn=null),e&&e()}))}))}},{key:"waitForBufferDone",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.bufferedAmount?setTimeout((function(){t.waitForBufferDone(e,n+1)}),150*n):e()}},{key:"waitForSocketClosed",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;5!==n&&this.conn&&this.conn.readyState!==_b?setTimeout((function(){t.waitForSocketClosed(e,n+1)}),150*n):e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,_h(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e);var t=this.transport,n=this.establishedConnections;this.stateChangeCallbacks.error.forEach((function(r){(0,_h(r,2)[1])(e,t,n)})),(t===this.transport||n>0)&&this.triggerChanError()}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(Ab)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case mb:return"connecting";case gb:return"open";case yb:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=_h(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new Lb(e,t,this);return this.channels.push(n),n}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push",n+" "+r+" ("+s+", "+o+")",i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){var e=this;this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout((function(){return e.heartbeatTimeout()}),this.heartbeatIntervalMs))}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.clearHeartbeats(),t.pendingHeartbeatRef=null,t.heartbeatTimer=setTimeout((function(){return t.sendHeartbeat()}),t.heartbeatIntervalMs)),t.hasLogger()&&t.log("receive",(i.status||"")+" "+n+" "+r+" "+(o&&"("+o+")"||""),i);for(var a=0;a<t.channels.length;a++){var u=t.channels[a];u.isMember(n,r,i,s)&&u.trigger(r,i,o,s)}for(var c=0;c<t.stateChangeCallbacks.message.length;c++){(0,_h(t.stateChangeCallbacks.message[c],2)[1])(e)}}))}},{key:"leaveOpenTopic",value:function(e){for(var t=void 0,n=0;n<this.channels.length;n++){var r=this.channels[n];if(r.topic===e&&(r.isJoined()||r.isJoining())){t=r;break}}t&&(this.hasLogger()&&this.log("transport",'leaving duplicate topic "'+e+'"'),t.leave())}}]),e}(),Bb=function(e,t){return t.onlyLongPollEnabled?Ub:window.WebSocket?window.navigator.onLine?e.transport===window.WebSocket?Ub:window.WebSocket:e.transport:Ub},Hb=function(e){return!function(e){return e&&"error"===e.type}(e)};function Wb(e){var t={onlyLongPollEnabled:!1,connectionTriedOnce:!1,avoidLongPollWorkerInterval:6e5},n=void 0,r=function(n,r){t.onlyLongPollEnabled=!0,e.disconnect((function(){e.transport=Ub,r&&r(n),e.connect()}))},i=void 0;return{ensureConnected:function(i){var o=i.onInitialTry,s=i.onInitialError,a=i.avoidLongPollWorkerInterval;if(!t.connectionTriedOnce){o&&o(),"number"==typeof a&&(t.avoidLongPollWorkerInterval=a);try{e.connect(),e.conn.readyState===window.WebSocket.CLOSED&&r(null,s)}catch(e){r(e,s)}t.connectionTriedOnce=!0,n=function(e,t){if(t.avoidLongPollWorkerInterval>0&&!t.onlyLongPollEnabled){var n=setInterval((function(){if("open"===e.connectionState()&&e.transport===Ub){var n=Bb(e,t);if(e.transport!==n)return e.transport=n,e.disconnect((function(){return e.connect()}))}}),t.avoidLongPollWorkerInterval);return function(){return clearInterval(n)}}}(e,t)}},selectNewTransport:function(n){Hb(n)&&Hb(i)||(e.transport=Bb(e,t),i=n)},stop:function(){n&&n()}}}var Gb=function(){return"hidden"===document.visibilityState},zb=function(){return window.navigator.onLine},Jb=function(e){return"object"===(void 0===e?"undefined":bh(e))?e&&e.reason:e},Yb=function(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t.push(e[n][r]);return t},Qb=function(e){return e===window.WebSocket?"WebSocket":e===Ub?"LongPoll":"unknown"},Kb=function(e){return"object"===(void 0===e?"undefined":bh(e))?e&&e.reason:e},Xb={metrics:{}};function $b(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{logPrefix:"PubSub"},i=r.logPrefix,o=0,s=!1;n=n||Xb;var a=function(e){n.metrics.connectionMetric&&n.increment(n.metrics.connectionMetric,e)},u=function(t){var n={transport:Qb(e.transport),online:zb(),visibility_state:document.visibilityState,error_count:o};return yh({},n,t)},c=function(t,n){return["transport:"+((n||{}).transport||Qb(e.transport)),"online:"+zb()].concat(t)},l=function(){s=!0,a(c(["action:connected"])),t.info(i+" socket opened",u({}))},f=function(e){if(e){var n=Qb(window.WebSocket),r=u({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:n}),o=c(["action:disconnected","type:"+e.type,"code:"+e.code],{transport:n});e.wasClean?(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected cleanly",r)):Gb()?(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected while tab was hidden",r)):(a(o.concat(["reason:closed"])),t.info(i+" connection disconnected",r))}else{var s=Qb(Ub),l=u({reason:"unknown",type:"unknown",code:"unknown",transport:s}),f=c(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:s});a(f),t.info(i+" connection disconnected",l)}},p=function(e){var n=e&&e.type||"unknown";o+=1;var r=e&&e.target?u({type:n}):u({type:n,error:e});Gb()?t.info(i+" connection error while tab was hidden",r):zb()?1!==o||s?(a(c(["action:error"])),t.warn(i+" socket connection error",r)):t.info(i+" socket connection error while attempting to establish the connection first time",r):t.info(i+" connection error while user was offline",r)},h=function(n){return t.info(i+" failed to connect with initial transport",{new_transport:Qb(e.transport),error:Kb(n)})},d=function(){return a(c(["action:connect"]))};return{onOpen:l,onClose:f,onError:p,onInitialTry:d,onInitialConnectError:h}}var Zb=function(e,t){var n=t.enabled,r=t.logPrefix;return n?function(t,n,i){return e.info(r+" "+t+": "+n,{pubsub_data:i})}:function(){}},em=function(e,t){window.addEventListener("offline",t),window.addEventListener("online",e)},tm="[Channel Phoenix]",nm={initialDelay:500,maxDelay:1e4,factor:1.2};function rm(e){var t=e.logger,n=e.serverURL,r=e.phoenixLogsEnabled,i=e.getAccessToken,o=e.transport,s=e.socketOverride,a=function(e){var t=e.initialDelay,n=e.maxDelay,r=e.factor,i=e.jitter,o=e.random;n||(n=6e4),void 0===r&&(r=2),void 0===i&&(i=.5),o||(o=Math.random);var s=null,a=function(e){var a=t*Math.pow(r,e);s&&(a=Math.max(a,s),s=null);var u=o(),c=Math.floor(u*i*a),l=Math.floor(10*u)%2==0?a-c:a+c;return Math.min(l,n)};return a.setNextDelayMinimum=function(e){s=e},a.maximizeNextDelay=function(){return a.setNextDelayMinimum(n)},a}(nm),u=n.split("?")[0],c={logger:Zb(t,{enabled:r,logPrefix:tm}),params:function(){return{access_token:i()}},reconnectAfterMs:a,timeout:864e5,transport:o};o&&o.customSerializer&&(c.decode=o.decode,c.encode=o.encode);var l=s||new Fb("wss://"+u,c),f=new Wb(l),p=new $b(l,t,null,{logPrefix:tm});l.onOpen((function(){p.onOpen()})),l.onClose((function(e){p.onClose(e)})),l.onError((function(e){if("number"==typeof e)switch(e){case 403:t.info(tm+" Detected likely pubsub authentication error, reconnecting after max delay"),a.setNextDelayMinimum(nm.maxDelay);break;case 410:break;case 500:t.info(tm+" PubSub connection disconnected with error 500");break;case 503:var n=nm.maxDelay/2;t.info(tm+" PubSub unavailable, postponing reconnecting for at least "+n+" ms"),a.setNextDelayMinimum(n);break;default:return t.error(tm+" Received unhandled pubsub error status "+e+", stopping reconnecting"),void l.disconnect()}p.onError(e),f.selectNewTransport(e)}));var h=void 0,d=function(e){var n=e.checkInterval,r=e.cutoff,i=Date.now();clearInterval(h),h=setInterval((function(){if(l.channels.length>0)i=Date.now();else{var e=Date.now()-i;e>=r&&(t.info(tm+" Disconnecting from PubSub due to idle",{idle_for:e}),l.disconnect(),clearInterval(h))}}),n||6e4)},v=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f.ensureConnected({onInitialTry:function(){return p.onInitialTry},onInitialError:function(e){return p.onInitialConnectError(e)}}),l.connect(),e.idleDisconnectCutoff>0&&d({checkInterval:e.idleCheckInterval,cutoff:e.idleDisconnectCutoff})},b=l.disconnect.bind(l),m=l.channel.bind(l),g=function(e,t){var n=e.disconnect,r=e.connect,i=e.triggerChanError,o=!1;return function(e){if(!e&&!o){t.info("Forcefully reconnecting to the socket"),o=!0;try{i()}catch(e){t.warn("Unable to triggerChanError",e)}n((function(){r(),o=!1}))}}}({disconnect:b,connect:v,triggerChanError:l.triggerChanError.bind(l)},t);return{connect:v,disconnect:b,channel:m,forceReconnect:g,socket:l}}var im="phoenix_signaler.proxy_channel",om=function(e){return yh({},e,{event:"phx_reply",payload:{response:{},status:"ok"}})};function am(e,t){var n=this;this.skipHeartbeat=!0,this.readyState=1,setTimeout((function(){return n.onopen()})),e.onmessage=function(e){n.onmessage(e)},this.send=function(t){e.postMessage(t)},this.close=function(){}}var um=function(e){var t=am.bind(null,e);return t.customSerializer=!0,t.decode=function(e,t){return t(e)},t.encode=function(e,t){return t(e)},t};function cm(){var e=void 0;return{listenForProxyTransport:function(t){var n=t.logger,r=t.allowedOrigin,i=t.checkOrigin;i=i||function(e){return e===r};var o=function(t){if(t.source===window.parent&&t.data===im)if(i(t.origin)){var r=t.ports[0];e=um(r)}else n.warn("Received CrossFrameMultiplexer message from unexpected origin, discarding",{origin:t.origin})};window.addEventListener("message",o);return function(){return window.removeEventListener("message",o)}},getProxyTransport:function(){return e},createProxyTransport:um}}var lm=function(){function e(){mh(this,e),this.joinRefs={},this.outboundMessageRefs={}}return gh(e,[{key:"registerInnerJoin",value:function(e,t,n){this.joinRefs[e]={innerJoinRef:t,channel:n}}},{key:"registerInnerLeave",value:function(e){var t=this.joinRefs[e].channel;return delete this.joinRefs[e],t}},{key:"isFresh",value:function(e,t){return this.joinRefs[e]&&this.joinRefs[e].innerJoinRef===t}},{key:"registerOutboundMessage",value:function(e,t,n){return this.outboundMessageRefs[t]=n,this.joinRefs[e].channel}},{key:"processMessageFromBackend",value:function(e){var t=e.topic,n=e.event,r=e.payload,i=e.ref,o=this.joinRefs[t];if(o&&(!i||this.outboundMessageRefs[i])){var s=i&&this.outboundMessageRefs[i];return delete this.outboundMessageRefs[i],{topic:t,event:n,payload:r,ref:s,join_ref:o.innerJoinRef}}}}]),e}();function fm(){return{proxyTo:function(e){var t=e.allowedDomain,n=e.phoenixSocket,r=e.iFrame,i=e.logger,o=new MessageChannel,s=new lm,a=[];o.port1.onmessage=function(e){var t=e.data,r=t.topic,u=t.event,c=t.join_ref,l=t.ref;if("phx_join"===u){var f=function(e,t){return e.channels.find((function(e){return e.topic===t&&(e.isJoined()||e.isJoining())}))}(n,r);if(f)return s.registerInnerJoin(r,c,f),void o.port1.postMessage(om(e.data));var p=n.channel(r);return p.join().receive("ok",(function(){o.port1.postMessage(om(e.data))})).receive("error",(function(e){i.warn("Failed to join extra channel in proxy transport",{topic:r,error:e})})),a.push(p),void s.registerInnerJoin(r,c,p)}if("phx_leave"!==u)if(s.isFresh(r,c)){var h=n.makeRef(),d=s.registerOutboundMessage(r,h,l);e.data.ref=h,e.data.join_ref=d.joinRef(),n.push(e.data)}else i.info("Discarding stale proxy push",{topic:r,event:u});else{if(s.isFresh(r,c)){var v=s.registerInnerLeave(r);v&&-1!==a.indexOf(v)&&(a.splice(a.indexOf(v),1),v.leave())}else i.info("Discarding stale proxy phx_leave instruction",{topic:r});o.port1.postMessage(om(e.data))}},r.contentWindow.postMessage(im,t,[o.port2]);var u=n.onMessage((function(e){var t=s.processMessageFromBackend(e);t&&o.port1.postMessage(t)}));return function(){a.forEach((function(e){return e.leave()})),n.off([u]),o.port1.close()}}}}var pm=void 0,hm=new function(){return{asInner:new cm,asOuter:new fm}},dm=function(e){if(e)return[{name:"cobrowse",unique:!0}]},vm=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=function(e,i){var o={0:e,1:i};r.length>0&&(o[2]=r),t.push("send",o).receive("error",(function(r){t.isClosed()||n.warn("Failed to push channel message",{eventName:e,error:r})})).receive("timeout",(function(){t.isClosed()||n.warn("Failed to push channel message due to timeout",{eventName:e})}))},o=function(i){return e(t,n,r.concat([i]))};return{emit:i,toTag:o}},bm=function(e,t,n){var r={},i=!1;return{on:function(o,s){if(i)t.warn("Tried to add eventHandler to stopped channel",{topic:n,eventName:o});else{var a=e.on(o,function(e){return function(t){t&&t.__value?e(t.__value):e(t)}}(s));!function(e,t,n){r[e]=r[e]||[],r[e].push({handler:t,ref:n})}(o,s,a)}},off:function(t,n){var i=function(e,t){var n=(r[e]||[]).filter((function(e){return e.handler===t}));return 1===n.length?(r[e]=r[e].filter((function(e){return e.handler!==t})),n[0].ref):null}(t,n);i&&e.off(t,i)},stop:function(){i=!0,r={}}}};function mm(e){var t=e.url,n=e.getAccessToken,r=e.isActiveTab,i=e.logger,o=e.callback,s=e.clientOverride,a=pm,u=hm.asInner.getProxyTransport();a||(a=s||new rm({logger:i,serverURL:t,phoenixLogsEnabled:!1,getAccessToken:n,transport:u}),pm=a);var c=[],l=!1,f=function(e){try{return e.split("?")[1].match(/topic=([^&]+)/)[1]}catch(e){throw new Error("Cannot find topic in channel URL params")}}(t),p=a.channel(f,(function(){return{tags:dm(r)}})),h=vm(p,i),d=bm(p,i,f),v=function(e){var t=[],n=new Db(e),r=function(e,t){return t.metas.map((function(t){return new fb({id:e.match(/visitor/)?"visitor":e,socketId:t.connection_id,tags:t.tags.map((function(e){return e.name}))})}))},i=Yb(n.list(r));return n.onSync((function(){i=Yb(n.list(r)),t.forEach((function(e){return e(i)}))})),{onParticipantState:function(e){return t.push(e),e(i),function(){t=t.filter((function(t){return t!==e}))}}}}(p).onParticipantState,b=function(){p.leave(),c.forEach((function(e){return e.call()})),c=[],d.stop(),l=!0},m=function(e){var t=e.name,n=e.unique?[{name:t,unique:!0}]:[{name:t}];p.push("register_tags",n).receive("error",(function(e){i.warn("Failed to register tag",{error:e,tag_name:t})})).receive("timeout",(function(){i.warn("Failed to register tag due to timeout",{tag_name:t})}))},g={url:t,on:d.on,off:d.off,onParticipantState:v,emit:h.emit,emitAll:h.emit,toTag:h.toTag,registerTag:m,registerUniqueTag:function(e){var t=e.name;m({name:t,unique:!0})},authorize:function(){},proxyToIframe:function(e,t){return hm.asOuter.proxyTo({allowedDomain:t,phoenixSocket:p.socket,logger:i,iFrame:e})},close:b,destroy:b,addDestroyListener:function(e){c.push(e)},isStopped:function(){return l}};return function(e){var t=!1;(arguments.length>1&&void 0!==arguments[1]?arguments[1]:em)((function(){if(t)return t=!1,e()}),(function(){t=!0}))}((function(){return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e3,r=!1,i=void 0,o=function(t){r||(r=!0,e(t))};t.ping((function(e){clearTimeout(i),o(!0)}))?i=setTimeout((function(){return o(!1)}),n):o(!1)}(a.forceReconnect,a.socket)})),{start:function(){a.connect({idleDisconnectCutoff:3e5});var e=void 0,t=!1;p.join().receive("ok",(function(){t||o(null,g),t=!0})).receive("error",(function(t){t&&"join crashed"===t.reason?i.info("Joining engagement channel failed with crash, retrying",{topic:f}):"unauthorized"===t&&(!e||e<Date.now()-1e4)?(i.info("Joining engagement channel failed due to unauthorized, reconnecting to refresh server side user state",{topic:f}),e=Date.now(),a.disconnect((function(){return a.connect()}))):(i.warn("Joining engagement channel failed",{topic:f,error:Jb(t)}),p.leave(),o({reason:t},null))})).receive("timeout",(function(){i.warn("Joining engagement channel failed",{topic:f,reason:"timeout"}),o({reason:"timeout"},null)}))}}}var gm="channel:meta",ym="current-participants",_m="authorization-response",wm=function(e){return function(t){if(t.type===ym){var n=t.participants.map(fb.build);e(n)}}},Em=function(){function e(t){var n=this,r=t.socket,i=t.url,o=t.id,s=t.logger;mh(this,e),this.url=i,this.id=o,this.socket=r,this.logger=s,this._stopped=!1,this._destroyListeners=[],this.emitter=new lb(this.socket),this.emitAll=this.emitter.emit,this.emit=this.emitter.emit,["on","once"].forEach((function(e){n[e]=function(t,r){if(n._stopped)n.logger.warn("Tried to add eventHandler to stopped channel",{eventType:t});else{if(t===gm)throw new Error("Don't set meta message listeners directly, use specialized functions");n.socket[e](t,r)}}}))}return gh(e,null,[{key:"join",value:function(t){var n=t.url,r=t.id,i=t.isInitiallyActive,o=t.options,s=t.callback,a=t.getAccessToken,u=t.logger;if(u=u||sm.logger,n.match(/engagement_signaler/)){new mm({url:n,getAccessToken:a,isActiveTab:i,logger:u,callback:s}).start()}else{var c=cb.establish({url:n,id:r,isActiveTab:i,options:o,logger:u}),l=new e({socket:c,url:n,id:r,logger:u});l.start(),function(e,t,n){var r=void 0,i=void 0,o=function(){e.off("connect",r),e.off("connect_error",i)};r=function(){o(),t()},i=function(e){o(),n(e)},e.on("connect",r),e.on("connect_error",i)}(c,(function(){s(null,l)}),(function(e){l.close();var t=new Error("Engagement.Kluster: Could not establish channel");t.channelUrl=n,t.reason=e,s(t,null)}))}}}]),gh(e,[{key:"off",value:function(e,t){this.socket.off(e,t)}},{key:"removeAllListeners",value:function(e){this.socket.removeAllListeners(e)}},{key:"onParticipantState",value:function(e){var t=this;if(!this._stopped){this._lastKnownParticipantState&&e(this._lastKnownParticipantState);var n=wm(e);return this.socket.on(gm,n),function(){return t.socket.off(gm,n)}}this.logger.warn("Tried to add eventHandler to stopped channel",{eventType:gm})}},{key:"authorize",value:function(e,t){var n=this,r=function e(r){r.type===_m&&(n.socket.off(gm,e),r.success?(n.logger.info("Engagement.Kluster: Channel authorization succeeded",{url:n.url}),t&&t(!0)):(n.logger.warn("Engagement.Kluster: Channel authorization failed",{url:n.url}),t&&t(!1)))},i=function(){n.socket.on(gm,r),n.emitter.authorize(e())};return this.socket.on("reconnect",i),i(),function(){n.socket.off(gm,r),n.socket.off("reconnect",i)}}},{key:"toTag",value:function(e){return this.emitter.in(e)}},{key:"start",value:function(){var e=this;this.socket.on(gm,wm((function(t){e._lastKnownParticipantState=t}))),this.socket.on("disconnect",(function(t){e.logger.info("Engagement.Kluster: Channel disconnected",{url:e.url,reason:t})})),this.socket.on("connect_error",(function(t){e.logger.warn("Engagement.Kluster: Channel connection error",{url:e.url,error:t})}))}},{key:"destroy",value:function(){null===this.socket||this._stopped||this.socket.emit("close_channel"),this.close()}},{key:"close",value:function(){var e=this;return Om(this.emitter,(function(e){return e.stop()})),null===this.socket||this._stopped||(this._stopped=!0,setTimeout((function(){return e.socket.disconnect()}),50)),this.cleanUp(),Om(this.socket,(function(e){return e.removeAllListeners()}))}},{key:"addDestroyListener",value:function(e){return this._destroyListeners.push(e)}},{key:"registerTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t}])}},{key:"registerUniqueTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t,unique:!0}])}},{key:"cleanUp",value:function(){this._destroyListeners.forEach((function(e){e.call()})),this._destroyListeners=[]}},{key:"isStopped",value:function(){return this._stopped}}]),e}();function Om(e,t){return null!=e?t(e):void 0}Em.listenForProxyTransport=function(e){return hm.asInner.listenForProxyTransport(e)};var Sm=function(){},Tm={},km=function(e){return Tm[e]?Tm[e].promise:void 0},Am=function(e,t){km(t)===e&&function(e){delete Tm[e]}(t)},xm=function(e,t,n){n.then((function(e){e.addDestroyListener((function(){return Am(n,e.otherId)}))}),Sm),Tm[e]={promise:n,url:t}},Im=km,Nm="Engagement.Kluster",Mm=function(e){var t=e.isActiveTab,n=e.participantId,r=e.operatorId,i=e.channelUrl,o=e.getAccessToken,s=e.stats,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Em,u=s.withTags(["protocol:websocket"]).instrument({namespace:"join-channel"}).attempted(),c={operator_id:r,channel_url:i,is_active_tab:t};zu.log("".concat(Nm,": Channel join started"),c);var l=new Promise((function(e,r){var s={timeout:3e4,reconnectionDelay:2e3,reconnectionDelayMax:3e3,randomizationFactor:.5,reconnectionAttempts:15,upgrade:!0};a.join({url:i,id:n,isInitiallyActive:t,options:s,getAccessToken:o,logger:zu,callback:function(t,n){t?(zu.warn("".concat(Nm,": Channel join failed"),I.merge(c,{error:t})),u.failed(),r(t)):(n.authorize(o),zu.info("".concat(Nm,": Channel join succeeded"),c),u.succeeded(),n.observable=function(e){return Zc(n,e)},e(n))}})}));return xm(r,i,l),Pu.Observable.fromPromise(l)},Cm=["scroll","keyup","mousemove"];function Rm(e){var t=e.getAccessToken,n=e.stats,r=e.start,i=e.stop,o=e.hideMouse,s=e.createChannelObservable,a=e.dynamicImport;s||(s=Mm),a||(a=Zu);var u=r.pipe(di(),Go((function(e){return s({channelUrl:e,participantId:"source",isActiveTab:!0,getAccessToken:t,stats:n})})),co(1),Te());this.sourceObservable=u.pipe(an((function(e){return a("Cobra").map((function(t){return{Cobra:t,channel:e}}))})),kt((function(e){var t=e.Cobra,n=e.channel;return new t.SourceInitializer(n,op()).initialize()})),co(),Te()),this.stopSourceObservable=this.sourceObservable.pipe(Go((function(e){return i.pipe(wi(1),kt((function(){return e})))})),Vr((function(){return Pu.Observable.empty()}))),this.hideMouseObservable=u.pipe(Go((function(e){return o.pipe(Qo(i),kt((function(){return e})))})),Vr((function(){return Pu.Observable.empty()})))}var Pm,jm,Lm=function(){function e(t,n,r,i){s(this,e),this._sendActivityFromCobrowsableIframe=this._sendActivityFromCobrowsableIframe.bind(this),this.windowMessenger=t,this.channelUrl=n,this.getAccessToken=r,this.stats=i}return u(e,[{key:"boot",value:function(){this._activityObservable().subscribe(this._sendActivityFromCobrowsableIframe);var e=new Rm({getAccessToken:this.getAccessToken,stats:this.stats,start:this._startObservable(),stop:this._stopObservable(),hideMouse:this._hideMouseObservable()});e.sourceObservable.subscribe((function(){return zu.log("Source started for cobrowsable iframe")}),(function(e){return zu.error("Couldn't start visitor cobrowsable iframe ".concat(e))})),e.stopSourceObservable.subscribe((function(e){return e.stop()}),zu.error.bind(zu,"cobra stop subscription error")),e.hideMouseObservable.subscribe((function(e){return e.toTag("cobrowse").emit("cobra:hide_mouse")}),zu.error.bind(zu,"cobra hide mouse subscription error")),zu.info("Started for visitor Nested CoBrowsable iFrame")}},{key:"_startObservable",value:function(){var e=this.channelUrl?Pu.Observable.of(this.channelUrl):Pu.Observable.empty();return this._cobrowsableFrameInviteObservable(this.windowMessenger).share().merge(e)}},{key:"_stopObservable",value:function(){return this.windowMessenger.observable("cobra:cobrowsable_iframe:stop")}},{key:"_hideMouseObservable",value:function(){return this.windowMessenger.observable("cobra:hide_mouse")}},{key:"_activityObservable",value:function(){return sm.PeriodicalActivityTracker.getStream(Cm)}},{key:"_cobrowsableFrameInviteObservable",value:function(e){return Pu.Observable.create((function(t){return e.respondTo("cobra:cobrowsable_iframe:join_channel_and_cobrowse",(function(e,n){var r=e.url;return n(),t.next(r)}))}))}},{key:"_sendActivityFromCobrowsableIframe",value:function(){return this.windowMessenger.emit("activity_from_cobrowsable_iframe")}}]),e}(),qm=new Error("Tried to connect internal visitor state subscription after already connected"),Um=null,Dm=I.compose(I.map(I.pick(["id","site_id","operator_id"])),I.pathOr([],["engagement","observations"])),Vm=I.compose(I.map(I.pick(["id","site_id","operator_id","outcome"])),I.pathOr([],["engagement","requests"])),Fm=["id","site_id","status","sub_engagement_id","visitor","restarted_from_engagement_id","capabilities"],Bm=function(e){return I.map(I.pick(e))},Hm=I.map((function(e){return I.merge(e,{visitor:I.pick(["authenticated","browser_tab_id"],e.visitor)})})),Wm=I.compose(Hm,Bm(Fm),I.pathOr([],["engagement","engagements"])),Gm=I.compose(I.map(I.pick(["id","site_id","state"])),I.pathOr([],["omniq","queue_tickets"])),zm=function(e,t){return I.pathOr({},["routing","".concat(sm.siteId),"".concat(t)],e)},Jm=I.compose(Hm,Bm(I.append("end_reason",Fm)),I.pathOr([],["engagement","ended_engagements"])),Ym=function(e){var t=e.pubsub,n=e.tabId,r=e.allowConnectingMultipleTimes,o=e.visitorIdObservable,s=void 0===o?Uu():o;return Um&&!r?zu.error(qm):((Um=s.switchMap((function(e){return t.joinChannel("visitor_state:".concat(e)).flatMap((function(e){return(0,e.observable)("change",{leaveChannelOnDispose:!0})})).map((function(t){return i(i({},t||{}),{},{visitor_id:e})}))})).do((function(e){return function(e,t){return zu.info("Received internal visitor state",{routing:zm(e,t),observations:Dm(e),engagement_requests:Vm(e),engagements:Wm(e),ended_engagements:Jm(e),queue_tickets:Gm(e)})}(e,n)})).publishReplay(1)).connect(),Um)},Qm=sm.logger,Km=function(e){var t=e.status,n=e.body,r=e.error;if(t>=200&&t<300)return Pu.Observable.of(n);var i=I.find(I.compose(I.not,I.isNil),[r,n,"unknown"]);return I.is(String,i)?Pu.Observable.throw({status:t,reason:i}):Pu.Observable.throw(I.merge({status:t},i))},Xm=function(e){return I.is(Object,e)&&"timeout"===e.type?Pu.Observable.throw(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT})):Pu.Observable.throw(e)},$m=I.propEq("persisted",!0);I.has("onpagehide",window)?(Pm=Pu.Observable.fromEvent(window,"pageshow").share(),jm=Pu.Observable.fromEvent(window,"pagehide").share()):(Pm=Pu.Observable.fromEvent(window,"load").share(),jm=Pu.Observable.fromEvent(window,"unload").share());var Zm={unloadMaybeToPageCache:jm,loadFromPageCache:Pm.filter($m)},eg=new RegExp("sm."),tg=function(e){return"sm.".concat(e)},ng={set:function(e,t){sessionStorage.setItem(tg(e),function(e){return JSON.stringify(e)}(t))},get:function(e){return function(e){try{return JSON.parse(e)}catch(e){return null}}(sessionStorage.getItem(tg(e)))},remove:function(e){sessionStorage.removeItem(tg(e))},removeAll:function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);eg.test(t)&&sessionStorage.removeItem(t)}}};var rg=function(){function e(t){var n=t.urlParams,r=t.storage,i=t.unloadMaybeToPageCache,o=t.loadFromPageCache,a=t.windowNameStorage,u=t.sessionContext,c=t.tabIdFromConfiguration;s(this,e),this.markAsAlive=this.markAsAlive.bind(this),this.markAsUnloaded=this.markAsUnloaded.bind(this),this.urlParams=n,this.storage=r,this.unloadMaybeToPageCache=i,this.loadFromPageCache=o,this.windowNameStorage=a,this.sessionContext=u,this.tabIdFromConfiguration=c}return u(e,[{key:"init",value:function(){this.localTabId=this._createOrReuseId(),this.markAsAlive(),this.unloadMaybeToPageCache.subscribe(this.markAsUnloaded,sm.logger.error),this.loadFromPageCache.subscribe(this.markAsAlive,sm.logger.error)}},{key:"markAsAlive",value:function(){this._changeTabStatus("alive")}},{key:"markAsUnloaded",value:function(){this._changeTabStatus("unloaded")}},{key:"getId",value:function(){return this.localTabId}},{key:"_createOrReuseId",value:function(){var e;if(e=this.tabIdFromConfiguration||this._findIdFromSessionContext()||this._findIdFromWindowName()||this._findIdFromUrlParams()||this._findIdFromStorage())return e;var t,n=(t=new Uint32Array(2),(window.crypto||window.msCrypto).getRandomValues(t),(t[0]*t[1]).toString(36).replace(".","").substring(0,11));return sm.logger.info("No existing tab ID found, generated new tab ID",{new_tab_id:n}),n}},{key:"_changeTabStatus",value:function(e){var t=this.storage.get("tab_ids")||{};return t[this.localTabId]=e,this.storage.set("tab_ids",t),this.windowNameStorage.setItem("tab_ids",t)}},{key:"_findIdFromStorage",value:function(){var e;return(e=this._findIdFromTabIds(this.storage.get("tab_ids")||{}))?(sm.logger.info("Found tab ID from session storage",{found_tab_id:e}),e):null}},{key:"_findIdFromSessionContext",value:function(){return this.sessionContext?this.sessionContext.tab_id:null}},{key:"_findIdFromWindowName",value:function(){var e,t=this.windowNameStorage.getItem("tab_ids")||{};return(e=this._anyFromTabIds(t))?(sm.logger.info('Found tab ID from "window.name"',{window_name:window.name,found_tab_id:e}),e):null}},{key:"_findIdFromTabIds",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];if("unloaded"===e[r])return r}}},{key:"_anyFromTabIds",value:function(e){return Object.keys(e)[0]}},{key:"_findIdFromUrlParams",value:function(){var e;return(e=this.urlParams.tabId)?(sm.logger.info("Found tab ID from url params",{found_tab_id:e}),e):null}}],[{key:"setup",value:function(t,n){var r=n.sessionContext,i=n.tabIdFromConfiguration,o=new e({urlParams:sm.urlParams,storage:ng,windowNameStorage:t,unloadMaybeToPageCache:Zm.unloadMaybeToPageCache,loadFromPageCache:Zm.loadFromPageCache,sessionContext:r,tabIdFromConfiguration:i});return o.init(),o}}]),e}(),ig=function(e){return function(e){var t=I.propEq("site_id",sm.siteId),n=I.compose(I.any(I.propEq("id",sm.siteId)),I.propOr([],"transferrable_sites")),r=I.pathOr([],["engagement","engagements"],e);try{return I.compose(I.complement(I.isEmpty),I.filter(I.either(t,n)))(r)}catch(t){return void zu.error("Engagements were undefined in state",{state:e,engagements:r})}}(e)?"engaged":function(e){return I.compose(I.complement(I.isEmpty),I.filter(I.propEq("site_id",sm.siteId)),I.pathOr([],["engagement","observations"]))(e)}(e)?"observed":"available"},og=function(e){return e.map(ig).distinctUntilChanged()},sg="high",ag="low",ug="visitor_priority",cg=I.pathOr([],["omniq","queue_tickets"]),lg=I.pathOr([],["engagement","requests"]),fg=I.pathOr([],["engagement","engagements"]),pg=function(e){return function(e){return cg(e).length>0||lg(e).length>0||fg(e).length>0}(e)?sg:ag},hg=function(e,t){var n=e.indexOf(t);return n>-1?[e.substring(0,n),e.substring(n+1)]:[e]},dg=function(e,t,n){n||(n="");var r=_(hg(e,"#"),2),i=r[0],o=r[1],s=_(hg(i,"?"),2),a=s[0],u=s[1],c=I.compose(I.join("&"),I.map(I.concat(n)),I.map(I.join("=")),I.map(I.map(encodeURIComponent)),I.toPairs)(t),l=u?"".concat(a,"?").concat(u,"&").concat(c):"".concat(a,"?").concat(c);return o?"".concat(l,"#").concat(o):l},vg=function(){if("function"!=typeof window.getGliaContext)return Promise.resolve({sessionId:null,idToken:null});try{var e=window.getGliaContext();"function"!=typeof e.then&&(e=Promise.resolve(e));return e.then((function(e){return Promise.resolve(i(i({},{sessionId:null,idToken:null}),e))}),(function(e){return zu.warn("getGliaContext() promise rejected",{error:e}),Promise.resolve({sessionId:null,idToken:null})})).catch((function(e){return zu.warn("Unexpected error in getGliaContext() promise",{error:e}),Promise.resolve({sessionId:null,idToken:null})}))}catch(e){return zu.warn("Unexpected error in getGliaContext()",{error:e}),Promise.resolve({sessionId:null,idToken:null})}},bg=function(){return Pu.Observable.create((function(e){vg().then((function(t){e.next(t),e.complete()}))}))},mg=function(e){try{var t=function(e){var t=e.split(".")[1],n=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)}(e);return(t.exp-t.iat)/2*1e3}catch(e){return zu.warn("Fetching interval from access token failed",e),864e5}},gg=function(e){return e&&"string"==typeof e},yg=function(e){var t=e.priority,n=e.accessToken,r=e.consolidationSecret,i=e.url,o=e.tabId,s=e.detectVisitorByExternalSessionTokenEnabled,a=e.opaqueVisitorAuthenticationEnabled;return i||(i=sm.visitorConfigUrl),i=dg(i,{priority:t,tab_id:o}),Pu.Observable.create((function(e){var t=new XMLHttpRequest;return t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var n=JSON.parse(t.responseText);e.next({accessToken:n.access_token,visitorId:n.visitor_id,authenticatedExternally:Boolean(n.authenticated_externally)}),e.complete()}else e.error({responseText:t.responseText,status:t.status})},function(e){var t=e.detectVisitorByExternalSessionTokenEnabled,n=e.opaqueVisitorAuthenticationEnabled;return vg().then((function(e){var r=e.sessionId,i=e.idToken;return[t&&gg(r)?"external_session_id=".concat(r):"",n&&gg(i)?"id_token=".concat(i):""]}))}({detectVisitorByExternalSessionTokenEnabled:s,opaqueVisitorAuthenticationEnabled:a}).then((function(e){var o=_(e,2),s=o[0],a=o[1],u=""!==a?"tab_id=".concat(sm.tabId):"",c=[r?"consolidation_token=".concat(encodeURIComponent(r)):null,n?"access_token=".concat(encodeURIComponent(n)):null,s,a,u].filter(I.identity).join("&");t.open("POST",i,!0),t.withCredentials=!0,t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(c)})),function(){return t.abort()}}))},_g=function(){function e(t){s(this,e),this.attributes=I.clone(t),this.id=this.attributes.id}return u(e,[{key:"get",value:function(e){return this.attributes[e]}},{key:"set",value:function(e){var t=this;Object.keys(e).forEach((function(n){var r=e[n];t.attributes[n]=r}))}},{key:"getId",value:function(){return this.get("id")}},{key:"getName",value:function(){return this.get("name")}},{key:"getFormattedName",value:function(){return this.get("formattedName")}},{key:"getMediaType",value:function(){return this.get("media_type")}},{key:"isOnline",value:function(){return!this.isUnavailable()}},{key:"currentlyAvailable",value:function(){return!this.currentlyUnavailable()}},{key:"currentlyUnavailable",value:function(){return this.isEngaged()||this.isUnavailable()}},{key:"isEngaged",value:function(){return"engaged"===this.get("status")}},{key:"mediaRank",value:function(){switch(this.getMediaType()){case"text":return.8;case"audio":return.9;case"video":return 1;default:return 0}}},{key:"getPictureUrl",value:function(){var e=this.get("picture")&&this.get("picture").url,t=sm.conf.visitor_app.always_use_default_operator_picture,n=sm.conf.visitor_app.default_operator_picture.url;if(!n||!t&&e){var r=-1!==sm.conf.assets.server.indexOf("libs.")?"/":sm.conf.assets.prepend;return e||[sm.conf.assets.server,r||"/","default_operator_picture-544677dd8.png"].join("")}return n}},{key:"isUnavailable",value:function(){return!1===this.get("available")}}]),e}(),wg=function(e){return I.filter(I.contains(I.__,["video"]),e)};function Eg(e){return/iPad|iPhone|iPod/.test(e)&&!window.MSStream}function Og(e){return/^((?!CriOS|Chrome|Android).)+Safari/.test(e)}function Sg(e){return 0===e.length}function Tg(e,t){return-1!==t.indexOf(e)}function kg(e){var t=e.match(/OS ((\d+_?){2,3})\s/);if(!t)return!1;var n=t[1].split("_"),r=n[0]+"."+n[1];return parseFloat(r)>=11.3}function Ag(e){if(Eg(e))return kg(e);var t=function(e){var t=e.match(/Version\/([0-9]+\.[0-9]*)/);return t&&parseFloat(t[1],10)}(e);return!!t&&t>=11}function xg(){return[{name:"RTCPeerConnection",pass:Boolean(window.RTCPeerConnection)},{name:"RTCIceCandidate",pass:Boolean(window.RTCIceCandidate)},{name:"AudioContext",pass:Boolean(window.AudioContext)||Boolean(window.webkitAudioContext)},{name:"MediaStream",pass:Boolean(window.MediaStream)}]}function Ig(){return[].concat(w(xg()),[{name:"getUserMedia",pass:Boolean(window.navigator.mediaDevices)&&Boolean(window.navigator.mediaDevices.getUserMedia)}])}var Ng={video:"camera",audio:"microphone"};function Mg(e,t,n){if(null==n)return!0;var r=Ng[t];return!!Tg(r,n)&&(!Og(e)||!Tg("".concat(r," *"),n))}function Cg(){var e=window.navigator.userAgent;return!(Og(e)&&Eg(e)&&!kg(e))&&Sg(xg().filter((function(e){return!e.pass})))}function Rg(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.media,n=e.iframeAllow,r=window.navigator.userAgent;if(!Mg(r,t,n))return!1;if(Og(r)&&!Ag(r))return!1;var i=Ig().filter((function(e){return!e.pass}));return Sg(i)}var Pg=Object.freeze({__proto__:null,canReceiveMedia:Cg,canSendMedia:Rg}),jg="none",Lg="receiver",qg="duplex",Ug=function(){return Cg()?Rg()?qg:Lg:jg},Dg=["video","audio"],Vg={video:["video","audio","phone","text"],audio:["audio","phone","text"],phone:["phone","text"],text:["text"]},Fg=I.lensPath(["state","medias"]),Bg=I.lensPath(["state","oneWayMedias"]),Hg=function(e,t){var n=I.difference(e.state[t],Dg);return I.assocPath(["state",t],n,e)},Wg=I.curry((function(e,t){return e===qg||e===Lg?t:Hg(t,"oneWayMedias")})),Gg=I.curry((function(e,t){return e===qg?t:Hg(t,"medias")})),zg=function(e){return I.assocPath(["state","media"],e.state.medias,e)},Jg=I.curry((function(e,t){var n,r=e.enabledMediaType,i=e.webRtcMode;return I.compose(zg,Wg(i),Gg(i),(n=r,I.over(Bg,I.intersection(wg(Vg[n])))),function(e){return I.over(Fg,I.intersection(Vg[e]))}(r))(t)})),Yg=u((function e(t){var n=t.id,r=t.name,i=t.formattedName,o=t.picture,a=t.state;s(this,e),this.id=n,this.name=r,this.formattedName=i||(null==r?void 0:r.split(" ")[0]),this.picture=o,this.state=a,this.assignment={type:"direct"}})),Qg=function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"serialize",value:function(){return new Yg({id:this.getId(),name:this.getName(),formattedName:this.getFormattedName(),picture:this._getPicture(),state:this._getState()})}},{key:"_getPicture",value:function(){return{url:this.getPictureUrl()}}},{key:"_getState",value:function(){var e=Vg[this.getMediaType()];return{available:this.currentlyAvailable(),medias:e,oneWayMedias:wg(e)}}}]),n}(_g),Kg=I.curry((function(e,t){var n=e.enabledMediaType,r=e.webRtcMode,i=new Qg(t.attributes).serialize();return Jg({enabledMediaType:n,webRtcMode:r},i)})),Xg=function(e){var t=e.id,n=e.name,r=e.formattedName,i=e.picture,o=e.mediaType,s=e.webRtcMode,a=e.enabledMediaType,u=new Qg({id:t,name:n,formattedName:r,picture:i,media_type:o});return Kg({enabledMediaType:a,webRtcMode:s},u)},$g=function(e){var t=e.enabledMediaLevel,n=e.webRtcMode,r=function(e,t){return{operator:e,isVisible:void 0!==e.state.available&&e.reactiveEnabled&&(I.isEmpty(t)||!I.isEmpty(I.intersection(e.teamIds,t)))}};return{fromPresence:function(e,i,o){var s=i.state,a=I.pathOr("operator",["operator_information","name"],s),u=I.pathOr(null,["operator_information","picture","url"],s),c=I.pathOr([],["operator_information","teams"],s),l=I.map(I.prop("id"),c),f=I.pathOr(!0,["operator_information","reactive_enabled"],s),p=I.pathOr([],["engagement","media"],s),h=I.has("engagement",s);-1!==p.indexOf("audio")&&p.push("phone");var d={id:e,name:a,picture:{url:u},state:{available:h?!I.isEmpty(p):void 0,media:p,medias:p,oneWayMedias:p},teamIds:l,reactiveEnabled:f};return d=Jg({enabledMediaType:t,webRtcMode:n},d),r(d,o)},updateVisibility:r}},Zg=function e(t,n){t||(t={}),n||(n={});return{omit:function(r){return e(I.dissoc(r,t),I.dissoc(r,n))},set:function(r){var i=r.operator,o=r.isVisible?I.assoc(i.id,i,n):I.dissoc(i.id,n);return e(I.assoc(i.id,i,t),o)},forEach:function(e){return I.values(t).forEach(e)},immutableFacade:function(){return{get:function(e){var t=n[e];return t?new Yg(t):t},values:function(){return I.map(I.construct(Yg),I.values(n))}}}}},ey=function(e){var t=e.presence,n=e.presenceMapper,r=e.visibleTeamsObservable,i=e.onChange,o=Zg(),s=[],a=r.subscribe((function(e){s=e,o.forEach((function(e){var t=n.updateVisibility(e,s),r=t.operator,i=t.isVisible;o=o.set({operator:r,isVisible:i})})),i(o.immutableFacade())}));t.list((function(e,t){return n.fromPresence(e,t,s)})).forEach((function(e){var t=e.operator,n=e.isVisible;o=o.set({operator:t,isVisible:n})})),i(o.immutableFacade()),t.onChange((function(e,t,r){if(r.metas.length>0){var a=n.fromPresence(e,r,s),u=a.operator,c=a.isVisible;o=o.set({operator:u,isVisible:c})}else o=o.omit(e);i(o.immutableFacade())}));return{stop:function(){return a.unsubscribe()}}},ty="salemove",ny=function(e){try{return JSON.parse(e.name)||{}}catch(e){return{}}},ry=function(e){return""===e.name},iy=function(e){return ry(e)||function(e){return ny(e).hasOwnProperty(ty)}(e)},oy=function(e){return I.lensPath([ty,e])},sy=[void 0,null,"javascript:;",""],ay=!1,uy=function(e,t){if(t||(t=sm.conf.navigatable_hostnames),I.contains(e,sy))return!0;var n=ay?t.engaged:t.available;return I.any((function(t){return e.indexOf(t)>-1}))(n)},cy={isInEngagement:ay,setEngagedStatus:function(e){ay=e},extractLinkFromEvent:function(e){try{var t=e.target;return t&&(t=function(e,t){t=t.toUpperCase();do{if(e.nodeName===t)return e}while(e=e.parentNode);return null}(t,"a")),t}catch(e){return null}},isAllowedToNavigate:uy},ly=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.isAllowed,n=void 0===t?uy:t;Wc(document.querySelectorAll('a[target="_blank"]')).filter((function(e){return"javascript:void(0)"!==e.href})).filter((function(e){return n(e.hostname)})).forEach((function(e){return e.setAttribute("target","_self")}))},fy=["target","defaultPrevented","ctrlKey","shiftKey","metaKey","button"],py=function(e){var t=e.getCurrentUrl,n=e.linkHandler,r=e.clicks,i=e.navigate,o={},s=function(e){var t=e.event,n=e.link;try{var r=n.href;sm.logger.info("XDomainUrlStorage: adding params to URL",{params:o});var s=dg(r,o,"__sm.");sm.logger.info("XDomainUrlStorage: navigating to modified URL",{original_url:r,modified_url:s}),t.preventDefault(),i(s)}catch(e){sm.logger.error("XDomainUrlStorage: error trying to store values in URL",e)}},a=function(e){return"_blank"!==e.link.target},u=function(e){var t=e.link;return!I.isEmpty(t.href)&&!I.isNil(t.href)&&I.contains(t.protocol,["http:","https:"])},c=function(e){var n=e.link;return!I.contains(n.hostname,t())},l=function(e){var t=e.link;return n.isAllowedToNavigate(t.hostname)},f=function(e){var t=e.event;return!(t.ctrlKey||t.shiftKey||t.metaKey)},p=function(e){return 0===e.event.button},h=function(e){try{return fy.forEach((function(t){return e[t]})),!0}catch(e){return!1}},d=function(e){return!e.defaultPrevented},v=function(e){for(var t=e.target;t&&t.nodeName&&"a"!==t.nodeName.toLowerCase();)t=t.parentElement;return t};return{start:function(){return r.pipe(wn((function(){return!I.isEmpty(o)})),wn(h),wn(d),kt((function(e){return{event:e,link:v(e)}})),wn(I.where({link:I.complement(I.isNil)})),wn(u),wn(a),wn(c),wn(f),wn(p),wn(l)).subscribe(s,(function(e){return sm.logger.error("XDomainUrlStorage: error while filtering user click event",e)}),(function(){return sm.logger.error("XDomainUrlStorage: clicks observable was completed")}))},setItem:function(e,t){o=I.assoc(e,t,o)},getItem:function(e){return sm.urlParams?sm.urlParams[e]:void 0}}},hy="sm.",dy=function(){return{getItem:function(e){return window.localStorage.getItem(hy+e)},setItem:function(e,t){return window.localStorage.setItem(hy+e,t)},removeItem:function(e){return window.localStorage.removeItem(hy+e)}}},vy=function(){var e,t,n=(e=window,{getItem:function(t){if(!ry(e))return I.view(oy(t),ny(e))},setItem:function(t,n){if(iy(e)){var r=ny(e),i=I.set(oy(t),n,r);e.name=JSON.stringify(i)}}}),r=(t=Pu.Observable.merge($c(document,"click"),$c(document,"mousedown")),new py({getCurrentUrl:function(){return window.location.href},linkHandler:cy,clicks:t,navigate:function(e){window.location.href=e}}));sm.conf.visitor_api&&sm.conf.visitor_api.persist_visitor_session_in_url&&r.start();var i,o=new dy;return{bestEffortXDomainStorage:(i={prioritizedStorages:[n,r,o]}.prioritizedStorages,{getItem:function(e){return function(e,t){for(var n=0;n<e.length;n++){var r=e[n].getItem(t);if(null!=r)return r}}(i,e)},setItem:function(e,t){return i.forEach((function(n){return n.setItem(e,t)}))}}),windowNameStorage:n,xDomainUrlStorage:r,localStorage:o}},by=function(e){var t=e.internalVisitorStateObservable,n=e.defaultQueues;return t.pipe(kt((function(e){return function(e,t){var n=I.pathOr({},["routing",sm.siteId,sm.tabId],e);return I.has("queues",n)?{queue_ids:n.queues}:t.length>0?{queue_ids:t.map((function(e){return e.id}))}:{}}(e,n)})),di(I.equals))},my="sm.app.visitor_api.custom_code",gy=function(e){var t=e.stats,n=e.loadCustomCodeScript,r=sm.conf.customCodeFile?sm.conf.customCodeFile.url:void 0;return r?(n||(n=L),new Promise((function(e,i){var o={integrity:P()?sm.conf.customCodeFile.sri:null,fileUrl:r,beforeLoad:function(){return e({ignored:!1})},onAttempt:function(){return t.increment(my,["action:attempted"])},onLoad:function(){return t.increment(my,["action:succeeded"])},onError:function(){return t.increment(my,["action:warning"])},onGiveUp:function(){return t.increment(my,["action:failed"]),sm.logger.warn(new Error("Failed to load custom code"),{custom_code_url:r})}};return n(o)}))):Promise.resolve({ignored:!0})},yy=function(e,t){return e.increment("sm.gva.assets.load",t)},_y=function(e){var t=e.stats,n=((sm.conf||{}).gva||{}).assets||{},r=sm.conf.visitor_api.load_gva_custom_renderer;return new Promise((function(e){return r&&n.js&&n.css?(n.js.forEach((function(e){return function(e,t){return L({fileUrl:t,integrity:j({versionedName:t.split("/").pop()}),onLoad:function(){return yy(e,["action:succeeded","asset:js"])},onError:function(){return yy(e,["action:warning","asset:js"])},onAttempt:function(){return yy(e,["action:attempted","asset:js"])},onGiveUp:function(){return yy(e,["action:failed","asset:js"]),sm.logger.warn(new Error("Failed to load script file from sm.conf.gva.assets"),{asset_url:t})}})}(t,e)})),n.css.forEach((function(e){return function(e,t){return q({fileUrl:t,integrity:j({versionedName:t.split("/").pop()}),onError:function(){return yy(e,["action:warning","asset:css"])},onAttempt:function(){return yy(e,["action:attempted","asset:css"])},onGiveUp:function(){return yy(e,["action:failed","asset:css"]),sm.logger.warn(new Error("Failed to load css file from sm.conf.gva.assets"),{asset_url:t})}})}(t,e)})),e({gvaAssetsRequested:!0})):e({gvaAssetsRequested:!1})}))};function wy(e,t){var n=t.targetWindow,r=t.logger,i="__sm.",o=n.location.search,s=n.location.href;try{var a=o.replace("?","").split("&").filter((function(e){return e.indexOf(i)>-1})),u=a.map((function(e){return e.split("=")})).map((function(e){var t=_(e,2),n=t[0],r=t[1];return{key:n.replace(i,""),value:r}})).map((function(e){var t=e.key,n=e.value;return{key:decodeURIComponent(t),value:decodeURIComponent(n)}})).reduce((function(e,t){var n=t.key,r=t.value;return e[n]=r,e}),{}),c=a.reduce((function(e,t){return e.replace("?".concat(t),"").replace("&".concat(t),"")}),s);return c!==s&&(r.info("Found sm params in URL",{params:u,url_length:s.length}),(n.history?n.history.replaceState:void 0)&&(r.info("Replacing page URL",{original_url:s,new_url:c}),n.history.replaceState(n.history.state,n.document.title,c))),function(t){return Object.keys(e).filter((function(e){return Boolean(t[e])})).map((function(n){return{key:n,value:t[n],regex:e[n]}})).reduce((function(e,t){var n=t.key,i=t.value,o=t.regex;return i.match(o)?e[n]=i:r.error("URL query param does no satisfy provided regex",{param_key:n,param_value:i,regex:o}),e}),{})}(u)}catch(e){return r.error("Error reading sm params from URL",e),{}}}function Ey(e,t){var n,r=t.salemovePresentInParent,i=function(){var t={url:e.location.href,page_title:e.title};if(r)return window.parent.postMessage(JSON.stringify({"sm-xdr-url":t.url}),"*")};this.start=function(){n=new Pu.Subscription;var e=sm.hrefObservable.skip(1);return n.add(e.subscribe(i,zu.error))},this.stop=function(){n&&n.unsubscribe()}}var Oy=function(e){return I.reduce(I.maxBy(I.prop("activity_at")),e[0],e)},Sy=function(e,t){return t?!e||e.activity_at<t.activity_at?t:e:(zu.warn("New active tab is not defined",{new_active_tab:t}),e)};function Ty(e,t,n){var r=this,i=t.salemovePresentInParent,o=t.renewFrequency,s=t.visitorPresenceChannel,a=t.tabId,u=void 0===a?sm.tabId:a;this.onStart=n;var c,l=1e3*o,f=Pu.Observable.timer(1e4).mapTo({tab_id:u,page_url:location.href}).do((function(){return zu.warn("Defaulting active tab to true, multi-tab cobrowsing can misbehave")})),p=s.getSameVisitorConnections().filter(I.complement(I.isEmpty)),h=p.map(Oy).scan(Sy).merge(f.takeUntil(p)).publishReplay(1),d=h.combineLatest(hp.asObservable()).map((function(e){var t=_(e,2),n=t[0],r=t[1];return n.tab_id===u||r.has(n.tab_id)})).distinctUntilChanged(I.equals),v=new Ey(e,{salemovePresentInParent:i}),b=Ml(),m=d.switchMap((function(e){var t=e?l:1500;return b.throttleTime(t)})).map((function(e){return{value:e,timestamp:Date.now()}})).share(),g=function(){return s.getPresenceObservable().take(1).switchMap((function(e){return h.take(1).map((function(t){return{presence:e,activeTab:t}}))})).subscribe((function(t){var n=t.presence,r=t.activeTab,i={page_description:e.title};return r.tab_id!==u&&(i.set_active_tab=!0,i.page_url=location.href),r.tab_id===u&&r.page_url!==location.href&&(i.page_url=location.href),n.channel.push("activity",i,5e3).receive("error",(function(e){return zu.warn("Unable to send activity update to presence",e)})).receive("timeout",(function(){}))}),(function(e){return zu.warn("Unable to send activity update to presence",{error:e})}))},y=function(){if(!r.started){r.started=!0,zu.info("Starting activity tracker"),v.start(),m.skip(1).subscribe((function(){return g()}),zu.error);var e,t=new Pu.Subscription([h.connect(),(e=v,new Pu.Subscription((function(){return e.stop()})))]);r.onStart(t)}};this.requestStart=function(){s.requestJoin(),s.getPresenceObservable().take(1).subscribe((function(){return y()}))},this.requestStartWhenSpaceAvailable=function(){s.requestJoinAllowRejection(),s.getPresenceObservable().take(1).subscribe((function(){return y()}))},this.getUserIsActiveTabObservable=function(){return r.requestStart(),d},this.avoidGoingIdle=function(){r.requestStart(),c&&clearInterval(c),c=setInterval((function(){return g()}),5e3)}}Ty.NavigationUpdater=Ey;var ky=function(){},Ay=I.propEq("site_id",sm.siteId),xy=I.compose(I.any(I.propEq("id",sm.siteId)),I.propOr([],"transferrable_sites")),Iy=I.compose(I.nth(0),I.filter(I.either(Ay,xy)),I.pathOr([],["engagement","engagements"])),Ny=I.compose(I.nth(0),I.filter((function(e){return!e.outcome})),I.filter(Ay),I.pathOr([],["engagement","requests"])),My=I.compose(I.nth(0),I.filter(I.propEq("site_id",sm.siteId)),I.pathOr([],["engagement","observations"])),Cy=function(e){var t=e.visitor;if(t)return{name:t.name,email:t.email}},Ry=function(e){var t=e.operator,n=I.map(I.prop("name"),t.teams);return{id:t.id,teamNames:n}},Py=function(e){var t,n,r;return(t=Iy(e))?{interaction:"engagement",channelUrl:t.channel_url,operator:Ry(t),visitor:Cy(t),engagement:t}:(n=Ny(e))?{interaction:"engagement",channelUrl:n.channel_url,operator:Ry(n),visitor:Cy(n)}:(r=My(e))?{interaction:"observation",channelUrl:r.channel_url,operator:Ry(r),visitor:Cy(r)}:{}},jy=function(e){var t=_(e,2),n=t[0],r=t[1],i=n.operator?n.operator.id:void 0,o=n.channelUrl,s=r.channelUrl;if(i&&o&&o!==s){var a=Im(i);if(a)return a.then((function(e){return e.destroy()}),ky)}},Ly=function(e){var t,n,r,i=e.internalVisitorStateObservable,o=e.getAccessToken,s=e.stats,a=e.visitorPresenceChannel,u=e.salemovePresentInParent;if(sm.trackerSubscription=new Pu.Subscription,sm.tracker=t=new Ty(document,{renewFrequency:(n=sm.conf.engagement.visitor_time_to_inactive_sec,r=sm.conf.engagement.renew_freq_muliplier||.8,Math.max(10,Math.round(n*r))),salemovePresentInParent:u,stats:s,visitorPresenceChannel:a},(function(e){return sm.trackerSubscription.add(e)})),sm.conf.visitor_api.visitor_presence_join_limited){var c=I.pathOr([],["engagement","observations"]),l=I.pathOr([],["engagement","requests"]),f=I.pathOr([],["engagement","engagements"]),p=I.pathOr([],["omniq","queue_tickets"]),h=function(e){return c(e).length>0||l(e).length>0||f(e).length>0||p(e).length>0};i.filter(h).take(1).subscribe((function(){return t.requestStart()})),i.take(1).filter(I.complement(h)).subscribe((function(){return t.requestStartWhenSpaceAvailable()}))}else t.requestStart();var d,v=(d={internalVisitorStateObservable:i},d.internalVisitorStateObservable.pipe(kt(Py),di(I.equals)).pipe(Ho({}),kr(2,1),es(jy),kt((function(e){var t=_(e,2);return t[0],t[1]})),Ho({}))).publishReplay(1);v.subscribe((function(e){cy.setEngagedStatus("engagement"===e.interaction)}));var b=function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Uu();return e.pipe(di(null,(function(e){return e.channelUrl})),Go((function(e){return i.pipe(kt((function(){return e})))})),es(null,zu.warn.bind(zu,"Failed to setup channel observable")),wn((function(e){return Boolean(e.interaction)})),Go((function(e){return t.getUserIsActiveTabObservable().pipe(wi(1),kt((function(t){return{status:e,isActiveTab:t}})))})),Go((function(e){var t=e.status,i=e.isActiveTab;return Mm({channelUrl:t.channelUrl,participantId:"visitor",operatorId:t.operator.id,isActiveTab:i,getAccessToken:n,stats:r}).pipe(Vr((function(){return Pu.Observable.empty()})),kt((function(e){return{channel:e,operator:t.operator}})))})),Io())}(v,t,o,s).publishReplay(1);return sm.channelSubscription=b.connect(),v.connect(),{statusObservable:v,channelObservable:b.filter((function(e){var t=e.channel,n=e.operator;return!t.isStopped()||(zu.warn("Filtering out stopped channel in channelObservable",{channelUrl:t.url,operator:n,siteId:sm.siteId}),!1)})),tracker:t}},qy={get:function(e){return e.checked},set:function(e,t){e.checked=t}},Uy={select:{get:function(e){return I.compose(I.fromPairs,I.map((function(e){return[e.index,e.selected]})))(e.options)},set:function(e,t){I.forEach((function(e){e.selected=t[e.index]}))(e.options)}},option:{get:function(e){return e.selected},set:function(e,t){e.selected=t}},radio:qy,checkbox:qy,default:{get:function(e){return e.value},set:function(e,t){if("function"==typeof Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e,"value")&&Object.getOwnPropertyDescriptor(e,"value").set)try{return Object.getOwnPropertyDescriptor(e.constructor.prototype,"value").set.call(e,t)}catch(n){e.value=t}else e.value=t}}},Dy=function(e){var t=Uy[e.type]||Uy[e.nodeName&&e.nodeName.toLowerCase()]||Uy.default,n=t.get,r=t.set;return{get:function(){return n(e)},set:function(t){r(e,t)}}},Vy="sm_engagement_serialized_inputs",Fy=function(e,t){return I.compose(I.forEach((function(t){var n=t.destInput,r=t.value;return t.hook.set(r),function(e,t){var n=e.createEvent("HTMLEvents");return n.initEvent("change",!0,!1),t.dispatchEvent(n)}(e,n)})),I.filter((function(e){var t=e.hook,n=e.value;return!I.equals(t.get(),n)})),I.map((function(e){var t=e.destInput;return{destInput:t,value:e.value,hook:Dy(t)}})),I.filter((function(e){var t=e.destInput;return Boolean(t)})),I.map((function(t){var n=t.value,r=t.xpath;return{value:n,destInput:Xc(e,r)}})))(t)},By=function(e){var t=I.compose((function(e){return Array.prototype.slice.call(e)}),(function(t){return e.getElementsByTagName(t)})),n=I.chain(t,["INPUT","TEXTAREA","SELECT","PASSWORD","CHECKBOX","RADIO"]);return I.map((function(e){return{value:Dy(e).get(),xpath:Yc(e)}}),n)},Hy=[I.ifElse(I.path(["state","available"]),I.always(1),I.always(0)),I.compose(I.length,I.path(["state","media"]))],Wy=I.reduce(I.maxBy((function(e){return I.ap(Hy,[e])})),null),Gy=function(e){return sm.conf.api_url+e},zy=function(e){return function(e){return e.pipe(wn(I.propEq("connected",!1)))}(e).pipe(Go((function(){return e.pipe(wn(I.propEq("connected",!0)),wi(1))})))},Jy=function(e,t,n){t||(t=Wf);var r=(n&&void 0!==n.authenticatedExternally?n.authenticatedExternally:Bu())?"/messaging/chat_transcript?_=".concat(Date.now()):"/engagements/".concat(e,"/chat_transcript?_=").concat(Date.now());return t({url:Gy(r)}).pipe(kt(I.prop("response")),No(),Vr((function(t){return zu.warn("Failed to fetch chat history",{error:t,engagement_id:e}),Nc.of([])})))},Yy=function(e){var t=e.engagementId,n=e.connectionStatusObservable,r=e.requestAsObservable;return zy(n).pipe(an((function(){return Jy(t,r)})),Io())},Qy=Pu.Observable.throw(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR})).pipe(es(null,(function(){return zu.warn("Operators observable timed out!")}))),Ky=function(e,t){t||(t=[]);return e.increment("engagement.flow",["entrypoint:reactive-request"].concat(t))},Xy=function(e,t,n,r){r||(r=Pu.Scheduler.asap);var i=t||{},o=i.operatorId,s=i.phoneNumber,a=i.phoneExtension,u=i.source,c=i.oneWay,l=i.siteId;l||(l=sm.siteId);var f=n.api,p=n.operatorsObservable,h=n.serverResponseTimeout,d=n.engagementCoreObservable,v=n.mediaValidation,b=n.statsClient;zu.info("Engagement: Reactive request initiated",{media:e,options:t});var m=o?I.find(I.propEq("id",o)):Wy,g=p.pipe(as(h,Qy,r),kt(m),an((function(e){return e?Pu.Observable.of(e):Pu.Observable.throw(new hf({cause:tf.SALEMOVE.OPERATOR_UNAVAILABLE}))})));return Pu.Observable.combineLatest(g,d).pipe(an((function(n){return function(n){var i=n.state.medias,o=n.state.oneWayMedias,s=v({media:e,options:t,availableMediaTypes:i,availableOneWayMediaTypes:o});return(s instanceof Pu.Observable?s:Pu.Observable.from(s,r)).pipe(kt(I.always(n)))}(_(n,1)[0])})),an((function(t){var n={phoneNumber:s,phoneExtension:a,oneWay:c};return Ky(b,["action:reach","stage:create-request"]),f.create({operatorId:t.id,siteId:l,media:e,source:u,mediaOptions:n}).pipe(kt((function(r){return I.merge(r,{operator:t,media:e,mediaOptions:n})})))})))},$y=function(e,t){t||(t=Pu.Scheduler.asap);var n=e.media,r=e.mediaOptions,i=e.mediaValidation,o=e.api,s=e.notifyOfTimeout,a=e.operatorsObservable,u=e.engagementCoreObservable,c=e.cobraObservable,l=e.channelObservable,f=e.serverResponseTimeout,p=e.communicationLib,h=e.engagementApi,d=e.webRtcMode,v=e.enabledMediaLevel,b=e.statsClient,m=Xy(n,r,{api:o,operatorsObservable:a,serverResponseTimeout:f,engagementCoreObservable:u,mediaValidation:i,statsClient:b},t).pipe(co()),g=m.connect();Ky(b,["action:begin"]);var y=m.pipe(an((function(e){var n=e.engagementRequestId,r=e.acknowledgeTimeoutSeconds,i=e.operator;return Ky(b,["action:reach","stage:requested"]),Pu.Observable.combineLatest(o.acceptedObservable,c,l,(function(e,t){return I.merge(e,{cobra:t})})).pipe(as(1e3*r+f,function(e,t){return Pu.Observable.throw(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT})).pipe(es(null,(function(){return zu.warn("Engagement request timed out! Some internal listener must be missing.")})),es(null,(function(){return e.notifyOfReactiveFailure({id:t})})))}(o,n),t),Ki(nl(function(e){return Pu.Observable.merge(o.declinedObservable.pipe(kt(I.always(new hf({cause:tf.SALEMOVE.OPERATOR_DECLINED})))),o.timedOutObservable.pipe(es((function(){return s({operator:e})})),kt(I.always(new hf({cause:tf.SALEMOVE.TIMEOUT})))))}(i))),wi(1),Ci((function(){return g.unsubscribe()})))})),es(null,I.ifElse(I.propEq("cause",tf.SALEMOVE.INTERNAL_ERROR),zu.warn.bind(zu,"Engagement: Reactive request failed"),zu.info.bind(zu,"Engagement: Reactive request failed"))),es(null,(function(e){return Ky(b,["action:end"].concat(function(e){return e&&e.cause===tf.SALEMOVE.OPERATOR_UNAVAILABLE?["stage:pre-request","expected:true","reason:target-unavailable"]:e&&e.cause===tf.SALEMOVE.INVALID_INPUT?["stage:pre-request","reason:invalid-input"]:e&&e.cause===tf.SALEMOVE.INTERNAL_ERROR?["stage:create-request","reason:internal-error"]:e&&e.cause===tf.SALEMOVE.TIMEOUT?["stage:requested","expected:true","reason:accept-timeout"]:e&&e.cause===tf.SALEMOVE.OPERATOR_DECLINED?["stage:requested","expected:true","reason:decline"]:e&&e.cause===tf.SALEMOVE.NETWORK_TIMEOUT?["stage:create-request","reason:network-error"]:["stage:pre-request","reason:script-load-error"]}(e)))})),kt((function(e){var t,r,i,o,s,a,u,c,f,b;i=e.engagementId,b=e.subEngagementId,t=e.cobra,n=e.media,s=e.operatorId,u=e.operatorName,c=e.operatorFormattedName,f=e.operatorPicture,a=e.operatorMediaType,o=e.entrypoint,r=e.createdAt;var m=Xg({id:s,name:u,formattedName:c,picture:f,mediaType:a,webRtcMode:d,enabledMediaType:v});return zu.info("Engagement: Reactive request accepted",{engagementId:i,subEngagementId:b,operator:m}),{engagementId:i,subEngagementId:b,startingMedia:n,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:Jy(i),operator:m,communicationLib:p,cobra:t,channelObservable:l,engagementApi:h,entrypoint:o,createdAt:r}})),wi(1));return{requestObservable:m,resultObservable:y}},Zy=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.Subscription=gr.Subscription})),e_=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(Zy)})),t_=u((function e(t){var n=t.id,r=t.content,i=t.status,o=t.attachment,a=t.created_at;if(s(this,e),this.id=n,this.content=r,this.sender="visitor",this.sender_details={type:"visitor"},this.status=null,this.attachment=o,this.created_at=a,i){if(!I.find(I.equals(i),I.values(this.STATUSES)))throw new hf({cause:tf.SALEMOVE.INTERNAL_ERROR,message:"Unknown status ".concat(i)});this.status=i}})),n_=I.propEq("sender","visitor");t_.prototype.STATUSES={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},t_.prototype.ATTACHMENT_RESPONSE_TYPES={SINGLE_CHOICE_RESPONSE:"single_choice_response",FILES:"files"};var r_=u((function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at,u=t.sender,c=void 0===u?{}:u;s(this,e),this.id=n,this.content=r,this.sender="operator",this.sender_details={type:"operator",name:c.name,picture:c.picture?c.picture.url:"",id:c.id},this.attachment=i,this.metadata=o,this.created_at=a}));r_.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var i_=u((function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at;s(this,e),this.id=n,this.content=r,this.sender="system",this.sender_details={type:"system"},this.attachment=i,this.metadata=o,this.created_at=a}));i_.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var o_=sm.conf.visitor_app_option,s_=function(e,t){return e===t},a_={VISITOR:"visitor",OPERATOR:"operator",SYSTEM:"system"},u_=function(e,t){var n=I.differenceWith(I.eqProps("id"),e,t);return 0===n.length?t:I.concat(n,t)},c_=function(e,t,n){var r=e.pipe(Ki(t),sr((function(e,t){var n=I.findIndex(I.propEq("id",t.id),e);return-1!==n?I.update(n,t,e):I.prepend(t,e)}),[]),Ho([]));return cc.combineLatest(r,n,u_).pipe(di(s_))},l_=function(e){var t=e.sender.type;return t===a_.VISITOR?new t_(e):t===a_.OPERATOR?new r_(e):t===a_.SYSTEM?new i_(e):void 0},f_=function(e){var t=e.sender.type;return l_(i(i({},e),{},t===a_.VISITOR?{content:e.message,status:t_.prototype.STATUSES.DELIVERED}:{content:e.message}))},p_=function(e){return I.map(f_,e).reverse()},h_=function(e){var t=e.chatHistoryObservable,n=e.ownMessages,r=e.otherMessages,i=e.statsClient,o=e.fetchExtraOperatorInfo,s=n.pipe(kt((function(e){var t=e.id,n=e.content,r=e.attachment;return new t_({id:t,content:n,attachment:r,status:null})}))),a=n.pipe(an((function(e){var t=e.id,n=e.content,r=e.status,i=e.attachment;return r.pipe(kt((function(e){return new t_({id:t,content:n,attachment:i,status:e})})))}))),u=r.pipe(fi(I.prop("id")),an((function(e){var t=I.path(["sender","type"],e);if(t===a_.OPERATOR){var n=e.sender.id;return o(n).pipe(kt((function(t){return I.evolve({sender:I.merge(t)})(e)})))}return t===a_.SYSTEM?Nc.of(e):(zu.warn("Received other chat message of unknown sender origin",{id:e.id,sender_type:t}),xc.empty())})),kt(l_)),c=t.pipe(kt(p_)),l=c_(a,u,c).pipe(es((function(){i.increment("sm.app.visitor_api.chat.messages",["action:emitted","visitor_app:".concat(o_)])})));return{messages:c_(s,u,c),messagesWithStatusUpdates:l}},d_=u((function e(t){var n=t.typing;s(this,e),this.typing=n})),v_="visitor";function b_(e){this.recordChatMessageSent=function(t){1===t?e.increment("sm.".concat(v_,".communication.chat.message.sent")):e.increment("sm.".concat(v_,".communication.chat.message.retry"))},this.recordChatMessageDeliveryFailed=function(){e.increment("sm.".concat(v_,".communication.chat.message.delivery_failed"))},this.recordChatMessageDelivered=function(){e.increment("sm.".concat(v_,".communication.chat.message.delivered"))}}var m_=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ReplaySubject=gr.ReplaySubject})),g_=k((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(m_)})),y_={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},__="Chat",w_=function(){function e(t){var n=t.chatApi,r=t.messagesToSend,i=t.previewToSend,o=t.deliveryTimeout,a=void 0===o?sm.conf.chat_message_send_timeout_ms||15e3:o,u=t.history,c=t.guid,l=void 0===c?Tl:c,f=t.stats,p=t.logger;s(this,e),this._chatApi=n,this._previewToSend=i,this._history=u,this._generateGuid=l,this._messagesToSend=r,this._deliveryTimeout=a,this.stats=f,this.logger=p,this._messengerStoppedSubject=new vc.Subject,this._sentMessages=new vc.Subject,this._deliveryEvents=this._chatEvents("deliveredMessages"),this._receivedMessageIds=[],this._subscription=new e_.Subscription}return u(e,[{key:"start",value:function(){var e=this;this._subscription.add(this._messagesToSend.subscribe(this._sendMessage.bind(this),this.logger.error)),this._subscription.add(this._previewToSend.subscribe((function(t){return e._chatApi.sendPreview({content:t})}),this.logger.error)),this._subscription.add(this._messagesReceivedFromHistory().subscribe(this._acceptReceivedMessage("history"),(function(t){return e.logger.warn("".concat(__,": Failed to fetch chat history"),t)})))}},{key:"stop",value:function(){this._chatApi.stop(),this._messengerStoppedSubject.next(),this._subscription.unsubscribe()}},{key:"observables",value:function(){return{ownMessages:this._sentMessages.pipe(Ki(this._receivedVisitorMessages())),otherMessages:this._receivedOtherMessages(),operatorTypingIndicator:this._chatApi.operatorTypingIndicator}}},{key:"_chatEvents",value:function(e){return this._chatApi[e].pipe(Qo(this._messengerStoppedSubject))}},{key:"_receivedVisitorMessages",value:function(){return this._chatEvents("receivedVisitorMessages").pipe(kt(I.merge({status:Nc.of(y_.DELIVERED)})))}},{key:"_sendMessageAndWaitForAcknowledgement",value:function(e){var t=this,n=e.message,r=this._deliveryEvents.pipe(wn((function(e){return I.equals(n.id,e.id)})),wi(1),Io()),i=r.subscribe(I.always);return this._chatApi.sendMessage(n).pipe(Yo(r.pipe(Wi(y_.DELIVERED),as(this._deliveryTimeout,jf._throw("".concat(__,": Message timed out before being delivered to other participant"))))),Vr((function(e){return t.logger.info("".concat(__,": Message delivery failed with error"),{error:e,message_id:n.id}),Nc.of(y_.FAILED)})),wi(1),Ci(i.unsubscribe))}},{key:"_sendMessage",value:function(e){var t,n,r,i,o,s,a=this,u=(t=e,n=this._generateGuid,r=t.content,i=t.options,o=i?i.attachment:void 0,s=i?i.metadata:void 0,{id:n(),content:r,attachment:o,metadata:s}),c=new g_.ReplaySubject(1).distinctUntilChanged();return c.next(y_.SENDING),this._sentMessages.next(I.merge(u,{status:c})),this._addToReceived(u),this._subscription.add(this._sendMessageAndWaitForAcknowledgement({message:u}).subscribe((function(e){c.next(e),e===y_.DELIVERED&&(c.complete(),a.stats.recordChatMessageDelivered(),a.logger.info("".concat(__,": Message delivered to other participant"),{message_id:u.id})),e===y_.FAILED&&a.stats.recordChatMessageDeliveryFailed()}),this.logger.error))}},{key:"_acceptReceivedMessage",value:function(e){var t=this;return function(n){t.logger.info("".concat(__,": Message received"),{message_id:n.id,source:e}),t._addToReceived(n),I.pathEq(["sender","type"],"visitor",n)||n.delivered_at||t._chatApi.markMessageAsDelivered(n.id)}}},{key:"_receivedOtherMessages",value:function(){var e=this;return this._chatEvents("receivedOtherMessages").pipe(wn((function(t){return e._messageNotReceived(t)})),an((function(t){return Nc.of(t).pipe(es(e._acceptReceivedMessage("participant")),Vr((function(){return Nc.of(t)})))})),Io())}},{key:"_messagesReceivedFromHistory",value:function(){var e=this;return this._history.pipe(wn((function(t){return e._messageNotReceived(t)})),an((function(e){return hc.from(e)})))}},{key:"_messageNotReceived",value:function(e){return!I.contains(e.id,this._receivedMessageIds)}},{key:"_addToReceived",value:function(e){this._receivedMessageIds=I.append(e.id,this._receivedMessageIds)}}]),e}();w_.STATUSES=y_;var E_=n.default.visitor_api.own_typing_duration||5e3;var O_="engagement.chat.message",S_="engagement.chat.system_message",T_="engagement.chat.message_status",k_="engagement.chat.typing_indicator.operator",A_="engagement:chat_message:preview_update",x_="Chat",I_={retryLimit:5,initialDelay:1e3,maxDelay:void 0,factor:1.5},N_=function(e){return 0===e||421===e||429===e||e>=500},M_=function(){},C_=I.propSatisfies((function(e){return e===O_||e===S_}),"event_type"),R_=I.propEq("event_type",T_),P_=function(e){var t=I.pathEq(["message","engagement_id"],e);return I.allPass([C_,t])},j_=function(e){var t,n,r=e.engagementId,i=e.visitorId,o=e.logger,s=e.stats,a=e.channelObservable,u=e.xhrWithRetry,c=void 0===u?Gf:u,l=e.getRequestHeaders,f=e.siteVisitorNotifications,p=new vc.Subject,h=function(e){return e.attachment?{content:e.content,attachment:e.attachment}:{content:e.content}},d=(t=p.map(I.prop("content")),t.pipe(Go((function(e){return""===e?Ru.Observable.of(!1):Ru.Observable.merge(Ru.Observable.of(!0),Ru.Observable.timer(E_,n).map((function(){return!1})))})),rs(50,n,{leading:!0,trailing:!0}),di())).subscribe((function(e){Hf({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/typing_indicator"),payload:JSON.stringify({typing:e}),responseType:"json",getRequestHeaders:function(){return I.merge(l?l():{},{"Content-Type":"application/json"})},onSuccess:M_,onError:function(e){return o.warn("Could not set typing indicator",e)},onAttempt:M_,shouldRetry:function(){return!1}})})),v=p.startWith({content:""}).combineLatest(a).subscribe((function(e){var t=_(e,2),n=t[0];t[1].emit(A_,{engagement_id:r,content:n.content,visitor_id:i})}),o.error.bind(o,"".concat(x_,": Error sending chat preview"))),b=I.compose(I.merge({type:"user"}),I.pick(["id","engagement_id","content","attachment","metadata","sender"]),I.prop("message")),m=I.compose(I.pick(["id","engagement_id"]),I.prop("message")),g=I.pathEq(["message","engagement_id"],r),y=I.pathEq(["message","sender","type"],"visitor"),w=I.pathEq(["message","status"],"delivered"),E=f.pipe(wn(P_(r))),O=E.pipe(wn(I.complement(y)),kt(b)),S=E.pipe(wn(y),kt(b)),T=f.pipe(wn(I.allPass([R_,g,w])),kt(m)),k=I.propEq("event_type",k_),A=I.pathEq(["typing_indicator","engagement_id"],r);return{stop:function(){v.unsubscribe(),d.unsubscribe()},sendMessage:function(e){var t=e.id;return ac.Observable.create((function(n){var i=0;c({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(t),payload:JSON.stringify(h(e)),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:M(I_.initialDelay,I_.maxDelay,I_.factor),retryLimit:I_.retryLimit,onSuccess:function(t){o.info("".concat(x_,": Message sent to system, waiting for it to be delivered to other participant"),{message_id:e.id}),n.next(t),n.complete()},onError:function(e){var r=e.status,i=e.statusText,s="".concat(x_,": Failed to send message to system");o.warn(s,{message_id:t,status:r,status_text:i}),n.error(s)},onAttempt:function(){++i>1&&o.info("Chat: Send message request failed, retrying",{message_id:t,attempt:i}),s.recordChatMessageSent(i)},shouldRetry:N_})})).pipe(wi(1))},sendPreview:function(e){return p.next(e)},markMessageAsDelivered:function(e,t,n){c({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(e),payload:JSON.stringify({status:"delivered"}),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:M(I_.initialDelay,I_.maxDelay,I_.factor),retryLimit:I_.retryLimit,onSuccess:function(){o.info("".concat(x_,": Marked message as delivered"),{message_id:e}),"function"==typeof t&&t()},onError:function(t){var r=t.status,i=t.statusText;o.warn("".concat(x_,": Failed to mark message as delivered"),{message_id:e,status:r,status_text:i}),"function"==typeof n&&n()},shouldRetry:N_})},receivedOtherMessages:O,receivedVisitorMessages:S,deliveredMessages:T,operatorTypingIndicator:f.pipe(wn(I.allPass([k,A])),kt(I.prop("typing_indicator")),sr((function(e,t){return t.clock>e.clock?t:e})),kt(I.pick(["typing"])),di(I.equals))}},L_=function(e,t){for(var n,r=[];n=t.exec(e);)r.push(n[1]);return r},q_=function(e,t,n){return t&&I.forEach((function(t){var r=t.split("").join(".*?");e=e.replace(new RegExp(r),n)}),t),e},U_=function(e){var t=!0;return e.split("").reduceRight((function(e,n){return n=parseInt(n,10),(t=!t)&&(n*=2),n>9&&(n-=9),e+n}),0)%10==0},D_=I.compose((function(e){var t=new RegExp(/(?:^|\D)(\d{3}(-| )\d{2}(-| )\d{4})(?=\D|$)/g),n=L_(e,t);return q_(e,n,"***Social Security Number Not Allowed***")}),(function(e){var t=new RegExp("(\\d{".concat(12,",})"),"g"),n=L_(function(e){var t=new RegExp("([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})|([^(a-zA-Z0-9)])","gm");return e.replace(t,"$1")}(e),t),r=I.filter(U_,n);return q_(e,r,"***Credit Card Number Not Allowed***")}),(function(e,t){return t.reduce((function(e,t){try{var n=new RegExp(t,"g");return e.replace(n,(function(e){return"*".repeat(e.length)}))}catch(t){return e}}),e)})),V_=function(e){return e.replace(/[0-9]/g,"*")},F_=function(){function e(t){var n=t.channelObservable,r=t.historyObservable,i=t.getRequestHeaders,o=t.logger,a=t.statsClient,u=t.engagementId,c=t.visitorId,l=t.siteVisitorNotifications,f=t.maskingRegularExpressions;s(this,e);var p=new b_(a);this._messagesToSend=new vc.Subject,this._previewToSend=new vc.Subject,this.chatApi=new j_({engagementId:u,visitorId:c,logger:o,stats:p,channelObservable:n,getRequestHeaders:i,siteVisitorNotifications:l}),this.messenger=new w_({chatApi:this.chatApi,stats:p,logger:o,messagesToSend:this._messagesToSend.pipe(kt((function(e){return function(e,t){var n=e.content,r=e.options;return{content:D_(n,t),options:r}}(e,f)}))),previewToSend:this._previewToSend.pipe(kt(V_)),history:r}),this.messenger.start()}return u(e,[{key:"sendMessage",value:function(e,t){this._messagesToSend.next({content:e,options:t})}},{key:"sendMessagePreview",value:function(e){this._previewToSend.next(e)}},{key:"stop",value:function(){this.messenger.stop()}},{key:"observables",value:function(){return this.messenger.observables()}}]),e}(),B_=function(){function e(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.observeChatMessages,o=t.statsClient,a=t.chatController,u=t.fetchExtraOperatorInfo;s(this,e);var c=new e_.Subscription,l=tp(),f=a.observables(),p=f.otherMessages,h=f.ownMessages,d=f.operatorTypingIndicator,v=i({chatHistoryObservable:n,otherMessages:p,ownMessages:h,statsClient:o,fetchExtraOperatorInfo:u}),b=v.messages.pipe(co(1)),m=v.messagesWithStatusUpdates.pipe(co(1));c.add(b.connect()),c.add(m.connect());var g=d.pipe(kt(I.construct(d_)),Ho(new d_({typing:!1})),co(1));c.add(g.connect());var y=function(){l.stop(),c.unsubscribe()},_=I.fromPairs([[this.EVENTS.MESSAGES,b],[this.EVENTS.MESSAGES_WITH_STATUS_UPDATES,m],[this.EVENTS.OPERATOR_TYPING_STATUS_UPDATE,g]]);l.proxyAll(_),this.addEventListener=l.addEventListener,this.removeEventListener=l.removeEventListener,this.observable=function(e){return _[e]},this.sendMessage=function(e,t){a.sendMessage(e,t),a.sendMessagePreview("")},this.sendMessagePreview=function(e){a.sendMessagePreview(e)},r.subscribe((function(){}),y,y)}return u(e,null,[{key:"create",value:function(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.statsClient,o=t.engagementId,s=t.getRequestHeaders,a=t.siteVisitorNotifications,u=t.maskingRegularExpressions,c=ec.vent.observable(ec.MSG.PUBLIC.ENGAGEMENT_START),l=ac.Observable.defer((function(){return ec.request("get:engagement_observables").engagementObservable})),f=function(e){var t=e.getRequestHeaders,n=e.xhrWithRetry,r=void 0===n?Gf:n,i=e.takeUntilNotifier,o={},s={},a=i||new Pu.Subject;return function(e){return o[e]?Nc.of(o[e]):ac.Observable.create((function(n){if(s[e])s[e].push(n);else{s[e]=[n];var i=function(e){return function(){s[e]&&(s[e].forEach((function(e){e.next(),e.complete()})),delete s[e])}}(e);r({method:"GET",url:"".concat(sm.conf.api_url,"/operators/").concat(e,"?include_engagements=false"),responseType:"json",contentType:"application/json",getRequestHeaders:t,onSuccess:function(t){o[e]=t.response,s[e]&&(s[e].forEach((function(e){e.next(t.response),e.complete()})),delete s[e]),delete s[e]},onError:i,shouldRetry:function(){return!1}})}})).pipe(Qo(a))}}({getRequestHeaders:s}),p=function(e){var t=e.chatHistoryObservable,n=e.engagementStartObservable,r=e.engagementObservables,i=e.siteVisitorNotifications,o=e.getRequestHeaders,s=e.statsClient,a=e.engagementId,u=e.maskingRegularExpressions,c=n.pipe(Xi(r),so("channel"),co(1)),l=c.connect(),f=new F_({channelObservable:c,historyObservable:t,getRequestHeaders:o,statsClient:s,logger:sm.logger.withTags({engagement_id:a,site_id:sm.siteId}),engagementId:a,visitorId:Lu(),siteVisitorNotifications:i,maskingRegularExpressions:u});return{chatController:f,stopChat:function(){f.stop(),l.unsubscribe()}}}({chatHistoryObservable:n,engagementStartObservable:c,siteVisitorNotifications:a,engagementObservables:l,statsClient:i,engagementId:o,getRequestHeaders:s,maskingRegularExpressions:u}),h=p.chatController,d=p.stopChat;return{chat:new e({chatHistoryObservable:n,engagementEndObservable:r,observeChatMessages:h_,statsClient:i,chatController:h,fetchExtraOperatorInfo:f}),stopChat:d}}}]),e}();B_.prototype.EVENTS={MESSAGES:"messages",MESSAGES_WITH_STATUS_UPDATES:"messages-with-status-updates",OPERATOR_TYPING_STATUS_UPDATE:"operator-typing-status-update"},B_.prototype.SENDERS=a_;var H_={OBSERVATION:"OBSERVATION",ENGAGEMENT:"ENGAGEMENT",POINTER:"POINTER"},W_=function(){function e(t,n){s(this,e),this.mode=t,this.session=n}return u(e,null,[{key:"createObservation",value:function(){return new this(H_.OBSERVATION,null)}},{key:"createActive",value:function(e){return new this(e.mode,e.session)}}]),e}(),G_=function(){function e(t){var n=t.cobra;s(this,e),this.stop=function(){return n.switchToObservation()}}return u(e,[{key:"stop",value:function(){}}]),e}(),z_=function(){function e(t){var n=t.operator,r=t.channel;s(this,e),this.operator=n,this.allow=function(){return r.emitAll("engagement:offer_cobrowsing:allow"),zu.info("Visitor accepted cobrowsing request"),null},this.decline=function(){return r.emitAll("engagement:offer_cobrowsing:deny"),zu.info("Visitor declined cobrowsing request"),null}}return u(e,[{key:"allow",value:function(){}},{key:"decline",value:function(){}}]),e}(),J_=u((function e(t){var n=this,r=t.cobra,i=t.operator,o=t.channelObservable,a=t.fromRxJs4,u=void 0===a?tl:a;s(this,e);var c=o.switchMap((function(e){var t=e.channel;return t.emitAll("engagement:offer_cobrowsing:ready"),t.observable("engagement:offer_cobrowsing:offer_cobrowsing").do((function(){return t.emitAll("engagement:offer_cobrowsing:ack")})).map(I.always({channel:t}))})).do((function(){return zu.info("Received cobrowsing request")})).share().map((function(e){var t=e.channel;return new z_({operator:i,channel:t})})),l=u(r.modeObservable.pluck("name").map((function(e){return e===n.MODES.OBSERVATION?W_.createObservation():W_.createActive({mode:e,session:new G_({cobra:r})})}))),f=I.fromPairs([[this.EVENTS.COBROWSING_REQUEST,c],[this.EVENTS.MODE_CHANGE,l]]),p=np(),h=tp();h.proxyAll(f),p.proxyAll(f),this.resendPage=function(){"function"==typeof r.resendPage&&r.resendPage()},this.addUnbufferedEventListener=h.addEventListener,this.removeUnbufferedEventListener=h.removeEventListener,this.addBufferedEventListener=p.addEventListener,this.removeBufferedEventListener=p.removeEventListener,this.observable=function(e){return h.observable(e)},this.bufferedObservable=function(e){return p.observable(e)}}));J_.prototype.EVENTS={COBROWSING_REQUEST:"cobrowsing_request",MODE_CHANGE:"cobrowser_mode_change"},J_.prototype.MODES=H_;var Y_=function(e){return"browser"===e?"audio":"phone"},Q_=function(e){var t=e.upgradeRequest,n=e.currentMediaState,r={audio:I.path(["audio","direction"],n),video:I.path(["video","direction"],n)},i=I.pick(["audio","video"],t),o=I.invert(r).two_way||[],s=I.invert(i).two_way||[];return!I.isEmpty(I.difference(s,o))},K_="two_way",X_="one_way",$_=function(e,t){return I.maxBy((function(e){return e===K_?2:e===X_?1:0}),e,t)},Z_=function(e){if(e){if(e.video)return"video";if(e.audio&&"browser"===e.audio.type)return"audio";if(e.audio&&"phone"===e.audio.type)return"phone"}return"text"},ew=function(e){return e.stateObservable.bufferCount(2,1).filter((function(e){var t=_(e,2),n=t[0],r=t[1];return n.sub_engagement_id!==r.sub_engagement_id})).do(zu.log.bind(zu,"Detect sub_engagement change")).map((function(e){var t=_(e,2);t[0];return t[1]})).map((function(e){var t=new _g({id:e.operator.id,name:e.operator.name||"Operator",formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},media_type:e.operator.media_type}),n={id:e.id,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,mediaState:e.media_state,operatorId:t.getId(),operatorName:t.getName(),operatorFormattedName:t.getFormattedName(),operatorPicture:t.getPictureUrl(),operatorMedia:t.getMediaType()};return n=I.assoc("startingMedia",Z_(n),n)})).map(I.pick(["operatorId","operatorName","operatorFormattedName","operatorPicture","operatorMedia","startingMedia","subEngagementId","id"])).map(I.merge({isReestablishing:!1,isTransfer:!0})).do(zu.log.bind(zu,"Engagement transferred"))},tw=function(e){var t,n=e.engagement,r=e.transfers,i=e.channelObservable,o=e.webRtcMode,s=e.statusObservable,a={id:n.engagementId,subEngagementId:n.subEngagementId,startingMedia:n.startingMedia,isReestablishing:n.isReestablishing,operatorId:n.operator.id,operatorName:n.operator.name,operatorFormattedName:n.operator.formattedName,operatorPicture:n.operator.picture?n.operator.picture.url:void 0,operatorMedia:(t=n.operator.state.medias,I.findLast(I.contains(I.__,t),rf)),observable:n.observable.bind(n),EVENTS:n.EVENTS},u=s.filter(I.propEq("interaction","engagement")).map(I.prop("channelUrl")).take(1),c=i.switchMap((function(e){var t=e.channel;return u.map((function(e){return{channel:t,engagementChannelUrl:e}}))})).filter((function(e){var t=e.channel,n=e.engagementChannelUrl;return t.url===n})).take(1);return Pu.Observable.of(a).merge(r).switchMap((function(e){return c.map((function(t){var n=t.channel;return I.merge({channel:n},e)}))})).map(I.evolve({startingMedia:I.when(I.isNil,I.always(n.startingMedia))})).map((function(e){return I.merge(e,{webRtcMode:o})}))};function nw(e){return I.reduce((function(e,t){return e.then((function(e){return t.then((function(t){return I.append(t,e)}))}))}),Promise.resolve([]),e)}var rw=I.compose(I.join(", "),I.map((function(e){return"'".concat(e,"'")}))),iw=/^\+?[1-9]\d{1,14}$/,ow=function(e){return new Promise((function(t,n){return function(e){return Boolean(e&&e.phoneNumber)}(e)?(r=e.phoneNumber,iw.test(r)?void t():n(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Invalid phone number: '".concat(e.phoneNumber,"'! Make sure that country code is present in the number and it has plus sign (+) prefix")}))):n(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"'phone' was specified as the media but the 'phoneNumber' option is missing!"}));var r}))},sw=function(e){return new Promise((function(t,n){if(function(e){return e&&e.hasOwnProperty("phoneExtension")}(e)&&(null!==(r=e.phoneExtension)&&!r.match(/^(,*\d,*){1,7}$/)))return n(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Invalid phone extension: '".concat(e.phoneExtension,"'! The phone extension can only contain commas and up to 7 digits.")}));var r;t()}))},aw=function(e){var t=e.media,n=e.options,r=e.availableMediaTypes,i=e.availableOneWayMediaTypes,o=e.visitorUpgradesAllowed,s=e.highestAllowedMediaType,a=[],u=!1===o?I.drop(r.indexOf(s),r):r;return a.push(function(e,t,n,r,i){return new Promise((function(o,s){if(i.oneWay){if(!1===r)return s(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if(!I.contains(e,n))return s(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(rw(n),"!")}))}if(!i.oneWay&&!I.contains(e,t))return s(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(rw(t),"!")}));o()}))}(t,u,i,o,n||{})),"phone"===t&&(a.push(ow(n)),a.push(sw(n))),nw(a)},uw=function(e){var t=e.options,n=e.availableMediaTypes,r=e.availableOneWayMediaTypes,i=e.visitorUpgradesAllowed,o=e.highestAllowedMediaType,s=[],a=!1===i?I.drop(n.indexOf(o),n):n;return s.push(function(e,t,n,r){return new Promise((function(i,o){if(e.audio){var s=["browser","phone"];if(!I.contains(e.audio,s))return o(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Audio must be one of: ".concat(rw(s),"!")}));if(!I.contains("audio",t)&&!I.contains("phone",t))return o(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Audio is not supported!"}))}if(e.video){var a=["one_way","two_way"];if(!I.contains(e.video,a))return o(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Video must be one of: ".concat(rw(a),"!")}));if("one_way"===e.video&&!1===r)return o(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if("one_way"===e.video&&!I.contains("video",n))return o(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"One-way video is not supported!"}));if("two_way"===e.video&&!I.contains("video",t))return o(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Video is not supported!"}))}i()}))}(t,a,r,i)),"phone"===t.audio&&(s.push(ow(t)),s.push(sw(t))),nw(s)},cw=u((function e(t){var n=this;s(this,e);var r=t.visitor,i=t.operator;this.visitor=I.compose(I.evolve({phoneStatus:function(e){switch(e){case ec.MSG.PHONE_STATUSES.CONNECTED:return n.PHONE_STATUSES.CONNECTED;case ec.MSG.PHONE_STATUSES.CONNECTING:return n.PHONE_STATUSES.CONNECTING;default:return n.PHONE_STATUSES.UNUSED}}}),I.pickAll(["media","audioMuted","videoMuted","phoneStatus"]))(r),this.operator=I.pickAll(["media","audioMuted","videoMuted"],i)}));cw.prototype.PHONE_STATUSES={CONNECTED:"connected",CONNECTING:"connecting",UNUSED:"unused"};var lw=u((function e(t){var n=t.id,r=t.label,i=t.is_default,o=t.position;if(s(this,e),this.id=n,this.label=r,this.is_default=i,this.position=o,!this.id||!this.label)throw zu.error("Survey choice missing parameters",{parameters:{id:n,label:r,is_default:i,position:o}}),new hf({cause:tf.SALEMOVE.INTERNAL_ERROR,message:"Survey choice is missing required parameters"})})),fw=u((function e(t){var n=this,r=t.id,i=t.text,o=t.name,a=t.type,u=t.required,c=t.position,l=t.options;s(this,e),this.id=r,this.text=i,this.name=o,this.type=a,this.required=u,this.position=c,this.options=l;var f=function(){return n.options&&Array.isArray(n.options)&&!I.isEmpty(n.options)};if("single_choice"===this.type&&f()&&(this.options=this.options.map((function(e){return new lw(e)}))),"single_choice"!==this.type||f()||zu.warn("Single choice survey question missing options",{parameters:arguments[0]}),!(this.id&&this.text&&this.name&&this.type))throw zu.error("Survey question missing parameters",{parameters:arguments[0]}),new hf({cause:tf.SALEMOVE.INTERNAL_ERROR,message:"Survey question is missing required parameters"})})),pw=u((function e(t,n){var r=this,i=t.survey;s(this,e),this.id=i.id,this.description=i.description,this.title=i.title,this.type=i.type,this.name=i.name,this.questions=i.questions.map((function(e){return new fw(e)})).filter((function(e){return!(e.type===r.QUESTION_TYPES.SINGLE_CHOICE&&I.isEmpty(e.options))})),this.answer=function(e){return n({surveyId:i.id,answers:Kl(e)})}}));pw.prototype.QUESTION_TYPES={BOOLEAN:"boolean",SCALE:"scale",TEXT:"text",SINGLE_CHOICE:"single_choice"};var hw=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),dw=["#inner-page",".socketio","script[src*='".concat(n.default.assets.server,"']"),"#cobrowsing-mouse-container","style[data-page-iframer='keep']"],vw=n.default.visitor_app.is_custom_theme?["body > link","head > link"]:["link[href*='".concat(n.default.assets.server,"']"),"link[href*='".concat(n.default.api_url,"']"),"link[href*='https://uploads.salemove.com']"],bw=dw.concat(vw),mw=function(){function e(t,n){s(this,e),this._retainedElementsBySelector=this._retainedElementsBySelector.bind(this),this._document=t,n||(n=[]),this._filters=n}return u(e,[{key:"clean",value:function(){this._removeAccordingToFiltersLeavingTopLevelInPlace(),this._cleanHtmlElementOfUnnecessaryAttributes(),this._overrideBodyInlineStyles(),this._hideParentsOfKeptHiddenElements()}},{key:"_removeAccordingToFiltersLeavingTopLevelInPlace",value:function(){var e=I.chain(this._retainedElementsBySelector,this._filters),t=Wc(this._document.head.querySelectorAll("*")).concat(Wc(this._document.body.querySelectorAll("*")));return I.differenceWith(I.identical,t,e).filter((function(e){return"title"!==e.localName})).map((function(e){return e.parentNode.removeChild(e)}))}},{key:"_retainedElementsBySelector",value:function(e){var t=Wc(this._document.querySelectorAll(e));return I.chain((function(e){return Wc(e.querySelectorAll("*")).concat([e]).concat(Hc(e))}),t)}},{key:"_cleanHtmlElementOfUnnecessaryAttributes",value:function(){var e=this._document.querySelector("html");Wc(e.attributes).filter((function(e){return"lang"!==e.name})).forEach((function(t){return e.removeAttribute(t.name)}))}},{key:"_overrideBodyInlineStyles",value:function(){this._document.body.removeAttribute("style")}},{key:"_hideParentsOfKeptHiddenElements",value:function(){if(this._filters.length>0){var e=Wc(this._document.body.querySelectorAll("*")).filter(Bc),t=Wc(this._document.body.querySelectorAll(this._filters.join(","))),n=I.chain((function(e){var t=Wc(e.querySelectorAll("*")).concat([e]);return Bc(e)?t.concat(Hc(e)):t}),t);I.differenceWith(I.identical,e,n).forEach((function(e){e.style.display="none"}))}}}]),e}(),gw=sm.conf.visitor_app.css_prefix||"sm-",yw={id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:[]},_w=function(){function e(t){s(this,e);var n=I.merge(yw,t);this._id=n.id,this._targetUrl=n.getTargetUrl(),this._targetDocument=n.document||window.document,this._iframeElement=this._createIframeElement(this._targetDocument);var r=(n.nonRemoved||[]).concat(["#".concat(this._id)]).concat(bw);this._cleaner=new mw(this._targetDocument,r),this._iframeTargetPointer=n.targetId,this._wrapIframe=n.wrapIframe}return u(e,[{key:"putIntoIframe",value:function(){var e=this;return new Promise((function(t,n){var r=By(e._targetDocument);return e._iframeElement.style.visibility="hidden",e._callWhenIframeLoaded((function(){return e._iframeElement.style.visibility="",Fy(e._iframeElement.contentDocument,r),e._clearCurrentDom(),t({iframe:e._iframeElement})})),e._insertIframe()}))}},{key:"_clearCurrentDom",value:function(){return this._cleaner.clean()}},{key:"_createIframeElement",value:function(e){var t=e.createElement("iframe");return t.setAttribute("id",this._id),t}},{key:"_insertIframe",value:function(){var e;this._iframeElement.src=this._targetUrl,this._ensureBodyExists();var t=this._iframeSiblingElement();if(this._wrapIframe){var n=this._targetDocument.createElement("div");n.setAttribute("id","".concat(gw,"inner-page-wrapper")),n.appendChild(this._iframeElement),e=n}else e=this._iframeElement;t?this._targetDocument.body.insertBefore(e,this._iframeSiblingElement()):this._targetDocument.body.appendChild(e),this._iframeElement.contentWindow.location.href=this._targetUrl}},{key:"_iframeSiblingElement",value:function(){if(this._iframeTargetPointer)return this._targetDocument.getElementById(this._iframeTargetPointer)}},{key:"_callWhenIframeLoaded",value:function(e){return this._iframeElement.addEventListener("load",(function t(n){return n.target.removeEventListener("load",t),e()}))}},{key:"_ensureBodyExists",value:function(){if(!this._targetDocument.body){var e=this._targetDocument.createElement("body");return this._targetDocument.appendChild(e)}}}]),e}(),ww="sm-wrapped-page",Ew=function(){function e(t){var n=t.document,r=t.nonRemoved;s(this,e),this.wrap=this.wrap.bind(this),this.unwrap=this.unwrap.bind(this),this.document=n,this.nonRemoved=(r||[]).concat(["#".concat(this._id)]).concat(bw)}return u(e,[{key:"wrap",value:function(){var e=this._createWrappingDiv(),t=this.nonRemoved.join(", ");Wc(this.document.body.children).forEach((function(n){Gc(n,t)||Gc(n,"iframe")&&"none"===window.getComputedStyle(n).display||e.appendChild(n)}));var n=this.document.body.children[0];this.document.body.insertBefore(e,n)}},{key:"unwrap",value:function(){var e=this.document.getElementById(ww);e&&(Wc(e.children).forEach((function(t){e.parentNode.appendChild(t)})),e.parentNode.removeChild(e))}},{key:"_createWrappingDiv",value:function(){var e=this.document.createElement("div");return e.id=ww,e.className=ww,e}}]),e}(),Ow=u((function e(t){var n=t.media,r=t.medias;s(this,e),this.media=n,this.medias=r})),Sw=function(e,t){"iframe"===e?document.querySelector("#inner-page").contentWindow.location.assign(t):window.location.href=t},Tw=function(e){var t=e.volatileNotifications,n=e.visitorPageAdaption;return t.filter(I.both(I.propEq("site_id",sm.siteId),I.propEq("event","navigation_to_url"))).map(I.prop("payload")).subscribe(Sw.bind(this,n),zu.error.bind(zu,"Unable to navigate to url"))},kw=u((function e(t){var n=t.medraStream;s(this,e),this.stream=n.getWebMediaStream()})),Aw=function(){function e(t){var n=t.medraStream,r=t.connection;s(this,e),n.getWebMediaStream().getVideoTracks()[0].onended=function(){return r.stop()},this.stopSharing=function(){return r.stop(),null}}return u(e,[{key:"stopSharing",value:function(){}}]),e}(),xw=u((function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r}));xw.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Iw=u((function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r}));Iw.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Nw=u((function e(t){var n=t.onAccept,r=t.onDecline;s(this,e),this.accept=function(){return n().then((function(){return{}}))},this.decline=function(){r()}})),Mw=function(){return{mediaDevices:navigator.mediaDevices}},Cw=function(e){return"NotReadableError"===e.name||"NotFoundError"===e.name||"AbortError"===e.name},Rw=function(e){return"Permission denied by system"===e.message?new hf({cause:tf.SALEMOVE.DENIED_BY_SYSTEM}):new hf({cause:tf.SALEMOVE.CANCEL})},Pw=function(e){var t,n=e.conf,r=e.channelObservable,i=e.namespace,o=e.videoProvider;return Zu("Medra").map(I.prop("default")).map((function(e){return new e({webRTC:{iceServers:n.communications.webrtc_server,videoProvider:o}})})).flatMap((function(e){return r.do((function(){t&&(sm.logger.info("Stopping Medra connection due to new channel"),t.stop())})).flatMap((function(t){var n=t.channel;return el(e.connect(n,{namespace:i}))})).do((function(e){t=e}))}))},jw=function(){function e(t){var n=t.adapter,r=t.operatorScreenSharedObservable,i=t.visitorScreenSharedObservable,o=t.screenShareRequestedObservable;s(this,e),this.EVENTS={OPERATOR_STATE_UPDATE:"operator_state_update",VISITOR_STATE_UPDATE:"visitor_state_update",SCREEN_SHARING_REQUEST:"screen_sharing_request"};var a=I.fromPairs([[this.EVENTS.OPERATOR_STATE_UPDATE,r],[this.EVENTS.VISITOR_STATE_UPDATE,i],[this.EVENTS.SCREEN_SHARING_REQUEST,o]]);n.proxyAll(a),this.addBufferedEventListener=n.addEventListener,this.removeBufferedEventListener=n.removeEventListener}return u(e,null,[{key:"start",value:function(t){var n,r,i=t.conf,o=t.channelObservable,s=t.connectMedra,a=t.fromRxJs5,u=t.scheduler,c=t.videoProvider,l=t.isReestablishing,f=t.stats;a||(a=el),s||(s=Pw);var p=new Pu.Subscription,h=new Pu.Subject,d=new Pu.Subject;c||(c=function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:Mw()).mediaDevices;return{getStream:function(){return new Promise((function(r,i){t.next(new Nw({onAccept:function(){zu.info("Requesting screen capture");var t=e.statScreenShareUsage({stage:"capture",resource:"visitor_api.screen_sharing"}).attempted();return n.getDisplayMedia({video:!0}).then((function(e){r(e),zu.info("Screen capture successful"),t.succeeded()})).catch((function(e){return i(e),"NotAllowedError"===e.name?(zu.info("Screen capture permissions denied",e),t.failed("canceled"),Promise.reject(Rw(e))):Cw(e)?(zu.info("Screen capture failed due to no access to screen",e),t.failed("device-error"),Promise.reject(new hf({cause:tf.SALEMOVE.DEVICE_ACCESS_ERROR}))):"SecurityError"===e.name?(zu.info("Screen capture failed due to Permissions Policy",e),t.failed("permissions-policy"),Promise.reject(new hf({cause:tf.SALEMOVE.DENIED_BY_PERMISSIONS_POLICY}))):(t.failedUnknown(),Promise.reject(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR})))}))},onDecline:function(){sm.logger.info("Screen sharing request declined"),i({name:"NotAllowedError"})}}))}))}}}(f,d));var v=new Pu.Subject,b=v.switchMap((function(){return s({conf:i,channelObservable:o,namespace:"visitor-screensharing",videoProvider:c})})).publishReplay(1);if(p.add(b.connect()),v.next({}),b.switchMap((function(e){return a(e.communicationRequest).map((function(t){return{proposal:t,connection:e}}))})).subscribe((function(e){var t=e.proposal,n=e.connection,r=f.statScreenShareUsage({stage:"sharing",resource:"visitor_api.screen_sharing"}).attempted();return t.accept({video:{type:"browser"}}).then((function(e){var t=e.localVideoStream;r.succeeded(),sm.logger.info("Screen sharing succeeded"),h.next({connection:n,localVideoStream:t})})).catch((function(e){e&&e.cause===n.ERRORS.DENIED_BY_SYSTEM?(r.failed("canceled"),sm.logger.info("Screen sharing canceled")):e&&e.cause===n.ERRORS.DEVICE_ACCESS_ERROR?(r.failed("device_access_error"),sm.logger.warn("Screen sharing failed due to device access error",e)):(r.failedUnknown(),sm.logger.warn("Screen sharing failed",e))}))}),sm.logger.error.bind(sm.logger,"Failed to receive screen sharing request")),l){p.add(b.take(1).subscribe((function(e){return e.reestablish().then((function(t){var n=t.localVideoStream;if(n)return h.next({connection:e,localVideoStream:n})}))}),sm.logger.error.bind(sm.logger,"Failed to reestablish visitor screen")))}var m=new xw({status:xw.prototype.STATUSES.NOT_SHARING}),g=(n=s({conf:i,channelObservable:o,namespace:"operator-screensharing"}).switchMap((function(e){var t=a(e.communicationRequest).pipe(an((function(t){return Pu.Observable.from(t.accept({})).catch((function(t){return t&&t.cause===e.ERRORS.REMOTE_PARTICIPANT_ERROR?sm.logger.info("Failed to receive operator screen due to error on operator side",t):sm.logger.warn("Failed to receive operator screen",t),Pu.Observable.empty()}))})));return l?Pu.Observable.merge(Pu.Observable.fromPromise(e.reestablish()),t).filter((function(e){var t=e.remoteVideoStream;return!I.isNil(t)})):t})).do((function(){return sm.logger.info("Remote screen sharing stream received")})).flatMap((function(e){var t=e.remoteVideoStream,n=Pu.Observable.defer((function(){var e="playing"===t.getMediaState()?xw.prototype.STATUSES.SHARING:xw.prototype.STATUSES.NOT_SHARING;return Pu.Observable.of(new xw({screen:new kw({medraStream:t}),status:e}))})),r=a(t.observe(t.EVENTS.DISCONNECTED)).map((function(){return m}));return Pu.Observable.merge(n,r)}))).startWith.apply(n,w([m,u].filter(I.identity))),y=new Iw({status:Iw.prototype.STATUSES.NOT_SHARING}),_=null,E=(r=h.do((function(){return sm.logger.info("Screen sharing request accepted")})).switchMap((function(e){var t=e.localVideoStream,n=e.connection;_=new Aw({medraStream:t,connection:n});var r=Pu.Observable.of(new Iw({screen:_,status:Iw.prototype.STATUSES.SHARING})),i=a(t.observe(t.EVENTS.DISCONNECTED)).do((function(){return v.next({})})).map((function(){return y}));return Pu.Observable.merge(r,i)}))).startWith.apply(r,w([y,u].filter(I.identity))).share(),O=np();return{screenSharing:new e({adapter:O,operatorScreenSharedObservable:g,visitorScreenSharedObservable:E,screenShareRequestedObservable:d}),stopScreenSharing:function(){_&&_.stopSharing(),O.stop(),p.unsubscribe()}}}}]),e}(),Lw=u((function e(t){var n=t.id,r=t.properties;s(this,e),this.id=n,this.properties=r})),qw=function(){return"iframe"===sm.conf.visitor_app.visitor_page_adaption},Uw=function(){return qw()?document.getElementById("inner-page").contentWindow.document:document},Dw=function(e){try{var t=Uw();return qw()?t.body.querySelector(e):t.querySelector(e)}catch(e){return zu.info("Target element not found",{error:e}),null}},Vw="virtual_assistant_cobrowsing_cursor",Fw="virtual_assistant_cobrowsing_cursor_label",Bw=function(e){var t=e.cursorIdentifier,n=e.onRemove;if(!qw()){var r=Dw(t||"#"+Vw);if(r&&(r.parentElement.removeChild(r),n))return n()}},Hw=function(e,t){var n=Dw("#"+Vw);if(!n){var r=function(){var e=Uw().createElement("div");return e.setAttribute("id",Vw),e.style.display="none",e.style.opacity="0",e.style.position="absolute",e.style.zIndex="10",e.style.top="0",e.style.left="0",e.style.width="20px",e.style.height="20px",e.style.backgroundRepeat="no-repeat",e.style.backgroundImage="url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAARCAYAAADpPU2iAAAAAXNSR0IArs4c6QAAAiNJREFUKBV1kl9oUlEcx39eR21JEAwEHQQ9OKcr2mDoemgsfV5vSdFLqzEu9NSo6MHF8iUIevRBtJfyrdjbarVQF8un7ELWnKUiNzFw88+qqyL3evoe22LG/MGHe87vfL+/37nnHGprWpLtRSKROE9EAugdrVZL8ly+yhYX7zNN01rRaHQa6t6mRqPxaWraxSBi0dg6U1W1GQgEzvQ0wbApijc7Bm56tfqaIbfj9XpPYa4D3dFsNtPXb8z/M2CVRSIxpiiK7Ha7BzHvNsGQ/d8ADUsmP7NqtSrBYDjYQtDpdIf8ICOnc5JKpe2xWq0Wg2Fg38TFffuTg996/Tc5HA4qFn9MVCqVVaz183Vu0PPBYbG7WyO73UbfMtmpQqHwFJr+PuFvdOkFvZ4eLPkI90Ky/J0aikJDZvOlcql0gm8H8EMiWli4Tfl8npaXX9Ds7DVaW3uTbbfVejaXPappKplNpkHCRVUsVjsTBH3ngZR3yp0jttlsLBgMbqEO30oQBMBDgRjT37t7h95vbJAoih9WXq7knJPnKJVK0bBl2OrxeH5B+G6PNLXRgpf2+/2bSD43Go3hjwmp08U6YmOyLOeQHwMmMER4cSyXychcDB6DOVT/Mjp6umMKhZ4wn88nIn8ckPA2Erl1dnz8GcbbIAHWw+Hwo1AwRAPHDCRJErlcrivIG4EAyALmwRwYAUfAyXg8Hi0Wiq2vW+mfF2dmeMELwPAHu44LBYcnDWwAAAAASUVORK5CYII=')",e}(),i=function(e,t){var n=Uw().createElement("div");return n.setAttribute("id",Fw),n.style.display="inline-block",n.style.color="#ffffff",n.style.fontSize="13px",n.style.padding="2px 12px",n.style.margin="18px 0 0 14px",n.style.boxShadow="1px 1px 4px rgba(50, 50, 50, 0.75)",n.style.border="1px solid #ffffff",n.style.borderRadius="4px",n.style.backgroundColor="#232323",n.style.whiteSpace="nowrap",n.innerText=t,n}(0,t);r.appendChild(i),n=Uw().body.appendChild(r)}return n.style.display="block",Pu.Observable.of({cursor:n})},Ww=function(e){return function(t){var n=t.interval.value+1;e.style.left=function(e,t){return(t=e.cursorInitialPosLeft-e.cursorDistanceDiffLeft*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px",e.style.top=function(e,t){return(t=e.cursorInitialPosTop-e.cursorDistanceDiffTop*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px"}},Gw=function(e,t){var n=10*t;e.style.left=function(e,t){return(e+3*Math.cos(t*Math.PI/180)).toFixed(0)}(e.offsetLeft,n)+"px",e.style.top=function(e,t){return(e-3*Math.sin(t*Math.PI/180)).toFixed(0)}(e.offsetTop,n)+"px"},zw=function(e){return e||(e={moveCursorToPosition:Ww,moveFrequency:20}),function(t){var n,r,i,o=t.cursor.offsetLeft,s=t.cursor.offsetTop,a=(n=t.targetElement,r=n.getBoundingClientRect(),i=r.top+Uw().documentElement.scrollTop,{left:r.left+Uw().documentElement.scrollLeft+n.offsetWidth/2,top:i+n.offsetHeight/2}),u=o-a.left,c=s-a.top,l=Math.abs((u+c)/50).toFixed(0),f=l>0?l:1;return Pu.Observable.interval(e.moveFrequency).timeInterval().map((function(e){return{cursorInitialPosLeft:o,cursorInitialPosTop:s,cursorDistanceDiffLeft:u,cursorDistanceDiffTop:c,totalCircleSteps:l,interval:e}})).do(e.moveCursorToPosition(t.cursor)).skip(f-1).take(1).mapTo(t)}},Jw=function(e){return e||(e={moveCursorCirclePosition:Gw,circleFrequency:50}),function(t){return Pu.Observable.interval(e.circleFrequency).timeInterval().do((function(n){return e.moveCursorCirclePosition(t.cursor,n.value)})).skip(107).take(1).mapTo(t)}},Yw=function(e,t){e.style.opacity=t>=1?1:(parseFloat(t)+.1).toFixed(1)},Qw=function(e,t){t<=.1?(e.style.opacity=0,e.style.display="none"):e.style.opacity=(parseFloat(t)-.1).toFixed(1)},Kw=function(e,t,n){return Pu.Observable.interval(t.stepDuration).do((function(){var r=e.cursor.style.opacity;"in"===n&&t.fadeInStep(e.cursor,r),"out"===n&&t.fadeOutStep(e.cursor,r)})).skip(9).take(1).mapTo(e)},Xw=function(e){return e||(e={fadeInStep:Yw,stepDuration:20}),function(t){return Kw(t,e,"in")}},$w=function(e){return e||(e={fadeOutStep:Qw,stepDuration:120}),function(t){return Kw(t,e,"out")}},Zw=function(e){e.targetElement.click()},eE="custom_commands",tE=function(){var e=localStorage.getItem(eE);return e?JSON.parse(e):[]},nE=function(e){localStorage.setItem(eE,JSON.stringify(e))},rE=function(e){nE([].concat(w(tE()),[e]))},iE=function(e){nE(tE().filter((function(t){return t.id!==e.id})))},oE="virtual_assistant_cobrowsing",sE="point",aE="scroll",uE="click",cE="navigate",lE=[aE,sE,uE],fE=function(e){return e.targetElement.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},pE=function(e,t){e.operatorName;var n=e.operatorFormattedName;return function(e){var t,r,i=e.properties[oE];if(t=i.target,!((r=i.type)===cE?t&&t.length:I.contains(r,lE)?Boolean(Dw(t)):(zu.info("Invalid Virtual Assistant Cobrowsing action type",{type:r}),0)))return iE(e),Pu.Observable.of(e);switch(i.type){case sE:return Hw(0,n).map(I.assoc("targetElement",Dw(i.target))).do(fE).flatMap(Xw()).flatMap(zw()).flatMap(Jw()).flatMap($w()).do((function(){return iE(e)})).mapTo(e);case uE:return Hw(0,n).map(I.assoc("targetElement",Dw(i.target))).do(fE).flatMap(Xw()).flatMap(zw()).flatMap(Jw()).do((function(){return iE(e)})).do(Zw).flatMap($w()).mapTo(e);case aE:return Hw(0,n).map(I.assoc("targetElement",Dw(i.target))).do(fE).flatMap(Xw()).flatMap(zw()).do((function(){return iE(e)})).mapTo(e);case cE:return function(e){return qw()?document.getElementById("inner-page").contentWindow.location.assign(e):window.location.href=e,Pu.Observable.of({})}(i.target).do((function(){return iE(e)})).mapTo(e);default:throw new Error("Unknown action: ".concat(i.type))}}},hE="custom_command",dE=function(e){return I.has(oE,e.properties)},vE=u((function e(t){var n=this,r=t.media,i=t.medias,o=t.onAccept,a=t.onDecline,u=t.validateMedia;s(this,e),this.media=r,this.medias=i,u=u||aw;this.select=function(e,t){return u({options:t,availableMediaTypes:n.medias,availableOneWayMediaTypes:[],media:e}).then((function(){return function(e,t){return o({media:e,options:t})}(e,t)}))},this.decline=a})),bE=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),mE=function(e){var t=e.visitorId,r=e.engagementId,i=e.volatileNotifications,o=e.engagementStateObservable,s=e.wsProxy,a=e.apiTimeoutMilliseconds,u=e.stats,c=Lf({stats:u,protocol:"rest",failureTagProperty:"message",timeout:a,timeoutError:Pu.Observable.throw(bE)});return{mediaUpgradeRequestObservable:function(e,t){var n=I.propEq("event_type","engagement.media_upgrade_request"),r=I.pathEq(["media_upgrade_request","engagement_id"],e),i=I.pathEq(["media_upgrade_request","target"],"visitor"),o=I.compose(I.pick(["id","audio","video"]),I.prop("media_upgrade_request"));return t.filter(I.allPass([n,r,i])).map(o)}(r,i),mediaStateObservable:function(e){return e.filter(I.identity).map(I.prop("media")).distinctUntilChanged(I.equals)}(o),requestMediaUpgrade:function(e){var t=e.mediaUpgradeRequest;return c({resource:"media-upgrade-request",method:"create"},(function(){return s.request({method:"POST",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests"),payload:t,headers:lf}).catch((function(e){return mf(e,{allowedCauses:[tf.SALEMOVE.INVALID_INPUT,tf.SALEMOVE.NETWORK_TIMEOUT,tf.SALEMOVE.CONFLICT]})}))})).toPromise()},acceptUpgradeRequest:function(e,t){return c({resource:"media-upgrade-request",method:"accept"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:I.merge(t,{action:"accept"}),headers:lf}).catch((function(e){return mf(e,{allowedCauses:[tf.SALEMOVE.INVALID_INPUT,tf.SALEMOVE.NETWORK_TIMEOUT,tf.SALEMOVE.CONFLICT]})}))})).toPromise()},declineUpgradeRequest:function(e){return c({resource:"media-upgrade-request",method:"decline"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:{action:"decline"},headers:lf}).catch((function(e){return mf(e,{allowedCauses:[tf.SALEMOVE.INVALID_INPUT,tf.SALEMOVE.NETWORK_TIMEOUT,tf.SALEMOVE.CONFLICT]})}))})).toPromise()},removeVideo:function(){return c({resource:"engagement-participant",method:"remove video"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_video"},headers:lf}).catch(mf)})).map((function(){return{}})).toPromise()},removeAudio:function(){return c({resource:"engagement-participant",method:"remove audio"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_audio"},headers:lf}).catch(mf)})).map((function(){return{}})).toPromise()}}},gE=function(e){return/android/i.test(e.userAgent)},yE=Object.freeze({__proto__:null,screenCapturingSupported:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.navigator;return Boolean(I.path(["mediaDevices","getDisplayMedia"],e))&&!gE(e)}}),_E=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Pg,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:yE,n=e.canReceiveMedia()?["browser"]:[],r=e.canSendMedia()?["browser"]:[];return{canReceive:{video:n,audio:n.concat(["phone"])},canSend:{video:r,audio:r.concat(["phone"])},canShareScreen:t.screenCapturingSupported()&&e.canSendMedia()}},wE=function(e,t){return t.filter(Q_).map((function(t){var n=t.upgradeRequest,r=t.currentMediaState,i=function(e,t){if("two_way"===e.video)return{media:"video",medias:["video"]};if("two_way"===e.audio)return{media:"audio",medias:t.canSend.audio.map(Y_)};throw new Error("Tried to create upgrade offer for one way media")}(n,_E());return new vE(I.merge(i,{onAccept:function(t){return e.acceptUpgradeRequest(n,function(e,t){var n=(e.options?e.options.phoneNumber:void 0)||I.path(["audio","phone_number"],t),r=(e.options?e.options.phoneExtension:void 0)||I.path(["audio","phone_extension"],t);return{audio_type:"video"===e.media?I.path(["audio","type"],t)||"browser":"phone"===e.media?"phone":"browser",phone_number:n,phone_extension:r}}(t,r)).then(I.always({}))},onDecline:function(){return e.declineUpgradeRequest(n).then(I.always({}))}}))})).share()},EE=function(e){var t,n=e.commsApi||mE(I.pick(["engagementId","visitorId","volatileNotifications","engagementStateObservable","wsProxy","apiTimeoutMilliseconds","stats"],e)),r=new Pu.Subscription,i=n.mediaUpgradeRequestObservable.switchMap((t=e.channelObservable,function(e){return t.take(1).do((function(t){return t.channel.emit("comms:media_upgrade_request:ack",{id:e.id})})).mapTo(e)})).withLatestFrom(n.mediaStateObservable).map(I.zipObj(["upgradeRequest","currentMediaState"])).share();r.add(function(e,t){return t.filter(I.complement(Q_)).do((function(e){var t=e.upgradeRequest;return zu.info("Accepting media request automatically",{upgrade_request:t})})).switchMap((function(t){var n=t.upgradeRequest,r=t.currentMediaState;return e.acceptUpgradeRequest(n,{audio_type:I.path(["audio","type"],r),phone_number:I.path(["audio","phone_number"],r),phone_extension:I.path(["audio","phone_extension"],r)})})).catch((function(){return Pu.Observable.empty()})).subscribe((function(){}))}(n,i));return r.add(ec.vent.observable(ec.MSG.ENGAGEMENT_REMOVE_AUDIO).subscribe(n.removeAudio,zu.error.bind(zu,"Error removing visitor's audio"))),{removeVideo:n.removeVideo.bind(n),mediaUpgradeOffers:wE(n,i),mediaStateObservable:n.mediaStateObservable,requestMediaUpgrade:function(e){return n.mediaStateObservable.take(1).switchMap((function(t){var r=function(e){var t=e.options,n=e.currentMediaState,r=I.path(["audio","direction"],n),i=I.path(["video","direction"],n),o=t.audio?K_:null,s=t.video?t.video:null,a=$_(o,r),u=$_(s,i),c=I.path(["audio","phone_number"],n)||t.phoneNumber||null,l=I.path(["audio","phone_extension"],n)||t.phoneExtension||null;return{audio:a,video:u,audio_type:I.path(["audio","type"],n)||t.audio||null,phone_number:c,phone_extension:l}}({options:e,currentMediaState:t});return n.requestMediaUpgrade({mediaUpgradeRequest:r})})).toPromise().then(I.always({}))},stop:function(){r.unsubscribe()}}},OE=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),SE=function(e){return e instanceof DOMException?vf(e):e instanceof hf?e:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(0===e)return new hf({cause:tf.SALEMOVE.CONNECTION_LOST});var o=I.equals(e,404)?tf.SALEMOVE.RESOURCE_NOT_FOUND:I.contains(e,sf)?tf.SALEMOVE.INVALID_INPUT:I.equals(e,429)?tf.SALEMOVE.TOO_MANY_REQUESTS:401===e||403===e?tf.SALEMOVE.FORBIDDEN:(zu.warn("An INTERNAL_ERROR error from XHR occurred. Can we expose this error as non-internal?",i({status:e,message:n,responseText:t},r)),tf.SALEMOVE.INTERNAL_ERROR),s=function(){try{return JSON.parse(t).message}catch(e){}};return n||(n=t?s():void 0),new hf(n?{cause:o,message:n}:{cause:o})}(e.status,e.response&&e.response.text&&e.response.text(),e.response?e.response.message:void 0,e)},TE=function(){function e(t,n){var r=this,i=t.id,o=t.securityScanningRequired,a=t.url;if(s(this,e),this.id=i,this.securityScanningRequired=o,this.url=a,this.securityScanningRequired){var u=I.pathEq(["security_scan_result","file_id"],this.id);this.scanResultObservable=n.find(u).map(I.path(["security_scan_result","result"])).map((function(e){return{result:e,file:r}}))}}return u(e,[{key:"getScanResult",value:function(){return this.securityScanningRequired?this.scanResultObservable.toPromise():Promise.reject("Security scanning is not required")}}]),e}(),kE=function(e,t,n,r,i){var o=n.onUploadProgress,s=n.getRequestHeaders,a=new FormData;a.append("content",t),a.append("site_id",sm.siteId);var u=Gy(e?"/engagements/".concat(e,"/files"):"/messaging/files");return I.contains(t.type,i)?t.size>25e6?Pu.Observable.throw(new hf({cause:tf.SALEMOVE.FILE_TOO_LARGE,message:"File exceeds the maximum file size"})):function(e){var t=e.method,n=e.url,r=e.payload,i=e.onUploadProgress,o=e.getRequestHeaders;return Wf({method:t,url:n,payload:r,responseType:"json",onUploadProgress:i,getRequestHeaders:o})}({url:u,method:"POST",payload:a,getRequestHeaders:s,onUploadProgress:o}).map((function(e){var t=e.response;return new TE({id:t.file_id,securityScanningRequired:t.security_scanning_required,url:u},r)})).catch((function(e){return Pu.Observable.throw(SE(e))})):Pu.Observable.throw(new hf({cause:tf.SALEMOVE.FILE_CONTENT_TYPE_NOT_ALLOWED,message:"File content type is not allowed"}))},AE=["engagement","engagements"],xE=["engagement","requests"],IE=["visitor","browser_tab_id"],NE=function(e){return I.any(I.propEq("id",sm.siteId),e.transferrable_sites)},ME=function(e){return e&&"transferring"===e.status&&e.capabilities.text},CE=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=void 0!==t.includeAsyncTransfer&&t.includeAsyncTransfer,r=I.pathOr([],AE,e);try{var i=I.find(NE,r);return ME(i)?n?i:void 0:i}catch(t){return void zu.error("Engagement was undefined in internalVisitorState",{internalVisitorState:e,engagements:r})}},RE=function(e){return NE(e)&&I.path(IE,e)===sm.tabId&&!ME(e)},PE=I.compose(I.nth(0),I.filter(RE),I.pathOr([],AE)),jE=I.compose(I.nth(0),I.filter(I.complement(RE)),I.pathOr([],AE)),LE=I.compose(I.nth(0),I.filter(I.allPass([NE,I.propEq("outcome",null),I.propEq("type","reactive")])),I.pathOr([],xE)),qE=["visitor_authenticated","visitor_unauthenticated"],UE=function(){function e(t){var n=t.iframe;s(this,e),this.iframe=n}return u(e,[{key:"deframe",value:function(){ec.vent.trigger("visit:restore_url")}}]),e}(),DE=u((function e(t){var n=t.unwrap;s(this,e),this.unwrap=n})),VE=u((function e(){s(this,e),this.responsePromise=Pu.Observable.merge(ec.vent.observable(ec.MSG.ALLOW_STREAM).map(I.always("allowed")),ec.vent.observable(ec.MSG.DENY_STREAM).map(I.always("denied"))).take(1).toPromise()})),FE=u((function e(t){var n=t.asynchronous;s(this,e),this.asynchronous=n})),BE=u((function e(t){var n=t.status,r=t.authenticated,i=t.isAsyncTransfer;s(this,e),this.status=n,this.authenticated=r,this.transfer="transferring"===n?new FE({asynchronous:i}):{}}));BE.prototype.STATUSES={ENGAGED:"engaged",TRANSFERRING:"transferring"};var HE=u((function e(t){var n=t.text;s(this,e),this.text=n})),WE=function(){function e(t){var n=this;s(this,e),this.startSalemoveViews=this.startSalemoveViews.bind(this);var r=t.engagementId,i=t.subEngagementId,a=t.startingMedia,u=t.type,c=t.isReestablishing,l=t.chat,f=t.stopChat,p=t.webRtcMode,h=t.enabledMediaLevel,d=t.channelObservable,v=t.operator,b=t.operatorFocusObservable,m=t.communicationWidget,g=t.createEngagementObservable,y=t.mediaStateObservable,_=t.backend,w=t.platform,E=t.startScreenSharing,O=t.stateObservable,S=t.statsClient,T=t.entrypoint,k=t.volatileNotifications,A=t.statusObservable,x=t.comms,N=t.events,M=t.surveyApi,C=t.getRequestHeaders,R=t.siteVisitorNotifications,P=t.createdAt,j=t.cobrowser;this.engagementId=r,this.chat=l,this.mediaState=null,this.isReestablishing=c,this.createdAt=P,this.subEngagementId=i,this.startingMedia=a,this.type=u,this.operator=v,this.cobrowser=j,this.allowFileSending=sm.conf.communications.allow_file_sending,this.allowedFileContentTypes=sm.conf.communications.allowed_file_content_types;var L=E({conf:sm.conf,channelObservable:d,isReestablishing:this.isReestablishing,stats:S}),q=L.screenSharing,U=L.stopScreenSharing;this.screenSharing=q;var D=new Pu.Subscription,V=t.engagementEndObservable.map((function(e){return"object"!==o(e)&&null!==e?{}:I.pick(n.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS,e)})).take(1);y=y.publishReplay(1).refCount(),b=b.map((function(e){return"chat"===e?n.FOCUS_TARGETS.CHAT:"cobrowse"===e?n.FOCUS_TARGETS.COBROWSER:(zu.error("Unexpected focus target!",e),"")}));var F=ec.vent.observable(ec.MSG.PUBLIC.ENGAGEMENT_MEDIA_UPGRADE_REQUEST).map(I.construct(Ow)),B=ec.vent.observable(ec.MSG.WILL_ASK_MEDIA_PERMISSION).map(I.construct(VE));c||localStorage.removeItem(eE);var H=function(e){return e.pipe(wn(I.propEq("event",hE)),kt((function(e){var t=e.payload,n=e.custom_command_id;return I.construct(Lw)({properties:t,id:n})})),wn((function(e){return I.not(dE(e))})),fi(I.prop("id")),es((function(e){return zu.info("Custom Command: received",{custom_command_id:e.id})})))}(k),W=function(e){var t=Pu.Observable.from(tE()),n=e.pipe(wn(I.propEq("event",hE)),kt((function(e){var t=e.payload,n=e.custom_command_id;return I.construct(Lw)({properties:t,id:n})})),wn((function(e){return dE(e)})),fi(I.prop("id")),es((function(e){return zu.info("Virtual CoBrowsing Command: received",{custom_command_id:e.id})})),es(rE));return t.pipe(Ki(n),es((function(e){return zu.info("Virtual CoBrowsing Command: processing",{custom_command_id:e.id})})))}(k).concatMap(pE({operatorName:v.name,operatorFormattedName:v.formattedName})).subscribe((function(){}),zu.error),G=tp(),z=O.distinctUntilChanged(I.equals,(function(e){return e.capabilities})).map((function(e){return new HE(e.capabilities)})),J=I.fromPairs([[this.EVENTS.END,V],[this.EVENTS.STATE_CHANGE,O.map((function(e){return{status:e.status,authenticated:I.propOr(!1,"authenticated")(e.visitor),isAsyncTransfer:ME(e)}})).map(I.construct(BE))],[this.EVENTS.CAPABILITIES,z],[this.EVENTS.MEDIA_UPGRADE_OFFER,x.mediaUpgradeOffers],[this.EVENTS.FOCUS,b],[this.EVENTS.MEDIA_STATE_CHANGE,y],[this.EVENTS.MEDIA_PERMISSION_REQUEST,B],[this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST,F],[this.EVENTS.CUSTOM_COMMAND,H]]);G.proxyAll(J),this.addEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.addUnbufferedEventListener(J_.prototype.EVENTS.COBROWSING_REQUEST,t):G.addEventListener(e,t)},this.removeEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.removeUnbufferedEventListener(J_.prototype.EVENTS.COBROWSING_REQUEST,t):G.removeEventListener(e,t)},this.recordEvent=function(e){return N.recordEvent(e)};var Y=I.propEq("event_type","engagement.files.security_scan_result"),Q=R.filter(Y).publishReplay(this.SCAN_EVENT_REPLAY_COUNT);D.add(Q.connect()),this.uploadFile=function(e,t){t||(t={});var n=t.onUploadProgress;return kE(this.engagementId,e,{onUploadProgress:n,getRequestHeaders:C},Q,this.allowedFileContentTypes).toPromise()},this.getChatTranscript=function(){return _.chatTranscript().then((function(e){return Promise.resolve(I.map((function(e){var t=e.id,n=e.message,r=e.sender,i=e.attachment,o=e.metadata,s=e.created_at,a=r.type;return"operator"===a?new r_({id:t,content:n,attachment:i,metadata:o,created_at:s,sender:r}):"visitor"===a?new t_({id:t,content:n,status:t_.prototype.STATUSES.DELIVERED,attachment:i,created_at:s}):null}),e))}))},this.observable=function(e){return e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.observable(J_.prototype.EVENTS.COBROWSING_REQUEST):G.observable(e)};var K=function(){return setTimeout((function(){return G.stop()}))};V.subscribe((function(){}),K,K),this.iframePage=function(e){e||(e={});var t=e.keptElementSelectors;zu.info("Engagement: Iframe page started");var n=new _w({id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:t||[]});return sm.visitorPageNotifierSubscription&&sm.visitorPageNotifierSubscription.unsubscribe(),sm.trackerSubscription.unsubscribe(),sm.cobraSubscription.unsubscribe(),n.putIntoIframe().then((function(e){var t=e.iframe;return zu.info("Engagement: Iframe page finished"),Promise.resolve(new UE({iframe:t}))}))},this.wrapPage=function(e){e||(e={});var t=e.keptElementSelectors;zu.info("Engagement: Wrap page started");var n=new Ew({document:window.document,nonRemoved:t||[]});return n.wrap(),zu.info("Engagement: Wrap page finished"),Promise.resolve(new DE({unwrap:n.unwrap}))};var X=ew({stateObservable:O}).share();D.add(Tw({volatileNotifications:k,visitorPageAdaption:sm.conf.visitor_app.visitor_page_adaption})),this.getSurvey=function(){return M.fetchSurvey()};var $=G.eventWithoutListenerObservable(this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST);D.add($.subscribe((function(){console.warn("No listener set for the Engagement WIDGET_MEDIA_UPGRADE_REQUEST event. See 'WidgetMediaUpgradeRequest' documentation for how to add the listener to enable media upgrades from the sm-engaged-visitor widget."),zu.warn("Listener is not set for WIDGET_MEDIA_UPGRADE_REQUEST")}),zu.error));D.add(y.subscribe((function(e){n.mediaState=e}),zu.error));var Z=g({engagement:this,transfers:X,channelObservable:d,webRtcMode:p,statusObservable:A});m.start(Z),this.communicationWidget=m;var ee=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return m.stop({mediaContinues:Boolean(e.isEngagementRestart)}),x.stop(),f(),U(),Bw({}),zu.info("Triggering ENGAGEMENT_END event"),ec.vent.trigger(ec.MSG.PUBLIC.ENGAGEMENT_END,n),D.unsubscribe()};this.start=function(){var e;n.isReestablishing||(e=["action:reach","stage:establish-engagement"],S.increment("engagement.flow",["entrypoint:".concat(T)].concat(e)));var t,r=ec.vent.trigger.bind(ec.vent,ec.MSG.ENGAGEMENT_TRANSFERRED);t={engagementObservable:Z},ec.reqres.setHandler("get:engagement_observables",I.always(t)),D.add(X.subscribe((function(e){return function(e){n.operator=Xg({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:{url:e.operatorPicture},mediaType:e.operatorMedia,webRtcMode:p,enabledMediaType:h})}(e),r(e)}),zu.error)),D.add(V.subscribe(ee,zu.error)),ec.vent.trigger(ec.MSG.PUBLIC.ENGAGEMENT_START,n)},this.upgrade=function(e){if(w===cf)return Promise.reject(new hf({cause:tf.SALEMOVE.NOT_SUPPORTED,message:"Unsupported functionality for OmniBrowse engagement"}));var t=n.operator.state.media,r=n.operator.state.oneWayMedias,i=sm.conf.communications.allow_upgrade_requests,o=n.mediaState.operator.media,s="phone"===o?"audio":o;return zu.info("Initiating media upgrade",{audio_type:e.audio,video_type:e.video,caller:(e?e.caller:void 0)||"client_integrator"}),uw({options:e,availableMediaTypes:t,availableOneWayMediaTypes:r,visitorUpgradesAllowed:i,highestAllowedMediaType:s}).then((function(){return x.requestMediaUpgrade(e)}))},this.end=function(){return ee(),_.end().then(I.always({})).catch((function(e){return 422===(e?e.status:void 0)?(zu.warn("Engagement already ended",{error:e,engagement_id:n.engagementId}),Promise.reject(new hf({cause:tf.SALEMOVE.CONFLICT}))):I.isNil(e.status)?(zu.warn("Engagement end failed. No connection",{error:e,engagement_id:n.engagementId}),Promise.reject(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}))):e.status>500&&e.status<=504?(zu.warn("Engagement end failed. Service unavailable",{error:e,engagement_id:n.engagementId}),Promise.reject(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}))):(zu.error("Engagement end failed",{error:e,engagement_id:n.engagementId}),Promise.reject(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR})))}))};var te=new Pu.Subject;this.notifyOfFocusChange=function(e){return te.next(e)};var ne=te.asObservable().distinctUntilChanged().withLatestFrom(d,(function(e,t){return{target:e,channel:t.channel}})).subscribe((function(e){var t=e.target;return e.channel.emitAll("visitor:focus_changed",t)}),zu.error);D.add(ne),D.add(W)}return u(e,[{key:"start",value:function(){}},{key:"upgrade",value:function(e){return null}},{key:"iframePage",value:function(e){return null}},{key:"wrapPage",value:function(e){}},{key:"getSurvey",value:function(){return null}},{key:"end",value:function(){return null}},{key:"notifyOfFocusChange",value:function(){return null}},{key:"startSalemoveViews",value:function(){zu.error("Private/undocumented Engagement#startSalemoveViews was used"),console.error("Usage of Engagement#startSalemoveViews is not supported")}},{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}},{key:"recordEvent",value:function(e){return null}},{key:"uploadFile",value:function(e,t){return null}},{key:"getChatTranscript",value:function(){return null}}],[{key:"create",value:function(t){var n=t.engagementId,r=t.subEngagementId,i=t.startingMedia,o=t.mediaState,s=t.type,a=t.isReestablishing,u=t.initialChatHistoryObservable,c=t.operator,l=t.statsClient,f=t.cobra,p=t.channelObservable,h=t.platform,d=t.engagementApi,v=t.connectionStatusObservable,b=t.getRequestHeaders,m=t.internalVisitorStateObservable,g=t.entrypoint,y=t.volatileNotifications,_=t.statusObservable,w=t.pubsub,E=t.wsProxy,O=t.createdAt,S=m.map(I.compose(I.find(I.propEq("id",n)),I.pathOr([],["engagement","engagements"]))),T=S.filter(I.identity).take(1),k=T.flatMap((function(){return S.filter(I.complement(I.identity)).switchMap((function(){return function(e){var t=e.engagementId,n=e.internalVisitorStateObservable,r=e.logger;return n.take(1).map((function(e){var n=I.pathOr([],["engagement","ended_engagements"],e),i=I.find(I.propEq("id",t),n),o=Boolean(i&&I.contains(i.end_reason,qE));return o&&r.info("Received engagement end signal with authentication end_reason. Initiating engagement restart",{engagement_id:t}),{isEngagementRestart:o}}))}({engagementId:n,internalVisitorStateObservable:m,logger:zu})})).take(1)})),A=ec.vent.observable("engagement:prepare_for_restart").map(I.always({isEngagementRestart:!0})),x=Pu.Observable.merge(k,A).take(1),N=p.switchMap((function(e){return e.channel.observable("visitor:state_changed")})),M=T.map(I.prop("transferrable_sites")),C=Lu(),R=M.flatMap((function(e){var t=e.map((function(e){return e.id}));return w.joinSiteVisitorNotifications(C,t)})),P=sm.conf.engagement.api_timeout_milliseconds||nf,j=EE({visitorId:Lu(),engagementId:n,volatileNotifications:y,engagementStateObservable:S,apiTimeoutMilliseconds:P,wsProxy:E,stats:l,channelObservable:p});zu.info("Starting medra communication controller");var L=ec.request("comms:create_controller",{requestHeaders:b(),visitorAppConf:sm.conf.visitor_app,statsClient:l,volatileNotifications:y,comms:j,pubsub:w,localCapabilities:_E(),onMediaUpgrade:function(e){return d.createMediaUpgrade(e).subscribe(zu.log.bind(zu,"Media upgrade successfully created"),zu.warn.bind(zu,"Failed to create media upgrade"))}}),q=function(e){var t=e.mediaState,n=e.mediaStateChanges,r=t?ge.of(t):ge.of(new cw({visitor:{media:"text",audioMuted:!1,videoMuted:!1},operator:{media:"text",audioMuted:!1,videoMuted:!1}}));return n.pipe(Ki(r),kt(I.construct(cw)))}({mediaState:o,mediaStateChanges:L.mediaStateChanges()}),U=Pu.Observable.merge(u,Yy({engagementId:n,connectionStatusObservable:v})),D=sm.conf.masking_regular_expressions;D||(zu.error("Failed to fetch masking_regular_expressions for site",{site_id:sm.siteId,visitor_id:Lu()}),D=[]);var V=B_.create({chatHistoryObservable:U,engagementEndObservable:x,engagementId:n,statsClient:l,getRequestHeaders:b,siteVisitorNotifications:R,maskingRegularExpressions:D}),F=V.chat,B=V.stopChat,H={end:function(){return d.endEngagement({engagementId:n}).toPromise()},chatTranscript:function(){return d.getChatTranscript(n).map(I.filter((function(e){var t=e.sender.type;return I.contains(t,["operator","visitor"])}))).toPromise()}},W=Ug(),G=sm.conf.communications.enabled_media_level,z=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=Lf({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:Pu.Observable.throw(OE)});return{recordEvent:function(e){return o({resource:"record-event",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/events"),payload:e,headers:lf}).catch(mf,{allowedCauses:[tf.SALEMOVE.INVALID_INPUT,tf.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}}({engagementId:n,wsProxy:E,apiTimeoutMilliseconds:P,stats:l}),J=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=Lf({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:Pu.Observable.throw(hw)}),s=function(e){switch(e.status){case 409:return zu.warn("Survey was not accepted because at least some answers were not unique for engagement. This could happen when survey was answered twice for the same engagement.",{engagement_id:t}),Pu.Observable.throw(new hf({cause:tf.SALEMOVE.CONFLICT}));default:return mf(e)}},a=function(e){var r=e.surveyId,i=e.answers;return o({resource:"survey-answers-post",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/surveys/").concat(r,"/answers"),payload:{engagement_id:t,answers:i},headers:lf}).catch(s)})).toPromise()};return{fetchSurvey:function(){return o({resource:"survey-request",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/survey"),payload:null,headers:lf}).catch(mf)})).map((function(e){return new pw(e,a)})).toPromise()},saveSurveyAnswers:a}}({engagementId:n,wsProxy:E,apiTimeoutMilliseconds:P,stats:l}),Y=new J_({cobra:f,operator:c,channelObservable:p});return i&&(c=function(e,t){var n=e.media,r=e.enabledMediaType,i=e.webRtcMode;if(I.indexOf(n,t.state.medias)>-1)return t;var o=Vg[n];return I.compose(Jg({enabledMediaType:r,webRtcMode:i}),I.set(Bg,o),I.set(Fg,o))(t)}({media:i,enabledMediaType:G,webRtcMode:W},c)),new e({engagementId:n,subEngagementId:r,engagementEndObservable:x,startingMedia:i,type:s,isReestablishing:a,chatHistoryObservable:U,chat:F,stopChat:B,webRtcMode:W,enabledMediaLevel:G,channelObservable:p,operator:c,operatorFocusObservable:N,communicationWidget:L,createEngagementObservable:tw,mediaStateObservable:q,cobra:f,backend:H,platform:h,startScreenSharing:jw.start,stateObservable:S.filter(I.identity).distinctUntilChanged(I.equals),statsClient:l,entrypoint:g,volatileNotifications:y,statusObservable:_,comms:j,events:z,surveyApi:J,getRequestHeaders:b,siteVisitorNotifications:R,createdAt:O,cobrowser:Y})}}]),e}();WE.prototype.SCAN_EVENT_REPLAY_COUNT=100,WE.prototype.EVENTS={END:"end",STATE_CHANGE:"state_change",CAPABILITIES:"capabilities",MEDIA_UPGRADE_OFFER:"media_upgrade_offer",FOCUS:"focus",MEDIA_STATE_CHANGE:"media_state_change",COBROWSING_REQUEST:"cobrowsing_request",MEDIA_PERMISSION_REQUEST:"media_permission_request",WIDGET_MEDIA_UPGRADE_REQUEST:"widget_media_upgrade_request",CUSTOM_COMMAND:"custom_command"},WE.prototype.ENGAGEMENT_END_EVENT_PAYLOAD_KEYS=["isEngagementRestart"],WE.prototype.FOCUS_TARGETS={CHAT:"chat",COBROWSER:"cobrowse"},WE.prototype.MEDIA_TYPES={TEXT:"text",AUDIO:"audio",PHONE:"phone",VIDEO:"video"};var GE=function(e){var t,n,r=e.api,i=e.conf,o=e.operatorsObservable,s=e.media,a=e.options,u=e.statsClient,c=e.cobraObservable,l=e.channelObservable,f=e.engagementApi,p=e.webRtcMode,h=e.enabledMediaLevel,d=e.connectionStatusObservable,v=e.getRequestHeaders,b=e.internalVisitorStateObservable,m=e.volatileNotifications,g=e.statusObservable,y=e.pubsub,_=e.wsProxy,w=e.dynamicImport,E=new Pu.AsyncSubject,O=$y({media:s,mediaOptions:a,mediaValidation:aw,api:r,notifyOfTimeout:ec.vent.trigger.bind(ec.vent,ec.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT),operatorsObservable:o,engagementCoreObservable:w("Comms"),cobraObservable:c,channelObservable:l,serverResponseTimeout:nf,communicationLib:i.communications.lib,engagementApi:f,webRtcMode:p,enabledMediaLevel:h,statsClient:u}),S=O.requestObservable,T=O.resultObservable,k=nl(E),A=T.merge(k).take(1).map((function(e){return I.merge(e,{statsClient:u,connectionStatusObservable:d,getRequestHeaders:v,internalVisitorStateObservable:b,volatileNotifications:m,statusObservable:g,pubsub:y,wsProxy:_})})).map(WE.create).do(I.invoker(0,"start")).catch(bf);return{operatorObservable:(t=S,n=k,t.pipe(kt(I.prop("operator")),Ki(n),wi(1))).catch(bf),engagementObservable:A,cancelEngagementRequest:function(){return function(e){var t=e.api,n=e.requestObservable,r=e.resultErrorSubject,i=e.statsClient;return n.catch((function(){return Pu.Observable.of({requestNotCreated:!0})})).flatMap((function(e){var n=e.engagementRequestId;return e.requestNotCreated?Pu.Observable.of({}):t.cancel({id:n}).do((function(){return r.next(new hf({cause:tf.SALEMOVE.CANCEL}))})).do((function(){return i.increment("engagement.flow",["entrypoint:reactive-request","action:end","stage:requested","expected:true","reason:cancel"])}))}))}({statsClient:u,api:r,requestObservable:S,resultErrorSubject:E}).toPromise()},engagementRequestTimeout:1e3*i.engagement.reactive_call_timeout}},zE=u((function e(t){var n=t.timeout,r=t.engagementPromise,i=t.cancel,o=t.operatorPromise;s(this,e),this.timeout=n,this.engagementPromise=r,this.cancel=i,this.operatorPromise=o})),JE=function(e){l(n,e);var t=m(n);function n(){var e;return s(this,n),(e=t.call(this))._currentSubscription=e_.Subscription.EMPTY,e}return u(n,[{key:"add",value:function(e){if(!this.closed)return"function"==typeof e&&(e=new e_.Subscription(e)),this._currentSubscription&&(this.remove(this._currentSubscription),this._currentSubscription.unsubscribe(),this._currentSubscription=null),y(f(n.prototype),"add",this).call(this,this._currentSubscription=e),this}}]),n}(e_.Subscription),YE=u((function e(t,n){s(this,e),this.code=t,this.validDuration=n})),QE=function(){function e(t){s(this,e);var n=t.incomingEngagementRequestObservable,r=t.setOmnibrowseReestablishHandler,i=t.statsClient,o=t.wsProxy,a=new JE,u=n.filter(I.propEq("platform",cf)).map(I.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){return a.add(u.subscribe(e,zu.error))},this.setEngagementReestablishHandler=r,this.getVisitorCode=function(){return Lf({stats:i,protocol:"rest",failureTagProperty:"error",timeout:nf,timeoutError:Pu.Observable.throw(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}))})({resource:"omnibrowse",method:"get"},(function(){return o.request({method:"GET",url:"".concat(sm.conf.api_url,"/omnibrowse/sites/").concat(Vu(),"/visitor_code/").concat(Lu()),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).map((function(e){var t=Date.parse(e.expires_at)-new Date;return new YE(e.code,t)})).catch(I.compose(Pu.Observable.throw,I.unless(I.is(hf),I.always(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR}))))).do(null,(function(e){return zu.warn("Fetching visitor code failed",{site_id:sm.siteId,err:e})})).toPromise()}}return u(e,[{key:"setIncomingEngagementRequestHandler",value:function(e){}},{key:"setEngagementReestablishHandler",value:function(e){}},{key:"getVisitorCode",value:function(){return null}}]),e}(),KE=u((function e(t){var n=t.text,r=t.noOperatorsOnlineText,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o})),XE=u((function e(t){s(this,e),this.duration=t})),$E=u((function e(t){var n=t.verticalOffset,r=t.horizontalOffset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r})),ZE=u((function e(t){s(this,e),this.text=t})),eO=u((function e(t,n){s(this,e),this.text=t,this.duration=n})),tO=u((function e(t){var n=t.operatorListReady,r=t.isOmniqEnabled,i=t.queueStateReady,o=t.routingObservable;s(this,e);var a=function(e){return r?e.flatMap((function(e){return Pu.Observable.combineLatest(o,i).take(1).mapTo(e)})):e.flatMap((function(e){return n.mapTo(e)}))},u=ec.vent.observable("reactive_bar:enable").map(I.always({})),c=ec.vent.observable("reactive_bar:disable").map(I.always({})),l=ec.vent.observable("reactive_bar:set_position").map((function(e){return new $E(e)})),f=ec.vent.observable("trigger_expand_reactive").map((function(e){return new XE(e.duration)})),p=ec.vent.observable("trigger_media_selection").map((function(e){return new ZE(e.text)})),h=ec.vent.observable("trigger_reactive_callout").map((function(e){return new KE({text:e.text,noOperatorsOnlineText:e.noOperatorsOnlineText,duration:e.duration,priority:e.priority})})),d=ec.vent.observable("show_engagement_invitation").map((function(e){return new eO(e.text,e.duration)})),v=I.fromPairs([[this.EVENTS.REACTIVE_ENABLE,u],[this.EVENTS.REACTIVE_DISABLE,c],[this.EVENTS.REACTIVE_SET_POSITION,l],[this.EVENTS.REACTIVE_EXPAND,a(f)],[this.EVENTS.MEDIA_SELECTION_START,a(p)],[this.EVENTS.REACTIVE_CALLOUT_START,a(h)],[this.EVENTS.ENGAGEMENT_INVITATION_SHOW,a(d)]]),b=tp();b.proxyAll(v);var m=np();m.proxyAll(v),this.addUnbufferedEventListener=b.addEventListener,this.removeUnbufferedEventListener=b.removeEventListener,this.addBufferedEventListener=m.addEventListener,this.removeBufferedEventListener=m.removeEventListener,this.observable=function(e){return b.observable(e)},this.bufferedObservable=function(e){return m.observable(e)}}));tO.prototype.EVENTS={REACTIVE_ENABLE:"overseer:reactive_enable",REACTIVE_DISABLE:"overseer:reactive_disable",REACTIVE_SET_POSITION:"overseer:reactive_set_position",REACTIVE_EXPAND:"overseer:reactive_expand",MEDIA_SELECTION_START:"overseer:media_selection_start",REACTIVE_CALLOUT_START:"overseer:reactive_callout_start",ENGAGEMENT_INVITATION_SHOW:"overseer:engagement_invitation_show"};var nO,rO=function(){function e(){s(this,e),this.EVENTS={ENGAGEMENT_REQUEST:"omnicall:engagement_request",PHONE_NUMBER_AVAILABLE:"omnicall:phone_number_available"};var t=I.fromPairs([[this.EVENTS.ENGAGEMENT_REQUEST,Pu.Observable.never()],[this.EVENTS.PHONE_NUMBER_AVAILABLE,Pu.Observable.never()]]),n=tp();n.proxyAll(t),this.addEventListener=n.addEventListener,this.removeEventListener=n.removeEventListener,this.observable=function(e){return t[e]}}return u(e,[{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}}]),e}(),iO=u((function e(){s(this,e),this.url=sm.conf.visitor_app.site_logo.url})),oO=function(){function e(){s(this,e),this.visibleOperatorCount=sm.conf.visitor_app.reactive_tab.visible_operator_count,this.backColor=sm.conf.visitor_app.reactive_tab.back_color,this.fontSize=sm.conf.visitor_app.reactive_tab.font_size,this.format=sm.conf.visitor_app.reactive_tab.format,this.frontColor=sm.conf.visitor_app.reactive_tab.front_color,this.iconType=this._iconClassToType(sm.conf.visitor_app.reactive_tab.icon_class),this.placement=sm.conf.visitor_app.reactive_tab.placement,this.size=sm.conf.visitor_app.reactive_tab.size,this.text=sm.conf.visitor_app.reactive_tab.text,this.verticalOffset=sm.conf.visitor_app.reactive_tab.vertical_offset}return u(e,[{key:"_iconClassToType",value:function(e){switch(e){case"ico-voice":return"audio";case"ico-video":return"video";case"ico-text":return"text";default:return zu.error("Unknown icon class of the reactive tab",e),"video"}}}]),e}(),sO=u((function e(){s(this,e),this.apiUrl=sm.conf.api_url,this.alwaysUseDefaultOperatorPicture=sm.conf.visitor_app.always_use_default_operator_picture,this.visitorPageAdaption=sm.conf.visitor_app.visitor_page_adaption,this.engagementMode=function(e){switch(e.visitor_app.visitor_page_adaption){case"div":return"iframeless";case"iframe":return"iframed";case"style":return"nowrap";default:return"iframeless"}}(sm.conf),this.offlineMessagesEnabled=sm.conf.visitor_app.reactive_tab.contact_when_unstaffed,this.reactiveTabEnabled=sm.conf.visitor_app.reactive_tab.enabled,this.widgetMode=sm.conf.visitor_app.widget_mode,this.showReactiveTabWhenOperatorsUnavailable=sm.conf.visitor_app.reactive_tab.show_unavailable,this.theme=sm.conf.visitor_app.theme,this.isCustomTheme=sm.conf.visitor_app.is_custom_theme,this.locale=sm.conf.visitor_app.visitor_app_default_locale,this.reactiveTabVisuals=new oO,this.siteLogo=new iO,this.queuingEnabled=sm.conf.omniq.omniq_enabled,this.panelPosition=sm.conf.visitor_app.reactive_tab.position,this.phoneExtensionEnabled=sm.conf.visitor_app.phone_extension_enabled,this.phoneNumberDefaultCountry=sm.conf.visitor_app.phone_number_default_country,this.hideVisitorInfo=sm.conf.visitor_app.hide_visitor_info_in_visitor_app,this.enableVisitorTranscriptDownload=sm.conf.visitor_app.enable_visitor_transcript_download,this.watchForNewContactOperatorIntegrations=!1!==sm.conf.visitor_app.watch_for_new_contact_operator_integrations,this.engagementInvitationAudio=sm.conf.visitor_app.engagement_invitation_audio})),aO=function(e,t,n,r){e||(e={}),n||(n=[]),r||(r=Pu.Scheduler.asap);var i=e,o=i.phone,s=i.email;if(!o&&!s)return Pu.Observable.throw({cause:tf.SALEMOVE.INVALID_INPUT,message:"Either phone or email must be specified"});var a=t.createApiRequestObservable,u=t.serverResponseTimeout;return a(I.pick(I.concat(["name","phone","email","message"],n),e)).pipe(kt((function(){return{}})),Vr((function(e){return Pu.Observable.throw(SE(e))})),as(u,Pu.Observable.throw(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT,message:"Leave message request timed out"})),r),es(null,I.ifElse(I.propEq("cause",tf.SALEMOVE.TOO_MANY_REQUESTS),zu.warn.bind(zu,"Leaving a message failed: too many requests"),zu.info.bind(zu,"Leaving a message failed"))),wi(1))},uO=function(e,t){return function(e,t){return Wf({method:"GET",url:e,responseType:"blob",getRequestHeaders:t})}(e,t).map((function(e){return e.response})).catch((function(e){return Pu.Observable.throw(SE(e))})).do(null,I.ifElse(I.propEq("cause",tf.SALEMOVE.TOO_MANY_REQUESTS),zu.warn.bind(zu,"Requesting asset failed: too many requests"),zu.info.bind(zu,"Requesting asset failed"))).take(1)},cO=function(){function e(t){var n=t.id,r=t.api,i=t.operator,o=t.restrictedOperator,a=t.cobraObservable,u=t.channelObservable,c=t.message,l=t.logoUrl,f=t.platform,p=t.timeout,h=t.engagementApi,d=t.statsClient,v=t.communicationLib,b=t.notifyOfAccept,m=t.notifyOfDecline,g=t.createEngagement,y=t.cobraLoadTimeout,_=t.connectionStatusObservable,w=t.getRequestHeaders,E=t.internalVisitorStateObservable,O=t.volatileNotifications,S=t.statusObservable,T=t.pubsub,k=t.wsProxy;s(this,e),this.message=c,this.timeout=p,this.operator=o,this.logo={url:l};var A=new Pu.AsyncSubject,x=A.merge(nl(Pu.Observable.merge(r.canceledObservable.map(I.always(new hf({cause:tf.SALEMOVE.CANCEL}))),r.timedOutObservable.map(I.always(new hf({cause:tf.SALEMOVE.TIMEOUT})))))).take(1).flatMap((function(e){return a.map((function(t){return I.merge({cobra:t},e)})).take(1).timeoutWith(y,Pu.Observable.throw(new hf({cause:tf.SALEMOVE.INTERNAL_ERROR,message:"Cobra load timeout exceeded"})).do(null,(function(e){return zu.warn("Cobra loading timed out",e)}))).do(null,(function(t){return zu.warn("Loading cobra failed, ending engagement",t),h.endEngagement({engagementId:e.engagementId,reason:"error",subReason:"visitor_cobra_load_failure"}).take(1).subscribe(zu.log.bind(zu,"Successfully ended engagement after cobra load failure"),zu.warn.bind(zu,"Failed to end engagement after cobra load failure"))})).map((function(e){var t=e.engagementId,n=e.subEngagementId,r=e.media,o=e.cobra,s=e.createdAt;return g({operator:i,engagementId:t,subEngagementId:n,startingMedia:r,type:"proactive",isReestablishing:!1,initialChatHistoryObservable:Jy(t),communicationLib:v,statsClient:d,cobra:o,channelObservable:u,platform:f,engagementApi:h,connectionStatusObservable:_,getRequestHeaders:w,internalVisitorStateObservable:E,entrypoint:"proactive-request",volatileNotifications:O,statusObservable:S,pubsub:T,wsProxy:k,createdAt:s})})).do((function(e){return e.start()})).catch(bf)}));this.engagementPromise=x.toPromise(),this.accept=function(){return r.acknowledge({id:n}).do((function(){return b({engagement_request_id:n,operator:i})})).do((function(){return zu.info("Engagement: Proactive request accepted",{operator:i})})).mapTo({}).catch(bf).toPromise()},this.selectMedia=function(e,t){if(f===cf&&"text"!==e)return Promise.reject(new hf({cause:tf.SALEMOVE.NOT_SUPPORTED,message:"OmniBrowse engagements only support text media."}));var s=o.state.medias,a=wg(o.state.oneWayMedias),u=t||{},c=u.phoneNumber,l=u.phoneExtension,p=u.oneWay;return aw({options:t,availableMediaTypes:s,availableOneWayMediaTypes:a,media:e}).then((function(){return b({engagement_request_id:n,operator:i}),r.accept({id:n,selectedMedia:e,mediaOptions:{phoneNumber:c,phoneExtension:l,oneWay:p}}).do((function(){sm.logger.info("Engagement: Proactive request media selected",arguments[0])})).map((function(t){return I.merge(t,{media:e})})).do(A).mapTo({}).catch(bf).toPromise()}))},this.decline=function(){return r.decline({id:n}).do((function(){return m({operator:i})})).do((function(){return A.error(new hf({cause:tf.SALEMOVE.DECLINE}))})).do((function(){return sm.logger.info("Engagement, Proactive request declined",arguments[0])})).mapTo({}).catch(bf).toPromise()}}return u(e,null,[{key:"create",value:function(t){var n=t.api,r=t.id,i=t.operator,o=t.restrictedOperator,s=t.message,a=t.logoUrl,u=t.platform,c=t.timeout,l=t.statsClient,f=t.cobraObservable,p=t.channelObservable,h=t.engagementApi,d=t.connectionStatusObservable,v=t.getRequestHeaders,b=t.internalVisitorStateObservable,m=t.volatileNotifications,g=t.statusObservable,y=t.pubsub,_=t.wsProxy;return new e({api:n,id:r,statsClient:l,communicationLib:sm.conf.communications.lib,createEngagement:WE.create,cobraObservable:f,operator:i,restrictedOperator:o,platform:u,timeout:c,message:s,logoUrl:a,cobraLoadTimeout:1e4,notifyOfAccept:ec.vent.trigger.bind(ec.vent,ec.MSG.PROACTIVE_ACCEPT),notifyOfDecline:ec.vent.trigger.bind(ec.vent,ec.MSG.PROACTIVE_DECLINE),channelObservable:p,engagementApi:h,connectionStatusObservable:d,getRequestHeaders:v,internalVisitorStateObservable:b,volatileNotifications:m,statusObservable:g,pubsub:y,wsProxy:_})}}]),e}(),lO=function(e,t){return t.pipe(wn((function(t){var n=function(e,t){return I.compose(I.find(I.propEq("id",e)),I.pathOr([],xE))(t)}(e.id,t);return Boolean(n.outcome)})),wi(1),kt((function(t){var n=PE(t);return n&&n.operator.id===e.operator.id?n:null})),wn(I.identity))},fO=function(e){var t=e.channelObservable,n=e.internalVisitorStateObservable,r=e.statusObservable,i=e.webRtcMode,o=e.enabledMediaLevel,s=e.statsClient,a=e.cobraObservable,u=e.isEngagedObservable,c=e.engagementApi,l=e.connectionStatusObservable,f=e.getRequestHeaders,p=e.volatileNotifications,h=e.pubsub,d=e.wsProxy,v=e.dynamicImport;return function(e){var t=e.reestablishRequestObservable,n=e.channelObservable,r=e.statusObservable,i=e.cobraObservable,o=e.isEngagedObservable;return t.pipe(Go((function(e){var t=r.pipe(wn(I.equals({}))),o=n.pipe(wn(I.compose(I.propEq("id",e.operatorId),I.prop("operator"))),wi(1),Wi(e),Qo(t)),s=i.pipe(wn(I.pathEq(["operator","id"],e.operatorId)),so("cobraSource"),wi(1));return Pu.Observable.combineLatest(o,s,(function(e,t){return I.merge(e,{cobra:t})}))})),As(o,(function(e,t){return{engagementReestablishMessage:e,isEngaged:t}})),es((function(e){e.isEngaged?zu.info("Found an ongoing engagement during engagement reestablishing, skipping"):zu.info("Reestablishing ongoing engagement")})),wn((function(e){return!e.isEngaged})),kt((function(e){return e.engagementReestablishMessage})))}({reestablishRequestObservable:function(e){var t=e.pipe(kr(2,1),kt((function(e){var t=_(e,2),n=t[0],r=t[1],i=jE(n),o=PE(r),s=o&&i,a=o&&n.visitor_id!==r.visitor_id,u=o&&!I.path(["engagement","engagements",0],n)&&I.path(["engagement","engagements",0,"restarted_from_engagement_id"],r);return s||a||u?o:null})),wn(I.identity));return e.pipe(wi(1),an((function(t){var n=Pu.Observable.of(t).map(PE).filter(I.identity),r=LE(t),i=r?lO(r,e):Pu.Observable.empty();return Pu.Observable.merge(n,i)})),Ki(t),kt((function(e){return{id:e.id,platform:e.platform,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,operatorId:e.operator.id,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorMediaType:e.operator.media_type,operatorPicture:{url:e.operator.picture_url},entrypoint:e.entrypoint,createdAt:e.start_time}})))}(n),channelObservable:t,statusObservable:r,cobraObservable:a,isEngagedObservable:u}).flatMap((function(e){return v("Comms").mapTo(e)})).delay(0).map((function(e){var a=Xg({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:e.operatorPicture,mediaType:e.operatorMediaType,webRtcMode:i,enabledMediaType:o}),u=WE.create({engagementId:e.id,subEngagementId:e.subEngagementId,initialChatHistoryObservable:Jy(e.id),operator:a,isReestablishing:!0,mediaState:e.mediaState,platform:e.platform,communicationLib:sm.conf.communications.lib,statsClient:s,cobra:e.cobra,channelObservable:t,engagementApi:c,connectionStatusObservable:l,getRequestHeaders:f,internalVisitorStateObservable:n,entrypoint:e.entrypoint,volatileNotifications:p,statusObservable:r,pubsub:h,wsProxy:d,createdAt:e.createdAt});return u.start(),{engagement:u,platform:e.platform}}))},pO=function(e){var t=e.replayedReestablishObservable,n=e.defaultHandler,r=e.storeKey,i=e.platform,o=e.sessionStore,s=e.timeout,a=new JE,u=t.filter(I.propEq("platform",i)).map(I.prop("engagement")),c=function(e){return a.add(u.subscribe(e,zu.error))},l=new Pu.Subject;return c((function(e){return o.get(r)?Pu.Observable.timer(s).takeUntil(l).subscribe((function(){return o.remove(r),zu.error("Waited for custom reestablish handler to be set, but it wasn't set before timeout."),l.subscribe((function(){return zu.error("Custom reestablish handler was set, but after timeout."),console.error("Salemove#setEngagementReestablishHandler() was called too late!"+" Glia waits ".concat(Math.round(15)," seconds after page load")+" for the custom reestablish handler to be set. Executing the handler anyway, although the default handler has already been called.")})),n(e)})):n(e)})),function(e){c(e),l.next(e),o.set(r,!0)}},hO=u((function e(t){var n=t.engaged,r=t.name,i=t.email;s(this,e),this.engaged=n,this.name=r,this.email=i})),dO=u((function e(t){var n=t.connected;s(this,e),this.connected=n})),vO="__sm_mutation_event_trigger_flip__",bO=new hf({cause:tf.SALEMOVE.INTERNAL_ERROR}),mO=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds;t||(t=Pu.Scheduler.asap);var o=function(){return Lf({stats:r,protocol:"rest",failureTagProperty:"message",timeout:i,timeoutError:Pu.Observable.throw(bO),scheduler:t})};return{createMediaUpgrade:function(e){var t=e.engagementId,r=e.media;return o()({resource:"media-upgrade",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/media_upgrades"),payload:{media:r},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},getChatTranscript:function(e){return o()({resource:"chat-transcript",method:"fetch"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(e,"/chat_transcript"),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},endEngagement:function(e){var t=e.engagementId,r=I.compose(I.assoc("action","end"),Xl({subReason:"sub_reason"}),I.pick(["reason","subReason"]))(e);return o()({resource:"engagement",method:"end"},(function(){return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}}},gO=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),yO={"'operator_id' Operator is not available to be engaged":tf.SALEMOVE.OPERATOR_UNAVAILABLE,"Operator cannot be engaged":tf.SALEMOVE.OPERATOR_UNAVAILABLE,"Visitor cannot be engaged":tf.SALEMOVE.ALREADY_ENGAGED,"'engagement_request_id' already failed":tf.SALEMOVE.CONFLICT,"'engagement_request_id' already accepted":tf.SALEMOVE.CONFLICT,"'engagement_request_id' already acknowledged":tf.SALEMOVE.CONFLICT},_O=(c(nO={},403,tf.SALEMOVE.FORBIDDEN),c(nO,409,tf.SALEMOVE.CONFLICT),nO),wO=["'engagement_request_id' already failed","'engagement_request_id' already accepted","'engagement_request_id' already acknowledged"],EO=function(e,t,n){var r=I.merge(n,{error:e});e&&I.contains(e.message,wO)||e instanceof hf?zu.warn("Failed to ".concat(t," engagement request"),r):zu.error("Failed to ".concat(t," engagement request"),r)},OO=function(e){var t=yO[e&&e.message]||_O[e&&e.status]||tf.SALEMOVE.INTERNAL_ERROR;return new hf({cause:t})},SO=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds,o=e.visitorMetadata,s=e.internalVisitorStateObservable;t||(t=Pu.Scheduler.asap);var a=Lf({stats:r,protocol:"rest",failureTagProperty:"cause",timeout:i,timeoutError:Pu.Observable.throw(gO),scheduler:t}),u=function(e){var t=e.id,r=e.data;return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagement_requests/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})},c=function(e){r.increment("engagement.flow",["entrypoint:proactive-request","stage:requested","action:end"].concat(e))},l=s.pipe(kt(CE),kr(2,1),wn((function(e){var t=_(e,2),n=t[0],r=t[1];return!n&&Boolean(r)})),kt((function(e){var t=_(e,2);t[0];return t[1]}))),f=l.pipe(wn(RE),es((function(e){var t=e.id;return zu.info("Found new accepted engagement",{engagement_id:t})})),kt((function(e){return{engagementId:e.id,subEngagementId:e.sub_engagement_legacy_id,operatorId:e.operator.id,operatorMediaType:e.operator.media_type,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorPicture:{url:e.operator.picture_url},media:Z_(e.media),entrypoint:e.entrypoint,platform:e.platform,createdAt:e.start_time}}))),p=l.pipe(wn(I.complement(RE)),Wi({})),h=function(e){var t=I.propEq("site_id",sm.siteId);return I.compose(I.filter(t),I.pathOr([],["engagement","requests"]))(e)},d=I.compose(I.nth(0),I.filter(I.propEq("outcome",null)),h),v=function(e){return I.compose(I.nth(0),I.filter(I.propEq("id",e)),h)},b=s.pipe(kt(d),wn(I.identity)),m=I.curry((function(e,t){return s.pipe(kt(v(t.id)),wn(I.identity),wn((function(t){return I.contains(t.outcome,e)})),wi(1),Qo(function(e,t){return s.pipe(kt(v(e.id)),wn(I.identity),wn((function(e){return!I.contains(e.outcome,t)})))}(t,I.append(null,e))))})),g=b.pipe(an(m(["operator_cancel","operator_left"])),Wi({})),y=Pu.Observable.merge(p,g),w=b.pipe(an(m(["timed_out"])),Wi({}));return{create:function(e){var t=e.operatorId,r=e.siteId,i=e.media,s=e.source,u=e.mediaOptions,c={operator_id:t,site_id:r,media:i,source:s||"sdk",visitor_metadata:o,media_options:{phone_number:u.phoneNumber,phone_extension:u.phoneExtension,one_way:u.oneWay}};return zu.info("Engagement: Sending reactive request",c),a({resource:"engagement-request",method:"create"},(function(){return(e=c,n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagement_requests"),payload:e,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})).map((function(e){var t=e.timeout;return{engagementRequestId:e.id,acknowledgeTimeoutSeconds:t}})).catch((function(e){var n={error:e,operator_id:t,site_id:r,media:i,source:s,media_options:u};return e instanceof hf?(zu.info("Failed to create engagement request",n),Pu.Observable.throw(e)):(403===(e&&e.status)?zu.info("Visitor forbidden to create engagement request",n):422===(e&&e.status)?zu.info("Operator is not available to be engaged",n):409===(e&&e.status)?zu.info("Operator cannot be engaged",n):zu.error("Failed to create engagement request",n),Pu.Observable.throw(OO(e)))}));var e}))},cancel:function(e){var t=e.id,n="cancel";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return EO(e,n,{engagement_request_id:t}),Pu.Observable.throw(OO(e))}))}))},acknowledge:function(e){var t=e.id,n="acknowledge";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return EO(e,n,{engagement_request_id:t}),Pu.Observable.throw(OO(e))})).do(null,(function(e){e.cause===tf.SALEMOVE.INTERNAL_ERROR?c(["reason:internal-error"]):e.cause!==tf.SALEMOVE.CONFLICT&&c(["reason:unknown"])}))}))},accept:function(e){var t=e.id,n=e.selectedMedia,r=e.mediaOptions,i="accept";return a({resource:"engagement-request",method:i},(function(){return u({id:t,data:{action:i,media:n,media_options:{phone_number:r.phoneNumber,phone_extension:r.phoneExtension,one_way:r.oneWay},visitor_metadata:o}}).catch((function(e){return EO(e,i,{engagement_request_id:t,media:n,media_options:r}),Pu.Observable.throw(OO(e))})).do(null,(function(e){e.cause===tf.SALEMOVE.INTERNAL_ERROR?c(["reason:internal-error"]):e.cause!==tf.SALEMOVE.CONFLICT&&c(["reason:unknown"])})).map(Xl({engagement_id:"engagementId",sub_engagement_id:"subEngagementId",created_at:"createdAt"}))}))},decline:function(e){var t=e.id,n="decline";return a({resource:"engagement-request",method:n},(function(){return u({id:t,data:{action:n}}).catch((function(e){return EO(e,n,{engagement_request_id:t}),Pu.Observable.throw(OO(e))}))}))},notifyOfReactiveFailure:function(e){var t=e.id;return a({resource:"engagement-request",method:"cancel-due-to-error"},(function(){return u({id:t,data:{action:"cancel",reason:"error"}}).catch((function(e){return Pu.Observable.throw(OO(e))})).do(null,zu.warn.bind(zu,"Failed to cancel reactive engagement request due to error"))}))},acceptedObservable:f,declinedObservable:b.pipe(an(m(["rejected"])),Wi({})),canceledObservable:y,timedOutObservable:w}},TO=["name","email","phone","note","customAttributes","customAttributesUpdateMethod"],kO={customAttributes:"custom_attributes",customAttributesUpdateMethod:"custom_attributes_update_method"},AO="last_known_ci:".concat(Vu()),xO=function(e){var t=Lu(),n=JSON.stringify(e);return function(e){for(var t=0,n=0,r=e.length;n<r;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t}(Math.floor(Date.now()/864e5).toString()+t+n).toString()},IO=new dy,NO=0,MO=function(e,t,n){n||(n=Pu.Scheduler.asap);var r=t.createApiRequestObservable,i=t.serverResponseTimeout,s=t.tabId,a=t.visitorMetadata,u=t.status;if(e.customAttributes&&"object"!==o(e.customAttributes))return Pu.Observable.throw({cause:tf.SALEMOVE.INVALID_INPUT,message:"Custom attributes must be an object"});if(I.has("customAttributesUpdateMethod",e)&&!I.contains(e.customAttributesUpdateMethod,["merge","replace"]))return Pu.Observable.throw({cause:tf.SALEMOVE.INVALID_INPUT,message:"Custom attributes update method must be either merge or replace"});var c=I.compose(Xl(kO),I.pick(TO)),l=I.has("externalId",e)?I.compose(I.assocPath(["custom_attributes","external_id"],e.externalId),c)(e):c(e);return l.context={tab_id:s,url:window.location.href,metadata:a,status:u},0===NO&&function(e){try{return IO.getItem(AO)===xO(e)}catch(e){return zu.info("Could not read last saved contact information hash",e),!1}}(I.dissoc("context",l))?(zu.info("Avoiding first visitor information update as it matches a previous update"),Pu.Observable.of({})):(NO+=1,r(l).pipe(es((function(){return function(e){try{IO.setItem(AO,xO(e))}catch(e){zu.info("Could not save last saved contact information hash",e)}}(I.dissoc("context",l))})),kt((function(){return{}})),Vr((function(e){return Pu.Observable.throw(SE(e))})),as(i,Pu.Observable.throw(new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT,message:"Set visitor information request timed out"})),n),es(null,I.ifElse(I.propEq("cause",tf.SALEMOVE.TOO_MANY_REQUESTS),zu.warn.bind(zu,"Setting visitor information failed: too many requests"),zu.info.bind(zu,"Setting visitor information failed"))),Vr(bf)))},CO={setTimeout:setTimeout,clearTimeout:clearTimeout},RO=function(e,t,n){var r,i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:CO,s=o.setTimeout,a=o.clearTimeout,u=function(e){return r=e,i&&a(i),i=s((function(){r=void 0}),t),e};return function(){return r?(n(r),Promise.resolve(r)):e().then(u)}},PO=u((function e(t){var n=t.state,r=t.medias,i=t.transitionReason,o=t.ticket,a=t.activeTicket;s(this,e),this.state=n,this.medias=r,this.transitionReason=i,this.ticket=o,this.activeTicket=a}));PO.prototype.QUEUE_STATES={CAN_QUEUE:"can_queue",CANNOT_QUEUE:"cannot_queue",QUEUED:"queued"},PO.prototype.TRANSITION_REASONS={ENGAGED:"engaged",CANCELED:"canceled",UNSTAFFED:"unstaffed",CLOSED:"closed",DISCONNECTED:"disconnected",FAILED:"failed",ALREADY_QUEUED:"already_queued",FORBIDDEN:"forbidden"};var jO=u((function e(t){var n=t.averageDurationInSeconds;s(this,e),this.averageDurationInSeconds=n})),LO=new hf({cause:tf.SALEMOVE.INTERNAL_ERROR}),qO=new hf({cause:tf.SALEMOVE.CANCEL}),UO=function(e,t){return e.increment("engagement.flow",["entrypoint:queue-request"].concat(t))},DO=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.ticket_id;return function(e,t){return Lf({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:Pu.Observable.throw(LO)})}(n,r)({resource:"queue_tickets",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/queue_tickets/").concat(i),payload:{},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).mapTo({}).do((function(){return function(e){return UO(e,["stage:requested","action:end","expected:true","reason:cancel"])}(n)})).catch(bf)},VO=function(e){var t=e.engagementApi,n=e.engagementRequestApi,r=e.cobraObservable,i=e.fetchEngagementDependencies,o=e.channelObservable,s=e.communicationLib,a=e.statsClient,u=e.webRtcMode,c=e.enabledMediaLevel,l=e.connectionStatusObservable,f=e.getRequestHeaders,p=e.internalVisitorStateObservable,h=e.volatileNotifications,d=e.pubsub,v=e.statusObservable,b=e.wsProxy,m=Pu.Observable.combineLatest(r,i(),(function(e){return{cobra:e}})).publishReplay(1),g=m.connect();return n.acceptedObservable.take(1).flatMap((function(e){var n=e.engagementId,r=e.subEngagementId,i=e.operatorId,g=e.media,y=e.operatorName,_=e.operatorFormattedName,w=e.operatorPicture,E=e.operatorMediaType,O=e.entrypoint,S=e.createdAt;return m.take(1).map((function(e){var m=e.cobra,T=Xg({id:i,name:y,formattedName:_,picture:w,mediaType:E,webRtcMode:u,enabledMediaType:c});return{engagementId:n,subEngagementId:r,startingMedia:g,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:Jy(n),operator:T,cobra:m,channelObservable:o,communicationLib:s,engagementApi:t,getRequestHeaders:f,internalVisitorStateObservable:p,entrypoint:O,volatileNotifications:h,pubsub:d,statusObservable:v,wsProxy:b,createdAt:S,statsClient:a,connectionStatusObservable:l}})).map(WE.create).do(null,(function(){return function(e){return UO(e,["stage:requested","action:end","reason:script-load-error"])}(a)})).do(null,(function(){return t.endEngagement({engagementId:n,reason:"error",subReason:"setup_failed"})}))})).finally((function(){return g.unsubscribe()}))},FO=function(){function e(t){s(this,e);var n=t.ticket_id,r=t.apiTimeoutMilliseconds,i=t.statsClient,o=t.wsProxy,a=t.stopObservable,u=new Pu.Subject,c=Pu.Observable.merge(u,a);zu.info("Queue Ticket created, waiting for engagement",{queue_ticket_id:n});var l=VO(t).takeUntil(c).do((function(e){return e.start()})).catch(bf).publishReplay(1);l.connect(),this.engagementPromise=l.merge(c.flatMapTo(Pu.Observable.throw(qO))).take(1).toPromise(),this.cancel=function(){return u.next(),l.last(null,null,null).flatMap((function(e){return e?Pu.Observable.fromPromise(e.end()):DO({wsProxy:o,statsClient:i,apiTimeoutMilliseconds:r,ticket_id:n})})).toPromise()}}return u(e,null,[{key:"create",value:function(t,n){var r=new Pu.Subject;return{ticket:I.compose(I.construct(e),I.assoc("stopObservable",r.asObservable()))(I.merge(t,{ticket_id:I.path(["activeTicket","id"],n)})),subscription:new Pu.Subscription((function(){return r.next(),r.unsubscribe()}))}}}]),e}(),BO="requesting",HO="created",WO={open:1,opened:1,full:2,unstaffed:3,closed:4},GO=I.compose(I.reduce(I.minBy((function(e){return WO[e]})),"closed"),I.map(I.path(["state","status"]))),zO=I.compose(I.uniq,I.chain(I.path(["state","medias"]))),JO=function(e){var t=I.filter(I.pathEq(["state","status"],"open"),e),n=zO(t);return{state:GO(e)||"closed",medias:n}},YO=function(e){return I.pick(Object.getOwnPropertyNames(e),e)},QO=["enqueued","request_sent"],KO=I.propEq("site_id",sm.siteId),XO=I.compose(I.filter(KO),I.pathOr([],["omniq","queue_tickets"])),$O=I.compose(I.nth(0),I.filter((function(e){return-1!==QO.indexOf(e.state)})),XO),ZO=I.curry((function(e,t){return I.compose(I.nth(0),I.filter(I.propEq("id",e)),XO)(t)})),eS=function(e){var t=e.queueState,n=e.queued,r=e.enqueuedInCurrentTab;return n||!(I.isNil(t)||I.isNil(n)||I.isNil(r))},tS=function(e,t){return I.intersection(function(e){var t=["text","phone"];return e&&(t=t.concat(["messaging"])),Ug()===qg&&(t=t.concat(["audio","video"])),t}(t),e)},nS=function(e){var t=e.queueState,n=e.queued,r=e.visitorLeftReason,i=e.enqueuedInCurrentTab,o=e.isEngaged,s=e.activeTicket,a=e.isVisitorAuthenticatedExternally,u=e.isAsyncTransfer;if(n)return new PO(i?{state:PO.prototype.QUEUE_STATES.QUEUED,activeTicket:s}:{state:PO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:PO.prototype.TRANSITION_REASONS.ALREADY_QUEUED});var c=function(e,t){if(t)return PO.prototype.TRANSITION_REASONS.ENGAGED;if(e)switch(e){case"finished":return PO.prototype.TRANSITION_REASONS.ENGAGED;case"canceled":return PO.prototype.TRANSITION_REASONS.CANCELED;case"unstaffed":return PO.prototype.TRANSITION_REASONS.UNSTAFFED;case"closed":return PO.prototype.TRANSITION_REASONS.CLOSED;case"disconnected":return PO.prototype.TRANSITION_REASONS.DISCONNECTED;case"failure":return PO.prototype.TRANSITION_REASONS.FAILED;case"forbidden":return PO.prototype.TRANSITION_REASONS.FORBIDDEN;case"visitor_conflict":return PO.prototype.TRANSITION_REASONS.FAILED;default:return void zu.error("Unknown visitor left reason",{reason:e})}}(r,o);if(c===PO.prototype.TRANSITION_REASONS.ENGAGED||"opened"!==t.state&&"open"!==t.state)return new PO({state:PO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c});var l=tS(u?t.medias.concat(["messaging"]):t.medias,a);return 0===l.length?new PO({state:PO.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:c}):new PO({state:PO.prototype.QUEUE_STATES.CAN_QUEUE,medias:l,transitionReason:c})},rS=I.both(I.propEq("state",PO.prototype.QUEUE_STATES.CANNOT_QUEUE),I.propEq("transitionReason",PO.prototype.TRANSITION_REASONS.ENGAGED)),iS=function(e){var t=e.routingObservable,n=e.internalVisitorStateObservable,r=e.visitorAuthenticatedExternallyObservable,i=e.queuesStateUpdatesObservable,o=e.createQueueTicketStateObservable,s=e.queueTicketBindings,a=e.scheduler;if(a||(a=Pu.Scheduler.asap),I.path(["conf","omniq","omniq_enabled"],sm)){var u=new Pu.ReplaySubject(1);o.subscribe((function(e){return u.next(!I.contains(e,[BO,HO]))}));var c=function(e,t){return e.pipe(uo((function(e){return e.pipe(Hr(t,(function(e,t){return t})),wn((function(e){return e})),uo((function(t){return e.bufferWhen((function(){return t.take(1)}))})))})),an((function(e){return Pu.Observable.from(e)})))}(function(e){var t=e.routingObservable,n=e.queuesStateUpdatesObservable;return t.pipe(Go((function(e){var t=e.queue_ids;return I.not(t)?Nc.of([]):n.subscribeToListAsObservable({queueIds:t})})),kt(JO),kt(I.objOf("queueState")),di(I.equals))}({routingObservable:t,queuesStateUpdatesObservable:i}),u),l=Pu.Observable.combineLatest(n,r).scan((function(e,t){var n,r,i,o=_(t,2),s=o[0],a=o[1],u=e&&e.activeTicket&&e.activeTicket.id,c=$O(s),l=CE(s,{includeAsyncTransfer:!0}),f=Boolean(l)&&!ME(l);return c?{queued:!0,enqueuedInCurrentTab:(r=c,i=I.lensPath(["visitor","browser_tab_id"]),I.compose(I.equals(sm.tabId),I.view(i))(r)),activeTicket:{id:c.id},visitorLeftReason:null,isEngaged:f,isAsyncTransfer:ME(l),isVisitorAuthenticatedExternally:a}:u&&(n=ZO(u,s))?{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:n.state,isEngaged:f,isAsyncTransfer:ME(l),isVisitorAuthenticatedExternally:a}:{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:null,isEngaged:f,isAsyncTransfer:ME(l),isVisitorAuthenticatedExternally:a}}),{}).do((function(e){e.queued||u.next(!0)})).distinctUntilChanged(I.equals);return{aggregateQueueStateObservable:Pu.Observable.merge(c,l).scan(I.merge,{}).filter(eS).do((function(e){sm.conf.visitor_api.enable_staffing_logs&&zu.info("[staffing-logs] Recording raw aggregate queue state",e)})).map(nS).distinctUntilChanged(I.equals,YO).scan(function(e){return function(t,n){var r;if(n.state===PO.prototype.QUEUE_STATES.QUEUED){var i;t.subscription.unsubscribe();var o=FO.create(e,n);return i=o.ticket,r=o.subscription,n.ticket=i,{queueState:n,subscription:r}}return rS(n)?(zu.info("Discarding queue ticket subscription as Visitor got engaged"),{queueState:n,subscription:Pu.Subscription.EMPTY}):(t.subscription!==Pu.Subscription.EMPTY&&zu.info("Dispose queue ticket subscription as Visitor is no longer queued"),t.subscription.unsubscribe(),{queueState:n,subscription:Pu.Subscription.EMPTY})}}(s),{subscription:Pu.Subscription.EMPTY}).map(I.prop("queueState")).publishReplay(1,Number.POSITIVE_INFINITY,a).refCount()}}return{aggregateQueueStateObservable:Pu.Observable.empty()}},oS=function(e){return e&&e.cause===tf.SALEMOVE.FORBIDDEN||e&&e.cause===tf.SALEMOVE.INVALID_INPUT?["reason:invalid-input"]:["reason:unknown"]},sS=[],aS=function(e){l(n,e);var t=m(n);function n(e){var r;return s(this,n),e||(e={}),(r=t.apply(this,arguments)).ticket=e.ticket,r}return u(n)}(hf),uS=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),cS=function(e){return!function(e){return 0===e}(e.status)?!function(e){return 403===e}(e.status)?"Service Unavailable"===e.errorThrown&&(e=new hf({cause:tf.SALEMOVE.INTERNAL_ERROR})):e=new hf({cause:tf.SALEMOVE.FORBIDDEN}):e=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),Pu.Observable.throw(e)},lS=function(e,t){return Lf({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:Pu.Observable.throw(uS)})},fS=function(e,t){return e.omniq.omniq_enabled?t():Promise.reject(new hf({cause:tf.SALEMOVE.DISABLED}))},pS=function(e){var t=e.conf,n=e.statsClient,r=e.apiTimeoutMilliseconds;return function(){return fS(t,(function(){return lS(n,r)({resource:"queue_wait_duration",method:"get"},(function(){return Wf({url:Gy("/engagements/queue/wait_duration"),responseType:"json"})})).map(I.compose(I.construct(jO),Xl({average_duration_in_seconds:"averageDurationInSeconds"}),I.map(Math.floor),I.prop("response"))).catch((function(e){return Pu.Observable.throw(SE(e))})).catch(bf).toPromise()}))}},hS=I.compose((function(e){var t=e.id,n=e.name,r=e.status,i=e.availableProperties;return new ef({id:t,name:n,status:r,medias:i.media})}),I.evolve({status:Zl}),I.pick(["id","name","status","availableProperties"])),dS=function(e){var t=e.conf,n=e.wsProxy,r=e.statsClient,i=e.apiTimeoutMilliseconds,o=e.apiMaxRetries,s=e.apiRetryIntervalMilliseconds;return function(){var e=function(e){return I.not(I.contains(e.status,I.range(400,499)))};return fS(t,(function(){var t=Pu.Observable.defer((function(){return lS(r,i)({resource:"queues",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/queues?site_ids[]=").concat(sm.siteId),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}));return il(t,{maxRetries:o,calculateDelay:M(s),shouldRetry:e}).map(I.prop("queues")).map(I.map(Xl({available_properties:"availableProperties"}))).map(I.map(hS)).catch(cS).catch(bf).toPromise()}))}},vS=function(e){var t=e.wsProxy,n=e.pubsub,r=e.routingObservable,i=e.engagementApi,o=e.engagementRequestApi,s=e.operatorsObservable,a=e.cobraObservable,u=e.channelObservable,c=e.communicationLib,l=e.statsClient,f=e.fetchEngagementDependencies,p=e.apiTimeoutMilliseconds,h=e.apiRetryIntervalMilliseconds,d=e.apiMaxRetries,v=e.connectionStatusObservable,b=e.webRtcMode,m=e.enabledMediaLevel,g=e.visitorMetadata,y=e.conf,w=e.getRequestHeaders,E=e.internalVisitorStateObservable,O=e.visitorAuthenticatedExternallyObservable,S=e.volatileNotifications,T=e.statusObservable,k=e.queuesStateUpdatesObservable,A=new Pu.Subscription;A.add(r.subscribe((function(e){sS=e.queue_ids})));var x=function(e){return l.increment("engagement.flow",["entrypoint:queue-request"].concat(e))},N=new Pu.Subject,M=iS({routingObservable:r,internalVisitorStateObservable:E,visitorAuthenticatedExternallyObservable:O,queuesStateUpdatesObservable:k,createQueueTicketStateObservable:N,queueTicketBindings:{apiTimeoutMilliseconds:p,statsClient:l,wsProxy:t,engagementApi:i,engagementRequestApi:o,cobraObservable:a,fetchEngagementDependencies:f,operatorsObservable:s,channelObservable:u,communicationLib:c,webRtcMode:b,enabledMediaLevel:m,connectionStatusObservable:v,getRequestHeaders:w,internalVisitorStateObservable:E,volatileNotifications:S,pubsub:n,statusObservable:T}}).aggregateQueueStateObservable,C=function(e,t){return M.take(1).flatMap((function(n){var r=n.state,i=n.medias;return r===PO.prototype.QUEUE_STATES.CAN_QUEUE?function(e){var t=e.media,n=e.options,r=e.availableMediaTypes;return aw({media:t,options:n,availableMediaTypes:r,availableOneWayMediaTypes:wg(r)})}({media:e,options:t,availableMediaTypes:i}):Pu.Observable.throw(new hf({cause:tf.SALEMOVE.FORBIDDEN,message:"Queue state must be: ".concat(PO.prototype.QUEUE_STATES.CAN_QUEUE)}))}))},R=function(){return E.take(1).flatMap((function(e){return Boolean(CE(e))?Pu.Observable.throw(new hf({cause:tf.SALEMOVE.FORBIDDEN,message:"Visitor is already engaged"})):Pu.Observable.of({})}))},P=function(e){return-1!==["Queue is closed","Queue is full"].indexOf(e.details)?Pu.Observable.throw(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:e.message})):409===e.status?M.take(1).flatMap((function(e){return function(e){return Pu.Observable.throw(new aS({cause:tf.SALEMOVE.ALREADY_QUEUED,message:"Visitor is already queued",ticket:e}))}(e.ticket)})):403===e.status?Pu.Observable.throw(new hf({cause:tf.SALEMOVE.FORBIDDEN})):"Validation error"===e.error?Pu.Observable.throw(new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:e.error})):bf(e)};return{subscription:A,queueForEngagement:function(e,n){return n||(n={}),x(["action:begin"]),fS(y,(function(){var r=_(n.queueId?[{media:e,options:n},R]:[{media:e,options:n,queueIds:sS},C],2),i=r[0],o=r[1],s=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.errorHandling,o=e.visitorMetadata;return function(e){var s=e.media,a=e.options,u=e.queueIds;return lS(n,r)({resource:"queue_tickets",method:"create"},(function(){var e={};a.phoneNumber&&(e.phone_number=a.phoneNumber),a.phoneExtension&&(e.phone_extension=a.phoneExtension),a.oneWay&&(e.one_way=a.oneWay);var n=a.source||"sdk",r={media:s,visitor_id:Lu(),media_options:e,source:n,visitor_metadata:o};a.queueId?r=I.merge(r,{queue_id:a.queueId}):u&&(r=I.merge(r,{queue_ids:u}));var c={method:"POST",url:"".concat(sm.conf.api_url,"/queue_tickets"),payload:I.merge(r,{site_id:sm.siteId}),headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}};return t.request(c).catch(i||bf)}))}}({wsProxy:t,statsClient:l,apiTimeoutMilliseconds:p,visitorMetadata:g,errorHandling:P})(i);return o(e,n).do((function(){return N.next(BO)})).do((function(){return x(["action:reach","stage:create-request"])}),(function(e){return x(["action:end","stage:pre-request"].concat(oS(e)))})).flatMapTo(s).mapTo({}).do((function(){return x(["action:reach","stage:requested"])}),(function(e){return x(["action:end","stage:create-request"].concat(oS(e)))})).do((function(){return N.next(HO)}),(function(){return N.next("failed-to-create")})).toPromise()}))},fetchWaitDuration:pS({conf:y,statsClient:l,apiTimeoutMilliseconds:p}),aggregateQueueStateObservable:M,getQueues:RO(dS({conf:y,wsProxy:t,statsClient:l,apiTimeoutMilliseconds:p,apiMaxRetries:d,apiRetryIntervalMilliseconds:h}),6e4,(function(e){return zu.info("Returning cached response for queues",{cached_queues_length:null==e?void 0:e.length})}))}},bS=function(e,t,n){return function(){if("function"==typeof n&&n(arguments),e&&"function"==typeof e[t])return e[t].apply(e,arguments);throw new hf({cause:tf.SALEMOVE.NOT_SUPPORTED})}},mS=function(e){if(!I.contains(e[0],ff))throw new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"Make sure function argument is one of ISO 3166-1 alpha-2 country codes"})},gS=function(){function e(t){s(this,e),this.triggerQueueMediaSelection=bS(t,"triggerQueueMediaSelection"),this.setChatMessageRenderer=bS(t,"setChatMessageRenderer"),this.setPhoneNumberDefaultCountry=bS(t,"setPhoneNumberDefaultCountry",mS),this.showVisitorCode=bS(t,"showVisitorCode")}return u(e,[{key:"triggerQueueMediaSelection",value:function(e){}},{key:"setChatMessageRenderer",value:function(e){}},{key:"setPhoneNumberDefaultCountry",value:function(e){}},{key:"showVisitorCode",value:function(){}}]),e}(),yS=u((function e(t){var n=t.id,r=t.siteId,i=t.visitorId,o=t.url,a=t.authenticationApi;s(this,e),this.id=n,this.siteId=r,this.visitorId=i,this.url=o,this.decline=function(e){return a.deleteAuthenticationRequest({id:this.id,siteId:this.siteId,visitorId:this.visitorId,reason:e})}})),_S=new hf({cause:tf.SALEMOVE.NETWORK_TIMEOUT}),wS=function(e){var t=e.wsProxy,n=e.apiTimeoutMilliseconds,r=e.stats,i=Lf({stats:r,protocol:"rest",failureTagProperty:"message",timeout:n,timeoutError:Pu.Observable.throw(_S)});return{createAuthenticationRequest:function(e){var n=(e=Ql(e)).webhooks||[];return i({resource:"authentication-request",method:"create"},(function(){return t.request({method:"POST",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests"),payload:{authentication_provider_id:e.authenticationProviderId,webhooks:n,visitor_id:Lu(),site_id:sm.siteId},headers:lf}).catch((function(t){return function(e,t){var n=404===e.status?new hf({cause:tf.SALEMOVE.INVALID_INPUT,message:"The authentication provider with ID ".concat(t.authenticationProviderId," was not found.")}):vf(e);return Pu.Observable.throw(n)}(t,e)}))})).toPromise()},deleteAuthenticationRequest:function(e){var n=e.id,r=e.siteId,o=e.visitorId,s=e.reason;return i({resource:"authentication-request",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests/").concat(n),payload:{site_id:r,visitor_id:o,fail_reason:s},headers:lf}).catch(mf,{allowedCauses:[tf.SALEMOVE.INVALID_INPUT,tf.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}},ES=!1,OS=function(e){var t=e.volatileChannelObservable,n=e.joinChannel,r=e.renewTokenAndReconnectWaitForTeardown;return function(e,t){return t.pipe(Go((function(t){return t.observable("message").pipe(wn((function(e){return"engagement.visitor_consolidation.requested"===e.event_type})),Go((function(n){var r=n.site_id,o=n.visitor_id,s=n.token_event_id;return e("site_visitor:".concat(o),{topics:["site_visitor:".concat(o,":").concat(r)]}).pipe(Vr((function(e){return e&&"unauthorized"===e.error?ac.Observable.empty():ac.Observable.throw(e)})),an((function(e){return(0,e.observable)("message",{leaveChannelOnDispose:!0})})),wn((function(e){return"engagement.visitor_consolidation"===e.event_type&&e.event_id===s})),wi(1),kt((function(e){return i(i({},e),{},{volatileChannel:t})})))})))})))}(n,t).subscribe((function(e){var t=e.secret,n=e.assumed_visitor_id,i=e.volatileChannel;zu.info("Consolidating visitor",{assumed_visitor_id:n}),i.leave(),r({consolidationSecret:t}).delay(0).subscribe((function(){return Du(n)}),zu.error.bind(zu,"Error from renewing token and reconnecting in visitor consolidation"))}),zu.error.bind(zu,"Error from visitor consolidation subscription"))},SS=I.prop("id"),TS=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,e),this._elements=[],this._ids=new Set,this._changeSubject=new Pu.Subject,this._insertToBeginning=!0===t.insertToBeginning,this.observable=this._changeSubject.asObservable()}return u(e,[{key:"change",value:function(e,t){return this._elements=this._elements.map((function(n){return n.id===e?t:n})),this._changeSubject.next(this._elements),this}},{key:"add",value:function(e){return this._ids.has(e.id)?this.change(e.id,e):(this._ids.add(e.id),this._insertToBeginning?this._elements=[e].concat(this._elements):this._elements=this._elements.concat([e])),this._changeSubject.next(this._elements),this}},{key:"replace",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.retainMissingElements;if(e.forEach((function(e){return t._ids.add(e.id)})),r){var i=I.indexBy(SS,e),o=this._elements.filter((function(e){return!i[e.id]}));this._insertToBeginning?this._elements=o.concat(e):this._elements=e.concat(o)}else this._elements=e;return this._changeSubject.next(this._elements),this}},{key:"values",value:function(){return this._elements}},{key:"valuesUntil",value:function(e){return I.takeWhile((function(t){return!I.propEq("id",e,t)}),this._elements)}}]),e}(),kS=I.pathOr(0,["engagement","unread_message_count"]),AS={MESSAGES:"MESSAGES",UNREAD_MESSAGE_COUNT:"UNREAD_MESSAGE_COUNT"},xS=function(){return M(I_.initialDelay,I_.maxDelay,I_.factor)},IS={latestQueueIds:[],unreadMessageCount:0,markAsReadCount:0,lastSeenMessageDuringMarkRead:{id:void 0}};function NS(e){var t,n=e.pubsub,r=e.routingObservable,o=e.getRequestHeaders,s=e.internalVisitorStateObservable,a=new Pu.Subscription,u=tp(),c=s.map(kS).distinctUntilChanged().publishReplay(1);a.add(c.connect());var l=s.map((function(e){return CE(e,{includeAsyncTransfer:!0})}));a.add(l.subscribe((function(e){t=e})));var f=IS;a.add(r.subscribe((function(e){var t=e.queue_ids;f=i(i({},f),{},{latestQueueIds:t})}))),a.add(c.subscribe((function(e){f=i(i({},f),{},{unreadMessageCount:e})})));var p,h=new TS({insertToBeginning:!0}),d=I.pipe(I.prop("message"),Xl({content:"message",timestamp:"created_at"}),f_),v=I.propEq("event_type","queued_message.created"),b=Lu(),m=I.pathEq(["message","sender","type"],"visitor"),g=Pu.Observable.create((function(e){var r=n.joinSiteVisitorNotifications(b,[sm.siteId]).pipe(I.filter((function(e){return v(e)||t&&P_(t.id)(e)})),I.reject(m),I.map(d)),i=h.observable.subscribe(e);return i.add(r.subscribe(h.add.bind(h))),i})).throttleTime(50,vt,{leading:!0,trailing:!0}).distinctUntilChanged(I.equals).share(),y=I.propEq("event_type","engagement.files.security_scan_result");u.proxyAll(I.fromPairs([[AS.MESSAGES,g],[AS.UNREAD_MESSAGE_COUNT,c]]));var _=u.addEventListener,w=u.removeEventListener;return{EVENTS:AS,addEventListener:_,uploadFile:function(e,t){var r=t.onUploadProgress,i=Lu();return kE(null,e,{onUploadProgress:r,getRequestHeaders:o},function(e){var t=e.visitorId;return p||((p=n.joinSiteVisitorNotifications(t,[sm.siteId]).filter(y).publishReplay(100)).connect(),p)}({visitorId:i}),sm.conf.communications.allowed_file_content_types).toPromise()},removeEventListener:w,fetchMessages:function(){return new Promise((function(e,t){!function(e){var t=e.getRequestHeaders,n=e.onSuccess,r=e.onError;Gf({url:"".concat(sm.conf.api_url,"/messaging/chat_transcript"),method:"GET",getRequestHeaders:t,responseType:"json",calculateAttemptDelay:xS(),onSuccess:function(e){return n(e.response)},shouldRetry:function(e){return e>=500},onError:r})}({getRequestHeaders:o,onSuccess:function(t){var n=p_(t).filter(I.identity);h.replace(n,{retainMissingElements:!0}),e(h.values())},onError:function(e){return t(SE(e))}})}))},send:function(e){var n=e.message,r=e.attachment,s=function(e){var t=e.message,n=e.attachment;return new t_({id:Tl(),content:t,attachment:n,status:t_.prototype.STATUSES.SENDING})}({message:n,attachment:r});return h.add(s),new Promise((function(e,a){!function(e){var t=e.id,n=e.ongoingEngagement,r=e.message,i=e.attachment,o=e.queueIds,s=e.getRequestHeaders,a=e.onSuccess,u=e.onError,c=n?"/engagements/".concat(n.id,"/chat_messages/").concat(t):"/messaging/chat_messages/".concat(t);Gf({url:sm.conf.api_url+c,method:"PUT",getRequestHeaders:s,contentType:"application/json",responseType:"json",payload:JSON.stringify({source:"tab",content:r,attachment:i,queue_ids:o}),calculateAttemptDelay:xS(),onSuccess:a,shouldRetry:function(e){return e>=500},onError:u})}({id:s.id,ongoingEngagement:t,message:n,attachment:r,queueIds:f.latestQueueIds,getRequestHeaders:o,onSuccess:function(){var t=function(e){return i(i({},e),{},{status:t_.prototype.STATUSES.DELIVERED})}(s);h.change(s.id,t),e(t)},onError:function(e){var t=function(e){return i(i({},e),{},{status:t_.prototype.STATUSES.FAILED})}(s);zu.warn("Failed to send message using message center",{error:e.response||{status:e.status}}),h.change(s.id,t),a(t)}})}))},markMessagesAsRead:function e(){var t=f,n=t.markAsReadCount,r=t.lastSeenMessageDuringMarkRead;f=i(i({},f),{},{markAsReadCount:n+1});var s=h.values()[0];if(s){if(0===n)return 0===f.unreadMessageCount?Promise.resolve():e();var a=h.valuesUntil(r.id);return I.all(n_,a)?Promise.resolve():(f=i(i({},f),{},{lastSeenMessageDuringMarkRead:s}),new Promise((function(e,t){Gf({url:"".concat(sm.conf.api_url,"/messaging/mark_chat_messages_read"),method:"POST",responseType:"json",getRequestHeaders:o,calculateAttemptDelay:xS(),onSuccess:function(){return e()},shouldRetry:function(e){return e>=500},onError:function(e){f=i(i({},f),{},{lastSeenMessageDuringMarkRead:IS.lastSeenMessageDuringMarkRead}),t(SE(e))}})})))}return Promise.resolve()},_stop:function(){a.unsubscribe(),u.stop()}}}var MS=function(e){return function(){console.warn("Private API, do not use"),e.apply(this,arguments)}},CS=function(){function e(t){var n=this,r=t.statusObservable,i=t.cobraObservable,o=t.webRtcMode,a=t.enabledMediaLevel,u=t.statsClient,c=t.channelObservable,l=t.apiStart,f=t.visitorAppPublicInterface,p=t.pubsub,h=t.routingObservable,d=t.visitorMetadata,v=t.internalVisitorStateObservable,b=t.volatileNotifications,m=t.wsProxy,g=t.currentStatusObservable,y=t.operatorPresenceObservable,w=t.getVisitorPriority,E=t.queuesStateUpdatesObservable,O=t.dynamicImport,S=void 0===O?Zu:O;s(this,e),this.willNavigate=this.willNavigate.bind(this),this.statsClient=u,this.visitorApp=new gS(f);var T,k=new Pu.ReplaySubject(1);this.setLocale=function(e){if(I.contains(e,I.keys(sm.conf.visitor_app_assets.locales)))return zf({url:sm.conf.visitor_app_assets.locales[e],retryLimit:5,calculateAttemptDelay:M(1e3),assetKey:"locale-change",identifier:e,onSuccess:function(t){return zu.info("Locale updated",{locale:e}),k.next(t.response)}},this.statsClient),{};throw new hf({cause:this.ERRORS.INVALID_INPUT})},this.messageCenter=new NS({routingObservable:(T={internalVisitorStateObservable:v,pubsub:p,routingObservable:h,getRequestHeaders:this.getRequestHeaders}).routingObservable,getRequestHeaders:T.getRequestHeaders,pubsub:T.pubsub,internalVisitorStateObservable:T.internalVisitorStateObservable});var A=y.map((function(e){return e.values()})),x=y.bufferCount(2,1).flatMap((function(e){var t=_(e,2),n=t[0],r=t[1],i=[];return n.values().forEach((function(e){var t=r.get(e.id);if(t&&!I.equals(e,t))return i.push(t)})),Pu.Observable.from(i)})),N=A,C=ec.vent.observable(ec.MSG.PUBLIC.ENGAGEMENT_START),R=ec.vent.observable(ec.MSG.PUBLIC.ENGAGEMENT_END),P=!1,j=function(e,t){return Vc.merge(e.pipe(kt(I.always(!0))),t.pipe(kt(I.always(!1)))).pipe(Ho(!1))}(C,R);j.subscribe((function(e){P=e})),this.isInEngagement=function(){return P};var L=new Pu.ReplaySubject(1),q=function(e){var t=I.equals("engagement");return e.pipe(kt((function(e){var n=e.interaction,r=e.visitor,i=e.engagement;return new hO({engaged:t(n)&&!ME(i),name:r&&r.name,email:r&&r.email})})))}(r),U=function(e){return e.connectedObservable.pipe(kt((function(e){return new dO({connected:e})})))}(p);OS(p);var D=sm.conf.engagement.api_timeout_milliseconds||nf,V=sm.conf.omniq.api_retry_interval_milliseconds||1e3,F=sm.conf.omniq.api_max_retries||100,B=new mO({wsProxy:m,stats:this.statsClient,apiTimeoutMilliseconds:D}),H=new SO({wsProxy:m,stats:this.statsClient,apiTimeoutMilliseconds:D,visitorMetadata:d,internalVisitorStateObservable:v}),W=new wS({wsProxy:m,apiTimeoutMilliseconds:D,stats:this.statsClient}),G=vS({wsProxy:m,pubsub:p,routingObservable:h,engagementApi:B,engagementRequestApi:H,operatorsObservable:N,cobraObservable:i.pluck("cobraSource"),fetchEngagementDependencies:function(){return S("Comms")},channelObservable:c,communicationLib:sm.conf.communications.lib,statsClient:this.statsClient,apiTimeoutMilliseconds:D,apiRetryIntervalMilliseconds:V,apiMaxRetries:F,connectionStatusObservable:U,webRtcMode:o,enabledMediaLevel:a,visitorMetadata:d,conf:sm.conf,getRequestHeaders:this.getRequestHeaders,internalVisitorStateObservable:v,visitorAuthenticatedExternallyObservable:Fu.asObservable().distinctUntilChanged(),volatileNotifications:b,statusObservable:r,queuesStateUpdatesObservable:E});this.queueForEngagement=G.queueForEngagement,this.getQueueWaitDuration=G.fetchWaitDuration,this.getQueues=G.getQueues;var z=G.aggregateQueueStateObservable;this.__queueForEngagement=G.oldQueueForEngagement,this.__setQueueReestablishListener=G.oldSetQueueReestablishListener,this.__fetchQueueWaitDuration=G.getQueueWaitDuration,this.subscribeToQueueStateUpdates=xf({enabled:sm.conf.omniq.omniq_enabled,statsClient:this.statsClient,pubsub:p}).subscribe,this.requestEngagement=function(e,t){var s=GE({api:H,conf:sm.conf,operatorsObservable:N.take(1),media:e,options:t,statsClient:n.statsClient,cobraObservable:i.take(1).pluck("cobraSource"),channelObservable:c,engagementApi:B,webRtcMode:o,enabledMediaLevel:a,connectionStatusObservable:U,getRequestHeaders:n.getRequestHeaders,internalVisitorStateObservable:v,volatileNotifications:b,statusObservable:r,pubsub:p,wsProxy:m,dynamicImport:S});return function(e){var t=e.operatorObservable,n=e.engagementObservable,r=e.cancelEngagementRequest,i=e.engagementRequestTimeout;return new zE({timeout:i,engagementPromise:n.toPromise(),operatorPromise:t.toPromise(),cancel:r})}({operatorObservable:s.operatorObservable,engagementObservable:s.engagementObservable,cancelEngagementRequest:s.cancelEngagementRequest,engagementRequestTimeout:s.engagementRequestTimeout})};var J=function(e){var t=e.internalVisitorStateObservable,n=e.webRtcMode,r=e.enabledMediaLevel,i=e.engagementRequestApi,o=e.statsClient,s=e.cobraObservable,a=e.channelObservable,u=e.engagementApi,c=e.connectionStatus,l=e.getRequestHeaders,f=e.volatileNotifications,p=e.statusObservable,h=e.pubsub,d=e.wsProxy,v=e.dynamicImport,b=1e3*sm.conf.engagement.proactive_call_timeout,m=I.compose(I.nth(0),I.filter((function(e){return I.any(I.propEq("id",sm.siteId),e.transferrable_sites)})),I.filter(I.propEq("outcome",null)),I.filter(I.propEq("type","proactive")),I.pathOr([],["engagement","requests"]));return t.map(m).filter(I.identity).distinctUntilChanged(null,I.prop("id")).map((function(e){var v=Xg({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.operator.media_type,webRtcMode:n,enabledMediaType:r}),m=Xg({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.offered_media_type,webRtcMode:n,enabledMediaType:r});return{incomingEngagementRequest:cO.create({api:i,id:e.id,operator:v,restrictedOperator:m,message:e.welcome_message,logoUrl:sm.conf.visitor_app.site_logo.url,platform:e.platform,timeout:b,statsClient:o,cobraObservable:s.take(1).pluck("cobraSource"),channelObservable:a,engagementApi:u,connectionStatusObservable:c,getRequestHeaders:l,internalVisitorStateObservable:t,volatileNotifications:f,statusObservable:p,pubsub:h,wsProxy:d}),platform:e.platform}})).switchMap((function(e){var t=e.incomingEngagementRequest,n=e.platform;return v("Comms").mapTo({incomingEngagementRequest:t,platform:n})}))}({dynamicImport:S,internalVisitorStateObservable:v,webRtcMode:o,enabledMediaLevel:a,engagementRequestApi:H,statsClient:this.statsClient,cobraObservable:i,channelObservable:c,engagementApi:B,connectionStatus:U,getRequestHeaders:this.getRequestHeaders,volatileNotifications:b,statusObservable:r,pubsub:p,wsProxy:m}),Y=new JE,Q=J.filter(I.propEq("platform",uf)).map(I.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){Y.add(Q.subscribe(e,zu.error))};var K=function(e){var t=e.reestablishObservable,n=e.defaultOmnicoreHandler,r=e.defaultOmnibrowseHandler,i=e.internalVisitorStateObservable,o=e.sessionStore||ng,s=e.timeout||15e3,a=t.publishReplay(1);a.connect();var u={replayedReestablishObservable:a.withLatestFrom(i,(function(e,t){return{source:e,visitorState:t}})).filter((function(e){var t=e.source,n=e.visitorState;return!!t.engagement.engagementId&&I.compose(I.find(I.propEq("id",t.engagement.engagementId)),I.pathOr([],["engagement","engagements"]))(n)})).map((function(e){return e.source})),sessionStore:o,timeout:s};return{setOmnicoreReestablishHandler:pO(I.merge(u,{defaultHandler:n,storeKey:"custom_reestablish_handler_set",platform:uf})),setOmnibrowseReestablishHandler:pO(I.merge(u,{defaultHandler:r,storeKey:"omnibrowse_custom_reestablish_handler_set",platform:cf}))}}({reestablishObservable:l.flatMap((function(){return fO({channelObservable:c,internalVisitorStateObservable:v,statusObservable:r,webRtcMode:o,enabledMediaLevel:a,statsClient:n.statsClient,cobraObservable:i,isEngagedObservable:j,engagementApi:B,connectionStatusObservable:U,getRequestHeaders:n.getRequestHeaders,volatileNotifications:b,pubsub:p,wsProxy:m,dynamicImport:S})})),defaultOmnicoreHandler:function(e){return zu.warn("Engagement reestablished without a reestablish handler in place")},defaultOmnibrowseHandler:function(e){return zu.warn("Phone-first (OmniBrowse) engagement reestablished without a reestablish handler in place")},internalVisitorStateObservable:v}),X=K.setOmnicoreReestablishHandler,$=K.setOmnibrowseReestablishHandler;this.setEngagementReestablishHandler=X,this.requestAsset=function(e,t){t||(t={});return uO(e,(function(){return I.merge(n.getRequestHeaders(),t)})).toPromise()},this.omnibrowse=new QE({incomingEngagementRequestObservable:J,setOmnibrowseReestablishHandler:$,statsClient:this.statsClient,wsProxy:m}),this.overseer=new tO({operatorListReady:A.take(1),isOmniqEnabled:sm.conf.omniq.omniq_enabled,routingObservable:h,queueStateReady:z.take(1)}),this.omnicall=new rO,this.config=new sO,this.getBrowserContext=function(){return g.take(1).map((function(e){return{tab_id:sm.tabId,url:window.location.href,metadata:sm.conf.visitor_metadata,status:e}})).toPromise()},this.updateInformation=function(e){return g.take(1).flatMap((function(t){return MO(e,{createApiRequestObservable:function(e){return Wf({url:Gy("/sites/".concat(Vu(),"/visitors/").concat(Lu())),method:"PATCH",contentType:"application/json",payload:e})},serverResponseTimeout:nf,tabId:sm.tabId,visitorMetadata:sm.conf.visitor_metadata,status:t})})).toPromise()},this.createAuthenticationRequest=function(e){return zu.info("Create authentication request called",e),W.createAuthenticationRequest(e)},this.setupContactOperatorButton=function(e){return e||(e={}),zu.warn("setupContactOperatorButton is deprecated!"),L.next(e)};var Z=function(e){var t=e.internalVisitorStateObservable,n=e.authenticationApi,r=I.compose(I.find((function(e){return e.site_id===Vu()&&e.visitor_id===Lu()})),I.pathOr([],["authentication_requests"]));return t.pipe(kt(r),wn(I.identity),di(I.equals),kt((function(e){return I.construct(yS)({id:e.id,siteId:e.site_id,visitorId:e.visitor_id,url:e.url,authenticationApi:n})})))}({internalVisitorStateObservable:v,authenticationApi:W}),ee=I.fromPairs([[this.EVENTS.ENGAGEMENT_START,C],[this.EVENTS.ENGAGEMENT_END,R],[this.EVENTS.VISITOR_STATUS_UPDATE,q],[this.EVENTS.OPERATOR_STATUS_UPDATE,x],[this.EVENTS.OPERATOR_LIST_UPDATE,A],[this.EVENTS.ENGAGEMENT_REQUEST,J.map(I.always({}))],[this.EVENTS.CONNECTION_STATUS_UPDATE,U],[this.EVENTS.QUEUE_STATE_UPDATE,z],[this.EVENTS.AUTHENTICATION_REQUEST,Z],["contact_operator_button_configuration",L],["locale_change_requested",k]]),te=tp();te.proxyAll(ee),this.addEventListener=te.addEventListener,this.removeEventListener=te.removeEventListener,this.observable=function(e){return ee[e]},function(e){var t,n=e.internalVisitorStateObservable,r=e.useOmniq,i=e.operatorListUpdate,o=e.queueStateUpdate,s=e.statsClient,a=e.staffingCheckDelayMs,u=void 0===a?1e4:a,c=e.recordingMaxTime,l=void 0===c?6e4:c,f=I.compose(I.length,I.filter(I.path(["state","available"]))),p=n.map((function(e){return Boolean(CE(e))})).filter(I.equals(!0));t=r?o.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&zu.info("[staffing-logs] Recording queue state",{queue_state:e.state}),I.contains(e.state,[e.QUEUE_STATES.CAN_QUEUE,e.QUEUE_STATES.QUEUED])?"staffed":"general"})):i.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&zu.info("[staffing-logs] Recording operator state",{operator_count:f(e)}),f(e)>0?"staffed":"general"})),sm.conf.visitor_api.enable_staffing_logs&&zu.info("[staffing-logs] Starting recorder timer",{duration:u});var h=Pu.Observable.create((function(e){var t=setTimeout((function(){e.next(null)}),u);return function(){return clearTimeout(t)}})),d=new Date,v=function(){return window.performance&&window.performance.now&&window.performance.now()},b=v();h.flatMapTo(t).take(1).takeUntil(p).subscribe((function(e){var t=new Date,n=v(),r=t-d+1e3<=u;r||t-d>l?zu.warn("Recording staffing failed due to browser timer issues",{type:e,early_recording:r,start_time:d.toISOString(),recording_time:t.toISOString(),accurate_start_time:b,accurate_recording_time:n,difference:t&&t-d,accurate_difference:n&&n-b}):s.increment("usage_metrics.visitor.reactive_tab_showed",["type:".concat(e),"source:desktop","site_id:".concat(Vu()),"visitor_id:".concat(Lu())])}),zu.error)}({internalVisitorStateObservable:v,useOmniq:sm.conf.omniq.omniq_enabled,operatorListUpdate:this.observable(this.EVENTS.OPERATOR_LIST_UPDATE),queueStateUpdate:this.observable(this.EVENTS.QUEUE_STATE_UPDATE),statsClient:this.statsClient});var ne=Ml();!function(e){var t=e.visitorIdleAfterTime,n=e.pubsub;t.subscribe((function(){sm.logger.info("Visitor was idle for too long, disconnecting"),n.disconnect(),ES=!0}))}({visitorIdleAfterTime:function(e,t){var n=e.activityObservable,r=e.engagementEndObservable,i=e.timeUntilIdle,o=e.maxIdleTime,s=e.isEngaged;return Pu.Observable.merge(n,r).debounceTime(i+o,t).filter((function(){return!s()})).map((function(){}))}({activityObservable:ne,engagementEndObservable:R,timeUntilIdle:1e3*sm.conf.engagement.visitor_time_to_inactive_sec,maxIdleTime:1e3*sm.conf.visitor_api.max_idle_time_seconds,isEngaged:function(){return P}}).filter((function(){return sm.conf.visitor_api.disconnect_idle_visitors})),pubsub:p}),function(e){var t=e.activityObservable,n=e.pubsub;t.filter((function(){return ES&&n.allowReconnection()})).subscribe((function(){sm.logger.info("Reconnecting idle visitor due to detected activity"),ES=!1,n.connect()}))}({activityObservable:ne,pubsub:p}),this.getSessionContext=function(){var e={tab_id:sm.tabId,visitor_priority:w(),access_token:sm.accessToken};return encodeURIComponent(btoa(JSON.stringify(e)))},this.__pubsub__={reconnect:MS(p.reconnect)}}return u(e,[{key:"getRequestHeaders",value:function(){return{Accept:"application/vnd.salemove.v1+json",Authorization:"Bearer "+sm.accessToken}}},{key:"getVisitorId",value:function(){return Lu()}},{key:"getSiteId",value:function(){return Vu()}},{key:"leaveMessage",value:function(e){return aO(e,{createApiRequestObservable:function(e){return Wf({url:Gy("/visitor/offline_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:nf}).toPromise()}},{key:"leaveOperatorMessage",value:function(e){return function(e,t,n){e||(e={}),n||(n=Pu.Scheduler.asap);var r=e.operatorId;return r?aO(I.merge({operator_id:r},e),t,["operator_id"],n):Pu.Observable.throw({cause:tf.SALEMOVE.INVALID_INPUT,message:"operatorId must be specified"})}(e,{createApiRequestObservable:function(e){return Wf({url:Gy("/visitor/operator_message"),method:"POST",contentType:"application/json",payload:e})},serverResponseTimeout:nf}).toPromise()}},{key:"willNavigate",value:function(){return Promise.resolve({})}},{key:"changeElementAttributesForCobrowsing",value:function(e,t){if("function"!=typeof t)throw new hf({cause:this.ERRORS.INVALID_INPUT});return e.sm_change_element_attributes=Zf("Custom element attribute serializer threw error",af,t),function(e){e.setAttribute(vO,"0"===(e.getAttribute(vO)||"0")?"1":"0")}(e),null}}]),e}();CS.prototype.ERRORS={INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_QUEUED:"already queued",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_TOO_LARGE:"file too large",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",DENIED_BY_PERMISSIONS_POLICY:"denied by permissions policy",DEVICE_ACCESS_ERROR:"device access error",DENIED_BY_SYSTEM:"denied by system"},CS.prototype.EVENTS={ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_START:"sm:engagement:start",VISITOR_STATUS_UPDATE:"sm:visitor_status:update",ENGAGEMENT_REQUEST:"sm:engagement:request",OPERATOR_LIST_UPDATE:"sm:operator_list:update",OPERATOR_STATUS_UPDATE:"sm:operator_status:update",CONNECTION_STATUS_UPDATE:"sm:connection_status:update",QUEUE_STATE_UPDATE:"sm:queue:update",AUTHENTICATION_REQUEST:"sm:authentication:request"};var RS="sm.app.visitor_api.send_capabilities",PS=function(){function e(t){var n=t.channelObservable,r=t.statsClient,i=t.getLocalCapabilities,o=void 0===i?_E:i;s(this,e),this.channelObservable=n,this.statsClient=r,this.getLocalCapabilities=o,this._receivePostMessage=this._receivePostMessage.bind(this),this._restoreLastUrl=this._restoreLastUrl.bind(this),this._subscription=new Pu.Subscription,this.lastUrl=window.location.href}return u(e,[{key:"start",value:function(){return this._addListeners()}},{key:"capabilitiesRequestObservable",value:function(){return this.channelObservable.switchMap((function(e){var t=e.channel;return function(e){return sm.logger.log("Capabilities response, received request"),e.observable("capabilities:request")}(t).map((function(){return t}))}))}},{key:"_addListeners",value:function(){var e=this;ec.vent.observable("visit:restore_url").subscribe(this._restoreLastUrl,sm.logger.error),window.addEventListener("message",this._receivePostMessage,!1),this._subscription.add(this.capabilitiesRequestObservable().map((function(t){return{channel:t,localCapabilities:e.getLocalCapabilities()}})).do((function(){return e.statsClient.increment(RS,["action:succeeded"])})).do(null,(function(){return e.statsClient.increment(RS,["action:failed"])})).subscribe((function(e){var t=e.channel,n=e.localCapabilities;sm.logger.log("Sending local capabilities",n),t.emit("capabilities:response",n)}),sm.logger.warn.bind(sm.logger,"Failed to send visitor capabilities")))}},{key:"_receivePostMessage",value:function(e){try{var t=JSON.parse(e.data);t["sm-xdr-url"]&&(this.lastUrl=t["sm-xdr-url"])}catch(e){}}},{key:"_restoreLastUrl",value:function(){var e;null!==(e=sm.conf.visitor_api)&&void 0!==e&&e.use_buggy_iframe_reload?this._oldRestoreLastUrl():window.location.hash&&this.lastUrl.split("#")[0]===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}},{key:"_oldRestoreLastUrl",value:function(){this.lastUrl&&this.lastUrl.split("#")===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}}]),e}(),jS=["v1"],LS=new Promise((function(e,t){return sm._apiHandlers.push({resolve:e,options:{version:"v1"}})})),qS=new Pu.Subject,US=Pu.Observable.fromPromise(LS).flatMap((function(e){return Pu.Observable.merge(e.observable(e.EVENTS.ENGAGEMENT_START),e.observable(e.EVENTS.ENGAGEMENT_END).map((function(){return null})))})).publishReplay(1);US.connect();var DS=function(){function e(t){var n=t.element;s(this,e),this._empty=this._empty.bind(this),this._startOperatorMediaInElement=this._startOperatorMediaInElement.bind(this),this.element=n,this._subscription=new Pu.Subscription;var r=_(US.partition(I.identity),2);this.startMediaObservable=r[0],this.endMediaObservable=r[1]}return u(e,[{key:"start",value:function(){this._subscription.add(this.startMediaObservable.subscribe(this._startOperatorMediaInElement,zu.error)),this._subscription.add(this.endMediaObservable.subscribe(this._empty,zu.error))}},{key:"destroy",value:function(){this._subscription.unsubscribe()}},{key:"_empty",value:function(){this.element.innerHTML=""}},{key:"_startOperatorMediaInElement",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;e.communicationWidget.startOperatorMedia(this.element),zu.info("Starting operator media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),Ju.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_operator","updated_webcomponents:".concat(t)])}}]),e}(),VS=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"connectedCallback",value:function(){return this._controller=new DS({element:this}),this._controller.start()}},{key:"disconnectedCallback",value:function(){return this._controller.destroy()}}]),n}(v(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){return this._controller=new DS({element:this}),this._controller.start()},e.prototype.disconnectedCallback=function(){return this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new DS({element:this}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},FS=function(){var e=VS();if(window.customElements)try{customElements.get("sm-engaged-operator")||window.customElements.define("sm-engaged-operator",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;Ju.increment("sm.app.visitor.customElements",["action:failed","type:engaged_operator","updated_webcomponents:".concat(t)]),zu.error("Failed to initiate sm-engaged-operator",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-operator",e)},BS=function(){function e(t){var n=t.engagedVisitorElement,r=t.attributes;s(this,e),this._addListeners=this._addListeners.bind(this),this._empty=this._empty.bind(this),this._startVisitorMedia=this._startVisitorMedia.bind(this),this.engagedVisitorElement=n,this._subscription=new Pu.Subscription,this._attributes=r}return u(e,[{key:"start",value:function(){return this._addListeners()}},{key:"destroy",value:function(){return this._subscription.unsubscribe()}},{key:"_addListeners",value:function(){var e=_(US.partition(I.identity),2),t=e[0],n=e[1];return this._subscription.add(t.subscribe(this._startVisitorMedia,zu.error)),this._subscription.add(n.subscribe(this._empty,zu.error))}},{key:"_empty",value:function(){this.engagedVisitorElement.innerHTML=""}},{key:"_startVisitorMedia",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0,r=document.createElement("div");this.engagedVisitorElement.appendChild(r),e.communicationWidget.startVisitorMedia(r,this._attributes),zu.info("Starting visitor media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),Ju.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_visitor","updated_webcomponents:".concat(t)])}}]),e}(),HS=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return u(n,[{key:"connectedCallback",value:function(){this._controller=new BS({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()}},{key:"disconnectedCallback",value:function(){this._controller.destroy()}}]),n}(v(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){this._controller=new BS({engagedVisitorElement:this,attributes:{translations:JSON.parse(this.getAttribute("translations"))||{}}}),this._controller.start()},e.prototype.disconnectedCallback=function(){this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new BS({engagedVisitorElement:this,translations:this.getAttribute("translations")||{}}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},WS=function(){var e=HS();if(window.customElements)try{customElements.get("sm-engaged-visitor")||window.customElements.define("sm-engaged-visitor",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;Ju.increment("sm.app.visitor.customElements",["action:failed","type:engaged_visitor","updated_webcomponents:".concat(t)]),zu.error("Failed to initiate sm-engaged-visitor",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-visitor",e)},GS=!1,zS=!1,JS=[],YS=function e(){if(!zS){if(!document.body)return setTimeout(e,13);if(zS=!0,JS){for(var t,n=0;t=JS[n++];)t.call(document);JS=null}}},QS=function e(){document.removeEventListener("DOMContentLoaded",e,!1),YS()};function KS(e){!function(){if(!GS){if(GS=!0,"complete"===document.readyState||"interactive"===document.readyState)return YS();document.addEventListener("DOMContentLoaded",QS,!1),window.addEventListener("load",YS,!1)}}(),zS?e.call(document):JS&&JS.push(e)}sm.ready=KS;var XS=function(e){localStorage.setItem("sm.access_token",e)};if(sm.conf.visitor_api.persist_visitor_session_in_url){sm.urlParams=wy({accessToken:/.+/,tabId:/.+/},{targetWindow:window,logger:zu})}else sm.urlParams={};if("show_visitor_code"===sm.conf.visitor_app.chat_link_visitor_consolidation){var $S=wy({showVisitorCode:/true/},{targetWindow:window,logger:zu});I.isEmpty($S)||(sm.urlParams.showVisitorCode=!0)}var ZS={setStatsClient:function(){},setLogger:function(){},ready:function(){}},eT=function(e){var t=sm.conf.visitor_app_assets,n="visitor_app";return new Promise((function(r,i){var o,s,a;-1!==["latest_new_app","latest_v2","latest_v2_plus"].indexOf(sm.conf.visitor_app_option)?(o=function(e){e.setAttribute("data-sm-visitor-app-asset",""),e.setAttribute("data-loaded-callback","sm.visitorAppLoaded"),sm.visitorAppLoaded=r},a=null):(o=function(e){return e.setAttribute("data-sm-visitor-app-asset","")},a=function(){return r(ZS)}),t.js.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),L({integrity:j({versionedName:s}),fileUrl:t,beforeLoad:o,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".js")])},onLoad:function(){e.increment("sm.assets.load",["action:succeeded","asset:".concat(n,".js")]),a&&a()},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".js")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".js")]),zu.warn(new Error("Failed to load visitor app JS asset"),{asset_url:t})}})})),t.css.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),q({integrity:j({versionedName:s}),fileUrl:t,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".css")])},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".css")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".css")]),zu.warn(new Error("Failed to load visitor app CSS asset"),{asset_url:t})}})}))}))},tT=function(){return-1!==["latest_new_app","latest_v2","latest_v2_plus","custom","omnibrowse"].indexOf(sm.conf.visitor_app_option)},nT=function(e){var t=e.stats;return tT()?eT(t):Promise.resolve(ZS)},rT=function(){return sm.conf.visitor_app.visitor_app_default_locale||""},iT={translations:{}},oT=function(e){return new Promise((function(t,n){var r=rT(),i=(sm.conf.visitor_app_assets.locales||{})[r];i?zf({url:i,retryLimit:5,calculateAttemptDelay:M(1e3),assetKey:"locale",identifier:r,onSuccess:function(e){t({translations:e.response})},onError:function(){zu.warn("Fetching locale failed, using empty locale"),t(iT)}},e):(e.increment("sm.assets.load",["action:failed","asset:locale","reason:locale_missing"]),zu.warn("Locale is not present, starting with defaultMessages",{localeKey:r,localeUrl:i}),t(iT))}))},sT=function(e){return"en-US"===rT()?Promise.resolve(iT):tT()?oT(e):Promise.resolve(iT)},aT=function(e){var t=cy.extractLinkFromEvent(e);t&&function(e,t){"https:"!==t.protocol&&"http:"!==t.protocol||cy.isAllowedToNavigate(t.hostname)||(e.preventDefault(),window.open(t.href))}(e,t)},uT=function(){return Zm.unloadMaybeToPageCache.subscribe((function(){return ng.set(Vy,By(document))}))},cT=function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.routingObservable;document.body.addEventListener("click",aT),uT(),function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.routingObservable;yp();var l=sp({channelObservable:Ly({internalVisitorStateObservable:o,getAccessToken:t,stats:n,visitorPresenceChannel:i,salemovePresentInParent:!0}).channelObservable,logger:zu}).cobraObservable,f=xf({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});$f({internalVisitorStateObservable:o,cobraObservable:l,volatileNotifications:s,stats:n,wsProxy:a,currentStatusObservable:og(o),operatorPresenceObservable:u,queuesStateUpdatesObservable:f,routingObservable:c})}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:u,routingObservable:c}),oc(),ly()},lT={setup:function(){XS(sm.accessToken),zu.info("Visitor WebRTC mode",{webrtc_mode:Ug()}),sm.conf.visitor_app.theme=sm.conf.visitor_app.theme.desktop_css_url;var e=vy(),t=e.bestEffortXDomainStorage,n=e.windowNameStorage,r=e.xDomainUrlStorage,i=rg.setup(n,{sessionContext:sm._sessionContext,tabIdFromConfiguration:sm.tabId}).getId();sm.tabId=i;var o=new Pu.Subject;!function(e,t){N=I.merge(N,{enabled:t}),e.take(1).subscribe((function(e){e.volatileChannelObservable.flatMap((function(e){return e.observable("system:visitor_retry_configuration")})).subscribe((function(e){N=e}))}))}(o,sm.conf.visitor_request_retries_enabled);var s=function(e){return e.getItem(ug)}(t)||ag,a=function(){return s},u=I.pathOr(!1,["sm","conf","site_visitor_config","detect_visitor_by_external_session_token"])(window),c=I.pathOr(!1,["sm","conf","site_visitor_config","opaque_visitor_authentication_enabled"])(window),l=new Pu.Subject,f=function(e){var t=e.fetchToken,n=void 0===t?yg:t,r=e.accessToken,i=e.scheduler,o=void 0===i?Pu.Scheduler.asap:i,s=e.accessTokenRenewalSignal,a=void 0===s?Pu.Observable.empty():s,u=e.backoffStrategy,c=void 0===u?M:u,l=e.getVisitorPriority,f=e.getVisitorTabId,p=void 0===f?function(){return sm.tabId}:f,h=e.detectVisitorByExternalSessionTokenEnabled,d=void 0!==h&&h,v=e.opaqueVisitorAuthenticationEnabled,b=void 0!==v&&v,m=new Pu.ReplaySubject(1),g=mg(r);m.next(g);var y=c(3e3),_=function(e){return function(e){return e&&e.consolidationSecret}(e)||function(e){return e&&e.newIdToken}(e)};return m.switchMap((function(e){return Pu.Observable.timer(e,o)})).merge(a.filter(I.complement(_))).throttleTime(6e4,o).merge(a.filter(_)).switchMap((function(e){var t={priority:l(),tabId:p(),detectVisitorByExternalSessionTokenEnabled:d,opaqueVisitorAuthenticationEnabled:b};e&&e.consolidationSecret?t.consolidationSecret=e.consolidationSecret:t.accessToken=r,zu.info("Refreshing access token");var i=Pu.Observable.defer((function(){return n(t)})).do(null,(function(e){503!==e.status&&429!==e.status||(zu.warn("Visitor access token unavailable, switching to maximum backoff"),y.maximizeNextDelay()),zu.warn("Failed to fetch JWT token. Retrying...",e.responseText)}));return il(i,{maxRetries:403200,calculateDelay:y,scheduler:o}).do((function(e){var t=e.accessToken;r=t;var n=mg(t);m.next(n),zu.info("Access token refresh succeeded",{interval_seconds:n/1e3})}))}))}({accessToken:sm.accessToken,accessTokenRenewalSignal:l,getVisitorPriority:a,detectVisitorByExternalSessionTokenEnabled:u,opaqueVisitorAuthenticationEnabled:c}).share(),p=function(){return sm.accessToken},h=ch({server:sm.conf.pubsub_server,stats:Ju,logsEnabled:sm.conf.visitor_api.pubsub_logs_enabled,getAccessToken:p,renewAccessToken:function(e){return l.next(e),f.delay(1e3)},reconnectConf:{initialDelay:sm.conf.visitor_api.socket_connection_error_retry_delay,maxDelay:sm.conf.visitor_api.socket_connection_error_max_delay,delayFactor:sm.conf.visitor_api.socket_connection_error_delay_factor},getVisitorPriority:a});o.next(h),f.subscribe((function(e){var t,n,r,i,o,s=e.accessToken,a=e.visitorId,u=e.authenticatedExternally;(sm.accessToken=s,XS(s),c)&&(t={oldVisitorId:Lu(),newVisitorId:a,oldAuthenticatedExternally:Bu(),newAuthenticatedExternally:u},n=t.oldVisitorId,r=t.newVisitorId,i=t.oldAuthenticatedExternally,o=t.newAuthenticatedExternally,r!==n&&o!==i&&function(e){var t=e.visitorId,n=e.authenticatedExternally,r=e.pubsub,i=e.App,o=void 0===i?ec:i,s=e.setNewVisitorIdFn,a=void 0===s?Du:s,u=e.setVisitorAuthenticatedExternallyFn,c=void 0===u?Hu:u;o.vent.trigger("engagement:prepare_for_restart"),c(n),r.disconnect((function(){a(t),r.connect()}))}({visitorId:a,authenticatedExternally:u,pubsub:h}))})),c&&bg().switchMap((function(e){var t=e.idToken;return function(e){var t=e.accessTokenObservable,n=e.timeInterval,r=void 0===n?1e3:n,i=e.scheduler,o=void 0===i?Pu.Scheduler.asap:i,s=e.initialValue,a=e.getGliaContextAsObservable,u=void 0===a?bg:a,c=s;return Pu.Observable.merge(t,Pu.Observable.of(null)).switchMap((function(){return Pu.Observable.timer(r,r,o).switchMap((function(){return u().filter((function(e){var t=e.idToken,n=t===c;return c=t,!n}))})).take(1)}))}({accessTokenObservable:f,initialValue:t})})).subscribe((function(){l.next({newIdToken:!0})}));var d=new lh(h,{tabId:sm.tabId,idleTimeoutSeconds:sm.conf.engagement.visitor_time_to_inactive_sec,visitorMetadata:sm.conf.visitor_metadata}),v=Ym({pubsub:h,tabId:sm.tabId});(function(e,t){return e.map(pg).distinctUntilChanged().do((function(e){return t.setItem(ug,e)}))})(v,t).subscribe((function(e){s=e}));var b,m=h.volatileChannelObservable.flatMap((function(e){return(0,e.observable)("message")})),g=function(e){var t=e.pubsub,n=t.joinChannel("websocket_proxy").publishReplay(1);return n.connect(),{connectedObservable:t.connectedObservable,updateAccessToken:function(e){n.take(1).flatMap((function(t){return t.push("update_access_token",{token:e})})).subscribe()},request:function(e,t){return t||(t={}),"GET"===e.method&&null!==e.payload?(Qm.error("Request with GET method cannot have payload",{params:e}),Pu.Observable.throw("Request with GET method cannot have payload")):n.flatMap((function(n){return n.push("request",e,t)})).flatMap(Km).catch(Xm)}}}({pubsub:h});f.subscribe((function(e){var t=e.accessToken;g.updateAccessToken(t)})),b=sm.conf.visitor_api.use_updated_webcomponents?window.customElements&&window.customElements.define?"webcomponents_es5":"webcomponents":"legacy_webcomponents";var y=sm.BusinessRules.Controller.actionTriggers(m,sm.BusinessRules.ACTION_TYPES.SHOW_OPERATORS_IN_SELECTOR_V2).scan((function(e,t){var n=t.operator_team_id,r=t.rule_id,i=t.rule_name,o=t.clear_previous;return o?{team_ids:[n],rule_id:r,rule_name:i,clear_previous:o}:{team_ids:I.union(e.team_ids,[n]),rule_id:r,rule_name:i,clear_previous:o}}),{}).do((function(e){return zu.info("Business rule setting visible teams",{team_ids:e.team_ids,rule_id:e.rule_id,rule_name:e.rule_name,clear_previous:e.clear_previous})})).pluck("team_ids").publishReplay(1);y.connect();var _=function(e){var t=e.pubsub,n=e.visibleTeamsObservable,r=e.enabledMediaLevel,i=e.webRtcMode,o=t.joinChannel("site_operator_presence:".concat(sm.siteId)).map((function(e){var t=e.phoenixChannel;return new Jp(t)})).switchMap((function(e){return Pu.Observable.create((function(t){return ey({presence:e,presenceMapper:$g({enabledMediaLevel:r,webRtcMode:i}),visibleTeamsObservable:n,onChange:function(e){return t.next(e)}})}))})).publishReplay(1);return(o=rl(o)).sampleTime(300)}({pubsub:h,visibleTeamsObservable:y,enabledMediaLevel:sm.conf.communications.enabled_media_level,webRtcMode:Ug()}),w=sm.conf.engagement.default_queues||[],E=by({internalVisitorStateObservable:v,defaultQueues:w});Zu(b).subscribe((function(){KS((function(){window!==window.top?lT.setupIFrame({getAccessToken:p,stats:Ju,pubsub:h,visitorPresenceChannel:d,internalVisitorStateObservable:v,volatileNotifications:m,wsProxy:g,bestEffortXDomainStorage:t,operatorPresenceObservable:_,xDomainUrlStorage:r,getVisitorPriority:a,routingObservable:E,tabId:i}):(sm.visitorPageNotifierSubscription={unsubscribe:bp(i)},mp(i),lT.setupApp({getAccessToken:p,stats:Ju,pubsub:h,visitorPresenceChannel:d,internalVisitorStateObservable:v,volatileNotifications:m,wsProxy:g,operatorPresenceObservable:_,bestEffortXDomainStorage:t,xDomainUrlStorage:r,getVisitorPriority:a,routingObservable:E}))}))}))},setupApp:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.operatorPresenceObservable,c=e.xDomainUrlStorage,l=e.getVisitorPriority,f=e.routingObservable;FS(),WS();return Promise.all([nT({stats:n}),sT(n),gy({stats:n}),_y({stats:n})]).then((function(e){return"[0]"!==JSON.stringify([0])?(r.disconnect(),Promise.reject('Misimplemented array stringification: (JSON.stringify([0]) !== "[0]"')):e})).then((function(e){var t=_(e,2);return function(e){var t=e.visitorApp,r=e.locale;return void 0===t.setStatsClient&&zu.warn("Setting dependencies failed. visitorApp.setStatsClient was undefined.",{visitorApp:t}),t.setStatsClient(n),t.setLogger(zu),t.ready({locale:r}),t}({visitorApp:t[0],locale:t[1]})})).then((function(e){c.setItem("tabId",sm.tabId),c.setItem("accessToken",sm.accessToken);var p=function(e){var t=e.getAccessToken,n=e.stats,r=e.visitorPresenceChannel,i=e.internalVisitorStateObservable;yp();var o=Ly({internalVisitorStateObservable:i,getAccessToken:t,stats:n,visitorPresenceChannel:r,salemovePresentInParent:!1}),s=o.channelObservable;return{channelObservable:s,statusObservable:o.statusObservable,cobraObservable:sp({channelObservable:s,logger:zu}).cobraObservable}}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o}),h=og(o),d=xf({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});!function(e){var t,n=e.statusObservable,r=e.cobraObservable,i=e.statsClient,o=e.channelObservable,s=e.visitorAppPublicInterface,a=e.pubsub,u=e.visitorMetadata,c=e.internalVisitorStateObservable,l=e.routingObservable,f=e.volatileNotifications,p=e.wsProxy,h=e.currentStatusObservable,d=e.operatorPresenceObservable,v=e.getVisitorPriority,b=e.queuesStateUpdatesObservable,m=Ug(),g=sm.conf.communications.enabled_media_level,y=new CS({statusObservable:n,webRtcMode:m,enabledMediaLevel:g,statsClient:i,cobraObservable:r,channelObservable:o,apiStart:qS,visitorAppPublicInterface:s,pubsub:a,visitorMetadata:u,internalVisitorStateObservable:c,routingObservable:l,volatileNotifications:f,wsProxy:p,currentStatusObservable:h,operatorPresenceObservable:d,getVisitorPriority:v,queuesStateUpdatesObservable:b});sm._getApi=t=function(e){e||(e={});var t=e.version;return t?I.contains(t,jS)?Promise.resolve(y):(zu.warn("getApi used with unsupported version ".concat(t," at ").concat(window.location.host)),Promise.reject(new Error("".concat(t," is not supported for Glia API. ")+"The supported versions are: ".concat(rw(jS))))):(console.warn("Requesting the Glia API without a version is deprecated. Provide the 'version' parameter to the sm.getApi function. Example: sm.getApi({version: 'v1'})"),zu.warn("getApi used without version at ".concat(window.location.host)),Promise.resolve(y))},I.forEach((function(e){t(e.options).then(e.resolve.bind(e))}),sm._apiHandlers),new PS({channelObservable:o,statsClient:i}).start(),qS.next(),qS.complete(),setTimeout((function(){sm.urlParams.showVisitorCode&&s&&(s.showVisitorCode?s.showVisitorCode():zu.info("showVisitorCode is undefined on visitorAppPublicInterface"))}))}({statusObservable:p.statusObservable,cobraObservable:p.cobraObservable,channelObservable:p.channelObservable,statsClient:n,visitorAppPublicInterface:e,pubsub:r,visitorMetadata:sm.conf.visitor_metadata,internalVisitorStateObservable:o,routingObservable:f,volatileNotifications:s,wsProxy:a,currentStatusObservable:h,operatorPresenceObservable:u,getVisitorPriority:l,queuesStateUpdatesObservable:d}),$f({internalVisitorStateObservable:o,cobraObservable:p.cobraObservable,volatileNotifications:s,stats:n,wsProxy:a,currentStatusObservable:h,operatorPresenceObservable:u,queuesStateUpdatesObservable:d,routingObservable:f}),oc(),function(){var e=ng.get(Vy);if(e)ng.remove(Vy),Fy(document,e)}()})).catch((function(e){return zu.warn("Starting visitor app failed",{error:e})}))},setupIFrame:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,u=e.bestEffortXDomainStorage,c=e.operatorPresenceObservable,l=e.xDomainUrlStorage,f=e.getVisitorPriority,p=e.routingObservable,h=e.tabId,d=new vp(h);d.start(),d.request(),sm.visitorPageNotifierSubscription={unsubscribe:bp(h)};var v=new gp(d,sm.conf),b=!1;return v.identityObservable().subscribe((function(e){if(b)zu.warn("Received iFrame identity after defaulting to unknown",{identity:e});else switch(b=!0,e){case v.IDENTITIES.NESTED_COBROWSABLE_IFRAME:oc(),function(e){var t=e.parentWindowMessenger,n=e.iframeContext,r=e.getAccessToken,i=e.stats;new Lm(t,n.nestedCobrowsableVisitorIframeChannelUrl,r,i).boot()}({getAccessToken:t,parentWindowMessenger:d.getParentWindowMessenger(),iframeContext:d.getCurrentContext(),stats:n});break;case v.IDENTITIES.ENGAGEMENT_IFRAME:d.stop(),cT({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,routingObservable:p});break;default:sm.conf.visitor_api.allow_embedding?(zu.info("Did not receive iFrame identity from parent, bootstrapping as top frame"),mp(h),lT.setupApp({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,bestEffortXDomainStorage:u,xDomainUrlStorage:l,getVisitorPriority:f,routingObservable:p})):zu.warn("Starting base app failed. IFrame has unknown identity.                 Top frame likely does not have Glia scripts installed.",{identity:e})}}))}};sm.EventEmitter=x,sm.dynamicImport=Zu,sm.R=I,sm.Rx=Pu,sm.App=ec;var fT=Boolean(sm.Bootstrapper);sm.Bootstrapper={boot:function(){fT||sm.installed||(sm.installed=!0,lT.setup())}}}(sm.conf);
//# sourceMappingURL=bootstrapper-544677dd8.js.map
